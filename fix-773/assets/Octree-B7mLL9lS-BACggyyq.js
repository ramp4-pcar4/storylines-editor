import{d7 as v,gJ as m,e4 as Ot,dn as F}from"./main-D8UjLOIQ.js";import{_ as tt,X as Rt,p as et,A as pt,P as y,L as q}from"./vec32-Cj8pVsU0-BmYyqgTW.js";import{j as V,_ as nt,l as k,K as rt,S as z,U as T,M as At,a as it,X as ut}from"./sphere-zPMQWhGG-C71NzDQ7.js";import{B as bt,z as Ft}from"./mat4-OOmHNWi7-Bnj6TIOE.js";import{D as Et}from"./vec42-D8CJyqHG-DnfLTeQH.js";import{r as g}from"./vec4f64-DD-nkcCV-CSNWKRqG.js";import{c as Mt,y as A,w as Nt,G as L}from"./plane-Cf3Koz3c-CFwUi6Ll.js";import{x as gt,v as Bt}from"./vectorStacks-5ZZtmT9E-D2GdqudT.js";import{p as lt}from"./BufferView-wDxx79o3-CaImLZVj.js";function Q(n){return n?{ray:it(n.ray),c0:n.c0,c1:n.c1}:{ray:it(),c0:0,c1:Number.MAX_VALUE}}function Qt(n,t=Q()){return At(n,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function Yt(n,t){return ct(n,n.c0,t)}function Zt(n,t){return ct(n,n.c1,t)}function ct(n,t,e){return y(e,n.ray.origin,q(e,n.ray.direction,t))}new ut(()=>Q());function te(n){return n?[A(n[0]),A(n[1]),A(n[2]),A(n[3]),A(n[4]),A(n[5])]:[A(),A(),A(),A(),A(),A()]}function St(){return[F(),F(),F(),F(),F(),F(),F(),F()]}function ee(n,t){for(let e=0;e<Y;e++)Nt(n[e],t[e]);return n}function ne(n,t,e,r=Lt){const i=bt(gt.get(),t,n);Ft(i,i);for(let o=0;o<jt;++o){const h=Et(Bt.get(),Pt[o],i);pt(r[o],h[0]/h[3],h[1]/h[3],h[2]/h[3])}xt(e,r)}function xt(n,t){L(t[s.FAR_BOTTOM_LEFT],t[s.NEAR_BOTTOM_LEFT],t[s.NEAR_TOP_LEFT],n[B.LEFT]),L(t[s.NEAR_BOTTOM_RIGHT],t[s.FAR_BOTTOM_RIGHT],t[s.FAR_TOP_RIGHT],n[B.RIGHT]),L(t[s.FAR_BOTTOM_LEFT],t[s.FAR_BOTTOM_RIGHT],t[s.NEAR_BOTTOM_RIGHT],n[B.BOTTOM]),L(t[s.NEAR_TOP_LEFT],t[s.NEAR_TOP_RIGHT],t[s.FAR_TOP_RIGHT],n[B.TOP]),L(t[s.NEAR_BOTTOM_LEFT],t[s.NEAR_BOTTOM_RIGHT],t[s.NEAR_TOP_RIGHT],n[B.NEAR]),L(t[s.FAR_BOTTOM_RIGHT],t[s.FAR_BOTTOM_LEFT],t[s.FAR_TOP_LEFT],n[B.FAR])}function C(n,t){for(let e=0;e<Y;e++){const r=n[e];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]>=t[3])return!1}return!0}function re(n,t){for(let e=0;e<Y;e++){const r=n[e];if(!Mt(r,t))return!1}return!0}var B,s;(function(n){n[n.LEFT=0]="LEFT",n[n.RIGHT=1]="RIGHT",n[n.BOTTOM=2]="BOTTOM",n[n.TOP=3]="TOP",n[n.NEAR=4]="NEAR",n[n.FAR=5]="FAR"})(B||(B={})),function(n){n[n.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",n[n.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",n[n.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",n[n.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",n[n.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",n[n.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",n[n.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",n[n.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(s||(s={})),s.FAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_LEFT,s.FAR_BOTTOM_LEFT,s.NEAR_BOTTOM_LEFT,s.NEAR_BOTTOM_RIGHT,s.NEAR_TOP_RIGHT,s.NEAR_TOP_LEFT,s.FAR_BOTTOM_RIGHT,s.FAR_BOTTOM_LEFT,s.FAR_TOP_LEFT,s.FAR_TOP_RIGHT,s.NEAR_BOTTOM_RIGHT,s.FAR_BOTTOM_RIGHT,s.FAR_TOP_RIGHT,s.NEAR_TOP_RIGHT,s.FAR_BOTTOM_LEFT,s.NEAR_BOTTOM_LEFT,s.NEAR_TOP_LEFT,s.FAR_TOP_LEFT,s.FAR_TOP_LEFT,s.NEAR_TOP_LEFT,s.NEAR_TOP_RIGHT,s.FAR_TOP_RIGHT;const Y=6,jt=8,Pt=[g(-1,-1,-1,1),g(1,-1,-1,1),g(1,1,-1,1),g(-1,1,-1,1),g(-1,-1,1,1),g(1,-1,1,1),g(1,1,1,1),g(-1,1,1,1)];new ut(Q);const Lt=St();class I{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,e){this.objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),W[0]=null,j.prune(),P.prune()}add(t){const e=Array.from(t);this._grow(e);const r=l.acquire();for(const i of e)++this._objectCount,this._isDegenerate(i)?this._degenerateObjects.add(i):(r.init(this._root),this._add(i,r));l.release(r)}remove(t,e=null){this._objectCount-=t.length;const r=l.acquire();for(const i of t){const o=e??V(this.objectToBoundingSphere(i),yt);D(o[3])?(r.init(this._root),It(i,o,r)):this._degenerateObjects.delete(i)}l.release(r),this._shrink()}update(t,e){if(!D(e[3])&&this._isDegenerate(t))return;const r=wt(t);this.remove(r,e),this.add(r)}forEachAlongRay(t,e,r){const i=nt(t,e);x(this._root,o=>{if(!Gt(i,o))return!1;const h=o.node;return h.terminals.forAll(c=>{this._intersectsObject(i,c)&&r(c)}),h.residents!==null&&h.residents.forAll(c=>{this._intersectsObject(i,c)&&r(c)}),!0})}forEachAlongRayWithVerticalOffset(t,e,r,i){const o=nt(t,e);x(this._root,h=>{if(!Ht(o,h,i))return!1;const c=h.node;return c.terminals.forAll(a=>{this._intersectsObjectWithOffset(o,a,i)&&r(a)}),c.residents!==null&&c.residents.forAll(a=>{this._intersectsObjectWithOffset(o,a,i)&&r(a)}),!0})}forEach(t){x(this._root,e=>{const r=e.node;return r.terminals.forAll(t),r.residents!==null&&r.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,r,i=()=>!0,o=1/0){let h=1/0,c=1/0,a=null;const d=J(t,e),f=u=>{if(--o,!i(u))return;const O=this.objectToBoundingSphere(u);if(!C(r,O))return;const E=S(t,e,T(O)),G=E-O[3],_=E+O[3];G<h&&(h=G,c=_,a=u)};return st(this._root,u=>{if(o<=0||!C(r,u.bounds)||(q(b,d,u.halfSize),y(b,b,T(u.bounds)),S(t,e,b)>c))return!1;const O=u.node;return O.terminals.forAll(E=>f(E)),O.residents!==null&&O.residents.forAll(E=>f(E)),!0},t,e),a}forEachInDepthRange(t,e,r,i,o,h,c){let a=-1/0,d=1/0;const f={setRange:_=>{r===I.DepthOrder.FRONT_TO_BACK?(a=Math.max(a,_.near),d=Math.min(d,_.far)):(a=Math.max(a,-_.far),d=Math.min(d,-_.near))}};f.setRange(i);const u=S(e,r,t),O=J(e,r),E=J(e,-r),G=_=>{if(!c(_))return;const N=this.objectToBoundingSphere(_),H=T(N),Z=S(e,r,H)-u,ft=Z-N[3],mt=Z+N[3];ft>d||mt<a||!C(h,N)||o(_,f)};st(this._root,_=>{if(!C(h,_.bounds)||(q(b,O,_.halfSize),y(b,b,T(_.bounds)),S(e,r,b)-u>d)||(q(b,E,_.halfSize),y(b,b,T(_.bounds)),S(e,r,b)-u<a))return!1;const N=_.node;return N.terminals.forAll(H=>G(H)),N.residents!==null&&N.residents.forAll(H=>G(H)),!0},e,r)}forEachNode(t){x(this._root,e=>t(e.node,e.bounds,e.halfSize,e.depth))}forEachNeighbor(t,e){const r=k(e),i=T(e),o=a=>{const d=this.objectToBoundingSphere(a),f=k(d),u=r+f;return!(et(T(d),i)-u*u<=0)||t(a)};let h=!0;const c=a=>{h&&(h=o(a))};x(this._root,a=>{const d=k(a.bounds),f=r+d;if(et(T(a.bounds),i)-f*f>0)return!1;const u=a.node;return u.terminals.forAll(c),h&&u.residents!==null&&u.residents.forAll(c),h}),h&&this.forEachDegenerateObject(c)}_intersectsObject(t,e){const r=this.objectToBoundingSphere(e);return!(r[3]>0)||rt(r,t)}_intersectsObjectWithOffset(t,e,r){const i=this.objectToBoundingSphere(e);return!(i[3]>0)||rt(r.applyToBoundingSphere(i),t)}_add(t,e){e.advanceTo(this.objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let r=0;r<e.length;r++){const i=l.acquire().init(t);this._add(e.at(r),i),l.release(i)}}_grow(t){if(ot(t,e=>this.objectToBoundingSphere(e),M),D(M[3])&&!this._fitsInsideTree(M))if(dt(this._root.node))V(M,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(M);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(M,e):this._growRootAsSubNode(e),l.release(e)}}_rebuildTree(t,e){tt(T(U),T(e.bounds)),U[3]=e.halfSize,ot([t,U],i=>i,X);const r=l.acquire().init(this._root);this._root.initFrom(null,X,X[3]),this._root.increaseHalfSize(1.25),x(r,i=>(this.add(i.node.terminals.data),i.node.residents!==null&&this.add(i.node.residents.data),!0)),l.release(r)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return x(this._root,i=>(r=Math.max(r,i.depth),r+e<=this._maximumDepth)),r+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],r=t;let i=-1/0;const o=this._root.bounds,h=this._root.halfSize;for(let a=0;a<3;a++){const d=o[a]-h-(r[a]-e),f=r[a]+e-(o[a]+h),u=Math.max(0,Math.ceil(d/(2*h))),O=Math.max(0,Math.ceil(f/(2*h)))+1,E=2**Math.ceil(Math.log(u+O)*Math.LOG2E);i=Math.max(i,E),w[a].min=u,w[a].max=O}for(let a=0;a<3;a++){let d=w[a].min,f=w[a].max;const u=(i-(d+f))/2;d+=Math.ceil(u),f+=Math.floor(u);const O=o[a]-h-d*h*2;K[a]=O+(f+d)*h}const c=i*h;return K[3]=c*Tt,l.acquire().initFrom(null,K,c,0)}_growRootAsSubNode(t){const e=this._root.node;tt(T(M),T(this._root.bounds)),M[3]=this._root.halfSize,this._root.init(t),t.advanceTo(M,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let r=0,i=0;for(;i<e.length&&t==null;)r=i++,t=e[r];for(;i<e.length;)if(e[i++])return-1;return r}_isDegenerate(t){return!D(this.objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,r=this._root.halfSize;return t[3]<=r&&t[0]>=e[0]-r&&t[0]<=e[0]+r&&t[1]>=e[1]-r&&t[1]<=e[1]+r&&t[2]>=e[2]-r&&t[2]<=e[2]+r}toJSON(){const{maximumDepth:t,maximumObjectsPerNode:e,_objectCount:r}=this,i=this._nodeToJSON(this._root.node);return{maximumDepth:t,maximumObjectsPerNode:e,objectCount:r,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:i}}}_nodeToJSON(t){const e=t.children.map(o=>o?this._nodeToJSON(o):null),r=t.residents?.map(o=>this.objectToBoundingSphere(o)),i=t.terminals?.map(o=>this.objectToBoundingSphere(o));return{children:e,residents:r,terminals:i}}static fromJSON(t){const e=new I(r=>r,{maximumDepth:t.maximumDepth,maximumObjectsPerNode:t.maximumObjectsPerNode});return e._objectCount=t.objectCount,e._root.initFrom(t.root.node,t.root.bounds,t.root.halfSize,t.root.depth),e}}class l{constructor(){this.bounds=z(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,r,i=this.depth){return this.node=t??l.createEmptyNode(),e&&V(e,this.bounds),this.halfSize=r,this.depth=i,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*Tt}advance(t){let e=this.node.children[t];e||(e=l.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const r=_t[t];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,e,r=!1){for(;;){if(this.isTerminalFor(t))return e&&e(this,-1),!0;if(this.isLeaf()){if(!r)return e&&e(this,-1),!1;this.node.residents=null}const i=this._childIndex(t);e&&e(this,i),this.advance(i)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new v({shrink:!0}),residents:new v({shrink:!0})}}static{this._pool=new Ot(l)}static acquire(){return l._pool.acquire()}static release(t){l._pool.release(t)}static clearPool(){l._pool.prune()}}function x(n,t){let e=l.acquire().init(n);const r=[e];for(;r.length!==0;){if(e=r.pop(),t(e)&&!e.isLeaf())for(let i=0;i<e.node.children.length;i++)e.node.children[i]&&r.push(l.acquire().init(e).advance(i));l.release(e)}}function st(n,t,e,r=I.DepthOrder.FRONT_TO_BACK){let i=l.acquire().init(n);const o=[i];for(Ct(e,r,ht);o.length!==0;){if(i=o.pop(),t(i)&&!i.isLeaf())for(let h=7;h>=0;--h){const c=ht[h];i.node.children[c]&&o.push(l.acquire().init(i).advance(c))}l.release(i)}}function It(n,t,e){j.clear();const r=e.advanceTo(t,(i,o)=>{j.push(i.node),j.push(o)})?e.node.terminals:e.node.residents;if(r.removeUnordered(n),r.length===0)for(let i=j.length-2;i>=0&&zt(j.data[i],j.data[i+1]);i-=2);}function zt(n,t){return t>=0&&(n.children[t]=null),!!dt(n)&&(n.residents===null&&(n.residents=new v({shrink:!0})),!0)}function Gt(n,t){return $(T(t.bounds),2*-t.halfSize,R),$(T(t.bounds),2*t.halfSize,p),lt(n.origin,n.direction,R,p)}function Ht(n,t,e){return $(T(t.bounds),2*-t.halfSize,R),$(T(t.bounds),2*t.halfSize,p),e.applyToMinMax(R,p),lt(n.origin,n.direction,R,p)}function dt(n){if(n.terminals.length!==0)return!1;if(n.residents!==null)return n.residents.length===0;for(let t=0;t<n.children.length;t++)if(n.children[t])return!1;return!0}function Dt(n,t){n[0]=Math.min(n[0],t[0]-t[3]),n[1]=Math.min(n[1],t[1]-t[3]),n[2]=Math.min(n[2],t[2]-t[3])}function vt(n,t){n[0]=Math.max(n[0],t[0]+t[3]),n[1]=Math.max(n[1],t[1]+t[3]),n[2]=Math.max(n[2],t[2]+t[3])}function $(n,t,e){e[0]=n[0]+t,e[1]=n[1]+t,e[2]=n[2]+t}function ot(n,t,e){R[0]=1/0,R[1]=1/0,R[2]=1/0,p[0]=-1/0,p[1]=-1/0,p[2]=-1/0;for(const r of n){const i=t(r);D(i[3])&&(Dt(R,i),vt(p,i))}Rt(T(e),R,p,.5),e[3]=Math.max(p[0]-R[0],p[1]-R[1],p[2]-R[2])/2}function Ct(n,t,e){if(!P.length)for(let r=0;r<8;++r)P.push({index:0,distance:0});for(let r=0;r<8;++r){const i=_t[r];P.data[r].index=r,P.data[r].distance=S(n,t,i)}P.sort((r,i)=>r.distance-i.distance);for(let r=0;r<8;++r)e[r]=P.data[r].index}function J(n,t){let e,r=1/0;for(let i=0;i<8;++i){const o=S(n,t,at[i]);o<r&&(r=o,e=at[i])}return e}function S(n,t,e){return t*(n[0]*e[0]+n[1]*e[1]+n[2]*e[2])}function D(n){return!isNaN(n)&&n!==-1/0&&n!==1/0&&n>0}(function(n){var t;(t=n.DepthOrder||(n.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"})(I||(I={}));const _t=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],at=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],Tt=Math.sqrt(3),W=[null];function wt(n){return W[0]=n,W}const K=z(),b=F(),R=F(),p=F(),j=new v,yt=z(),M=z(),U=z(),X=z(),w=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],P=new v,ht=[0,0,0,0,0,0,0,0];export{Qt as B,Q as C,re as G,I as H,ne as I,ee as L,B as N,te as P,Zt as j,Yt as x};
