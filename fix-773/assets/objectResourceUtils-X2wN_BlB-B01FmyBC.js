const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./loader-DSz2HLee-CtD160-f.js","./main-D8UjLOIQ.js","./main-D2F5QhFW.css","./mat4f64-xsZDPPj0-Dq35B4BL.js","./enums-wEDHPbCF-Cf76M5_x.js","./Version-CnwD6MZa-BSzQWZwL.js","./mat4-OOmHNWi7-Bnj6TIOE.js","./common-CYWrYyJl-E8-sukrT.js","./quat-DQgq9Ar5-BXKCqDvc.js","./mat3f64-BnNZDR5l-Bz3OL2oI.js","./quatf64-C16JxGFv-BKWK1F8U.js","./vec32-Cj8pVsU0-BmYyqgTW.js","./vec42-D8CJyqHG-DnfLTeQH.js","./BufferView-wDxx79o3-CaImLZVj.js","./vec2-BnynUbeJ-Bdx0nwES.js","./vec2f64-CkowXrDb-3zFQ3LNH.js","./vec4f64-DD-nkcCV-CSNWKRqG.js","./resourceUtils-Tz7BBTTs-CPb3IWQ1.js","./basicInterfaces-Dsf65ICa-DkQ9Rsnx.js"])))=>i.map(i=>d[i]);
import{_ as ye,k1 as K,dn as z,jh as se,lV as j,N as be,t as ne,a3 as we,j5 as ae,j4 as W,h as ve}from"./main-D8UjLOIQ.js";import{m as Me}from"./devEnvironmentUtils-CxrVv3RG-CX5aoxVE.js";import{E as Y,X as Re,P as Ae}from"./mat3-DOnW3DjW-C3hbW9XY.js";import{r as X,n as ie}from"./mat3f64-BnNZDR5l-Bz3OL2oI.js";import{z as Be}from"./mat4-OOmHNWi7-Bnj6TIOE.js";import{n as Oe}from"./mat4f64-xsZDPPj0-Dq35B4BL.js";import{_ as Se}from"./vec2f64-CkowXrDb-3zFQ3LNH.js";import{Y as Q,r as Pe,x as J,b as $e,l as Ie,X as Ee}from"./vec32-Cj8pVsU0-BmYyqgTW.js";import{a3 as le,M as ue,j as L}from"./OutputColorHighlightOID.glsl-BdXTjs7_-CKA6PhQ5.js";import{T as ce,L as me,U as ke,k as _e,S as Ue,_ as Ce}from"./BufferView-wDxx79o3-CaImLZVj.js";import{b as Fe,z as Le,T as Z,R as ee}from"./vec3-lTcIGC_C-DghACve9.js";import{P as Ne,R as te}from"./vec4-FWCYsiir-DaTfKTqq.js";import{T as je,N as qe,l as Ve}from"./indexUtils-l8XrgMvJ-CR6m_lbx.js";import{g as N}from"./resourceUtils-Tz7BBTTs-CPb3IWQ1.js";import{f as De,l as Ge}from"./vec2f32-hTAvipMV-C0AQcwEv.js";import{k as fe}from"./asyncUtils-BPUlNCrX-Cy1oR89x.js";import{i as ze}from"./memoryEstimations-DeWfxwaV-DpFMiS4z.js";import{u as Xe}from"./NestedMap-DL9KstBd-DcOmdaty.js";import{m as pe}from"./Version-CnwD6MZa-BSzQWZwL.js";import{w as He}from"./Indices-BuIC5D20-CLTzZiKe.js";import{r as Ke}from"./requestImageUtils-B2YN5Eb9-BsUXe8R6.js";import{M as k}from"./orientedBoundingBox-CSC169JG-sahCtZa2.js";import{e as H,N as R,s as We}from"./basicInterfaces-Dsf65ICa-DkQ9Rsnx.js";import{T as I}from"./VertexAttribute-hUz6pozM-Bx3V-z96.js";import{B as q,i as Ye,n as Qe,s as Je,v as Ze}from"./DefaultMaterial-7UvmJfZD-DJ0iH7DM.js";import{U as re}from"./enums-wEDHPbCF-Cf76M5_x.js";import{a as oe}from"./NormalAttribute.glsl-BnbqDItl-CYv195N3.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./videoUtils-Scb4DgCQ-CgkdeYXh.js";import"./TextureFormat-Cl0ugX3E-DD0Aw8RG.js";import"./Texture-D5XWO2GQ-DFkJKk2N.js";import"./getDataTypeBytes-DYbftOSj-BNZIboqJ.js";import"./triangle-BM89wdHY-DbHhF_Uh.js";import"./sphere-zPMQWhGG-C71NzDQ7.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./vectorStacks-5ZZtmT9E-D2GdqudT.js";import"./quatf64-C16JxGFv-BKWK1F8U.js";import"./lineSegment-BAWQVP9P-DeXzNZgW.js";import"./glsl-Z5uYj8ka-BRgh2Cgo.js";import"./BindType-CKbZk6AG-Bqvzo9NX.js";import"./ShaderOutput-CUn9tpiG-CW1Nc608.js";import"./renderState-BM-MCKUz-CZGNA7AS.js";import"./ViewingMode-CdRKcXnc-Dab70bGf.js";import"./lengthUtils-C61nRlXw-DQA1PQjj.js";import"./boundedPlane-QDtjx5eO-DTzPveh0.js";import"./plane-Cf3Koz3c-CFwUi6Ll.js";import"./projectionUtils-B-CplN3q-DU9g_puo.js";import"./vec2-BnynUbeJ-Bdx0nwES.js";import"./quat-DQgq9Ar5-BXKCqDvc.js";import"./spatialReferenceEllipsoidUtils-BK0OQJn2-BK41gVH6.js";import"./computeTranslationToOriginAndRotation-e-ft1lOz-f-oZR0ZL.js";import"./InterleavedLayout-C2YUDwKf-DGaiAF6f.js";import"./types-l27bT09Q-DE0QfIFp.js";import"./ShaderBuilder-CU5v4tk1-qD9qPa-X.js";function _(r){if(r==null)return null;const t=r.offset!=null?r.offset:De,s=r.rotation!=null?r.rotation:0,o=r.scale!=null?r.scale:Ge,u=X(1,0,0,0,1,0,t[0],t[1],1),i=X(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),n=X(o[0],0,0,0,o[1],0,0,0,1),a=ie();return Y(a,i,n),Y(a,u,a),a}class et{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class tt{constructor(t,s,o){this.name=t,this.lodThreshold=s,this.pivotOffset=o,this.stageResources=new et,this.numberOfVertices=0}}const B=()=>we.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class rt{constructor(t,s,o){this.resource=t,this.textures=s,this.cachedMemory=o}}async function ot(r,t){const s=await st(r,t),o=await ut(s.textureDefinitions??{},t);let u=0;for(const i in o)if(o.hasOwnProperty(i)){const n=o[i];u+=n?.image?n.image.width*n.image.height*4:0}return new rt(s,o,u+ze(s))}async function st(r,t){const s=t?.streamDataRequester;if(s)return nt(r,s,t);const o=await fe(be(r,t));if(o.ok===!0)return o.value.data;ne(o.error),de(o.error)}async function nt(r,t,s){const o=await fe(t.request(r,"json",s));if(o.ok===!0)return o.value;ne(o.error),de(o.error.details.url)}function de(r){throw new ve("",`Request for object resource failed: ${r}`)}function at(r){const t=r.params,s=t.topology;let o=!0;switch(t.vertexAttributes||(B().warn("Geometry must specify vertex attributes"),o=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=t.faces;if(i){if(t.vertexAttributes)for(const n in t.vertexAttributes){const a=i[n];a?.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(B().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),o=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(B().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),o=!1)):(B().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),o=!1)}}else B().warn("Indexed geometries must specify faces"),o=!1;break}default:B().warn(`Unsupported topology '${s}'`),o=!1}r.params.material||(B().warn("Geometry requires material"),o=!1);const u=r.params.vertexAttributes;for(const i in u)u[i].values||(B().warn("Geometries with externally defined attributes are not yet supported"),o=!1);return o}function it(r,t){const s=new Array,o=new Array,u=new Array,i=new Xe,n=r.resource,a=pe.parse(n.version||"1.0","wosr");mt.validate(a);const m=n.model.name,e=n.model.geometries,l=n.materialDefinitions??{},c=r.textures;let x=0;const h=new Map;for(let g=0;g<e.length;g++){const f=e[g];if(!at(f))continue;const b=ct(f),y=f.params.vertexAttributes,w=[],d=p=>{if(f.params.topology==="PerAttributeArray")return null;const M=f.params.faces;for(const T in M)if(T===p)return M[T].values;return null},v=y[I.POSITION],U=v.values.length/v.valuesPerElement;for(const p in y){const M=y[p],T=M.values,D=d(p)??He(U);w.push([p,new k(T,D,M.valuesPerElement,!0)])}const A=b.texture,P=c&&c[A];if(P&&!h.has(A)){const{image:p,parameters:M}=P,T=new le(p,M);o.push(T),h.set(A,T)}const C=h.get(A),V=C?C.id:void 0,O=b.material;let S=i.get(O,A);if(S==null){const p=l[O.slice(O.lastIndexOf("/")+1)].params;p.transparency===1&&(p.transparency=0);const M=P?he(P.alphaChannelUsage):void 0,T={ambient:K(p.diffuse),diffuse:K(p.diffuse),opacity:1-(p.transparency||0),textureAlphaMode:M,textureAlphaCutoff:.33,textureId:V,doubleSided:!0,cullFace:H.None,colorMixMode:p.externalColorMixMode||"tint",textureAlphaPremultiplied:P?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(T,t.materialParameters),S=new q(T,t),i.set(O,A,S)}u.push(S);const F=new ue(S,w);x+=w.find(p=>p[0]===I.POSITION)?.[1]?.indices.length??0,s.push(F)}return{engineResources:[{name:m,stageResources:{textures:o,materials:u,geometries:s},pivotOffset:n.model.pivotOffset,numberOfVertices:x,lodThreshold:null}],referenceBoundingBox:lt(s)}}function lt(r){const t=se();return r.forEach(s=>{const o=s.boundingInfo;o!=null&&(j(t,o.bbMin),j(t,o.bbMax))}),t}async function ut(r,t){const s=new Array;for(const i in r){const n=r[i],a=n.images[0].data;if(!a){B().warn("Externally referenced texture data is not yet supported");continue}const m=n.encoding+";base64,"+a,e="/textureDefinitions/"+i,l=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:re.REPEAT,t:re.REPEAT},preMultiplyAlpha:he(l)!==R.Opaque},x=t?.disableTextures?Promise.resolve(null):Ke(m,t);s.push(x.then(h=>({refId:e,image:h,parameters:c,alphaChannelUsage:l})))}const o=await Promise.all(s),u={};for(const i of o)u[i.refId]=i;return u}function he(r){switch(r){case"mask":return R.Mask;case"maskAndTransparency":return R.MaskBlend;case"none":return R.Opaque;default:return R.Blend}}function ct(r){const t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const mt=new pe(1,2,"wosr");async function ft(r,t){const s=xe(Me(r));if(s.fileType==="wosr"){const c=await(t.cache?t.cache.loadWOSR(s.url,t):ot(s.url,t)),{engineResources:x,referenceBoundingBox:h}=it(c,t);return{lods:x,referenceBoundingBox:h,isEsriSymbolResource:!1,isWosr:!0}}let o;if(t.cache)o=await t.cache.loadGLTF(s.url,t,!!t.usePBR);else{const{loadGLTF:c}=await ye(()=>import("./loader-DSz2HLee-CtD160-f.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]),import.meta.url);o=await c(new je(t.streamDataRequester),s.url,t,t.usePBR)}const u=o.model.meta?.ESRI_proxyEllipsoid,i=o.meta.isEsriSymbolResource&&u!=null&&o.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!o.customMeta.esriTreeRendering&&(o.customMeta.esriTreeRendering=!0,gt(o,u));const n=!!t.usePBR,a=o.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:Je}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:Ze},m={...t.materialParameters,treeRendering:i},{engineResources:e,referenceBoundingBox:l}=pt(o,a,m,t,s.specifiedLodIndex,i);return{lods:e,referenceBoundingBox:l,isEsriSymbolResource:o.meta.isEsriSymbolResource,isWosr:!1}}function xe(r){const t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function pt(r,t,s,o,u,i){const n=r.model,a=new Array,m=new Map,e=new Map,l=n.lods.length,c=se();return n.lods.forEach((x,h)=>{const g=o.skipHighLods===!0&&(l>1&&h===0||l>3&&h===1)||o.skipHighLods===!1&&u!=null&&h!==u;if(g&&h!==0)return;const f=new tt(x.name,x.lodThreshold,[0,0,0]);x.parts.forEach(b=>{const y=g?new q({},o):dt(n,b,f,t,s,m,e,o,i),{geometry:w,vertexCount:d}=ht(b,y??new q({},o)),v=w.boundingInfo;v!=null&&h===0&&(j(c,v.bbMin),j(c,v.bbMax)),y!=null&&(f.stageResources.geometries.push(w),f.numberOfVertices+=d)}),g||a.push(f)}),{engineResources:a,referenceBoundingBox:c}}function dt(r,t,s,o,u,i,n,a,m){const e=r.materials.get(t.material);if(e==null)return null;const{normal:l,color:c,texCoord0:x,tangent:h}=t.attributes,g=t.material+(l?"_normal":"")+(c?"_color":"")+(x?"_texCoord0":"")+(h?"_tangent":""),f=t.attributes.texCoord0!=null,b=t.attributes.normal!=null,y=xt(e.alphaMode);if(!i.has(g)){if(f){const p=(T,D=!1,ge=!1)=>{if(T!=null&&!n.has(T)){const G=r.textures.get(T);if(G){const $=G.data,Te=D&&!N($)?a.compressionOptions:void 0;n.set(T,new le(N($)?$.data:$,{...G.parameters,preMultiplyAlpha:!N($)&&ge,encoding:N($)?$.encoding:void 0,compressionOptions:Te}))}}},M=y!==R.Opaque&&!m;p(e.colorTexture,M,y!==R.Opaque),p(e.normalTexture),p(e.occlusionTexture,!0),p(e.emissiveTexture),p(e.metallicRoughnessTexture,!0)}const d=1/ae,v=e.color[0]**d,U=e.color[1]**d,A=e.color[2]**d,P=e.emissiveFactor[0]**d,C=e.emissiveFactor[1]**d,V=e.emissiveFactor[2]**d,O=e.colorTexture!=null&&f?n.get(e.colorTexture):null,S=Ye(e),F=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:Se;i.set(g,new q({...o,customDepthTest:We.Lequal,textureAlphaMode:y,textureAlphaCutoff:e.alphaCutoff,diffuse:[v,U,A],ambient:[v,U,A],opacity:e.alphaMode==="OPAQUE"?1:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?H.None:H.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:b?oe.Attribute:oe.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclusion,textureId:O?.id,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&f?n.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&f?n.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&f?n.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&f?n.get(e.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[P,C,V],mrrFactors:S?Qe:[e.metallicFactor,e.roughnessFactor,o.mrrFactors[2]],isSchematic:S,colorTextureTransformMatrix:_(e.colorTextureTransform),normalTextureTransformMatrix:_(e.normalTextureTransform),scale:[F[0],F[1]],occlusionTextureTransformMatrix:_(e.occlusionTextureTransform),emissiveTextureTransformMatrix:_(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:_(e.metallicRoughnessTextureTransform),...u},a))}const w=i.get(g);if(s.stageResources.materials.push(w),f){const d=v=>{v!=null&&s.stageResources.textures.push(n.get(v))};d(e.colorTexture),d(e.normalTexture),d(e.occlusionTexture),d(e.emissiveTexture),d(e.metallicRoughnessTexture)}return w}function ht(r,t){const s=r.attributes.position.count,o=qe(r.indices||s,r.primitiveType),u=L(3*s),{typedBuffer:i,typedBufferStride:n}=r.attributes.position;Fe(u,i,r.transform,3,n);const a=[[I.POSITION,new k(u,o,3,!0)]];if(r.attributes.normal!=null){const e=L(3*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.normal;Re(E,r.transform),Le(e,l,E,3,c),W(E)&&Z(e,e),a.push([I.NORMAL,new k(e,o,3,!0)])}if(r.attributes.tangent!=null){const e=L(4*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.tangent;Ae(E,r.transform),Ne(e,l,E,4,c),W(E)&&Z(e,e,4),a.push([I.TANGENT,new k(e,o,4,!0)])}if(r.attributes.texCoord0!=null){const e=L(2*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.texCoord0;Ve(e,l,2,c),a.push([I.UV0,new k(e,o,2,!0)])}const m=r.attributes.color;if(m!=null){const e=new Uint8Array(4*s);m.elementCount===4?m instanceof me?te(e,m,1,255):(m instanceof ke||m instanceof _e)&&te(e,m,1/255,255):(e.fill(255),m instanceof ce?ee(e,m.typedBuffer,1,255,4,m.typedBufferStride):(r.attributes.color instanceof Ue||r.attributes.color instanceof Ce)&&ee(e,m.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push([I.COLOR,new k(e,o,4,!0)])}return{geometry:new ue(t,a),vertexCount:s}}const E=ie();function xt(r){switch(r){case"BLEND":return R.Blend;case"MASK":return R.Mask;case"OPAQUE":case null:case void 0:return R.Opaque}}function gt(r,t){for(let s=0;s<r.model.lods.length;++s){const o=r.model.lods[s];for(const u of o.parts){const i=u.attributes.normal;if(i==null)return;const n=u.attributes.position,a=n.count,m=z(),e=z(),l=z(),c=new Float32Array(4*a),x=new Float32Array(3*a),h=Be(Oe(),u.transform);let g=0,f=0;for(let b=0;b<a;b++){n.getVec(b,e),i.getVec(b,m),Q(e,e,u.transform),Pe(l,e,t.center),J(l,l,t.radius);const y=l[2],w=$e(l),d=Math.min(.45+.55*w*w,1)**ae;J(l,l,t.radius),h!==null&&Q(l,l,h),Ie(l,l),s+1!==r.model.lods.length&&r.model.lods.length>1&&Ee(l,l,m,y>-1?.2:Math.min(-4*y-3.8,1)),x[g]=l[0],x[g+1]=l[1],x[g+2]=l[2],g+=3,c[f]=d,c[f+1]=d,c[f+2]=d,c[f+3]=1,f+=4}u.attributes.normal=new ce(x),u.attributes.color=new me(c)}}}const yr=Object.freeze(Object.defineProperty({__proto__:null,fetch:ft,parseUrl:xe},Symbol.toStringTag,{value:"Module"}));export{ft as Y,yr as o,_ as s};
