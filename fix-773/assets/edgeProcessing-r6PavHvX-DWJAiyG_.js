import{v as pt}from"./deduplicate-DRKoZSEv-CDSyrVcJ.js";import{e as _}from"./InterleavedLayout-C2YUDwKf-DGaiAF6f.js";import{T as a}from"./VertexAttribute-hUz6pozM-Bx3V-z96.js";import{m as Q}from"./glUtil-0ZzWJjlL-BE-sKb_G.js";import{d7 as Y,dn as w,gV as Nt,fg as mt,aq as lt}from"./main-D8UjLOIQ.js";import{g as It,A as K,_ as nt,y as j,P as Ot,l as ut,r as ot,S as ft,W as St}from"./vec32-Cj8pVsU0-BmYyqgTW.js";import{b as J}from"./Normals-BNEsVQbp-CD6rilyo.js";const At=_().vec3f(a.POSITION).u16(a.COMPONENTINDEX).freeze(),Et=_().vec2u8(a.SIDENESS).freeze();Q(Et);const k=_().vec3f(a.POSITION0).vec3f(a.POSITION1).vec2i16(a.NORMALCOMPRESSED).u16(a.COMPONENTINDEX).u8(a.VARIANTOFFSET,{glNormalized:!0}).u8(a.VARIANTSTROKE).u8(a.VARIANTEXTENSION,{glNormalized:!0}).freeze(),q=_().vec3f(a.POSITION0).vec3f(a.POSITION1).vec2i16(a.NORMALCOMPRESSED).vec2i16(a.NORMAL2COMPRESSED).u16(a.COMPONENTINDEX).u8(a.VARIANTOFFSET,{glNormalized:!0}).u8(a.VARIANTSTROKE).u8(a.VARIANTEXTENSION,{glNormalized:!0}).freeze();a.POSITION0,a.POSITION1,a.COMPONENTINDEX,a.VARIANTOFFSET,a.VARIANTSTROKE,a.VARIANTEXTENSION,a.NORMALCOMPRESSED,a.NORMAL2COMPRESSED,a.SIDENESS;class wt{constructor(){this.position0=w(),this.position1=w(),this.faceNormal0=w(),this.faceNormal1=w(),this.componentIndex=0,this.cosAngle=0}}const U=-1;function Tt(t,n,s){const r=t.vertices.position,c=t.vertices.componentIndex,u=N.position0,h=N.position1,I=N.faceNormal0,S=N.faceNormal1,{edges:i,normals:g}=Mt(t),m=i.length/4,A=n.allocate(m);let V=0;const b=m,T=s?.allocate(b);let X=0,e=0,o=0;z.length=0;for(let d=0;d<m;++d){const y=4*d;r.getVec(i.data[y],u),r.getVec(i.data[y+1],h);const C=z.pushNew();C.index=4*d,C.length=It(u,h)}z.sort((d,y)=>y.length-d.length);const f=new Array,l=new Array;z.forAll(({length:d,index:y})=>{const C=i.data[y],ht=i.data[y+1],Z=i.data[y+2],tt=i.data[y+3],et=tt===U;if(r.getVec(C,u),r.getVec(ht,h),et){const E=3*Z;K(I,g.data[E],g.data[E+1],g.data[E+2]),nt(S,I),N.componentIndex=c.get(C),N.cosAngle=j(I,S)}else{let E=3*Z;if(K(I,g.data[E],g.data[E+1],g.data[E+2]),E=3*tt,K(S,g.data[E],g.data[E+1],g.data[E+2]),N.componentIndex=c.get(C),N.cosAngle=j(I,S),yt(N,Dt))return;N.cosAngle<-.9999&&nt(S,I)}e+=d,o++,et||vt(N,Lt)?(n.write(A,V++,N),f.push(d)):Pt(N,gt)&&(T&&s&&s.write(T,X++,N),l.push(d))});const O=new Float32Array(f.reverse()),v=new Float32Array(l.reverse()),P=T&&s?{instancesData:T.slice(0,X),lodInfo:{lengths:v}}:void 0;return{regular:{instancesData:A.slice(0,V),lodInfo:{lengths:O}},silhouette:P,averageEdgeLength:e/o}}function vt(t,n){return t.cosAngle<n}function yt(t,n){return t.cosAngle>n}function Pt(t,n){const s=Nt(t.cosAngle);return St(st,t.position1,t.position0),s*(j(ft(Vt,t.faceNormal0,t.faceNormal1),st)>0?-1:1)>n}function Mt(t){const n=t.faces.length/3,s=t.faces,r=t.neighbors,c=t.vertices.position;p.length=G.length=0;for(let u=0;u<n;u++){const h=3*u,I=r[h],S=r[h+1],i=r[h+2],g=s[h],m=s[h+1],A=s[h+2];c.getVec(g,D),c.getVec(m,B),c.getVec(A,W),ot(B,B,D),ot(W,W,D),ft(D,B,W),ut(D,D),G.pushArray(D),(I===U||g<m)&&(p.push(g),p.push(m),p.push(u),p.push(I)),(S===U||m<A)&&(p.push(m),p.push(A),p.push(u),p.push(S)),(i===U||A<g)&&(p.push(A),p.push(g),p.push(u),p.push(i))}return{edges:p,normals:G}}class Rt{constructor(){this.index=0,this.length=0}}const z=new Y({allocator:t=>t||new Rt,deallocator:null}),p=new Y({deallocator:null}),G=new Y({deallocator:null}),N=new wt,Vt=w(),st=w(),D=w(),B=w(),W=w(),gt=lt(4),Dt=Math.cos(gt),Ct=lt(35),Lt=Math.cos(Ct);function rt(t,n,s){const r=n/3,c=new Uint32Array(s+1),u=new Uint32Array(s+1),h=(e,o)=>{e<o?c[e+1]++:u[o+1]++};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],l=t[3*e+2];h(o,f),h(f,l),h(l,o)}let I=0,S=0;for(let e=0;e<s;e++){const o=c[e+1],f=u[e+1];c[e+1]=I,u[e+1]=S,I+=o,S+=f}const i=new Uint32Array(6*r),g=c[s],m=(e,o,f)=>{if(e<o){const l=c[e+1]++;i[2*l]=o,i[2*l+1]=f}else{const l=u[o+1]++;i[2*g+2*l]=e,i[2*g+2*l+1]=f}};for(let e=0;e<r;e++){const o=t[3*e],f=t[3*e+1],l=t[3*e+2];m(o,f,e),m(f,l,e),m(l,o,e)}const A=(e,o)=>{const f=2*e,l=o-e;for(let O=1;O<l;O++){const v=i[f+2*O],P=i[f+2*O+1];let d=O-1;for(;d>=0&&i[f+2*d]>v;d--)i[f+2*d+2]=i[f+2*d],i[f+2*d+3]=i[f+2*d+1];i[f+2*d+2]=v,i[f+2*d+3]=P}};for(let e=0;e<s;e++)A(c[e],c[e+1]),A(g+u[e],g+u[e+1]);const V=new Int32Array(3*r),b=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,T=(e,o)=>{const f=b(e,o);V[3*o+f]=-1},X=(e,o,f,l)=>{const O=b(e,o);V[3*o+O]=l;const v=b(f,l);V[3*l+v]=o};for(let e=0;e<s;e++){let o=c[e];const f=c[e+1];let l=u[e];const O=u[e+1];for(;o<f&&l<O;){const v=i[2*o],P=i[2*g+2*l];v===P?(X(e,i[2*o+1],P,i[2*g+2*l+1]),o++,l++):v<P?(T(e,i[2*o+1]),o++):(T(P,i[2*g+2*l+1]),l++)}for(;o<f;)T(e,i[2*o+1]),o++;for(;l<O;)T(i[2*g+2*l],i[2*g+2*l+1]),l++}return V}const H=.7;let dt=class{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?xt:Ft}write(t,n,s){$.seed=this._edgeHashFunction(s);const r=$.getIntRange(0,255),c=$.getIntRange(0,this.settings.variants-1),u=$.getFloat(),h=255*(.5*_t(-(1-Math.min(u/H,1))+Math.max(0,u-H)/(1-H),1.2)+.5);t.position0.setVec(n,s.position0),t.position1.setVec(n,s.position1),t.componentIndex.set(n,s.componentIndex),t.variantOffset.set(n,r),t.variantStroke.set(n,c),t.variantExtension.set(n,h)}};const M=new Float32Array(6),R=new Uint32Array(M.buffer),x=new Uint32Array(1);function Ft(t){return M[0]=t.position0[0],M[1]=t.position0[1],M[2]=t.position0[2],M[3]=t.position1[0],M[4]=t.position1[1],M[5]=t.position1[2],x[0]=31*(31*(31*(31*(31*(166811+R[0])+R[1])+R[2])+R[3])+R[4])+R[5],x[0]}function xt(t){const n=M;n[0]=L(t.position0[0]),n[1]=L(t.position0[1]),n[2]=L(t.position0[2]),n[3]=L(t.position1[0]),n[4]=L(t.position1[1]),n[5]=L(t.position1[2]),x[0]=5381;for(let s=0;s<R.length;s++)x[0]=31*x[0]+R[s];return x[0]}const it=1e4;function L(t){return Math.round(t*it)/it}function _t(t,n){return Math.abs(t)**n*Math.sign(t)}class bt{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return k.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r),Ot(F,r.faceNormal0,r.faceNormal1),ut(F,F);const{typedBuffer:c,typedBufferStride:u}=n.normalCompressed;J(c,s,F[0],F[1],F[2],u)}static{this.Layout=k}static{this.glLayout=Q(k,1)}}class Xt{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return q.createBuffer(n)}write(n,s,r){this._commonWriter.write(n,s,r);{const{typedBuffer:c,typedBufferStride:u}=n.normalCompressed;J(c,s,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],u)}{const{typedBuffer:c,typedBufferStride:u}=n.normal2Compressed;J(c,s,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],u)}}static{this.Layout=q}static{this.glLayout=Q(q,1)}}const F=w(),$=new mt;function Ht(t){const n=zt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return ct.updateSettings(t.writerSettings),at.updateSettings(t.writerSettings),Tt(n,ct,at)}function zt(t,n,s,r){if(n){const h=rt(s,r,t.count);return new Bt(s,r,h,t)}const c=pt(t.buffer,t.stride/4,{originalIndices:s}),u=rt(c.indices,r,c.uniqueCount);return{faces:c.indices,facesLength:c.indices.length,neighbors:u,vertices:At.createView(c.buffer)}}class Bt{constructor(n,s,r,c){this.faces=n,this.facesLength=s,this.neighbors=r,this.vertices=c}}const ct=new bt,at=new Xt,jt=_().vec3f(a.POSITION0).vec3f(a.POSITION1),Jt=_().vec3f(a.POSITION0).vec3f(a.POSITION1).u16(a.COMPONENTINDEX);export{Jt as K,jt as U,Ht as X,Tt as c,zt as g,At as r};
