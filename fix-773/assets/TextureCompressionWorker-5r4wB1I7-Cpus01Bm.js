import{_ as D,bq as S}from"./main-D8UjLOIQ.js";import{B as A}from"./TextureFormat-Cl0ugX3E-DD0Aw8RG.js";import{u as w}from"./enums-wEDHPbCF-Cf76M5_x.js";function R(){return C??=(async()=>{const t=await D(()=>import("./basis_encoder-DZxp6hVo-Cdns4fBz.js"),[],import.meta.url),e=await t.default({locateFile:r=>S(`esri/libs/basisu/${r}`)});return e.initializeBasis(),e})(),C}let C;function b(){return E??=(async()=>await(await D(async()=>{const{default:t}=await import("./dxt_encoder-P9_YitA5-7jID2QdP.js");return{default:t}},[],import.meta.url)).default({locateFile:t=>S(`esri/libs/dxtEncoder/${t}`)}))(),E}let E,B,X,u=null,h=null;class m{constructor(e,r){this.internalFormat=e,this.compressedTexture=r}}async function j(t){let e;if(e=t.data instanceof ImageBitmap?U(t.data):v(t.data,t.width,t.height,t.components,t.needsFlip),t.hasS3TC){h||await g();const r=new Uint8Array(e.length);if(h?.encode(e,t.width,t.height,t.preMultiplyAlpha,r)){const n=H(r,!0),o=[r.buffer];return{result:new m(n?.internalFormat??null,n?.textureData??null),transferList:o}}return{result:new m(null,null)}}if(t.hasETC){if(u||await x(),t.preMultiplyAlpha&&!h&&await g(),t.preMultiplyAlpha){const i=new Uint8ClampedArray(e.length);h?.premultiply(new Uint8Array(e),t.width,t.height,i),e=i}const r=await F(e,t.width,t.height,t.hasMipmap),n=r?await M(r):null,o=n?.compressedTexture?.levels.map(i=>i.buffer)||[];return{result:new m(n?.internalFormat??null,n?.compressedTexture??null),transferList:o}}return{result:new m(null,null)}}async function x(){u||(u=await(B??=R()))}async function g(){h||(h=await(X??=b()))}async function F(t,e,r,n,o=255,i=0,s=!1,l=!1){if(!u)return null;const a=new u.BasisEncoder;a.setPerceptual(!l),a.setCheckForAlpha(!0),a.setForceAlpha(!1),a.setRenormalize(l),a.setMipGen(n),a.setMipSRGB(!l),a.setCreateKTX2File(!0),a.setKTX2SRGBTransferFunc(!l),a.setQualityLevel(o),a.setCompressionLevel(i);const c=new Uint8Array(t.byteLength);a.setSliceSourceImage(0,new Uint8Array(t),e,r,s);const f=a.encode(c),d=new Uint8Array(c.buffer,0,f),p=new u.KTX2File(new Uint8Array(d));return p.isValid()?(a.delete(),d):(p.close(),p.delete(),a.delete(),null)}async function M(t){if(!u)return new m(null,null);const e=new u.KTX2File(new Uint8Array(t));e.startTranscoding();const[r,n]=e.getHasAlpha()?[A.ETC2_RGBA,w.COMPRESSED_RGBA8_ETC2_EAC]:[A.ETC1_RGB,w.COMPRESSED_RGB8_ETC2],o=e.getLevels(),i=[];for(let s=0;s<o;s++)i.push(new Uint8Array(e.getImageTranscodedSizeInBytes(s,0,0,r))),e.transcodeImage(i[s],s,0,0,r,0,-1,-1);return e.close(),e.delete(),{internalFormat:n,compressedTexture:{type:"compressed",levels:i}}}function U(t){const e=new OffscreenCanvas(t.width,t.height),r=e.getContext("2d");return r.drawImage(t,0,0),r.getImageData(0,0,e.width,e.height).data}function v(t,e,r,n,o){const i=new Uint8ClampedArray(t).subarray(0,e*r*n);if(!o)return i;const s=new Uint8ClampedArray(i.length),l=e*n;for(let a=0;a<r;a++){const c=a*l,f=(r-a-1)*l;s.set(i.subarray(c,c+l),f)}return s}const G=31,O=1,I=2,P=3,L=4,K=7,k=21,z=131072;function T(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}const $=T("DXT1"),V=T("DXT3"),q=T("DXT5");function H(t,e){const r=new Int32Array(t.buffer,t.byteOffset,G);let n,o;switch(r[k]){case $:n=8,o=w.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case V:n=16,o=w.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case q:n=16,o=w.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}let i=1,s=r[L],l=r[P];(3&s||3&l)&&(s=s+3&-4,l=l+3&-4);const a=s,c=l;let f,d;r[I]&z&&e!==!1&&(i=Math.max(1,r[K]));let p=t.byteOffset+r[O]+4;const _=[];for(let y=0;y<i;++y)d=(s+3>>2)*(l+3>>2)*n,f=new Uint8Array(t.buffer,p,d),_.push(f),p+=d,s=Math.max(1,s>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:_},internalFormat:o,width:a,height:c}}export{m as TextureCompressionWorkerOutput,j as compress,F as compressRGBADataToKTX2,M as createTextureDataKTX2,x as initializeBasisEncoder,g as initializeDXTEncoder};
