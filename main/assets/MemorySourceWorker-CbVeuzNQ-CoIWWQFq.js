import{c as b,iu as M,bs as A,bt as S,dG as I,ff as Q,bh as $}from"./main-DK5A1thH.js";import{B as O,E as Z,z as C}from"./featureConversionUtils-DRaHTjrY-FINpcsWc.js";import{K as B,W as P}from"./executeQueryForSnapping-BaQkcS1W-B9RZj7By.js";import{p as _,h as E}from"./queryUtils-OXllLZed-D4rO0__t.js";import{Y as k}from"./QueryEngine-DEm6IK5j-Cnxsa_2R.js";import{A as z,d as G,f as W}from"./clientSideDefaults-B-KLKMEC-BxU8bzJb.js";import{b as K,a as g,A as T,w as x,C as w,q as L}from"./sourceUtils-4Pkpu1X1-u6dKsCds.js";import{o as D}from"./FieldsIndex-Y7EBAYp0-CS8vHjAS.js";import{i as Y}from"./fieldType-VTpxE-EM-CxCafxk5.js";import"./OptimizedFeatureSet-D6mgsKNr-D8fSqNQJ.js";import"./memoryEstimations-iHVpvWPf-CMfAjuGi.js";import"./OptimizedGeometry-1qDYm3YK-Cg6l96SZ.js";import"./PooledRBush-J5-OtqBl-CmtgNGYZ.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./timeSupport-_0FhDj9z-DtiFHNAM.js";import"./optimizedFeatureQueryEngineAdapter-Bx4OOJmK-DCZa1S4t.js";import"./normalizeUtils-b-vZURob-A8spekoP.js";import"./utils-DuaeuwP5-IrMotWQ7.js";import"./utils-Jw-4AGsF-CezsCFGF.js";import"./projection-m8vi7Cxv-ByA_2Rez.js";import"./json-BI97KiBB-Ce5cWfI2.js";import"./WhereClauseCache-CAR59H4Y-Cc6o3b54.js";import"./LRUCache-BLmkvs7b-C8UYsL5g.js";import"./MemCache-BCippCv6-1uKfr3Ab.js";import"./WhereClause-nZnXFKnG-0kg1cLKe.js";import"./TimeOnly-C3SOkmg2-DQWQOy69.js";import"./QueryEngineCapabilities-C8pazosU-DZTubngj.js";import"./TimeExtent-gZaEUVeW-DaDBMnur.js";import"./quantizationUtils-Cndke4AR-C-yFTim2.js";import"./utils-BrRx2KpZ-aOPGQzLr.js";import"./heatmapUtils--OU2Fakh-CU7rUz5B.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./vec4f64-CjUMzAyX-DPYbdAom.js";import"./utils-BG7WTOnW-0dD0ASRJ.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-BFStKTjU-BMLpTkEG.js";import"./intl-DLmy-Li5-BP8VBpPh.js";import"./timeZoneUtils-z3WjfjXQ-CBz80Iqi.js";import"./ClassBreaksDefinition-B_vYk3bu-BFm4eQQf.js";import"./SnappingCandidate-DJDyIbpo-CuetCfU1.js";import"./FixedIntervalBinParameters-aoOPIkh7-Cfdo5iJN.js";import"./NormalizationBinParametersMixin-ZkplD1Sk-BF47-tnr.js";import"./Scheduler-Br-2v2ys-DaLUn3wq.js";import"./signal-DxzURL18-BUWbVrim.js";import"./date-Cqvy-TgA-DIf-QFLz.js";const N=1;function H(y,e){let t=0;for(const a of e){const s=a.attributes?.[y];typeof s=="number"&&isFinite(s)&&(t=Math.max(t,s))}return t}const U=Q,V={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:Q},J={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryBins:!0,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0,supportsQueryWithCacheHint:!0},queryBinsCapabilities:L};function X(y){return $(y)?y.z!=null:!!y.hasZ}function ee(y){return $(y)?y.m!=null:!!y.hasM}class te{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(e){const t=[],{features:a}=e,s=this._inferLayerProperties(a,e.fields),l=e.fields||[],d=e.hasM!=null?e.hasM:!!s.hasM,c=e.hasZ!=null?e.hasZ:!!s.hasZ,p=!e.spatialReference&&!s.spatialReference,u=p?U:e.spatialReference||s.spatialReference,h=p?V:null,f=e.geometryType||s.geometryType,o=!f;let i=e.objectIdField||s.objectIdField,n=e.timeInfo;const m=new D(l);if(!o&&(p&&t.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!f))throw new b("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!i)throw new b("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");if(s.objectIdField&&i!==s.objectIdField&&(t.push({name:"feature-layer:duplicated-oid-field",message:`Provided objectIdField "${i}" doesn't match the field name "${s.objectIdField}", found in the provided fields`}),i=s.objectIdField),i&&!s.objectIdField){const r=m.get(i);r?(i=r.name,r.type="esriFieldTypeOID",r.editable=!1,r.nullable=!1):l.unshift({alias:i,name:i,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(const r of l){if(r.name==null&&(r.name=r.alias),r.alias==null&&(r.alias=r.name),!r.name)throw new b("feature-layer:invalid-field-name","field name is missing",{field:r});if(r.name===i&&(r.type="esriFieldTypeOID"),!Y.jsonValues.includes(r.type))throw new b("feature-layer:invalid-field-type",`invalid type for field "${r.name}"`,{field:r});r.length==null&&(r.length=M(r))}const F={};for(const r of l)if(r.type!=="esriFieldTypeOID"&&r.type!=="esriFieldTypeGlobalID"){const q=A(r);q!==void 0&&(F[r.name]=q)}if(n){if(n.startTimeField){const r=m.get(n.startTimeField);r?(n.startTimeField=r.name,r.type="esriFieldTypeDate"):n.startTimeField=null}if(n.endTimeField){const r=m.get(n.endTimeField);r?(n.endTimeField=r.name,r.type="esriFieldTypeDate"):n.endTimeField=null}if(n.trackIdField){const r=m.get(n.trackIdField);r?n.trackIdField=r.name:(n.trackIdField=null,t.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:n}}))}n.startTimeField||n.endTimeField||(t.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:n}}),n=null)}const j=m.dateFields.length?{timeZoneIANA:e.dateFieldsTimeZone??S}:null;this._createDefaultAttributes=z(F,i);const R={warnings:t,featureErrors:[],layerDefinition:{...J,drawingInfo:G(f),templates:W(F),extent:h,geometryType:f,objectIdField:i,fields:l,hasZ:c,hasM:d,timeInfo:n,dateFieldsTimeReference:j},assignedObjectIds:{}};if(this._queryEngine=new k({fieldsIndex:D.fromLayerJSON({fields:l,timeInfo:n,dateFieldsTimeReference:j}),geometryType:f,hasM:d,hasZ:c,objectIdField:i,spatialReference:u,featureStore:new B({geometryType:f,hasM:d,hasZ:c}),timeInfo:n}),!a?.length)return this._nextObjectId=N,R;const v=H(i,a);return this._nextObjectId=v+1,await _(a,u),this._loadInitialFeatures(R,a)}async applyEdits(e){const{spatialReference:t,geometryType:a}=this._queryEngine;return await Promise.all([K(t,a),_(e.adds,t),_(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return P(this._queryEngine,e,t.signal)}queryAttributeBins(e,t={}){return this._queryEngine.executeAttributeBinsQuery(e,t.signal)}_inferLayerProperties(e,t){let a,s,l=null,d=null,c=null;for(const p of e){const u=p.geometry;if(u!=null&&(l||(l=I(u)),d||(d=u.spatialReference),a==null&&(a=X(u)),s==null&&(s=ee(u)),l&&d&&a!=null&&s!=null))break}if(t&&t.length){let p=null;t.some(u=>{const h=u.type==="esriFieldTypeOID",f=!u.type&&u.name&&u.name.toLowerCase()==="objectid";return p=u,h||f})&&(c=p.name)}return{geometryType:l,spatialReference:d,objectIdField:c,hasM:s,hasZ:a}}async _loadInitialFeatures(e,t){const{geometryType:a,hasM:s,hasZ:l,objectIdField:d,spatialReference:c,featureStore:p,fieldsIndex:u}=this._queryEngine,h=[];for(const i of t){if(i.uid!=null&&(e.assignedObjectIds[i.uid]=-1),i.geometry&&a!==I(i.geometry)){e.featureErrors.push(g("Incorrect geometry type."));continue}const n=this._createDefaultAttributes(),m=T(u,n,i.attributes,!0);m?e.featureErrors.push(m):(this._assignObjectId(n,i.attributes,!0),i.attributes=n,i.uid!=null&&(e.assignedObjectIds[i.uid]=i.attributes[d]),i.geometry!=null&&(i.geometry=E(i.geometry,i.geometry.spatialReference,c)),h.push(i))}p.addMany(O([],h,a,l,s,d));const{fullExtent:f,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();if(e.layerDefinition.extent=f,o){const{start:i,end:n}=o;e.layerDefinition.timeInfo.timeExtent=[i,n]}return e}async _applyEdits(e){const{adds:t,updates:a,deletes:s}=e,l={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(l,t),a?.length&&this._applyUpdateEdits(l,a),s?.length){for(const p of s)l.deleteResults.push(x(p));this._queryEngine.featureStore.removeManyById(s)}const{fullExtent:d,timeExtent:c}=await this._queryEngine.fetchRecomputedExtents();return{extent:d,timeExtent:c,featureEditResults:l}}_applyAddEdits(e,t){const{addResults:a}=e,{geometryType:s,hasM:l,hasZ:d,objectIdField:c,spatialReference:p,featureStore:u,fieldsIndex:h}=this._queryEngine,f=[];for(const o of t){if(o.geometry&&s!==I(o.geometry)){a.push(g("Incorrect geometry type."));continue}const i=this._createDefaultAttributes(),n=T(h,i,o.attributes);if(n)a.push(n);else{if(this._assignObjectId(i,o.attributes),o.attributes=i,o.uid!=null){const m=o.attributes[c];e.uidToObjectId[o.uid]=m}if(o.geometry!=null){const m=o.geometry.spatialReference??p;o.geometry=E(w(o.geometry,m),m,p)}f.push(o),a.push(x(o.attributes[c]))}}u.addMany(O([],f,s,d,l,c))}_applyUpdateEdits({updateResults:e},t){const{geometryType:a,hasM:s,hasZ:l,objectIdField:d,spatialReference:c,featureStore:p,fieldsIndex:u}=this._queryEngine;for(const h of t){const{attributes:f,geometry:o}=h,i=f?.[d];if(i==null){e.push(g(`Identifier field ${d} missing`));continue}if(!p.has(i)){e.push(g(`Feature with object id ${i} missing`));continue}const n=Z(p.getFeature(i),a,l,s);if(o!=null){if(a!==I(o)){e.push(g("Incorrect geometry type."));continue}const m=o.spatialReference??c;n.geometry=E(w(o,m),m,c)}if(f){const m=T(u,n.attributes,f);if(m){e.push(m);continue}}p.add(C(n,a,l,s,d)),e.push(x(i))}}_assignObjectId(e,t,a=!1){const s=this._queryEngine.objectIdField;a&&t&&isFinite(t[s])?e[s]=t[s]:e[s]=this._nextObjectId++}}const Ne=Object.freeze(Object.defineProperty({__proto__:null,default:te},Symbol.toStringTag,{value:"Module"}));export{Ne as M,H as n};
