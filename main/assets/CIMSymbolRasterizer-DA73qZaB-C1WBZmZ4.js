import{n as K}from"./CIMResourceManager-CQYnPdeC-kA8FZ2Ou.js";import{b as G,h as A,E as F}from"./CIMSymbolHelper-Bcp4nGf3-tVo9HCSr.js";import{OverrideHelper as H}from"./OverrideHelper-GkMo7t6B-CX42k4kO.js";import{J as S,K as D}from"./rasterizingUtils-B8CPqgVl-BT6pSCt7.js";import{I as z}from"./utils-BYqzY6_X-C0l8qNfz.js";import"./fontUtils-Ce-zEYaT-cCtJax0R.js";import"./main-DK5A1thH.js";import"./imageUtils-DEFspgr5-2i-CEKzB.js";import"./BidiEngine-Bdqv5H5j-Dyqh9XG-.js";import"./OptimizedGeometry-1qDYm3YK-Cg6l96SZ.js";import"./memoryEstimations-iHVpvWPf-CMfAjuGi.js";import"./Rect-KI3be8Nv-DWpEYHLJ.js";import"./enums-f9UUstHQ-hLTu4V1l.js";import"./defaultCIMValues-gWpu7WSC-cjxb95kj.js";import"./definitions-CBIQmVpq-o3EUznKY.js";import"./mat2d-BQA-1WB--Pnyy0dhf.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./mat2df32-BCnkwMW8-BLRY8i4P.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./vec2f32-CVhmN3Me-DxoqVD7C.js";import"./BoundingBox-D9JxeQeA-SaxmeIkg.js";import"./colorUtils-DxUhbS7D-CbcIfQgk.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./vec4f64-CjUMzAyX-DPYbdAom.js";import"./callExpressionWithFeature-uWLbeAgq-Brz58BQV.js";import"./quantizationUtils-Cndke4AR-C-yFTim2.js";import"./floatRGBA-YJlz5IlR-B5_mu0Vq.js";const O=96/72;class yt{constructor(m){this._spatialReference=m,this._imageDataCanvas=null,this._cimResourceManager=new K}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(m,n,o,v,l,a,c,g,x,I){if(!m)return null;const{data:d}=m;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:M}=d;a||(a=z(M));const s=await H.resolveSymbolOverrides(d,n,this._spatialReference,l,a,c,g),p=this._cimResourceManager,f=[];G.fetchResources(s,p,f),G.fetchFonts(s,p,f),f.length>0&&await Promise.all(f);const{width:e,height:h}=o;let b=E(a,e,h,v,I);const t=G.getEnvelope(s,b,p);if(!t)return null;t.x===1/0&&(t.x=e+2),t.y===1/0&&(t.y=-h/2),t.width===-1/0&&(t.width=e),t.height===-1/0&&(t.height=h);let y=1,R=0,_=0;switch(M.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;t.width>e&&(i=e/t.width);let r=1;t.height>h&&(r=h/t.height),v==="preview"&&(t.width<e&&(i=e/t.width),t.height<h&&(r=h/t.height)),y=Math.min(i,r),R=t.x+t.width/2,_=t.y+t.height/2}break;case"CIMLineSymbol":if(I){_=t.y+t.height/2,R=t.x+t.width/2;const i=t.width-e,r=t.height-h;b={paths:S(b.paths,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+r,ymax:t.height/2-r,width:t.width-2*i,height:t.height-2*r})}}else{(x||t.height>h)&&(y=h/t.height),_=t.y+t.height/2;const i=t.x*y+e/2,r=(t.x+t.width)*y+e/2,{paths:C}=b;C[0][0][0]-=i/y,C[0][2][0]-=(r-e)/y}break;case"CIMPolygonSymbol":if(I){_=t.y+t.height/2,R=t.x+t.width/2;const i=t.width-e,r=t.height-h;b={paths:S(b.rings,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+r,ymax:t.height/2-r,width:t.width-2*i,height:t.height-2*r})}}else{R=t.x+t.width/2,_=t.y+t.height/2;const i=t.x*y+e/2,r=(t.x+t.width)*y+e/2,C=t.y*y+h/2,P=(t.y+t.height)*y+h/2,{rings:w}=b;i<0&&(w[0][0][0]-=i,w[0][3][0]-=i,w[0][4][0]-=i),C<0&&(w[0][0][1]+=C,w[0][1][1]+=C,w[0][4][1]+=C),r>e&&(w[0][1][0]-=r-e,w[0][2][0]-=r-e),P>h&&(w[0][2][1]+=P-h,w[0][3][1]+=P-h)}}const k={type:"cim",data:{type:"CIMSymbolReference",symbol:s}};return this.rasterize(k,e,h,R,_,y,a,1,b)}rasterize(m,n,o,v,l,a,c,g=0,x=null,I=window.devicePixelRatio||1){const{data:d}=m;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:M}=d,s=this._canvas,p=I*O;s.width=n*p,s.height=o*p,c||(c=z(M)),x||(x=E(c,n,o,"legend")),s.width+=2*g,s.height+=2*g;const f=s.getContext("2d",{willReadFrequently:!0}),e=F.createIdentity();return e.translate(-v,-l),e.scale(a*p,-a*p),e.translate(n*p/2+g,o*p/2+g),f.clearRect(0,0,s.width,s.height),new A(f,this._cimResourceManager,e,!0).drawSymbol(M,x),f.getImageData(0,0,s.width,s.height)}}function q(u,m,n,o){return m==="esriGeometryPolygon"?{rings:D(S(u.rings,{xmin:0,ymin:0,xmax:n,ymax:o,width:n,height:o}),-1*n/2,-1*o/2)}:m==="esriGeometryPolyline"?{paths:D(S(u.paths,{xmin:0,ymin:0,xmax:n,ymax:o,width:n,height:o}),-1*n/2,-1*o/2)}:null}function E(u,m,n,o,v){const l=-m/2+1,a=m/2-1,c=n/2-1,g=-n/2+1;if(v&&(u==="esriGeometryPolygon"||u==="esriGeometryPolyline")){const x=q(v,u,m,n);if(x)return x}switch(u){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[l,0],[0,0],[a,0]]]};default:return o==="legend"?{rings:[[[l,c],[a,0],[a,g],[l,g],[l,c]]]}:{rings:[[[l,c],[a,c],[a,g],[l,g],[l,c]]]}}}export{yt as CIMSymbolRasterizer};
