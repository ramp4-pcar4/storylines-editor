import{io as $,aK as b,ee as F,aL as T,cY as U,ea as D,a8 as S,bw as O,am as Q,a5 as z}from"./main-DK5A1thH.js";import{T as I,C as y}from"./intl-DLmy-Li5-BP8VBpPh.js";import{x as A,F as G}from"./utils-BG7WTOnW-0dD0ASRJ.js";import{k as H}from"./timeZoneUtils-z3WjfjXQ-CBz80Iqi.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-BFStKTjU-BMLpTkEG.js";import"./common-CYWrYyJl-E8-sukrT.js";const P="esri.widgets.Feature.support.featureUtils",g=()=>S.getLogger(P),_=/href=(""|'')/gi,K=/(\{([^{\r\n]+)\})/g,Y=/'/g,C=/^\s*expression\//i,J=/(\n)/gi,V=/[\u00A0-\u9999<>&]/gim,B=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,W=/^(?:mailto:|tel:)/,Z="relationships/",w=$("short-date-short-time");function Ze(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function qe({type:e,value:t,event:r}){try{return typeof t=="function"?t(r):await t}catch(n){return void g().error("error",`An error occurred when calling the "${e}" function`,{error:n,graphic:r.graphic,value:t})}}function Ee(e=""){if(e)return!W.test(e.trim().toLowerCase())}function X(e){return!!e&&C.test(e)}function ee(e,t){if(!t||!X(t)||!e)return;const r=t.replace(C,"").toLowerCase();return e.find(({name:n})=>n.toLowerCase()===r)}function ke(e,t){const r=ee(t,e?.fieldName);return r?r.title||null:e?e.label||e.fieldName:null}function te(e,t){return`{${t.get(e.toLowerCase())?.fieldName||e}}`}function re(e){return e.replaceAll(_,"")}function q(e,t){const r=h(t,e);return r?r.name:e}function Re(e,t){return e&&e.map(r=>q(r,t))}function h(e,t){return e&&typeof e.getField=="function"&&t?e.getField(t)??null:null}function E(e){return`${e}`.trim()}function Me({attributes:e,globalAttributes:t,layer:r,text:n,expressionAttributes:a,fieldInfoMap:i}){return n?ne({formattedAttributes:t,template:se(n,{...t,...a,...e},r),fieldInfoMap:i}):""}function ne({formattedAttributes:e,template:t,fieldInfoMap:r}){return E(re(b(b(t,n=>te(n,r)),e)))}function ie(e,t,r=!1){const n=t[e];if(typeof n=="string"){const a="%27",i=(r?encodeURIComponent(n):n).replaceAll(Y,a);t[e]=i}}function ae(e,t=!1){const r={...e};return Object.keys(r).forEach(n=>ie(n,r,t)),r}function oe(e,t,r){const n=(t=E(t))&&t[0]!=="{";return b(e,ae(r,n||!1))}function le(e,t){return e.replaceAll(K,(r,n,a)=>{const i=h(t,a);return i?`{${i.name}}`:n})}function se(e,t,r){const n=le(e,r);return n&&n.replaceAll(B,(a,i,o)=>oe(a,i||o,t))}function ue(e,t){if(typeof e=="string"&&t&&t.dateFormat==null&&(t.places!=null||t.digitSeparator!=null)){const r=Number(e);if(!isNaN(r))return r}return e}function fe(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="subtype-group"||e.type==="subtype-sublayer"||e.type==="sublayer")&&"when"in e}function ce(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function k(e){return fe(e)&&ce(e)}function je(e){return!(!(e&&typeof e=="object"&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||e.type!=="feature"&&e.type!=="subtype-group"&&e.type!=="subtype-sublayer"&&e.type!=="sublayer"||!("when"in e))&&(e.type==="subtype-sublayer"&&"parent"in e&&e.parent&&typeof e.parent=="object"?"globalIdField"in e.parent:"globalIdField"in e)}function ve(e){return!!e&&typeof e=="object"&&"sourceLayer"in e&&k(e.sourceLayer)}function de(e,t){const{fieldInfos:r,fieldName:n,preventPlacesFormatting:a,layer:i,timeZone:o}=t,u=ye(r,n),s=h(i,n);if(u&&!F(n)){const f=s?.type,c=u.format?.dateFormat;if(f==="date"||f==="date-only"||f==="time-only"||f==="timestamp-offset"||c)return A(e,{format:c,fieldType:f,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:o,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}})}const l=u?.format;return typeof e=="string"&&F(n)&&l?pe(e,l):typeof(e=ue(e,l))=="string"||e==null||l==null?R(e):I(e,a?{...y(l),minimumFractionDigits:0,maximumFractionDigits:20}:y(l))}function pe(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?m(e,",",", ",t):e.includes(";")?m(e,";","; ",t):e.includes(" ")?m(e," "," ",t):I(Number(e),y(t))}function m(e,t,r,n){return e.trim().split(t).map(a=>I(Number(a),y(n))).join(r)}function ye(e,t){if(e?.length&&t)return e.find(r=>r.fieldName?.toLowerCase()===t.toLowerCase())}function me({fieldName:e,graphic:t,layer:r}){if(j(e)||!r||typeof r.getFeatureType!="function")return null;const{typeIdField:n}=r;if(!n||e!==n)return null;const a=r.getFeatureType(t);return a?a.name:null}function be({fieldName:e,value:t,graphic:r,layer:n}){if(j(e)||!n||typeof n.getFieldDomain!="function")return null;const a=r&&n.getFieldDomain(e,{feature:r,excludeImpliedDomains:z("esri-widget-legacy-field-domain-calculation")});return a&&a.type==="coded-value"?a.getName(t):null}function $e(e,t,r,n){const{creatorField:a,creationDateField:i,editorField:o,editDateField:u}=e;if(!t)return;const s=H(n&&"preferredTimeZone"in n?n.preferredTimeZone:null,!(!n||!("datesInUnknownTimezone"in n))&&!!n.datesInUnknownTimezone,r,w,"date"),l={...w,...s},f=t[u];if(typeof f=="number"){const d=t[o];return{type:"edit",date:T(f,l),user:d}}const c=t[i];if(typeof c=="number"){const d=t[a];return{type:"create",date:T(c,l),user:d}}return null}function Ue(e,t){const r=new Map;if(!e)return r;for(const n of e){if(!n.fieldName)continue;const a=q(n.fieldName,t);n.fieldName=a,r.set(a.toLowerCase(),n)}return r}function De(e){const t=[];if(!e)return t;const{fieldInfos:r,content:n}=e;return r&&t.push(...r),n&&Array.isArray(n)&&n.forEach(a=>{if(a.type==="fields"){const i=a?.fieldInfos;i&&t.push(...i)}}),t}function Se(e){return e.replaceAll(V,t=>`&#${t.charCodeAt(0)};`)}function R(e){return typeof e=="string"?e.replaceAll(J,'<br class="esri-text-new-line" />'):e}function M(e){const{value:t,fieldName:r,fieldInfos:n,fieldInfoMap:a,layer:i,graphic:o,timeZone:u}=e;if(t==null)return"";const s=be({fieldName:r,value:t,graphic:o,layer:i});if(s)return s;const l=me({fieldName:r,graphic:o,layer:i});if(l)return l;if(a.get(r.toLowerCase()))return de(t,{fieldInfos:n||Array.from(a.values()),fieldName:r,layer:i,timeZone:u});const f=i?.fieldsIndex?.get(r);return f&&(G(f)||O(f))?A(t,{fieldType:f.type,timeZoneOptions:{layerTimeZone:i&&"preferredTimeZone"in i?i.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!i||!("datesInUnknownTimezone"in i))&&!!i.datesInUnknownTimezone}}):R(t)}function Oe({fieldInfos:e,attributes:t,layer:r,graphic:n,fieldInfoMap:a,relatedInfos:i,timeZone:o}){const u={};return i?.forEach(s=>Fe({attributes:u,relatedInfo:s,fieldInfoMap:a,fieldInfos:e,layer:r,timeZone:o})),t&&Object.keys(t).forEach(s=>{const l=t[s];u[s]=M({fieldName:s,fieldInfos:e,fieldInfoMap:a,layer:r,value:l,graphic:n,timeZone:o})}),u}async function ge(e,t){const{layer:r,graphic:n,outFields:a,objectIds:i,returnGeometry:o,spatialReference:u}=e,s=i[0];if(typeof s!="number"&&typeof s!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",c={layer:r,graphic:n,objectId:s,requiredFields:a};return g().warn(f,c),null}if(!U(r)?.operations?.supportsQuery){const f="The specified layer cannot be queried. The following fields will not be available.",c={layer:r,graphic:n,requiredFields:a,returnGeometry:o};return g().warn(f,c),null}const l=r.createQuery();return l.objectIds=i,l.outFields=a?.length?a:[r.objectIdField],l.returnGeometry=!!o,l.returnZ=!!o,l.returnM=!!o,l.outSpatialReference=u,(await r.queryFeatures(l,t)).features[0]}async function Ie(e){if(!e.expressionInfos?.length)return!1;const t=await Q(),{arcadeUtils:{hasGeometryFunctions:r}}=t;return r(e)}async function Qe({graphic:e,popupTemplate:t,layer:r,spatialReference:n},a){if(!r||!t||(typeof r.load=="function"&&await r.load(a),!e.attributes))return;const i=r.objectIdField,o=e.attributes[i];if(o==null)return;const u=[o],s=await t.getRequiredFields(r.fieldsIndex),l=D(s,e),f=l?[]:s.includes(i)?s:[...s,i],c=t.returnGeometry||await Ie(t);if(l&&!c)return;const d=await ge({layer:r,graphic:e,outFields:f,objectIds:u,returnGeometry:c,spatialReference:n},a);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function j(e=""){return!!e&&e.includes(Z)}function he(e){return`${Z}${e.layerId}/${e.fieldName}`}function L({attributes:e,graphic:t,relatedInfo:r,fieldInfos:n,fieldInfoMap:a,layer:i,timeZone:o}){e&&t&&r&&Object.keys(t.attributes).forEach(u=>{const s=he({layerId:r.relation.id.toString(),fieldName:u}),l=t.attributes[u];e[s]=M({fieldName:s,fieldInfos:n,fieldInfoMap:a,layer:i,value:l,graphic:t,timeZone:o})})}function Fe({attributes:e,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i}){e&&t&&(t.relatedFeatures?.forEach(o=>L({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i})),t.relatedStatsFeatures?.forEach(o=>L({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:r,fieldInfos:n,layer:a,timeZone:i})))}const N=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},v=({layer:e,method:t,query:r,definitionExpression:n})=>{if(!e.capabilities?.query?.supportsCacheHint||t==="attachments")return;const a=r.where!=null?r.where:null,i=r.geometry!=null?r.geometry:null;N(n)||N(a)||i?.type==="extent"||r.resultType==="tile"||(r.cacheHint=!0)},ze=({query:e,layer:t,method:r})=>{v({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},Ge=({queryPayload:e,layer:t,method:r})=>{v({layer:t,method:r,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function He(e,t,r){return e&&t&&r?t.type==="sublayer"?p({layers:t.layer?.sublayers,map:e,relatedLayer:t,relationship:r})||p({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:r}):p({layers:e.allLayers,map:e,relatedLayer:t,relationship:r})||p({layers:e.allTables,map:e,relatedLayer:t,relationship:r}):null}function Pe(e,t){return e&&"utilityNetworks"in e&&t?e.utilityNetworks?.find(r=>r.isUtilityLayer(t)):null}function x(e,t){return e?.allTables.find(r=>r.type==="feature"&&r.layerId===t.id&&r.url===t.layer?.url)}function p({map:e,relationship:t,relationship:{relatedTableId:r},relatedLayer:n,layers:a}){if(!a)return null;for(const i of a){if(i.type==="map-image"){const u=p({layers:i.sublayers,map:e,relatedLayer:n,relationship:t})||p({layers:i.subtables,map:e,relatedLayer:n,relationship:t});if(u)return u;continue}if(!k(i))continue;if(n.type==="sublayer"){if(i!==n&&i.id===r)return i.isTable?x(e,i):i;continue}const o=n.type==="scene"&&n.associatedLayer?n.associatedLayer.url:n.url;if(!o)return null;if(i.type!=="sublayer"){if(i!==n&&i.url===o&&i.layerId===r)return i}else if(i!==n&&i.layer?.url===o&&i.id===r)return i.isTable?x(e,i):i}return null}function _e(e){const t=e.getObjectId();return t!=null?`oid:${t}`:`uid:${e.uid}`}export{R as applyTextFormattingHTML,Ue as createFieldInfoMap,He as findRelatedLayer,Pe as findUtilityNetwork,le as fixTokens,Oe as formatAttributes,$e as formatEditInfo,de as formatValueToFieldInfo,De as getAllFieldInfos,ye as getFieldInfo,ke as getFieldInfoLabel,q as getFixedFieldName,Re as getFixedFieldNames,_e as getHighlightKeyForFeature,Ze as getSourceLayer,qe as graphicCallback,Se as htmlEntities,je as isAssociatedFeatureSupportedLayer,X as isExpressionField,fe as isFeatureSupportedLayer,ve as isGraphicForRelatableFeatureSupportedLayer,k as isRelatableFeatureSupportedLayer,ce as isRelatableLayer,j as isRelatedField,ze as preLayerQueryCallback,Ge as preRequestCallback,ge as querySourceLayer,Qe as queryUpdatedFeature,Ee as shouldOpenInNewTab,ne as substituteAttributes,Me as substituteFieldsInLinksAndAttributes};
