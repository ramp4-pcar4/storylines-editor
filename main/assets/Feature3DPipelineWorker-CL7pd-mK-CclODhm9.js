import{v as p,I as y,t as L,a as Ie,T as ae,s as $e,ai as ke,c6 as Ne,H as z,gg as ve,ck as Ue,gj as F,ba as Qe,bc as ze,iQ as de,b9 as Ce,ii as He,j0 as We,aO as Re,d6 as Ve,a5 as X,R as Ye,dM as qe,as as Je,F as Ze,cE as E,jJ as Xe,c as Ke,f3 as le,iv as et,jK as tt,gi as ce,jL as rt,jM as nt,ji as st}from"./main-DK5A1thH.js";import{Q as it,O as ot,o as at}from"./projection-m8vi7Cxv-ByA_2Rez.js";import{Y as dt}from"./QueryEngine-DEm6IK5j-Cnxsa_2R.js";import{b as ue}from"./Query-CxQYWcUQ-DdfiJ2tS.js";import{o as he}from"./ReactiveMap-BaMcQuG3-XXoaBLPE.js";import{o as lt}from"./signal-DxzURL18-BUWbVrim.js";import{n as G,o as Se,a as ct,i as ut}from"./memoryEstimations-iHVpvWPf-CMfAjuGi.js";import{O as ht,j as Ae}from"./PooledRBush-J5-OtqBl-CmtgNGYZ.js";import{M as mt}from"./OptimizedFeatureSet-D6mgsKNr-D8fSqNQJ.js";import{c as K}from"./OptimizedGeometry-1qDYm3YK-Cg6l96SZ.js";import{p as ft}from"./query-nJmB7Ppn-zFa41ywm.js";import{o as pt}from"./pbf-Ijhb7ANA-8T2-r4K4.js";import{w as gt}from"./quantizationUtils-Cndke4AR-C-yFTim2.js";import{o as _t}from"./FieldsIndex-Y7EBAYp0-CS8vHjAS.js";import{k as yt,m as wt}from"./pbfQueryUtils-1j64fqcx-DJN3pyPb.js";import{l as C}from"./ViewingMode-CyR_b1T8-_s7_Gbsk.js";import{A as bt,U as xt}from"./Indices-DkAzsiH--DFsJBoBx.js";import{y as It}from"./vec4f64-CjUMzAyX-DPYbdAom.js";import{y as vt,S as Ct,a as Rt,L as St}from"./LodRenderer-DcLHtm7X-BayFsdGs.js";import{p as At}from"./glUtil-n1JOrdV3-CRAZdee5.js";import{o as j}from"./ShaderOutput-C_OqLoo1-jp3zUBgm.js";import{u as Tt,Y as Mt,Z as Et,O as Pt,Q as Ot}from"./HUDMaterial.glsl-DUfp5PMk-jxjn1loR.js";import{Y as me,G as Ft,W as Bt}from"./VerticalOffset.glsl-BtVaDxLq-Bbkz3TDV.js";import{E as Te,b as Gt,Q as Lt}from"./DefaultMaterial-DGGIMylx-Co3fv8Ux.js";import{T as g}from"./VertexAttribute-DFC3a3eR-BhmQtMsu.js";import{m as Dt,l as jt,f as $t,h as kt}from"./RealisticTree.glsl-De7nH4tm-BOWO-Fc0.js";import{a as fe}from"./renderState-DlSSrLcZ-Du_EmLq6.js";import{E as Nt,k as Me,Z as Ut,V as Qt,z as zt,G as Ht}from"./mat4-BFStKTjU-BMLpTkEG.js";import{n as D}from"./mat4f64-BaJwL7tQ-k0uMm8LY.js";import{f as ee}from"./projectVectorToVector-D0K_S4MR-BN7ztR9y.js";import{p as Wt}from"./computeTranslationToOriginAndRotation-DwwrTl3S-JrOuDVP0.js";import{N as pe,u as Vt,D as Yt}from"./HUDVisibility.glsl-Bl7zdrV0-B9Qw8wSm.js";import{M as I}from"./orientedBoundingBox-CTsjUkMw-DzdH9G5q.js";import{_ as ge,A as qt}from"./vec32-BuqRmYBM-Docn8r6P.js";import{d as Jt}from"./spatialReferenceEllipsoidUtils-DlQOpWof-8b-0SJHm.js";import{o as Zt}from"./projectPointToVector-CG1hALQu-BoURAVep.js";import{C as Xt,U as Kt}from"./boundedPlane-B6TkXVHT-y-1QO8ec.js";import{D as er,V as tr}from"./sphere-Cj20syUS-P9gsXSIi.js";import{f as v,u as rr,g as nr}from"./plane-B_adY3_o-Ns1JnzfT.js";import"./featureConversionUtils-DRaHTjrY-FINpcsWc.js";import"./WhereClauseCache-CAR59H4Y-Cc6o3b54.js";import"./LRUCache-BLmkvs7b-C8UYsL5g.js";import"./MemCache-BCippCv6-1uKfr3Ab.js";import"./WhereClause-nZnXFKnG-0kg1cLKe.js";import"./TimeOnly-C3SOkmg2-DQWQOy69.js";import"./fieldType-VTpxE-EM-CxCafxk5.js";import"./timeSupport-_0FhDj9z-DtiFHNAM.js";import"./queryUtils-OXllLZed-D4rO0__t.js";import"./normalizeUtils-b-vZURob-A8spekoP.js";import"./utils-DuaeuwP5-IrMotWQ7.js";import"./utils-Jw-4AGsF-CezsCFGF.js";import"./json-BI97KiBB-Ce5cWfI2.js";import"./QueryEngineCapabilities-C8pazosU-DZTubngj.js";import"./TimeExtent-gZaEUVeW-DaDBMnur.js";import"./utils-BrRx2KpZ-aOPGQzLr.js";import"./heatmapUtils--OU2Fakh-CU7rUz5B.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./utils-BG7WTOnW-0dD0ASRJ.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./intl-DLmy-Li5-BP8VBpPh.js";import"./timeZoneUtils-z3WjfjXQ-CBz80Iqi.js";import"./ClassBreaksDefinition-B_vYk3bu-BFm4eQQf.js";import"./SnappingCandidate-DJDyIbpo-CuetCfU1.js";import"./FixedIntervalBinParameters-aoOPIkh7-Cfdo5iJN.js";import"./NormalizationBinParametersMixin-ZkplD1Sk-BF47-tnr.js";import"./Scheduler-Br-2v2ys-DaLUn3wq.js";import"./Field-Cj6Pz3TI-Ca9WushU.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./queryZScale-DBCLQqDI-C48O7bKk.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./vec2f64-CEUyUoff-BBc0aQ6D.js";import"./InterleavedLayout-DcHoXu73-35D6EIGL.js";import"./BufferView-BBCzkcZS-BKSq5J5y.js";import"./Octree-Kk-G5P_T-xRLR75Xc.js";import"./mat3-DOnW3DjW-C3hbW9XY.js";import"./mat3f64-Dh9_zhFu-BIT-k8Dm.js";import"./VertexArrayObject-DTkLCIKs-UH72P2I_.js";import"./Texture-DXSFJsEu-0d91IJKM.js";import"./enums-DBi1-Mm2-CUS1pvQe.js";import"./getDataTypeBytes-HSdrWtlL-ClHsCcSN.js";import"./HighlightDefaults-Cg50f_1y-CeQprwVu.js";import"./VertexElementDescriptor-BAy1DPb3-BOhpDZGx.js";import"./floatRGBA-YJlz5IlR-B5_mu0Vq.js";import"./glsl-o28TenZV-B0eZUNn3.js";import"./BindType-CKbZk6AG-Bqvzo9NX.js";import"./ShaderBuilder-BkQM64Qp-Ckh4B6kE.js";import"./triangle-BePBrXJ8-BGvt3tv3.js";import"./lineSegment-BJNfNZM5-RDIZE__8.js";import"./lengthUtils-wU9RRIqK-CcSgrDlT.js";import"./requestImageUtils-rT_rMd2F-Cv4KeeHw.js";import"./TextureFormat-Cl0ugX3E-DD0Aw8RG.js";import"./NormalAttribute.glsl-C9zbIKka-BQ-gxZja.js";import"./doublePrecisionUtils-BJbYwoii-kIP-tL_t.js";import"./vec3f32-BS0cezmI-B_madU1n.js";import"./meshVertexSpaceUtils-BwEbYR8F-D_1-zksg.js";import"./MeshLocalVertexSpace-DFCiKNRA-BLWX9O__.js";import"./hydratedFeatures-BDT5zTGB-CvrRwYk-.js";import"./quat-D8L_R4I0-CsHvsQG-.js";import"./quatf64-C16JxGFv-BKWK1F8U.js";function sr(t){const{value:e,operations:r}=t;return{operations:r,value:r.create(e)}}function ir(t,e,r){return t.operations.setExtent(t.value,e,r.value),r}function or(t,e){return t.operations.getExtent(t.value,e),e}function ar(t){return{operations:t,value:t.create()}}function Ee(t,e,r=ar(t)){return r.operations=t,t.copy(e,r.value),r}function dr(t){return Ee(tr,er(0,0,0,ve(t).radius))}const _e=2**50;function lr(){return Ee(Kt,Xt([0,0,0],[_e,0,0],[0,_e,0]))}function cr(t,e,r){return t.operations.axisAt(t.value,e,F.Z,r)}function ur(t,e,r,n){return t.operations.axisAt(t.value,e,r,n)}function hr(t,e,r){return t.operations.intersectRay(t.value,e,r)}function mr(t,e,r){return t.operations.intersectRayClosestSilhouette(t.value,e,r)}function fr(t,e){return t.operations.altitudeAt(t.value,e)}function Pe(t,e,r,n){return t.operations.setAltitudeAt(t.value,e,r,n)}function pr(t,e,r,n){return e!==n&&Me(n,e),qt(A,n[12],n[13],n[14]),Pe(t,A,r,A),n[12]=A[0],n[13]=A[1],n[14]=A[2],n}function q(t,e,r){return t.operations.elevate(t.value,e,r.value)}const A=E();class H{constructor(e,r,n,s){this.viewingMode=e,this.spatialReference=r,this.unitInMeters=n,this._coordinateSystem=s,this._tmpCoordinateSystem=sr(s),this.referenceEllipsoid=ve(r),this.sphericalPCPF=Jt(r)}set extent(e){e&&ir(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return or(this._coordinateSystem,Ue())}getAltitude(e){return fr(this._coordinateSystem,e)}setAltitude(e,r,n=e){return Pe(this._coordinateSystem,n,r,e)}setAltitudeOfTransformation(e,r){pr(this._coordinateSystem,r,e,r)}worldUpAtPosition(e,r){return cr(this._coordinateSystem,e,r)}worldBasisAtPosition(e,r,n){return ur(this._coordinateSystem,e,r,n)}basisMatrixAtPosition(e,r){const n=this.worldBasisAtPosition(e,F.X,v.get()),s=this.worldBasisAtPosition(e,F.Y,v.get()),i=this.worldBasisAtPosition(e,F.Z,v.get());return Nt(r,n[0],n[1],n[2],0,s[0],s[1],s[2],0,i[0],i[1],i[2],0,0,0,0,1),r}headingAtPosition(e,r){const n=this.worldUpAtPosition(e,v.get()),s=this.worldBasisAtPosition(e,F.Y,v.get()),i=rr(r,s,n);return Qe(i)}intersectManifoldClosestSilhouette(e,r,n){return q(this._coordinateSystem,r,this._tmpCoordinateSystem),mr(this._tmpCoordinateSystem,e,n),n}intersectManifold(e,r,n){q(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=v.get();return hr(this._tmpCoordinateSystem,e,s)?ge(n,s):null}intersectInfiniteManifold(e,r,n){if(this.viewingMode===C.Global)return this.intersectManifold(e,r,n);q(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=this._tmpCoordinateSystem.value,i=v.get();return nr(s.plane,e,i)?ge(n,i):null}toRenderCoords(e,r,n){return pe(e)?Zt(e,r,this.spatialReference):ee(e,r,n,this.spatialReference)}fromRenderCoords(e,r,n=null){return pe(r)?(n!=null&&(r.spatialReference=n),vt(e,this.spatialReference,r)?r:null):ee(e,this.spatialReference,r,n)?r:null}static create(e,r){switch(e){case C.Local:return new H(C.Local,r,ze(r),lr());case C.Global:return new H(C.Global,r,1,dr(r))}}static renderUnitScaleFactor(e,r){return de(e)/de(r)}}let gr=class extends Gt{constructor(t=E()){super(),this.origin=t}get slicePlaneLocalOrigin(){return this.origin}},_=class extends Ce{constructor(t){super(t),this._updatingCount=0,this._tileHandles=new he,this._wanted=new he}destroy(){for(const t of this._tileHandles.values())t.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){const{extent:t}=this;return t==null?null:He(t)}get _missingTiles(){const t=new Array,e=this._wanted;for(const r of this._tileHandles.values())e.has(r.id)&&!B(r)&&t.push(r);return t}async onTileTreeChange(t){++this._updatingCount;try{const{added:e,removed:r}=t,n=this._tileHandles,{_boundingRect:s}=this,i=s!=null?e.filter(a=>We(s,a.extent)):e,o=this._wanted,d=new Array;for(const a of r){const{id:l}=a;if(o.delete(l),e.some(h=>b(h,a)||b(a,h)))continue;const c=n.get(l);c!=null&&d.push(this._removeTile(c))}for(const a of i)o.set(a.id,a),d.push(this._addTile(a));await Promise.allSettled(d)}finally{--this._updatingCount}}async _removeTile(t){this._tileHandles.delete(t.id),t.abort(),this._validate();const{tile:e}=t,r=new P(t.untilSettled(),e!=null?this.createRemoveTileCommand(e):null);t.nextEvent=null;const{command:n}=await r.getCommand();n?.execute()}async _addTile(t){const{_tileHandles:e}=this,r=e.get(t.id);if(r!=null)return!B(r)||r.tile.isComplete||(r.tile=r.tile.reset(),r.nextEvent=this._onTileLoad(r)),void await r.untilSettled();const n=new _r(t);this._tileHandles.set(n.id,n);const s=this.loadTile(t,n.signal);n.nextEvent=s;const i=await s;if(n.aborted)throw Re();n.tile=i,yr(n),n.nextEvent=this._onTileLoad(n),await n.untilSettled()}async _onTileLoad(t){const{_wanted:e,_tileHandles:r,_missingTiles:n}=this,s=t.descriptor,i=new Array,o=new Array,d=new Set;for(const l of r.values()){if(l===t)continue;const{descriptor:c,id:h}=l;if(e.has(h)||n.some(({descriptor:m})=>b(m,c)||b(c,m))){if(B(l)){if(b(s,c)){const m=l.tile;for(const u of m.objectIds())d.add(u)}if(b(c,s)){const m=t.tile,u=new Set(m.objectIds()),f=l.tile,x=f.exclude(u);l.tile=x;const R=AbortSignal.any([l.signal,t.signal]),S=l.untilSettled();i.push(new P(S,this.createRemoveTileCommand(f))),i.push(new P(S,this.createAddTileCommand(x,R),R)),o.push(l),this._validateRemoval(x,u)}}}else{l.abort(),r.delete(h);const{tile:m}=l;m!=null&&i.push(new P(l.untilSettled(),this.createRemoveTileCommand(m))),l.nextEvent=null}}d.size>0&&(t.tile=t.tile.exclude(d),this._validateRemoval(t.tile,d)),i.push(new P(t.untilSettled(),this.createAddTileCommand(t.tile,t.signal),t.signal)),o.push(t),this._validate();const a=this._joinCommands(i);for(const l of o)l.nextEvent=a;await a}async _joinCommands(t){const e=(await Promise.allSettled(t.map(async r=>r.getCommand()))).map(r=>r.status!=="fulfilled"||r.value.signal?.aborted?null:r.value.command).filter(Ve);e.length!==0&&e.reduce((r,n)=>(r.append(n),r)).execute()}_validate(){if(!X("feature-pipeline-3d-test-validation"))return;const t=new Array;for(const e of this._tileHandles.values()){if(!B(e))continue;const{tile:r}=e,n=r.featureCount,s=new Uint32Array(n);r.readObjectIds(s),t.push({tile:r,objectIds:new Set(s)})}for(let e=0;e<t.length;++e){const{tile:r,objectIds:n}=t[e];for(let s=e+1;s<t.length;++s){const{tile:i,objectIds:o}=t[s];for(const d of o)if(n.has(d)){const a=b(i.descriptor,r.descriptor),l=b(r.descriptor,i.descriptor);throw new Error(`${r.descriptor.id} and ${i.descriptor.id} both contain ${d}. aInB: ${a}; bInA: ${l}`)}}}}_validateRemoval(t,e){if(X("feature-pipeline-3d-test-validation")){for(const r of t.objectIds())if(e.has(r))throw new Error(`Failed to remove ${r} from ${t.descriptor.id}!`)}}};function b({lij:[t,e,r]},{lij:[n,s,i]}){const o=n-t;return o>=0&&e===s>>o&&r===i>>o}p([y()],_.prototype,"updating",null),p([y({constructOnly:!0})],_.prototype,"loadTile",void 0),p([y({constructOnly:!0})],_.prototype,"createAddTileCommand",void 0),p([y({constructOnly:!0})],_.prototype,"createRemoveTileCommand",void 0),p([y()],_.prototype,"_updatingCount",void 0),p([y()],_.prototype,"extent",void 0),p([y()],_.prototype,"_boundingRect",null),p([y()],_.prototype,"_missingTiles",null),_=p([L("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],_);let _r=class{constructor(t){this.descriptor=t,this._controller=new AbortController,this._tile=lt(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(t){this._tile.value=t}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}async untilSettled(){try{await this.nextEvent}catch(t){Ye(t)||console.error(t)}}};function B(t){return t.tile!=null}function yr(t){if(!B(t))throw new Error}let P=class{constructor(t,e,r){this.previousEventSettled=t,this.commandPromise=e,this.signal=r}async getCommand(){const{previousEventSettled:t,commandPromise:e,signal:r}=this,[n]=await Promise.all([e,t]);if(r?.aborted)throw Re();return{command:n,signal:r}}},wr=class te{constructor(e,r){this.tile=e,this._tileIndices=r}get id(){return this.tile.id}get featureCount(){return this._tileIndices?.length??this.tile.featureCount}get usedMemory(){return G+(this._tileIndices?.byteLength??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(e,r){const{_tileIndices:n,tile:s}=this;return s.readObjectIds(e,n,r)}readCoordinates(e,r){const{_tileIndices:n,tile:s}=this;return s.readCoordinates(e,n,r)}subset(e){const{_tileIndices:r,tile:n}=this;if(r==null)return new te(n,e);const s=new Uint32Array(e.length);for(let i=0;i<s.length;++i)s[i]=r[e[i]];return new te(n,s)}},br=class{constructor(){this._tileToFeatureData=new Map}add(t){this._tileToFeatureData.set(t.tile,t)}remove(t){this._tileToFeatureData.delete(t)}get(t){return this._tileToFeatureData.get(t)}},re=class{constructor(t,e){this._index=t,this._view=e}get usedMemory(){return G+Se}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(t){return this._view.getAttribute(this._index,t)}getAttributeAsTimestamp(t){return this._view.getAttributeAsTimestamp(this._index,t)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(t){return this._view.getCentroid(this._index,t)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(t){return new xr(this._index,this._view,t)}},xr=class extends re{constructor(t,e,r){super(t,e),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(t){return mt(new K,this._geometryOverride,t.hasZ,t.hasM)}};class Ir{constructor(){this._tileBounds=new Map,this.events=new Ie,this.featureAdapter=ne.shared}get usedMemory(){return G+G*this._tileBounds.size}addTile(e){const{featureCount:r}=e;if(r===0)return;const n=new ht(9,i=>e.getBounds(i)),s=new Array;for(let i=0;i<r;++i)s[i]=i;n.load(s),this._tileBounds.set(e,n),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(const[r,n]of this._tileBounds)n.all(s=>e(new re(s,r)))}forEachInBounds(e,r){O.minX=e[0],O.minY=e[1],O.maxX=e[2],O.maxY=e[3];for(const[n,s]of this._tileBounds)s.search(O,i=>r(new re(i,n)))}forEachBounds(e,r){for(const n of e)r(n.getBoundingBox())}getFullExtent(e){let r=1/0,n=1/0,s=-1/0,i=-1/0;for(const o of this._tileBounds.values()){const{minX:d,minY:a,maxX:l,maxY:c}=o.toJSON();r=Math.min(r,d),n=Math.min(n,a),s=Math.min(s,l),i=Math.min(i,c)}return{xmin:r,ymin:n,xmax:s,ymax:i,spatialReference:e}}}let ne=class{getObjectId(t){return t.getObjectId()}getAttribute(t,e){return t.getAttribute(e)}getAttributeAsTimestamp(t,e){return t.getAttributeAsTimestamp(e)}getAttributes(t){return t.getAttributes()}getGeometry(t){return t.getOptimizedGeometry()}getCentroid(t,e){return t.getCentroid(e)}cloneWithGeometry(t,e){return t.cloneWithGeometry(e)}};ne.shared=new ne;const O=new Ae;let vr=class se{constructor(e,r,n=Cr(r)){this.descriptor=e,this._pages=r,this._addressTable=n;const s=ct+r.reduce((d,{usedMemory:a})=>d+a,0),i=3*Se,o=ut(n);this.usedMemory=G+s+i+o,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===r.reduce((d,a)=>d+a.featureCount,0)}get id(){return this.descriptor.id}getObjectId(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getObjectId(n)}getAttribute(e,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getAttribute(s,r)}getAttributeAsTimestamp(e,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getAttributeAsTimestamp(s,r)}getAttributes(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttributes(n)}getCoordinates(e,r,n){const{pageIndex:s,featurePageIndex:i}=this._translateIndex(e);this._pages[s].getCoordinates(i,r,n)}getOptimizedGeometry(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getOptimizedGeometry(n)}getCentroid(e,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getCentroid(s,r)}getBounds(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getBounds(n)}getBoundingBox(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getBoundingBox(n)}readObjectIds(e,r=this._allFeatureIndices(),n=0){let s=n;for(const{page:i,indices:o}of this._batchPageIndices(r))s=i.readObjectIds(e,o,s);return s}readCoordinates(e,r=this._allFeatureIndices(),n=0){let s=n;for(const{page:i,indices:o}of this._batchPageIndices(r))s=i.readCoordinates(e,o,s);return s}*objectIds(e=this._allFeatureIndices()){for(const{page:r,indices:n}of this._batchPageIndices(e))for(const s of r.objectIds(n))yield s}exclude(e){if(e.size===0)return this;const{_addressTable:r,featureCount:n}=this,s=new Array;for(let i=0;i<n;++i){const o=this.getObjectId(i);e.has(o)||(s.push(r[2*i]),s.push(r[2*i+1]))}return new se(this.descriptor,this._pages,s)}reset(){const{isComplete:e,_pages:r}=this;return e?this:new se(this.descriptor,r)}*_allFeatureIndices(){const{featureCount:e}=this;for(let r=0;r<e;++r)yield r}_translateIndex(e){const{_addressTable:r}=this;return{pageIndex:r[2*e],featurePageIndex:r[2*e+1]}}*_batchPageIndices(e){const r=new Array;{let s=0,i=new Array;for(const o of e){const{pageIndex:d,featurePageIndex:a}=this._translateIndex(o);s!==d&&(i.length!==0&&r.push({pageIndex:s,indices:i}),s=d,i=[]),i.push(a)}i.length!==0&&r.push({pageIndex:s,indices:i})}const{_pages:n}=this;for(const{pageIndex:s,indices:i}of r)yield{page:n[s],indices:i}}};function Cr(t){const e=t.reduce((s,{featureCount:i})=>s+i,0),r=new Array;if(e===0)return r;const n=t[0].featureCount;for(let s=0;s<e;++s)r[2*s]=Math.floor(s/n),r[2*s+1]=s%n;return r}let Rr=class{constructor(t){this._reader=new pt(new Uint8Array(t),new DataView(t)),this._index=Sr(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(t){return this.getAttribute(t,this._index.objectIdFieldName)}getAttribute(t,e){const{_index:{fieldsIndex:r,attributeIndices:n}}=this,s=r.get(e)?.index;if(s==null)return;const i=n[t*r.fields.length+s],o=this._reader;return o.move(i),$(o)}getAttributeAsTimestamp(t,e){const r=this.getAttribute(t,e);return typeof r=="string"?new Date(r).getTime():typeof r=="number"||r==null?r:null}getAttributes(t){const{_index:{fieldsIndex:e,attributeIndices:r}}=this,n=t*e.fields.length,s=this._reader,i={};for(const o of e.fields){const d=r[n+o.index];s.move(d),i[o.name]=$(s)}return i}getCoordinates(t,e,r=0){const n=this._reader,{transform:s,featureIndices:i}=this._index,{scale:o,translate:d}=s;n.move(i[t]),this._readCoordinates(o,d,e,r)}getOptimizedGeometry(t){const e=E();return this.getCoordinates(t,e),new K([],e)}getCentroid(t,{hasZ:e,hasM:r}){this.getCoordinates(t,T);const[n,s,i]=T,o=[n,s];return e&&(o[3]=i),r&&(o[e?4:3]=0),new K([],o)}getBounds(t){this.getCoordinates(t,T);const[e,r]=T,n=new Ae;return n.minX=e,n.minY=r,n.maxX=e,n.maxY=r,n}getBoundingBox(t){this.getCoordinates(t,T);const[e,r,n]=T;return Xe(e,r,n,e,r,n)}readObjectIds(t,e=this._allFeatureIndices(),r=0){const n=this._reader,{objectIdFieldName:s,attributeIndices:i,fieldsIndex:o}=this._index,d=o.get(s).index,a=o.fields.length;for(const l of e){const c=i[l*a+d];n.move(c),t[r++]=$(n)}return r}readCoordinates(t,e=this._allFeatureIndices(),r=0){const n=this._reader,{transform:s,featureIndices:i}=this._index,{scale:o,translate:d}=s;for(const a of e){const l=i[a];n.move(l),r=this._readCoordinates(o,d,t,r)}return r}*objectIds(t=this._allFeatureIndices()){const e=this._reader,{objectIdFieldName:r,attributeIndices:n,fieldsIndex:s}=this._index,i=s.get(r).index,o=s.fields.length;for(const d of t){const a=n[d*o+i];e.move(a),yield $(e)}}*_allFeatureIndices(){const{featureCount:t}=this;for(let e=0;e<t;++e)yield e}_readCoordinates([t,e,r],[n,s,i],o,d){const a=this._reader,l=a.getLength(),c=a.pos()+l;for(;a.pos()<c&&a.next();)switch(a.tag()){case 2:{const h=a.getLength(),m=a.pos()+h;for(;a.pos()<m&&a.next();)a.tag()===3?(a.getUInt32(),o[d++]=n+t*a.getSInt64(),o[d++]=s+e*a.getSInt64(),o[d++]=i+r*a.getSInt64()):a.skip();break}default:a.skip()}return d}};function Sr(t){for(;t.next();){if(t.tag()===2)return Ar(t.getMessage());t.skip()}W()}function Ar(t){for(;t.next();){if(t.tag()===1)return Tr(t.getMessage());t.skip()}W()}function Tr(t){let e,r,n=!1,s=!1,i=0;const o=new Array,d=new Array,a=new Array;for(;t.next();)switch(t.tag()){case 1:r=t.getString();break;case 7:t.getEnum()!==0&&W();break;case 9:n=t.getBool()??!1;break;case 12:e=gt(t.processMessage(wt));break;case 13:{const c=t.processMessage(yt);c.index=i++,o.push(c);break}case 15:{d.push(t.pos());const c=t.getUInt32(),h=t.pos()+c;for(;t.pos()<h&&t.next();)t.tag()===1&&a.push(t.pos()),t.skip();break}case 10:s=t.getBool()??!1;break;default:t.skip()}const l=new _t(o);return e!=null&&s&&r!=null&&l.has(r)||W(),{transform:e,exceededTransferLimit:n,fieldsIndex:l,objectIdFieldName:r,featureIndices:d,attributeIndices:a}}function W(){const t=new Ke("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(t),t}function $(t){const e=t.getLength(),r=t.pos()+e;for(;t.pos()<r&&t.next();)switch(t.tag()){case 1:return t.getString();case 2:return t.getFloat();case 3:return t.getDouble();case 4:return t.getSInt32();case 5:return t.getUInt32();case 6:return t.getInt64();case 7:return t.getUInt64();case 8:return t.getSInt64();case 9:return t.getBool();default:return t.skip(),null}return null}const T=E(),ye=8e3,Mr=4,Er=4;let Pr=class{constructor(t,e,r,n,s){this.spatialReference=t,this.url=r,this.objectIdField=n,this.capabilities=s;const{supportsMaxRecordCountFactor:i,maxRecordCount:o}=this.capabilities.query,d=i?Mr:1,a=(o??ye)*d;this._pageSize=Math.min(ye,a);const l=e.clone();l.cacheHint=!0,l.resultType="tile",l.outSpatialReference=t,l.returnGeometry=!0,l.returnZ=!0,l.maxRecordCountFactor=d,l.num=this._pageSize,l.outFields=[n],this._baseQuery=l}async fetch(t,e){const{spatialReference:r}=this,n=qe(t.extent,r),s=this._baseQuery.clone();s.geometry=n;const i=new Array;let o=0,d=!1,a=1;for(;!d;){const l=[];for(let h=0;h<a;++h)l.push(this._fetchPage(s,o++,e));const c=await Promise.all(l);z(e);for(const h of c){const m=h.featureCount!==0;d||=!h.exceededTransferLimit||!m,m&&i.push(h)}a=Math.min(a+1,Er)}return new vr(t,i)}async _fetchPage(t,e,r){const n=t.clone();n.start=e*this._pageSize;const s=(await ft(this.url,n,{signal:r})).data;return z(r),new Rr(s)}},U=class extends Tt{constructor(t){super(t),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new gr,this._bufferWriter=null}get produces(){return this._produces}get numFeatures(){let t=0;return this._renderGeometries.forEach(e=>t+=e.numElements/6),t}get usedMemory(){let t=0;return this._renderGeometries.forEach(e=>{t+=e.vao.usedMemory}),t}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((t,e)=>{this._produces.set(e,r=>r!==j.Highlight&&r!==j.ShadowHighlight&&t(r))})}destroy(){this._glMaterials.dispose();const t=this._renderGeometries.keys();for(const e of t)this.removeRenderGeometry(e)}acquireTechniques(t){const e=this.material;if(!e.shouldRender(t))return null;const{output:r,bind:n}=t;return!e.produces.get(n.slot)?.(r)||r===j.Highlight||r===j.ShadowHighlight?null:this._glMaterials.load(t.rctx,n.slot,r)?.beginSlot(n)}render(t,e){const r=this._renderGeometries;if(r.size===0)return;const{bind:n}=t,s=n.slot===me.OCCLUDER_MATERIAL||n.slot===me.TRANSPARENT_OCCLUDER_MATERIAL?n.slot:null,i=t.rctx;i.runAppleAmdDriverHelper(),i.bindTechnique(e,n,this.material.parameters);const o=e.program;for(const[d,a]of r)this._drawParameters.origin=a.localOrigin,o.bindDraw(n,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(a.vao),i.bindVAO(a.vao),i.setPipelineState(e.getPipeline(!1,s)),i.drawArrays(e.primitiveType,0,a.numElements)}initializeRenderContext(t,e){this._glMaterials=new Ct(this.material,t.materials),this._vaoCache=t.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,At(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometry(t,e,r){this.removeRenderGeometry(t);const n=this._vaoCache.newVao(e.data.byteLength);n.vertexBuffers.get("geometry").setSubData(new Uint8Array(e.data),0,0,e.data.byteLength);const s={localOrigin:r,vao:n,numElements:e.elementCount};return this._renderGeometries.set(t,s),s}removeRenderGeometry(t){const e=this._renderGeometries.get(t);e!=null&&(this._vaoCache.deleteVao(e.vao),this._renderGeometries.delete(t))}hasHighlightOptions(t){return!1}};p([y({constructOnly:!0})],U.prototype,"material",void 0),U=p([L("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],U);let ie=class{constructor(t){this._optionalFields=new Array,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=t.layerUid,this.view=t.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._featureIdToInstanceIndex.size}get usedMemory(){return(this._lodRendererResources?.lodRenderer?.symbol?.computeUsedMemory()??0)+16*this._featureIdToInstanceIndex.size}destroy(){this._disposeResourceHandles.forEach(t=>t())}async doLoad(t,e,r){X("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(g.OBJECTANDLAYERIDCOLOR);const n=Or(a=>e(a),t),s=this.view._stage,i=n.getMaterials();s.addMany(i),this._addDisposeResource(()=>s.removeMany(i));const o=n.getTextures();s.addMany(o),this._addDisposeResource(()=>{o.forEach(a=>a.unload()),s.removeMany(o)}),await Promise.all(o.map(a=>this.view._stage.schedule(()=>a.load(s.renderView.renderingContext),r))),z(r);const d=await this._createLodRenderer(n,r);this._lodRendererResources={lodRenderer:d,materials:i,textures:o}}addInstances(t){const e=this._lodRendererResources;if(e==null)return;const{featureIds:r,localTransforms:n,globalTransforms:s}=t,i=e.lodRenderer;if(i==null)return;const o=i.instanceData,d=r.length;for(let a=0;a<d;++a){const l=r[a],c=o.addInstance(),h=o.view,m=16*a;h.localTransform.copyFromTypedBuffer(c,n,m),h.globalTransform.copyFromTypedBuffer(c,s,m),o.updateModelTransform(c),o.setVisible(c,!0),this._featureIdToInstanceIndex.set(l,c)}}removeInstances(t){const e=this._lodRendererResources;if(e==null)return;const r=e.lodRenderer.instanceData,n=this._featureIdToInstanceIndex,s=t.length;for(let i=0;i<s;++i){const o=t[i],d=n.get(o);d!=null&&(r.removeInstance(d),n.delete(o))}}_addDisposeResource(t){this._disposeResourceHandles.push(t)}async _createLodRenderer(t,e){const r=this.view._stage,n={layerUid:this.layerUid,graphicUid:i=>1,notifyGraphicGeometryChanged:i=>1,notifyGraphicVisibilityChanged:i=>1},s=new Rt({symbol:t,optionalFields:this._optionalFields,metadata:n,shaderTransformation:null},this.scheduler);return s.slicePlaneEnabled=!1,this._addDisposeResource(()=>{r.removeRenderPlugin(s),s.destroy()}),await r.addRenderPlugin(s,e),s}};function Or(t,e){const r=e.levels.map(n=>{const s=n.components.map(i=>{const o=t(i.materialId);if(!Fr(o))throw new Error("LodRenderer only supports DefaultMaterial");const d=new Dt(o,i.renderGeometryBuffer.data,i.renderGeometryBuffer.elementCount,i.boundingInfo);return new jt(d)});return new $t(s,n.minScreenSpaceRadius)});return new kt(r)}function Fr(t){return t!=null&&"materialType"in t&&t.materialType==="default"}ie=p([L("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],ie);let J=class extends Ce{constructor(t){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=t.view,this.layerUid=t.layerUid}initialize(){}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(t=>t.destroy())}async executeRenderCommands(t){for(const e of t)switch(e.id){case"create-material":await this._createMaterial(e);break;case"create-direct-renderer":await this._createDirectRenderer(e);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(e),this._updateFeatureCount();break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(e),this._updateFeatureCount();break;case"create-lod-renderer":await this._createLodRenderer(e);break;case"add-lod-instances":await this._addLodInstances(e),this._updateFeatureCount();break;case"remove-lod-instances":await this._removeLodInstances(e),this._updateFeatureCount()}}_updateFeatureCount(){let t=0;for(const e of this._directRenderers.values())t+=e.numFeatures;for(const e of this._lodRenderers.values())t+=e.numFeatures;this._set("totalFeatures",t)}get usedMemory(){let t=0;for(const e of this._directRenderers.values())t+=e.usedMemory;for(const e of this._lodRenderers.values())t+=e.usedMemory;return t}async _createMaterial(t){const{view:e}=this,{sharedSymbolResources:r}=e;if(r==null)throw new Error("No shared symbol resources found!");const{textures:n}=r,s=e.state.viewingMode===C.Global;let i=null;switch(t.type){case"default":i=Br(r,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:e._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},s);break;case"hud":{const[o,d]=Oe(n,s);this.addHandles([Je(()=>Ze(d))]),i=o}break;default:throw new Error(`unable to create unknown material type ${t.type}`)}this._materials.set(t.materialId,i)}_getMaterial(t){return this._materials.get(t)}async _createDirectRenderer(t){const e=t.materialId,r=this._getMaterial(e);if(r==null)throw new Error(`material not found ${e}`);const{view:n}=this,s=new U({material:r});this._directRenderers.set(e,s),n._stage.addRenderPlugin(s),n._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(t){const e=t.renderGeometryId,r=t.materialId;await this._removeDirectRendererGeometry({renderGeometryId:e});const n=this._directRenderers.get(r);if(n==null)return void console.error("no renderer assigned to provided material");const s=n.addRenderGeometry(e,t.renderGeometryBuffer,t.localOrigin);this._renderGeometries.set(e,{renderGeometry:s,materialId:r}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(t){const e=t.renderGeometryId,r=this._renderGeometries.get(e);if(r==null)return;const n=r.materialId,s=this._directRenderers.get(n);s!=null?s.removeRenderGeometry(t.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(t){const e=new ie({view:this.view,layerUid:this.layerUid}),r=new AbortController,n=s=>this._getMaterial(s);await e.doLoad(t.lodRenderGeometry,n,r.signal),this._lodRenderers.set(t.lodRendererId,e)}async _addLodInstances(t){const e=this._lodRenderers.get(t.lodRendererId);if(e==null)throw new Error("no lod renderer assigned to provided lod renderer Id");e.addInstances(t.data)}async _removeLodInstances(t){const e=this._lodRenderers.get(t.lodRendererId);if(e==null)throw new Error("no lod renderer assigned to provided lod renderer Id");e.removeInstances(t.featureIds)}};function Oe(t,e){const r={anchorPosition:St.center,occlusionTest:!0,hasSlicePlane:!1,color:[1,0,0,1],outlineColor:[0,0,0,1],outlineSize:1,distanceFieldBoundingBox:Mt},n=null;if(t!=null){const s=t.fromData("circle-icon",()=>Et("circle"));r.textureId=s.texture.id,r.textureIsSignedDistanceField=!0,r.sampleSignedDistanceFieldTexelCenter=Ot("circle")}return[new Pt(r,e),n]}function Br(t,e,r){const n={usePBR:e.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:Lt,ambient:le,diffuse:le,hasSlicePlane:e.slicePlaneEnabled,castShadows:e.castShadows,offsetTransparentBackfaces:!e.isPrimitive};return Gr(n),n.screenSizePerspective=t.screenSizePerspectiveSettings,n.externalColor=It,n.isInstanced=!0,new Te(n,{spherical:r,doublePrecisionRequiresObfuscation:!0})}function Gr(t){const e=t.opacity??1,r=e<1;return t.transparent=r,t.opacity=e,t.cullFace=r?fe.None:fe.Back,t}p([y({readOnly:!0})],J.prototype,"totalFeatures",void 0),J=p([L("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],J);let we=class{constructor(t){this._bufferWriter=null,this._bufferWriter=t.createBufferWriter()}createBuffer(t,e){const r=this._bufferWriter;let n=null;if(t.transformation&&e)Me(M,t.transformation),M[12]-=e[0],M[13]-=e[1],M[14]-=e[2],n=M;else{if(e)throw new Error("not implemented");t.transformation&&(n=t.transformation)}let s=null;n&&(zt(k,M),Ht(k,k),s=k);const i=t.attributes,o=r.elementCount(i),d=r.vertexBufferLayout.stride/4;o>Math.floor(Lr/d)&&console.warn("geometry with very large number of elements encountered");const a=r.vertexBufferLayout.createBuffer(o);return r.write(n,s,i,t.objectAndLayerIdColor,a,0),{data:a.buffer,elementCount:o}}};const M=D(),k=D(),Lr=16777216/4;let Dr=class{constructor(t){this._context=t,this._commands=[],this._transferables=new Set}createMaterial(t){const e=this._context,r=e.generateId("material");switch(t){case"default":{const n=new Te({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),s=new we(n);e.registerRenderGeometryBufferWriter(r,s)}break;case"hud":{const n=Oe(null,this._context.globalViewingMode)[0],s=new we(n);e.registerRenderGeometryBufferWriter(r,s)}}return this._commands.push({id:"create-material",type:t,materialId:r}),r}createDirectRenderer(t){const e=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:e,materialId:t}),e}addDirectRendererGeometry(t,e,r){const n=e.materialId,s=this._context.getRenderGeometryBufferWriter(n);if(s==null)throw new Error(`no bufferwriter found for material ${n}`);const i=s.createBuffer(e,r);this._transferables.add(i.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:t,materialId:n,renderGeometryBuffer:i,localOrigin:r})}removeDirectRendererGeometry(t){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:t})}createLodRenderer(t){const e=this._context.generateId("lod-renderer"),r={levels:t.levels.map(n=>({components:n.components.map(s=>{const i=s.attributes.get(g.POSITION);if(!i||i.indices.length===0)throw new Error("positions attribute expected");const o=3,d=bt(i.indices.length/o),a=new Ft(d,o,i),l=this._context.getRenderGeometryBufferWriter(s.materialId);if(l==null)throw new Error("writer not found");const c=l.createBuffer(s,null);return this._transferables.add(c.data),{materialId:s.materialId,renderGeometryBuffer:c,boundingInfo:{bbMax:a.bbMax,bbMin:a.bbMin}}}),minScreenSpaceRadius:n.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:e,lodRenderGeometry:r}),e}addLodInstances(t,e){this._commands.push({id:"add-lod-instances",lodRendererId:t,data:e}),this._transferables.add(e.featureIds.buffer),this._transferables.add(e.globalTransforms.buffer),this._transferables.add(e.localTransforms.buffer)}removeLodInstances(t,e){this._commands.push({id:"remove-lod-instances",lodRendererId:t,featureIds:e}),this._transferables.add(e.buffer)}append(t){if(t._context!==this._context)throw new Error("Cannot append encoders from different contexts");const{_commands:e,_transferables:r}=this;for(const n of t._commands)e.push(n);for(const n of t._transferables)r.add(n)}async dispatch(){const t=this._commands,e=Array.from(this._transferables);this._clearCommandBuffer(),await this._context.dispatchRenderCommands(t,e)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};class jr{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===C.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new Dr(this)}async dispatchRenderCommands(e,r){e.length!==0&&await this._dispatchRenderCommandsCallback(e,r)}registerRenderGeometryBufferWriter(e,r){this._bufferWriters.set(e,r)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}let Z=class{constructor(t,e){this._renderCommands=t,this._pipelineStateCommands=e}append(t){this.appendRenderCommands(t._renderCommands),this.appendPipelineStateCommands(t._pipelineStateCommands)}appendRenderCommands(t){this._renderCommands.append(t)}appendPipelineStateCommand(t){this._pipelineStateCommands.push(t)}appendPipelineStateCommands(t){const{_pipelineStateCommands:e}=this;for(const r of t)e.push(r)}execute(){for(const t of this._pipelineStateCommands)t();this._renderCommands.dispatch()}};function oe(t,e){const{featureCount:r}=t;if(r===0)return new Uint32Array;const n=new Uint32Array(r);return t.readObjectIds(n),n}function Fe(t,e){const{featureCount:r}=t;if(r===0)return new Float64Array;const n=new Float64Array(3*r);return t.readCoordinates(n),n}function $r(t,e){const{featureCount:r}=t;if(r===0)return new Float64Array;const n=Fe(t),s=e.viewSpatialReference,i=e.renderSpatialReference,o=new Float64Array(3*r);if(!at(n,s,0,o,i,0,r))throw new Error("Failed to project coordinates");return o}function kr(t,e){const r=e.viewSpatialReference,n=e.renderSpatialReference,{extent:s}=t,i=st(s),o=E();return ee([i[0],i[1],0],r,o,n),o}function Be(t){const e=new Map;for(const[r,n]of t)e.set(r,{...n,indices:xt(n.indices)});return e}function Nr(t,e){const r=(n,s,i=!1)=>({levels:n.map(o=>{const d=Be(s(o.tesselation));return i&&Ur(d),{components:[{attributes:d,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(t){case"cone":return r(Qr,n=>Yt(1,.5,n,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function Ur(t){const e=t,r=e.get(g.POSITION).data,n=e.get(g.NORMAL).data;if(n){const s=be(t,g.NORMAL).data;for(let i=0;i<n.length;i+=3){const o=n[i+1];s[i+1]=-n[i+2],s[i+2]=o}}if(r){const s=be(t,g.POSITION).data;for(let i=0;i<r.length;i+=3){const o=r[i+1];s[i+1]=-r[i+2],s[i+2]=o}}}function be(t,e){let r=t.get(e);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:Bt(r.data)},t.set(e,r)),r}const Qr=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class zr{constructor(e){this._context=e,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder(),r=e.createMaterial("default"),n=Nr(this._primitive,r);this.lodRendererId=e.createLodRenderer(n),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const r=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");const{featureCount:n}=e;if(n===0)return r;const s=!0,i=et(tt(this._primitive)),o=ce(rt(i)),d=ce(nt(o,{isPrimitive:s,width:100,depth:null,height:null})),a=new Float64Array(16*n),l=new Float64Array(16*n),c=Fe(e,this._context);for(let u=0;u<n;++u){const f=u,x=c[3*u+0],R=c[3*u+1],S=c[3*u+2],V=this._computeGlobalTransform(x,R,S,this._context.viewSpatialReference,Wr),Y=this._computeLocalTransform(d,o,Hr);this._writeMatrixToTypedBuffer(a,f,Y),this._writeMatrixToTypedBuffer(l,f,V)}const h=oe(e,this._context),m={featureIds:new Uint32Array(h),localTransforms:a,globalTransforms:l};return r.addLodInstances(this.lodRendererId,m),r}async createRemoveCommand(e){const r=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)return r;const n=oe(e,this._context);return r.removeLodInstances(this.lodRendererId,n),r}_writeMatrixToTypedBuffer(e,r,n){let s=16*r;for(let i=0;i<16;i++)e[s++]=n[i]}_computeGlobalTransform(e,r,n,s,i){return N[0]=e,N[1]=r,N[2]=n,Wt(s,N,i,this._context.renderSpatialReference),i}_computeLocalTransform(e,r,n){return Ut(n),this._applyObjectScale(e,r,n),n}_applyObjectScale(e,r,n){const s=Vt(e,e,r,this._context.renderCoordsHelper.unitInMeters);s[0]===1&&s[1]===1&&s[2]===1||Qt(n,n,s)}}const N=E(),Hr=D(),Wr=D();class Vr{constructor(e){this._context=e,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder();this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const r=this._context.renderCommandContext.createEncoder();if(this.materialId==null)throw new Error("expected material not to be null");const{featureCount:n,id:s}=e;if(n===0)return r;const i=$r(e,this._context),o=kr(e,this._context),d=new Float64Array([0,0,1]),a=new Float64Array([255,255,255,255]),l=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),h=new Float64Array([0,0]),m=new Float64Array([0]),u=new Uint32Array(n);for(let w=0;w<n;++w)u[w]=w;const f=new Uint32Array(n);for(let w=0;w<n;++w)f[w]=0;const x=new I(i,u,3,!0),R=new I(d,f,3,!0),S=new I(h,f,2,!0),V=new I(a,f,4,!0),Y=new I(m,f,1,!0),Ge=new I(l,f,2,!0),Le=new I(c,f,4,!0),De=[[g.POSITION,x],[g.NORMAL,R],[g.UV0,S],[g.COLOR,V],[g.ROTATION,Y],[g.SIZE,Ge],[g.CENTEROFFSETANDDISTANCE,Le]],je={attributes:Be(De),objectAndLayerIdColor:void 0,transformation:D(),materialId:this.materialId};return r.addDirectRendererGeometry(s,je,o),r}async createRemoveCommand(e){const r=this._context.renderCommandContext.createEncoder();return r.removeDirectRendererGeometry(e.id),r}}class Yr{constructor(e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=e}async load(){this._symbols[0]=new Vr(this._context),this._symbols[1]=new zr(this._context)}async createAddCommand(e){const r=this._partition(e),n=await Promise.all(r.map(async({index:i,features:o})=>await(await this._provisionSymbol(i))?.createAddCommand(o))),s=this._context.renderCommandContext.createEncoder();for(const i of n)i!=null&&s.append(i);return new Z(s,[()=>{this._featureDataPartitioning.set(e,r)}])}async createRemoveCommand(e){const{_featureDataPartitioning:r}=this,n=r.get(e),s=this._context.renderCommandContext.createEncoder();if(n==null)return new Z(this._context.renderCommandContext.createEncoder(),[]);const i=await Promise.all(n.map(async({index:o,features:d})=>await this._getLoadedSymbol(o)?.createRemoveCommand(d)));for(const o of i)o!=null&&s.append(o);return new Z(s,[()=>{r.delete(e)}])}async _provisionSymbol(e){if(e==null)return null;const r=this._symbols[e];return r?(r.loaded||await r.load(),r):null}_getLoadedSymbol(e){if(e==null)return null;const r=this._symbols[e];return r!=null&&r.loaded?r:null}_partition(e){const r=oe(e,this._context);if(r==null)throw new Error("unable to fetch objectIds");const{featureCount:n}=e,s=[[],[]];for(let i=0;i<n;++i)s[r[i]%2].push(i);return s.map((i,o)=>new qr(o,e.subset(new Uint32Array(i)))).filter(i=>i.features.featureCount>0)}}class qr{constructor(e,r){this.index=e,this.features=r}}let Q=class extends Ie.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new br,this._featureStore=new Ir,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}async setup({viewSpatialReference:t,renderSpatialReference:e,viewingMode:r,baseQuery:n,url:s,objectIdField:i,capabilities:o,fieldsIndex:d,timeInfo:a,fullExtent:l}){const c=ae.fromJSON(t),h=ae.fromJSON(e);this._fetcher=new Pr(c,ue.fromJSON(n),s,i,o),this._queryEngine=new dt({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:i,fieldsIndex:d,availableFields:[i],spatialReference:t,featureStore:this._featureStore,timeInfo:a}),this._renderer=new Yr({viewSpatialReference:c,renderSpatialReference:h,renderCoordsHelper:H.create(r,h),renderCommandContext:new jr({viewingMode:r,dispatchRenderCommandsCallback:(u,f)=>this.remoteClient.invoke("dispatchRenderCommands",u,{transferList:f})})}),this._defaultQueryJSON=new ue({outSpatialReference:c}).toJSON();let m=null;if(l!=null){const u=$e.fromJSON(l);await it(u.spatialReference,c),m=ot(u,c)}return this._tileManager=new _({loadTile:(u,f)=>this._fetcher.fetch(u,f),createAddTileCommand:(u,f)=>this._createAddTileCommand(u,f),createRemoveTileCommand:u=>this._createRemoveTileCommand(u),extent:m}),this.addHandles(ke(()=>this.updating,u=>{this.emit("notify-updating",{updating:u})}),Ne),await this._renderer.load(),xe}async executeQuery(t,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(t),e)}}async executeQueryForIds(t,e){const r=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(t),e);return{result:Array.from(r)}}async executeQueryForCount(t,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(t),e)}}async executeQueryForExtent(t,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(t),e)}}async executeQueryForLatestObservations(t,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(t),e)}}async onTileTreeChange(t){return await this._tileManager.onTileTreeChange(t),xe}async _createAddTileCommand(t,e){const r=new wr(t),n=await this._renderer.createAddCommand(r);return z(e),n.appendPipelineStateCommand(()=>{this._featureDataStore.add(r),this._featureStore.addTile(t)}),n}async _createRemoveTileCommand(t){const e=this._featureStore,r=this._featureDataStore,n=this._renderer,s=r.get(t);if(s==null)return null;const i=await n.createRemoveCommand(s);return i.appendPipelineStateCommand(()=>{r.remove(t),e.removeTile(t)}),i}_ensureQuery(t){return t??this._defaultQueryJSON}};p([y()],Q.prototype,"updating",null),Q=p([L("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],Q);const Qs=Q,xe={result:void 0};export{Qs as default};
