import{v as y,I as S,t as pe,b9 as Ce,a as Oe,jN as Ie,cE as C,d6 as ye,K as Re,H as Se,dg as Me,aC as De,c as Z,ah as we,jO as Fe,jP as He,j7 as Ne,jQ as ee,jR as ze,jS as Ue,ct as Be}from"./main-DK5A1thH.js";import"./projection-m8vi7Cxv-ByA_2Rez.js";import{f as Pe}from"./projectVectorToVector-D0K_S4MR-BN7ztR9y.js";import{d as Ve,m as te}from"./vec2-BnynUbeJ-CKtGJQAy.js";import{t as L,l as Ge}from"./vec2f64-CEUyUoff-BBc0aQ6D.js";import{Y as W,j as z,M as We,a as q}from"./VerticalOffset.glsl-BtVaDxLq-Bbkz3TDV.js";import{n as V}from"./mat4f64-BaJwL7tQ-k0uMm8LY.js";import{A as $e,r as $,y as ie,Z as Y}from"./vec32-BuqRmYBM-Docn8r6P.js";import{o as ke,e as D}from"./vec4f64-CjUMzAyX-DPYbdAom.js";import{p as Te}from"./glUtil-n1JOrdV3-CRAZdee5.js";import{V as p,a as Ae}from"./InterleavedLayout-DcHoXu73-35D6EIGL.js";import{d as je,h as qe,f as Ye}from"./HUDMaterial.glsl-DUfp5PMk-jxjn1loR.js";import{o as E}from"./ShaderOutput-C_OqLoo1-jp3zUBgm.js";import{w as Xe,z as Ke}from"./HUDVisibility.glsl-Bl7zdrV0-B9Qw8wSm.js";import{I as X}from"./Octree-Kk-G5P_T-xRLR75Xc.js";import{T as c}from"./VertexAttribute-DFC3a3eR-BhmQtMsu.js";import{P as Je,k as Qe,V as Ze}from"./mat3-DOnW3DjW-C3hbW9XY.js";import{n as et}from"./mat3f64-Dh9_zhFu-BIT-k8Dm.js";import{B as tt}from"./mat4-BFStKTjU-BMLpTkEG.js";import{b as se,m as it,o as U,p as st,A as nt,X as ve,L as B,O as ne,l as ae}from"./BufferView-BBCzkcZS-BKSq5J5y.js";import{b as at,I as rt}from"./plane-B_adY3_o-Ns1JnzfT.js";import{u as Le}from"./VertexArrayObject-DTkLCIKs-UH72P2I_.js";import{n as xe}from"./enums-DBi1-Mm2-CUS1pvQe.js";import{H as ht,S as ot,U as lt}from"./sphere-Cj20syUS-P9gsXSIi.js";import{f as ct}from"./renderState-DlSSrLcZ-Du_EmLq6.js";import{S as dt}from"./DefaultMaterial-DGGIMylx-Co3fv8Ux.js";import{w as k}from"./HighlightDefaults-Cg50f_1y-CeQprwVu.js";import{i as _t,f as ut}from"./Scheduler-Br-2v2ys-DaLUn3wq.js";import{t as gt,r as ft}from"./Texture-DXSFJsEu-0d91IJKM.js";function ci(e,t,i){return!!Pe(e,t,H,i.spatialReference)&&(i.x=H[0],i.y=H[1],i.z=H[2],!0)}const H=C();function K(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}function mt(e){const{size:t}=e.definition,i=e.fontString(t);let s=re.get(i);if(!s){const n=K(It,0,0).getContext("2d");e.setFontProperties(n,t);const a=n.measureText(yt);s=new pt(a.actualBoundingBoxAscent,a.actualBoundingBoxDescent),re.set(i,s)}return s}const re=new Map;let pt=class{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}};const It={canvas:null},yt=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})(),be=1;let di=class{constructor(e,t,i,s){this.text=e,this._alignment=t,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`${e}--${this._parameters.key}-${this._alignment}`,this._lines=e.replaceAll(" ","Â ").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){const e=K(he,N,N).getContext("2d"),t=this._parameters.definition.pixelRatio,i=this._fontSize*t;this._parameters.setFontProperties(e,i);let s=2*this._haloSize;const n=this._parameters.definition.font;n.style!=="italic"&&n.style!=="oblique"&&n.weight!=="bold"&&n.weight!=="bolder"||(s+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let a=0,h=0,o=0,r=0,l=0;this._lines.forEach((G,M)=>{const x=e.measureText(G),F=x.width/t,Q=F+s;this._textWidths.push(F),this._lineWidths.push(Q),a=Math.max(a,Q),r=Math.max(r,x.actualBoundingBoxAscent/t),l=Math.max(l,x.actualBoundingBoxDescent/t),M===0&&(h=x.actualBoundingBoxAscent/t),M===this._lines.length-1&&(o=x.actualBoundingBoxDescent/t)});const _=mt(this._parameters),d=Math.max(r,_.maxAscent),m=Math.max(l,_.maxDescent),f=h,g=this._parameters.definition.font.decoration==="underline"?m:o,R=a;this._metricsCached=new St(f,g,d,m,R)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*Rt}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,be)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){const e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case b.Left:return this._horizontalPadding;case b.Center:return(this.displayWidth-this._lineWidths[e])/2;case b.Right:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,t,i){e.save();const s=t/=this.renderPixelRatio,n=i/=this.renderPixelRatio,a=this._haloSize,h=this._firstLineYOffset+this._metrics.firstLineAscent;t+=a,i+=h;const o=this._haloSize>0;o&&this._renderHalo(e,s,n,a,h),this._parameters.setFontProperties(e,this._renderedFontSize);for(let r=0;r<this._lines.length;++r){const l=this._lines[r],_=this._getLineXOffset(r);o&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,l,t+_,i),this._renderLineDecoration(e,t+_,i,this._textWidths[r])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,l,t+this._getLineXOffset(r),i),this._renderLineDecoration(e,t+_,i,this._textWidths[r]),i+=this._lineSpacing}if(z.TEXT_SHOW_BASELINE){e.strokeStyle=oe,e.setLineDash([2,2]),e.lineWidth=1;let r=n+h;for(let l=0;l<this._lines.length;++l)this._drawLine(e,[s,r],[s+this.displayWidth,r]),r+=this._lineSpacing}if(z.TEXT_SHOW_BORDER&&(e.strokeStyle=oe,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const r=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,n,r),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,i,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const a=1,h=Math.max(this._parameters.definition.size/16,a);switch(this._parameters.definition.font.decoration){case"underline":i+=2*h;break;case"line-through":i-=.33*this._midLineAscent}const o=n?this._haloSize:0;e.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(h+2*o),e.beginPath(),e.moveTo(this._toRenderUnit(t-o),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(t+s+o),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,t,i,s){t=this._toRenderUnit(t),i=this._toRenderUnit(i);const n=this.renderedWidth,a=this.renderedHeight;s!==0?(s=Be(s,0,Math.floor(a/2)),e.beginPath(),e.moveTo(t,i+s),e.arcTo(t,i,t+s,i,s),e.lineTo(t+n-s,i),e.arcTo(t+n,i,t+n,i+s,s),e.lineTo(t+n,i+a-s),e.arcTo(t+n,i+a,t+n-s,i+a,s),e.lineTo(t+s,i+a),e.arcTo(t,i+a,t,i+a-s,s),e.closePath()):e.rect(t,i,n,a)}_renderHalo(e,t,i,s,n){const a=this.renderedWidth,h=this.renderedHeight,o=K(he,Math.max(a,N),Math.max(h,N)),r=o.getContext("2d");r.clearRect(0,0,a,h),this._parameters.setFontProperties(r,this._renderedFontSize),r.fillStyle=this._parameters.haloStyle,r.strokeStyle=this._parameters.haloStyle;const l=this._renderedHaloSize<3;r.lineJoin=l?"miter":"round",l?this._renderHaloEmulated(r,s,n):this._renderHaloNative(r,s,n);let _=n;for(let d=0;d<this._lines.length;++d){const m=this._getLineXOffset(d);this._renderLineDecoration(r,s+m,_,this._textWidths[d],!0),_+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,a,h,this._toRenderUnit(t),this._toRenderUnit(i),a,h),e.globalAlpha=1}_renderHaloEmulated(e,t,i){for(let s=0;s<this._lines.length;++s){const n=this._lines[s],a=this._getLineXOffset(s);for(const[h,o]of Ee)this._fillText(e,n,t+a+this._haloSize*h,i+this._haloSize*o);i+=this._lineSpacing}}_renderHaloNative(e,t,i){const s=2*this._haloSize;for(let n=0;n<this._lines.length;++n){const a=this._lines[n],h=this._getLineXOffset(n),o=5,r=.1;for(let l=0;l<o;l++){const _=1-(o-1)*r+l*r;e.lineWidth=this._toRenderUnit(_*s),this._strokeText(e,a,t+h,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,i,s){e.fillText(t,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(e,t,i,s){e.strokeText(t,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(e,t,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,t,i){const s=this._toRenderUnit(t[0]),n=this._toRenderUnit(t[1]),a=this._toRenderUnit(i[0]),h=this._toRenderUnit(i[1]),o=Math.floor(s)+.5,r=Math.ceil(s+a)-.5,l=Math.floor(n)+.5,_=Math.ceil(n+h)-.5;e.beginPath(),e.moveTo(o,l),e.lineTo(r,l),e.lineTo(r,_),e.lineTo(o,_),e.lineTo(o,l),e.stroke()}};const Ee=[];for(let e=0;e<360;e+=360/16)Ee.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var b;(function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"})(b||(b={}));const he={canvas:null},Rt=.2,N=512,oe="rgb(255, 0, 255, 0.5)";let St=class{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,i,s,n){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=i,this.maxLineDescent=s,this.displayWidth=n}};const _i=Object.freeze({left:0,center:.5,right:1}),ui=Object.freeze({"bottom-left":L(0,0),bottom:L(.5,0),"bottom-right":L(1,0),left:L(0,.5),center:L(.5,.5),right:L(1,.5),"top-left":L(0,1),top:L(.5,1),"top-right":L(1,1)});function gi(e){switch(e){case"left":return b.Left;case"right":return b.Right;default:return b.Center}}function fi(e,t){switch(t){case"bottom":return e==="left"?"bottom-left":e==="right"?"bottom-right":"bottom";case"center":return e;case"top":return e==="left"?"top-left":e==="right"?"top-right":"top"}}function mi(e){return e==="middle"?"center":e}function pi(e,t){switch(e){case"top":return te(t,0,be);case"bottom":return te(t,0,-1);default:return Ve(t,Ge)}}class Tt{constructor(t,i){this._material=t,this._repository=i,this._map=new Map}dispose(){this._map.forEach((t,i)=>{t!=null&&this._repository.release(this._material,i)})}load(t,i,s){if(!this._material.produces.get(i)?.(s))return null;this._map.has(s)||this._map.set(s,this._repository.acquire(this._material,i,s));const n=this._map.get(s);if(n!=null){if(n.ensureResources(t)===ct.LOADED)return n;this._repository.requestRender()}return null}}let w=class{constructor(e=1/0,t=-1/0){this.near=e,this.far=t}set(e,t){this.near=e,this.far=t}union(e){e!=null&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far))}within(e){return this.near<=e&&e<=this.far}};w.zero=new w(0,0);class At{constructor(t,i,s){this._elementSize=i,this._buffer=Le.createVertex(t,xe.STATIC_DRAW),this.resize(s)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get usedMemory(){return this._array.byteLength+this._buffer.usedMemory}copyRange(t,i,s,n=0){const a=new Uint8Array(this.array,t*this.elementSize,(i-t)*this.elementSize);new Uint8Array(s.array,n*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(t,i){const s=t*this._elementSize,n=i*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),s,s,n)}resize(t){const i=t*this._elementSize,s=new ArrayBuffer(i);this._array&&(t>=this._capacity?new Uint8Array(s).set(new Uint8Array(this._array)):new Uint8Array(s).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=s,this._buffer.setSize(i),this._capacity=t}}class vt{constructor(t){this.modelOriginHi=t.getField(c.INSTANCEMODELORIGINHI,ae),this.modelOriginLo=t.getField(c.INSTANCEMODELORIGINLO,ae),this.model=t.getField(c.INSTANCEMODEL,U),this.modelNormal=t.getField(c.INSTANCEMODELNORMAL,U),this.featureAttribute=t.getField(c.INSTANCEFEATUREATTRIBUTE,ve),this.color=t.getField(c.INSTANCECOLOR,B),this.objectAndLayerIdColor=t.getField(c.INSTANCEOBJECTANDLAYERIDCOLOR,B)}}class Lt{constructor(t,i){this._rctx=t,this._instanceBufferLayout=i,this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get usedMemory(){return this._buffer?.usedMemory??0}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){p(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){p(this._updating,"not updating"),this.size<Fe*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){p(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),p(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){p(this._updating,"not updating"),p(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(P,Math.floor(this._capacity*Ie));this._resize(t)}_shrink(){const t=Math.max(P,Math.floor(this._capacity*He));this._resize(t)}_resize(t){if(p(this._updating,"not updating"),t===this._capacity)return;const i=new At(this._rctx,this._instanceBufferLayout.stride,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const s=this.size,n=this._compactInstances(i);p(n===s,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=n,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new vt(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const i=this._headIndex,s=this._tailIndex;return s<i?(this._buffer.copyRange(s,i,t),i-s):s>i?(this._buffer.copyRange(s,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-s),i+(this._capacity-s)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}}const P=64;var u;function xt(e){let t=Ae().mat4f64(c.LOCALTRANSFORM).mat4f64(c.GLOBALTRANSFORM).vec4f64(c.BOUNDINGSPHERE).vec3f64(c.MODELORIGIN).mat3f(c.INSTANCEMODEL).mat3f(c.INSTANCEMODELNORMAL).vec2f(c.MODELSCALEFACTORS);return e.includes(c.FEATUREATTRIBUTE)&&(t=t.vec4f(c.FEATUREATTRIBUTE)),e.includes(c.COLOR)&&(t=t.vec4u8(c.COLOR)),e.includes(c.OBJECTANDLAYERIDCOLOR)&&(t=t.vec4u8(c.OBJECTANDLAYERIDCOLOR)),t=t.u8(c.STATE).u8(c.LODLEVEL),t}(function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"})(u||(u={}));class le{constructor(t){this.localTransform=t.getField(c.LOCALTRANSFORM,se),this.globalTransform=t.getField(c.GLOBALTRANSFORM,se),this.modelOrigin=t.getField(c.MODELORIGIN,it),this.model=t.getField(c.INSTANCEMODEL,U),this.modelNormal=t.getField(c.INSTANCEMODELNORMAL,U),this.modelScaleFactors=t.getField(c.MODELSCALEFACTORS,st),this.boundingSphere=t.getField(c.BOUNDINGSPHERE,nt),this.featureAttribute=t.getField(c.FEATUREATTRIBUTE,ve),this.color=t.getField(c.COLOR,B),this.objectAndLayerIdColor=t.getField(c.OBJECTANDLAYERIDCOLOR,B),this.state=t.getField(c.STATE,ne),this.lodLevel=t.getField(c.LODLEVEL,ne)}}let O=class extends Ce{constructor(e,t){super(e),this.events=new Oe,this._capacity=0,this._size=0,this._next=0,this._highlightOptionsMap=new Map,this._highlightOptionsMapPrev=new Map,this._layout=xt(t),this._capacity=P,this._buffer=this._layout.createBuffer(this._capacity),this._view=new le(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,u.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;p(e>=0&&e<this._capacity&&!!(t.get(e)&u.ALLOCATED),"invalid instance handle"),this._getStateFlag(e,u.ACTIVE)?this._setStateFlags(e,u.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;p(e>=0&&e<this._capacity&&!!(t.get(e)&u.ALLOCATED),"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=I,s=T;t.localTransform.getMat(e,ce),t.globalTransform.getMat(e,j);const n=tt(j,j,ce);$e(i,n[12],n[13],n[14]),t.modelOrigin.setVec(e,i),Je(s,n),t.model.setMat(e,s);const a=at(I,n);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),Qe(s,s),Ze(s,s),t.modelNormal.setMat(e,s),this._setStateFlags(e,u.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,T),i.modelOrigin.getVec(e,I),t[0]=T[0],t[1]=T[1],t[2]=T[2],t[3]=0,t[4]=T[3],t[5]=T[4],t[6]=T[5],t[7]=0,t[8]=T[6],t[9]=T[7],t[10]=T[8],t[11]=0,t[12]=I[0],t[13]=I[1],t[14]=I[2],t[15]=1}applyShaderTransformation(e,t){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){this._view.localTransform.getMat(e,t),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(I,this,e),t*=Math.max(I[0],I[1],I[2])),t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(I,this,e),t*=bt(I[0],I[1],I[2])),t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,u.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,u.VISIBLE)}setHighlight(e,t){const{_highlightOptionsMap:i}=this,s=i.get(e);t?t!==s&&(i.set(e,t),this._setStateFlag(e,u.HIGHLIGHT,!0),this.events.emit("instance-highlight-changed")):s&&(i.delete(e),this._setStateFlag(e,u.HIGHLIGHT,!1),this.events.emit("instance-highlight-changed"))}get highlightOptionsMap(){return this._highlightOptionsMap}getHighlightStateFlag(e){return this._getStateFlag(e,u.HIGHLIGHT)}geHighlightOptionsPrev(e){const t=this._highlightOptionsMapPrev.get(e)??null;return this._highlightOptionsMapPrev.delete(e),t}getHighlightName(e){const t=this.highlightOptionsMap.get(e)??null;return t?this._highlightOptionsMapPrev.set(e,t):this._highlightOptionsMapPrev.delete(e),t}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){this._capacity=Math.max(P,Math.floor(this._capacity*Ie)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new le(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&u.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};function bt(e,t,i){return Math.max(Math.min(e,t),Math.min(Math.max(e,t),i))}y([S({constructOnly:!0})],O.prototype,"shaderTransformation",void 0),y([S()],O.prototype,"_size",void 0),y([S({readOnly:!0})],O.prototype,"size",null),O=y([pe("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],O);const I=C(),T=et(),ce=V(),j=V();class Et extends X{constructor(t,i){super(s=>ht(this._instanceData.view.boundingSphere.getVec(s,this._tmpSphere)),{maximumDepth:25}),this._instanceData=t,this._boundingSphere=i,this._tmpSphere=ot(),this._tmpMat4=V()}addInstance(t){const i=this._instanceData.view.boundingSphere,s=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);Y(lt(this._tmpSphere),this._boundingSphere.center,s),this._tmpSphere[3]=this._boundingSphere.radius*rt(s),i.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class Ct{constructor(t,i){this._worldSpaceRadius=t,this._minScreenSpaceRadii=i}selectLevel(t,i,s){const n=s.computeScreenPixelSizeAt(t),a=this._worldSpaceRadius*i/n;let h=0;for(let o=1;o<this._minScreenSpaceRadii.length;++o)a>=this._minScreenSpaceRadii[o]&&(h=o);return h}}let Ot=class{constructor(e,t){const i=e.renderContext.rctx,s=t.geometry,n=t.geometry.getRenderGeometry(),a=n.material;this._materials=e.materials,a.setParameters({instancedDoublePrecision:!0}),this.geometry=s,this.material=a,this.glMaterials=new Tt(a,this._materials),this.vertexBufferLayout=n.vertexBufferLayout,this.vbo=Le.createVertex(i,xe.STATIC_DRAW,n.buffer),this.vao=new Ye(i,q,new Map([["geometry",Te(n.vertexBufferLayout)]]),new Map([["geometry",this.vbo]])),this.vertexCount=n.elementCount}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,i,s,n,a,h,o){return this.geometry.intersect(e,t,i,s,n,a,h,o)}};class J{static async create(t,i,s){const n=await Promise.allSettled(i.components.map(h=>t.controller.schedule(()=>new Ot(t,h),s))),a=n.map(h=>h.status==="fulfilled"?h.value:null).filter(ye);if(Re(s)||a.length!==n.length){a.forEach(h=>h.destroy()),Se(s);for(const h of n)if(h.status==="rejected")throw h.reason}return new J(i.minScreenSpaceRadius,a)}constructor(t,i){this.minScreenSpaceRadius=t,this.components=i}destroy(){this.components.forEach(t=>t.destroy())}intersect(t,i,s,n,a,h,o){this.components.forEach(r=>r.intersect(t,i,s,n,a,h,this.boundingSphere,o))}get boundingBox(){if(this._boundingBox==null){const t=Ne();this.components.forEach(i=>{i.boundingInfo!=null&&(ee(t,i.boundingInfo.bbMin),ee(t,i.boundingInfo.bbMax))}),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const t=this.boundingBox,i=C();ze(t,i),this._boundingSphere={center:i,radius:.5*Ue(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((t,i)=>t+i.triangleCount,0)}}const Mt=e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map(s=>s.minScreenSpaceRadius);return new Ct(t,i)};let A=class extends je{constructor(e,t){super(e),this.type=Xe.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDataMap=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new qe,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[W.OPAQUE_MATERIAL,i=>this._produces(i)],[W.TRANSPARENT_MATERIAL,i=>!!this._hasTransparentLevels()&&this._produces(i)]]),this._instanceData=new O({shaderTransformation:e.shaderTransformation},e.optionalFields),this.addHandles(t.registerTask(_t.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=wt(this.optionalFields),this._glInstanceBufferLayout=Te(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)e.push(t[1]);return e}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDataMap)t[0]!==k&&e.push(t[1]);return e}hasHighlightOptions(e){return this._highlightRenderInstanceDataMap.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get hasEmissions(){return this._levels.some(e=>e.components.some(t=>t.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((i,s)=>i+s.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((i,s)=>i+s.usedMemory,0),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((i,s)=>{const n=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,a=i.triangleCount;t.push({renderedInstances:n,renderedTriangles:n*a,trianglesPerInstance:a})}),{totalInstances:e,renderedInstances:t.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:t.reduce((i,s)=>i+s.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(e=[]){const{rctx:t}=this._context.renderContext;return this.symbol.levels.map(i=>{e.push(new Lt(t,this._instanceBufferLayout))}),e}async initializeRenderContext(e,t){this._context=e,this._createRenderInstanceDataArray(this._defaultRenderInstanceData);const i=await Promise.allSettled(this.symbol.levels.map(n=>J.create(e,n,t))),s=i.map(n=>n.status==="fulfilled"?n.value:null).filter(ye);if(Re(t)||s.length!==i.length){s.forEach(n=>n.destroy()),Se(t);for(const n of i)if(n.status==="rejected")throw n.reason}this._levels=s,this._levelSelector=Mt(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDataMap.forEach(e=>e.forEach(t=>t.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(t=>t.material.produces.get(W.TRANSPARENT_MATERIAL)?.(E.Color)))}hasHighlights(){return Me(this._highlightRenderInstanceDataMap,e=>e.some(t=>t.size>0))}_produces(e){return(e!==E.Highlight||this.hasHighlights())&&(e!==E.ShadowHighlight||this.hasHighlightOptions(k))}prepareRender(e){if(!z.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(ut),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const i=new Array,s=this.levels;return t.forEach(n=>s.forEach(({components:a},h)=>a.forEach(o=>i.push(this._beginComponent(e,n[h],o))))),i}render(e,t){const i=this._getInstanceDatas(e);if(!i||t==null)return;let s=0;e.rctx.bindVAO();const n=this.levels;i.forEach(a=>n.forEach(({components:h},o)=>h.forEach(r=>this._renderComponent(e,t[s++],a[o],r,o))))}_getInstanceDatas(e){const{output:t,bind:i}=e,s=t===E.Highlight,n=t===E.ShadowHighlight,a=!s&&!n,h=t!==E.ShadowExcludeHighlight;if(a)return h?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;if(h){if(s){const r=i.highlight?.name;if(!r)return null;const l=this._highlightRenderInstanceDataMap.get(r);return l?[l]:null}const o=this._highlightRenderInstanceDataMap.get(k);return n?o?[o]:null:Array.from(this._highlightRenderInstanceDataMap.values())}return null}intersect(e,t,i,s){if(!this.baseMaterial.visible||this._octree==null)return;const n=C();$(n,s,i);const a=h=>{this._instanceData.getCombinedModelTransform(h,ue),e.transform.set(ue),Y(ge,i,e.transform.inverse),Y(fe,s,e.transform.inverse);const o=this._instanceData.getState(h),r=this._instanceData.getLodLevel(h),l=this._levels.length;p(!!(o&u.ACTIVE),"invalid instance state"),p(r>=0&&r<l,"invaid lod level"),this._levels[r].intersect(e,t,ge,fe,h,this.metadata,l)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(i,n,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){const e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new Et(e,this.baseBoundingSphere);for(let i=0;i<e.capacity;++i)t.get(i)&u.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=De(this._octreeCached)}queryDepthRange(e){if(this._octree==null)return new w;const t=e.viewForward,i=this._octree.findClosest(t,X.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(t,X.DepthOrder.BACK_TO_FRONT,e.frustum);if(i==null||s==null)return new w;const n=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(i,v),$(v,v,n);const h=ie(v,t)-v[3];a.boundingSphere.getVec(s,v),$(v,v,n);const o=ie(v,t)+v[3];return new w(h,o)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(t=>t.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach(_=>_.forEach(d=>d.beginUpdate()));const n=this._instanceData,a=n.view;let h=n.size;const o=n.capacity;let r=this._instanceIndex;const l=Math.ceil(o/500);for(let _=0;_<h&&!e.done;++_){r===this._cycleStartIndex&&this._startUpdateCycle();const d=a.state.get(r);let m=0;if(!(d&u.ALLOCATED)){r=r+1===o?0:r+1,h++;continue}const f=a.lodLevel.get(r);if(d&u.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[f].freeTail(),d&u.HIGHLIGHT_ACTIVE){const g=n.geHighlightOptionsPrev(r);if(g){const R=this._highlightRenderInstanceDataMap.get(g);if(!R)throw new Z("Internal error in lodRenderer");R[f].freeTail()}}if(d&u.REMOVE)n.freeInstance(r);else if(d&u.VISIBLE){let g=0;if(t&&(a.modelOrigin.getVec(r,_e),g=s.selectLevel(_e,n.getCombinedMedianScaleFactor(r),i)),m=d&~(u.ACTIVE|u.TRANSFORM_CHANGED),g>=0)if(d&u.HIGHLIGHT){const R=n.getHighlightName(r);if(R){const G=()=>{const x=this._createRenderInstanceDataArray();return x.forEach(F=>F.beginUpdate()),x},M=we(this._highlightRenderInstanceDataMap,R,G);if(g>=M.length)throw new Z(`LodRenderer internal error - missing lodLevel ${g}`);de(M[g],a,r)}m|=u.HIGHLIGHT_ACTIVE}else de(this._defaultRenderInstanceData[g],a,r),m|=u.DEFAULT_ACTIVE;a.state.set(r,m),a.lodLevel.set(r,g)}else m=d&~(u.ACTIVE|u.TRANSFORM_CHANGED),a.state.set(r,m);if(this._octreeCached!=null){const g=!!(d&u.ACTIVE),R=!!(m&u.ACTIVE);!g&&R?this._octreeCached.addInstance(r):g&&!R?this._octreeCached.removeInstance(r):g&&R&&d&u.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(r),this._octreeCached.addInstance(r))}r=r+1===o?0:r+1,r%l==0&&e.madeProgress()}this._instanceIndex=r,this._allRenderInstanceData.forEach(_=>_.forEach(d=>d.endUpdate())),this._context.requestRender()}_beginComponent(e,t,i){return t.size===0?null:i.glMaterials.load(e.rctx,e.bind.slot,e.output)?.beginSlot(e.bind)}_renderComponent(e,t,i,s,n){if(!t)return;const{bind:a,rctx:h}=e;h.runAppleAmdDriverHelper();const o=h.bindTechnique(t,a,s.material.parameters,Ft);h.bindVAO(s.vao),t.ensureAttributeLocations(s.vao),z.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===E.Color&&(o.setUniform4fv("externalColor",me[Math.min(n,me.length-1)]),o.setUniform1i("colorMixMode",We.replace));const r=i.capacity,l=i.headIndex,_=i.tailIndex,d=i.firstIndex,m=this._glInstanceBufferLayout,f=(g,R)=>{gt(h,q,i.buffer,m,g),h.drawArraysInstanced(t.primitiveType,0,s.vertexCount,R-g),ft(h,q,i.buffer,m)};s.material.parameters.transparent&&d!=null?l>_?(p(d>=_&&d<=l,"invalid firstIndex"),f(d,l),f(_,d)):l<_&&(d<=l?(p(d>=0&&d<=l,"invalid firstIndex"),f(d,l),f(_,r),f(0,d)):(p(d>=_&&d<=r,"invalid firstIndex"),f(d,r),f(0,l),f(_,d))):l>_?f(_,l):l<_&&(f(0,l),f(_,r)),h.bindVAO(null)}};function de(e,t,i){const s=e.allocateHead();Dt(t,i,e.view,s)}function Dt(e,t,i,s){Ke(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,s),i.model.copyFrom(s,e.model,t),i.modelNormal.copyFrom(s,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(s,e.color,t),e.objectAndLayerIdColor&&i.objectAndLayerIdColor&&i.objectAndLayerIdColor.copyFrom(s,e.objectAndLayerIdColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(s,e.featureAttribute,t)}function wt(e){let t=Ae().vec3f(c.INSTANCEMODELORIGINHI).vec3f(c.INSTANCEMODELORIGINLO).mat3f(c.INSTANCEMODEL).mat3f(c.INSTANCEMODELNORMAL);return e!=null&&e.includes("featureAttribute")&&(t=t.vec4f(c.INSTANCEFEATUREATTRIBUTE)),e!=null&&e.includes("color")&&(t=t.vec4u8(c.INSTANCECOLOR)),e!=null&&e.includes("objectAndLayerIdColor")&&(t=t.vec4u8(c.INSTANCEOBJECTANDLAYERIDCOLOR)),t}y([S({constructOnly:!0})],A.prototype,"symbol",void 0),y([S({constructOnly:!0})],A.prototype,"optionalFields",void 0),y([S({constructOnly:!0})],A.prototype,"metadata",void 0),y([S({constructOnly:!0})],A.prototype,"shaderTransformation",void 0),y([S()],A.prototype,"_instanceData",void 0),y([S()],A.prototype,"_cycleStartIndex",void 0),y([S({readOnly:!0})],A.prototype,"_enableLevelSelection",null),y([S()],A.prototype,"_updateCyclesWithStaticCamera",void 0),y([S({readOnly:!0})],A.prototype,"running",null),A=y([pe("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],A);const _e=C(),v=ke(),ue=V(),ge=C(),fe=C(),me=[D(1,0,1,1),D(0,0,1,1),D(0,1,0,1),D(1,1,0,1),D(1,0,0,1)],Ft=new dt;export{mi as C,fi as E,ui as L,pi as O,K as P,Tt as S,A as a,gi as b,di as c,mt as m,_i as x,ci as y};
