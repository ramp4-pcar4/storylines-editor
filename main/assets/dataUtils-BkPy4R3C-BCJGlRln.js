import{v as O,S as $,ad as _t,i as Dt,aK as Rt,e as Lt,o as Nt,P as Et,a1 as Z,K as et,$ as jt,ff as At,aG as Gt,n as Ot,bj as Wt}from"./main-BNyfiy7F.js";let bt=class{constructor(t=null,e=null,n=null){this.minValue=t,this.maxValue=e,this.noDataValue=n}};const $t=9999999e31,qt=2e-7,zt={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE],unknown:void 0,c64:void 0,c128:void 0};function lt(t){return zt[t]??[-34028234663852886e22,34028234663852886e22]}function ke(t,e){return t==null||e==null?"s32":t<0?t>=-128&&e<128?"s8":t>=-32768&&e<32768?"s16":"s32":e<256?"u8":e<65536?"u16":"u32"}function Kt(t){return(t?.startsWith("s")||t?.startsWith("u"))??!1}function Me(t,e,n,r){let[o,s]=lt(n);const i=Kt(n);return i&&(o-=1e-5,s+=1e-5),i?n.startsWith("u")?Xt(t,e,r,[o,s]):Jt(t,e,r,[o,s]):Ht(t,e,r,[o,s])}function Ae(t,e){for(let n=0;n<e.length;n++)e[n]&&isNaN(t[n])&&(e[n]=0,t[n]=0)}function Xt(t,e,n,r){const[o,s]=r;for(let i=0;i<e.length;i++)if(e[i]){const c=t[i];c<o||c>s?e[i]=0:n[i]=c+.5|0}}function Jt(t,e,n,r){const[o,s]=r;for(let i=0;i<e.length;i++)if(e[i]){const c=t[i];c<o||c>s?e[i]=0:n[i]=c+(c>0?.5:-.5)|0}}function Ht(t,e,n,r){const[o,s]=r;for(let i=0;i<e.length;i++)if(e[i]){const c=t[i];c<o||c>s?e[i]=0:n[i]=c}}function be(t,e,n){if(t.depthCount&&t.depthCount>1)return;const{pixels:r,statistics:o,pixelType:s}=t,i=r[0].length,c=t.bandMasks??[],a=t.mask??new Uint8Array(i).fill(255),h=s==="f32"||s==="f64",l=lt(s);let f=!1;for(let p=0;p<r.length;p++){const u=typeof e=="number"?e:e[p];if(u==null)continue;const m=o?.[p]?.minValue??l[0],d=o?.[p]?.maxValue??l[1];if(m>u+Number.EPSILON||d<u-Number.EPSILON)continue;const g=c[p]||a.slice(),k=r[p],M=n?.customFloatTolerance;if(h&&M!==0){let y=M;y||(y=Math.abs(u)>=$t?qt*Math.abs(u):s==="f32"?2**-23:Number.EPSILON);for(let w=0;w<k.length;w++)g[w]&&Math.abs(k[w]-u)<y&&(k[w]=0,g[w]=0,a[w]=0,f=!0)}else for(let y=0;y<k.length;y++)g[y]&&k[y]===u&&(k[y]=0,g[y]=0,a[y]=0,f=!0);c[p]=g}f&&(t.bandMasks=t.bandMasks||t.pixels.length>1?c:null,t.mask=a),f&&"updateStatistics"in t&&t.updateStatistics()}var J;let G=J=class extends Lt{static createEmptyBand(t,e){return new(J.getPixelArrayConstructor(t))(e)}static combineBandMasks(t){if(t.length<2)return t[0];const e=t[0].length,n=new Uint8Array(e).fill(255);for(let r=0;r<t.length;r++){const o=t[r];for(let s=0;s<e;s++)o[s]||(n[s]=0)}return n}static getPixelArrayConstructor(t){let e;switch(t){case"u1":case"u2":case"u4":case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":e=Float32Array;break;case"f64":e=Float64Array}return e}constructor(t){super(t),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(t){if(!t)return"f32";let e=t.toLowerCase();return["u1","u2","u4"].includes(e)?e="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(e)||(e="f32"),e}getPlaneCount(){return this.pixels?.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new Nt("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics??new bt)}getAsRGBA(){const t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)}getAsRGBAFloat(){const t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(n=>Yt(n,this.mask));const t=this.mask;let e=0;if(t!=null)for(let n=0;n<t.length;n++)t[n]&&e++;else e=this.width*this.height;this.validPixelCount=e}clamp(t){if(!t||t==="f64"||t==="f32"||!this.pixels)return;const[e,n]=lt(t),r=this.pixels,o=this.width*this.height,s=r.length;let i,c,a;const h=[];for(let l=0;l<s;l++){a=J.createEmptyBand(t,o),i=r[l];for(let f=0;f<o;f++)c=i[f],a[f]=c>n?n:c<e?e:c;h.push(a)}this.pixels=h,this.pixelType=t}extractBands(t){const{pixels:e,statistics:n}=this;if(t==null||t.length===0||!e||e.length===0)return this;const r=e.length,o=t.some(f=>f>=e.length),s=r===t.length&&!t.some((f,p)=>f!==p);if(o||s)return this;const i=this.bandMasks?.length===r?t.map(f=>this.bandMasks[f]):void 0;let{mask:c,validPixelCount:a}=this;const{width:h,height:l}=this;return i?.length&&(c=J.combineBandMasks(i),a=c.filter(f=>!!f).length),new J({pixelType:this.pixelType,width:h,height:l,mask:c,bandMasks:i,validPixelCount:a,maskIsAlpha:this.maskIsAlpha,pixels:t.map(f=>e[f]),statistics:n&&t.map(f=>n[f])})}clone(){const t=new J({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let e;this.mask!=null&&(t.mask=new Uint8Array(this.mask)),this.bandMasks&&(t.bandMasks=this.bandMasks.map(r=>new Uint8Array(r)));const n=J.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];const r=!!this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=r?this.pixels[e].slice():new n(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=Et(this.statistics[e]);return t.premultiplyAlpha=this.premultiplyAlpha,t}_fillFrom8Bit(t){const{mask:e,maskIsAlpha:n,premultiplyAlpha:r,pixels:o}=this;if(!t||!o?.length)return void Z.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let s,i,c,a;s=i=c=o[0],o.length>=3?(i=o[1],c=o[2]):o.length===2&&(i=o[1]);const h=new Uint32Array(t),l=this.width*this.height;if(s.length===l)if(e!=null&&e.length===l)if(n)for(a=0;a<l;a++){const f=e[a];if(f){const p=f/255;h[a]=r?f<<24|c[a]*p<<16|i[a]*p<<8|s[a]*p:f<<24|c[a]<<16|i[a]<<8|s[a]}}else for(a=0;a<l;a++)e[a]&&(h[a]=255<<24|c[a]<<16|i[a]<<8|s[a]);else for(a=0;a<l;a++)h[a]=255<<24|c[a]<<16|i[a]<<8|s[a];else Z.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(t){const{pixels:e,mask:n,statistics:r}=this;if(!t||!e?.length)return void Z.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const o=this.pixelType;let s=1,i=0,c=1;if(r&&r.length>0){for(const d of r)if(d.minValue!=null&&(i=Math.min(i,d.minValue)),d.maxValue!=null&&d.minValue!=null){const g=d.maxValue-d.minValue;c=Math.max(c,g)}s=255/c}else{let d=255;o==="s8"?(i=-128,d=127):o==="u16"?d=65535:o==="s16"?(i=-32768,d=32767):o==="u32"?d=4294967295:o==="s32"?(i=-2147483648,d=2147483647):o==="f32"?(i=-34e38,d=34e38):o==="f64"&&(i=-Number.MAX_VALUE,d=Number.MAX_VALUE),s=255/(d-i)}const a=new Uint32Array(t),h=this.width*this.height;let l,f,p,u,m;if(l=f=p=e[0],l.length!==h)return Z.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(e.length>=2)if(f=e[1],e.length>=3&&(p=e[2]),n!=null&&n.length===h)for(u=0;u<h;u++)n[u]&&(a[u]=255<<24|(p[u]-i)*s<<16|(f[u]-i)*s<<8|(l[u]-i)*s);else for(u=0;u<h;u++)a[u]=255<<24|(p[u]-i)*s<<16|(f[u]-i)*s<<8|(l[u]-i)*s;else if(n!=null&&n.length===h)for(u=0;u<h;u++)m=(l[u]-i)*s,n[u]&&(a[u]=255<<24|m<<16|m<<8|m);else for(u=0;u<h;u++)m=(l[u]-i)*s,a[u]=255<<24|m<<16|m<<8|m}_fillFrom32Bit(t){const{pixels:e,mask:n}=this;if(!t||!e?.length)return Z.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let r,o,s,i;r=o=s=e[0],e.length>=3?(o=e[1],s=e[2]):e.length===2&&(o=e[1]);const c=this.width*this.height;if(r.length!==c)return Z.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let a=0;if(n!=null&&n.length===c)for(i=0;i<c;i++)t[a++]=r[i],t[a++]=o[i],t[a++]=s[i],t[a++]=1&n[i];else for(i=0;i<c;i++)t[a++]=r[i],t[a++]=o[i],t[a++]=s[i],t[a++]=1}};function Yt(t,e){let n=1/0,r=-1/0;const o=t.length;let s,i=0;if(e!=null)for(s=0;s<o;s++)e[s]&&(i=t[s],n=i<n?i:n,r=i>r?i:r);else for(s=0;s<o;s++)i=t[s],n=i<n?i:n,r=i>r?i:r;return new bt(n,r)}O([$({json:{write:!0}})],G.prototype,"width",void 0),O([$({json:{write:!0}})],G.prototype,"height",void 0),O([$({json:{write:!0}})],G.prototype,"pixelType",void 0),O([_t("pixelType")],G.prototype,"castPixelType",null),O([$({json:{write:!0}})],G.prototype,"validPixelCount",void 0),O([$({json:{write:!0}})],G.prototype,"mask",void 0),O([$({json:{write:!0}})],G.prototype,"maskIsAlpha",void 0),O([$({json:{write:!0}})],G.prototype,"pixels",void 0),O([$()],G.prototype,"premultiplyAlpha",void 0),O([$({json:{write:!0}})],G.prototype,"statistics",void 0),O([$({json:{write:!0}})],G.prototype,"depthCount",void 0),O([$({json:{write:!0}})],G.prototype,"noDataValues",void 0),O([$({json:{write:!0}})],G.prototype,"bandMasks",void 0),G=J=O([Dt("esri.layers.support.PixelBlock")],G);const D=G;var dt,mt;(function(t){t[t.matchAny=0]="matchAny",t[t.matchAll=1]="matchAll"})(dt||(dt={})),function(t){t[t.bestMatch=0]="bestMatch",t[t.fail=1]="fail"}(mt||(mt={}));const ve=6;function L(t){return t!=null&&t.declaredClass==="esri.layers.support.PixelBlock"&&t.pixels&&t.pixels.length>0}function Ue(t){if(!t?.length||t.some(l=>!L(l)))return null;if(t.length===1)return t[0]?.clone()??null;const e=t,{width:n,height:r,pixelType:o}=e[0];if(e.some(l=>l.width!==n||l.height!==r))return null;const s=e.map(({mask:l})=>l).filter(l=>l!=null);let i=null;s.length&&(i=new Uint8Array(n*r),i.set(s[0]),s.length>1&&Ut(s.slice(1),i));const c=[];e.forEach(({pixels:l})=>c.push(...l));const a=e.map(({statistics:l})=>l).filter(l=>l?.length),h=[];return a.forEach(l=>h.push(...l)),new D({pixelType:o,width:n,height:r,mask:i,pixels:c,statistics:h.length?h:null})}function Pe(t){if(!t)return;const e=t.colormap;if(!e||e.length===0)return;const n=e.sort((f,p)=>f[0]-p[0]);let r=0;n[0][0]<0&&(r=n[0][0]);const o=Math.max(256,n[n.length-1][0]-r+1),s=new Uint8Array(4*o),i=[];let c,a=0,h=0;const l=n[0].length===5;if(o>65536)return n.forEach(f=>{i[f[0]-r]=l?f.slice(1):f.slice(1).concat([255])}),{indexed2DColormap:i,offset:r,alphaSpecified:l};if(t.fillUnspecified)for(c=n[h],a=c[0]-r;a<o;a++)s[4*a]=c[1],s[4*a+1]=c[2],s[4*a+2]=c[3],s[4*a+3]=l?c[4]:255,a===c[0]-r&&(c=h===n.length-1?c:n[++h]);else for(a=0;a<n.length;a++)c=n[a],h=4*(c[0]-r),s[h]=c[1],s[h+1]=c[2],s[h+2]=c[3],s[h+3]=l?c[4]:255;return{indexedColormap:s,offset:r,alphaSpecified:l}}function Ie(t,e){if(!L(t)||!e||!e.indexedColormap&&!e.indexed2DColormap)return t;const n=t.clone(),r=n.pixels;let o=n.mask;const s=n.width*n.height;if(r.length!==1)return t;const{indexedColormap:i,indexed2DColormap:c,offset:a,alphaSpecified:h}=e;let l=0;const f=r[0],p=new Uint8Array(f.length),u=new Uint8Array(f.length),m=new Uint8Array(f.length);let d,g=0;if(i){const k=i.length-1;if(o!=null)for(l=0;l<s;l++)o[l]&&(g=4*(f[l]-a),g<a||g>k?o[l]=0:(p[l]=i[g],u[l]=i[g+1],m[l]=i[g+2],o[l]=i[g+3]));else{for(o=new Uint8Array(s),l=0;l<s;l++)g=4*(f[l]-a),g<a||g>k?o[l]=0:(p[l]=i[g],u[l]=i[g+1],m[l]=i[g+2],o[l]=i[g+3]);n.mask=o}}else if(c)if(o!=null)for(l=0;l<s;l++)o[l]&&(d=c[f[l]],p[l]=d[0],u[l]=d[1],m[l]=d[2],o[l]=d[3]);else{for(o=new Uint8Array(s),l=0;l<s;l++)d=c[f[l]],p[l]=d[0],u[l]=d[1],m[l]=d[2],o[l]=d[3];n.mask=o}return n.pixels=[p,u,m],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=h,n}function Be(t,e){if(!L(t))return null;const{pixels:n,mask:r}=t,o=n.length;let s=e.lut;const{offset:i}=e;s&&s[0].length===1&&(s=n.map(()=>s));const c=[],a=e.outputPixelType||"u8";for(let l=0;l<o;l++){const f=vt(n[l],r,s[l],i||0,a);c.push(f)}const h=new D({width:t.width,height:t.height,pixels:c,mask:r,pixelType:a});return h.updateStatistics(),h}function vt(t,e,n,r,o){const s=t.length,i=D.createEmptyBand(o,s);if(e)for(let c=0;c<s;c++)e[c]&&(i[c]=n[t[c]-r]);else for(let c=0;c<s;c++)i[c]=n[t[c]-r];return i}function Te(t,e){if(!L(t))return null;const n=t.clone(),{pixels:r}=n,o=n.width*n.height,s=e.length,i=Math.floor(s/2),c=e[Math.floor(i)],a=r[0];let h,l,f,p,u,m,d=!1;const g=new Uint8Array(o),k=new Uint8Array(o),M=new Uint8Array(o);let y=n.mask;const w=e[0].mappedColor.length===4;for(y||(y=new Uint8Array(o),y.fill(w?255:1),n.mask=y),u=0;u<o;u++)if(y[u]){for(h=a[u],d=!1,m=i,l=c,f=0,p=s-1;p-f>1;){if(h===l.value){d=!0;break}h>l.value?f=m:p=m,m=Math.floor((f+p)/2),l=e[Math.floor(m)]}d||(h===e[f].value?(l=e[f],d=!0):h===e[p].value?(l=e[p],d=!0):h<e[f].value?(d=!1,l=null):h>e[f].value&&(h<e[p].value?(l=e[f],d=!0):p===s-1?(d=!1,l=null):(l=e[p],d=!0))),d?(g[u]=l.mappedColor[0],k[u]=l.mappedColor[1],M[u]=l.mappedColor[2],y[u]=l.mappedColor[3]):g[u]=k[u]=M[u]=y[u]=0}return n.pixels=[g,k,M],n.mask=y,n.pixelType="u8",n.maskIsAlpha=w,n}function Se(t,e){if(!L(t))return null;const{width:n,height:r}=t,{inputRanges:o,outputValues:s,outputPixelType:i,noDataRanges:c,allowUnmatched:a,isLastInputRangeInclusive:h}=e,l=t.pixels[0],f=D.createEmptyBand(i,l.length),p=t.mask,u=new Uint8Array(n*r);p?u.set(p):u.fill(255);const m=t.pixelType.startsWith("f")?1e-6:0,d=o.map(w=>w-m);d[0]=o[0],d[d.length-1]=o[o.length-1]+(h?1e-6:0);const g=o.length/2,[k,M]=lt(i);for(let w=0;w<r;w++)for(let x=0;x<n;x++){const b=w*n+x;if(u[b]){const U=l[b];let P=!1;for(let T=g-1;T>=0;T--)if(U===d[2*T]||U>d[2*T]&&U<d[2*T+1]){f[b]=s[T],P=!0;break}P||(a?f[b]=U>M?M:U<k?k:U:u[b]=0)}}const y=c?.length;if(y)for(let w=0;w<r;w++)for(let x=0;x<n;x++){const b=w*n+x;if(!p||p[b]){const U=l[b];for(let P=0;P<y;P+=2)if(U>=c[P]&&U<=c[P+1]){f[b]=0,u[b]=0;break}}}return new D({width:n,height:r,pixelType:i,pixels:[f],mask:u})}function gt(t,e,n,r){const o=n!=null&&n.length>=2?new Set(n):null,s=n?.length===1?n[0]:null,i=!!e?.length;for(let c=0;c<t.length;c++)if(r[c]){const a=t[c];if(i){let h=!1;for(let l=0;l<e.length;l+=2)if(a>=e[l]&&a<=e[l+1]){h=!0;break}h||(r[c]=0)}r[c]&&(a===s||o?.has(a))&&(r[c]=0)}}function xt(t,e){const n=t[0].length;for(let r=0;r<n;r++)if(e[r]){let o=!1;for(let s=0;s<t.length;s++)if(t[s][r]){o=!0;break}o||(e[r]=0)}}function Ut(t,e){const n=t[0].length;for(let r=0;r<n;r++)if(e[r]){let o=!1;for(let s=0;s<t.length;s++)if(t[s][r]===0){o=!0;break}o&&(e[r]=0)}}function Fe(t,e){if(!L(t))return null;const{width:n,height:r,pixels:o}=t,s=n*r,i=new Uint8Array(s);t.mask?i.set(t.mask):i.fill(255);const c=o.length,{includedRanges:a,noDataValues:h,outputPixelType:l,matchAll:f,lookups:p}=e;if(p){const u=[];for(let m=0;m<c;m++){const d=p[m],g=vt(o[m],i,d.lut,d.offset||0,"u8");u.push(g)}u.length===1?i.set(u[0]):f?xt(u,i):Ut(u,i)}else if(f){const u=[];for(let m=0;m<c;m++){const d=new Uint8Array(s);d.set(i),gt(o[m],a?.slice(2*m,2*m+2),h?.[m],d),u.push(d)}u.length===1?i.set(u[0]):xt(u,i)}else for(let u=0;u<c;u++)gt(o[u],a?.slice(2*u,2*u+2),h?.[u],i);return new D({width:n,height:r,pixelType:l,pixels:o,mask:i})}function Ve(t){const{srcPixelType:e,inputRanges:n,outputValues:r,allowUnmatched:o,noDataRanges:s,isLastInputRangeInclusive:i,outputPixelType:c}=t;if(e!=="u8"&&e!=="s8"&&e!=="u16"&&e!=="s16")return null;const a=e.includes("16")?65536:256,h=e.includes("s")?-a/2:0,l=D.createEmptyBand(c,a),f=new Uint8Array(a);o&&f.fill(255);const[p,u]=lt(c);if(n?.length&&r?.length){const m=n.map(d=>d-1e-6);m[0]=n[0],i&&(m[m.length-1]=n[n.length-1]);for(let d=0;d<m.length;d++){const g=r[d]>u?u:r[d]<p?p:r[d],k=Math.ceil(m[2*d]-h),M=Math.floor(m[2*d+1]-h);for(let y=k;y<=M;y++)l[y]=g,f[y]=255}}if(s?.length)for(let m=0;m<s.length;m++){const d=Math.ceil(s[2*m]-h),g=Math.floor(s[2*m+1]-h);for(let k=d;k<=g;k++)f[k]=0}return{lut:l,offset:h,mask:f}}function Ce(t,e,n){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const r=t.includes("16")?65536:256,o=t.includes("s")?-r/2:0,s=new Uint8Array(r);if(e)for(let i=0;i<e.length;i++){const c=Math.ceil(e[2*i]-o),a=Math.floor(e[2*i+1]-o);for(let h=c;h<=a;h++)s[h]=255}else s.fill(255);if(n)for(let i=0;i<n.length;i++)s[n[i]-o]=0;return{lut:s,offset:o}}function Zt(t,e,n,r,o,s,i,c){return{xmin:o<=n*t?0:o<n*t+t?o-n*t:t,ymin:s<=r*e?0:s<r*e+e?s-r*e:e,xmax:o+i<=n*t?0:o+i<n*t+t?o+i-n*t:t,ymax:s+c<=r*e?0:s+c<r*e+e?s+c-r*e:e}}function _e(t,e){if(!t||t.length===0)return null;const n=t.find(m=>m.pixelBlock);if(n?.pixelBlock==null)return null;const r=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,o=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,s=.01*Math.min(r,o),i=t.sort((m,d)=>Math.abs(m.extent.ymax-d.extent.ymax)>s?d.extent.ymax-m.extent.ymax:Math.abs(m.extent.xmin-d.extent.xmin)>s?m.extent.xmin-d.extent.xmin:0),c=Math.min.apply(null,i.map(m=>m.extent.xmin)),a=Math.min.apply(null,i.map(m=>m.extent.ymin)),h=Math.max.apply(null,i.map(m=>m.extent.xmax)),l=Math.max.apply(null,i.map(m=>m.extent.ymax)),f={x:Math.round((e.xmin-c)/r),y:Math.round((l-e.ymax)/o)},p={width:Math.round((h-c)/r),height:Math.round((l-a)/o)},u={width:Math.round((e.xmax-e.xmin)/r),height:Math.round((e.ymax-e.ymin)/o)};return Math.round(p.width/n.pixelBlock.width)*Math.round(p.height/n.pixelBlock.height)!==i.length||f.x<0||f.y<0||p.width<u.width||p.height<u.height?null:{extent:e,pixelBlock:Qt(i.map(m=>m.pixelBlock),p,{clipOffset:f,clipSize:u})}}function ht(t,e,n,r,o,s){const{width:i,height:c}=n.block,{x:a,y:h}=n.offset,{width:l,height:f}=n.mosaic,p=Zt(i,c,r,o,a,h,l,f);let u=0,m=0;if(s){const d=s.hasGCSSShiftTransform?360:s.halfWorldWidth??0,g=i*s.resolutionX,k=s.startX+r*g;k<d&&k+g>d?m=s.rightPadding:k>=d&&(u=s.leftMargin-s.rightPadding,m=0)}if(p.xmax-=m,typeof e!="number")for(let d=p.ymin;d<p.ymax;d++){const g=(o*c+d-h)*l+(r*i-a)+u,k=d*i;for(let M=p.xmin;M<p.xmax;M++)t[g+M]=e[k+M]}else for(let d=p.ymin;d<p.ymax;d++){const g=(o*c+d-h)*l+(r*i-a)+u;for(let k=p.xmin;k<p.xmax;k++)t[g+k]=e}}function Qt(t,e,n={}){const{clipOffset:r,clipSize:o,alignmentInfo:s,blockWidths:i}=n;if(i)return te(t,e,{blockWidths:i});const c=t.find(v=>L(v));if(c==null)return null;const a=o?o.width:e.width,h=o?o.height:e.height,l=c.width,f=c.height,p=e.width/l,u=e.height/f,m={offset:r||{x:0,y:0},mosaic:o||e,block:{width:l,height:f}},d=c.pixelType,g=D.getPixelArrayConstructor(d),k=c.pixels.length,M=[];let y,w;for(let v=0;v<k;v++){w=new g(a*h);for(let B=0;B<u;B++)for(let A=0;A<p;A++){const I=t[B*p+A];L(I)&&(y=I.pixels[v],ht(w,y,m,A,B,s))}M.push(w)}const x=t.some(v=>v==null||v.mask!=null&&v.mask.length>0),b=t.some(v=>v?.bandMasks&&v.bandMasks.length>1),U=x?new Uint8Array(a*h):void 0,P=b?[]:void 0;if(U){for(let v=0;v<u;v++)for(let B=0;B<p;B++){const A=t[v*p+B],I=A!=null?A.mask:null;ht(U,I??(A?255:0),m,B,v,s)}if(P)for(let v=0;v<k;v++){const B=new Uint8Array(a*h);for(let A=0;A<u;A++)for(let I=0;I<p;I++){const V=t[A*p+I],S=V?.bandMasks?.[v]??V?.mask;ht(B,S??(V?255:0),m,I,A,s)}P.push(B)}}const T=new D({width:a,height:h,pixels:M,pixelType:d,bandMasks:P,mask:U});return T.updateStatistics(),T}function te(t,e,n){const r=t.find(g=>g!=null);if(r==null)return null;const o=t.some(g=>g==null||!!g.mask),{width:s,height:i}=e,c=o?new Uint8Array(s*i):null,{blockWidths:a}=n,h=[],l=r.getPlaneCount(),f=D.getPixelArrayConstructor(r.pixelType);if(o)for(let g=0,k=0;g<t.length;k+=a[g],g++){const M=t[g];if(!L(M))continue;const y=M.mask;for(let w=0;w<i;w++)for(let x=0;x<a[g];x++)c[w*s+x+k]=y==null?255:y[w*M.width+x]}const p=t.some(g=>g?.bandMasks&&g.bandMasks.length>1),u=p?[]:void 0,m=s*i;for(let g=0;g<l;g++){const k=new f(m),M=p?new Uint8Array(m):void 0;for(let y=0,w=0;y<t.length;w+=a[y],y++){const x=t[y];if(!L(x))continue;const b=x.pixels[g];if(b!=null){for(let U=0;U<i;U++)for(let P=0;P<a[y];P++)k[U*s+P+w]=b[U*x.width+P];if(M){const U=x.bandMasks?.[g]??x.mask;for(let P=0;P<i;P++)for(let T=0;T<a[y];T++)M[P*s+T+w]=U?U[P*x.width+T]:255}}}h.push(k),u&&M&&u.push(M)}const d=new D({width:s,height:i,mask:c,bandMasks:u,pixels:h,pixelType:r.pixelType});return d.updateStatistics(),d}function De(t,e,n){if(!L(t))return null;const{width:r,height:o}=t,s=e.x,i=e.y,c=n.width+s,a=n.height+i;if(s<0||i<0||c>r||a>o||s===0&&i===0&&c===r&&a===o)return t;t.mask||(t.mask=new Uint8Array(r*o));const h=t.mask;for(let l=0;l<o;l++){const f=l*r;for(let p=0;p<r;p++)h[f+p]=l<i||l>=a||p<s||p>=c?0:1}return t.updateStatistics(),t}function ee(t){if(!L(t))return null;const e=t.clone(),{width:n,height:r,pixels:o}=t,s=o[0],i=e.pixels[0],c=t.mask;for(let a=2;a<r-1;a++){const h=new Map;for(let f=a-2;f<a+2;f++)for(let p=0;p<4;p++){const u=f*n+p;st(h,s[u],c?c[u]:1)}i[a*n]=wt(h),i[a*n+1]=i[a*n+2]=i[a*n];let l=3;for(;l<n-1;l++){let f=(a-2)*n+l+1;st(h,s[f],c?c[f]:1),f=(a-1)*n+l+1,st(h,s[f],c?c[f]:1),f=a*n+l+1,st(h,s[f],c?c[f]:1),f=(a+1)*n+l+1,st(h,s[f],c?c[f]:1),f=(a-2)*n+l-3,rt(h,s[f],c?c[f]:1),f=(a-1)*n+l-3,rt(h,s[f],c?c[f]:1),f=a*n+l-3,rt(h,s[f],c?c[f]:1),f=(a+1)*n+l-3,rt(h,s[f],c?c[f]:1),i[a*n+l]=wt(h)}i[a*n+l+1]=i[a*n+l]}for(let a=0;a<n;a++)i[a]=i[n+a]=i[2*n+a],i[(r-1)*n+a]=i[(r-2)*n+a];return e.updateStatistics(),e}function wt(t){if(t.size===0)return 0;let e=0,n=-1,r=0;const o=t.keys();let s=o.next();for(;!s.done;)r=t.get(s.value),r>e&&(n=s.value,e=r),s=o.next();return n}function rt(t,e,n){if(n===0)return;const r=t.get(e);r===1?t.delete(e):t.set(e,r-1)}function st(t,e,n){n!==0&&t.set(e,t.has(e)?t.get(e)+1:1)}function Pt(t,e,n){let{x:r,y:o}=e;const{width:s,height:i}=n;if(r===0&&o===0&&i===t.height&&s===t.width)return t;const{width:c,height:a}=t,h=Math.max(0,o),l=Math.max(0,r),f=Math.min(r+s,c),p=Math.min(o+i,a);if(f<0||p<0||!L(t))return null;r=Math.max(0,-r),o=Math.max(0,-o);const{pixels:u}=t,m=s*i,d=u.length,g=[];for(let w=0;w<d;w++){const x=u[w],b=D.createEmptyBand(t.pixelType,m);for(let U=h;U<p;U++){const P=U*c;let T=(U+o-h)*s+r;for(let v=l;v<f;v++)b[T++]=x[P+v]}g.push(b)}const k=new Uint8Array(m),M=t.mask;for(let w=h;w<p;w++){const x=w*c;let b=(w+o-h)*s+r;for(let U=l;U<f;U++)k[b++]=M?M[x+U]:1}const y=new D({width:n.width,height:n.height,pixelType:t.pixelType,pixels:g,mask:k});return y.updateStatistics(),y}function It(t,e=!0){if(!L(t))return null;const{pixels:n,width:r,height:o,mask:s,pixelType:i}=t,c=[],a=Math.round(r/2),h=Math.round(o/2),l=o-1,f=r-1;for(let u=0;u<n.length;u++){const m=n[u],d=D.createEmptyBand(i,a*h);let g=0;for(let k=0;k<o;k+=2)for(let M=0;M<r;M+=2){const y=m[k*r+M];if(e){const w=M===f?y:m[k*r+M+1],x=k===l?y:m[k*r+M+r],b=M===f?x:k===l?w:m[k*r+M+r+1];d[g++]=(y+w+x+b)/4}else d[g++]=y}c.push(d)}let p=null;if(s!=null){p=new Uint8Array(a*h);let u=0;for(let m=0;m<o;m+=2)for(let d=0;d<r;d+=2){const g=s[m*r+d];if(e){const k=d===f?g:s[m*r+d+1],M=m===l?g:s[m*r+d+r],y=d===f?M:m===l?k:s[m*r+d+r+1];p[u++]=g*k*M*y?1:0}else p[u++]=g}}return new D({width:a,height:h,pixelType:i,pixels:c,mask:p})}function Re(t,e,n=0,r=!0){if(!L(t))return null;const{width:o,height:s}=e;let{width:i,height:c}=t;const a=new Map,h={x:0,y:0},l=1+n;let f=t;for(let p=0;p<l;p++){const u=Math.ceil(i/o),m=Math.ceil(c/s);for(let d=0;d<m;d++){h.y=d*s;for(let g=0;g<u;g++){h.x=g*o;const k=Pt(f,h,e);a.set(`${p}/${d}/${g}`,k)}}p<l-1&&(f=It(f,r)),i=Math.round(i/2),c=Math.round(c/2)}return a}function Le(t){const{pixelBlock:e,tileSize:n,level:r,row:o,col:s,useBilinear:i}=t;if(!L(e))return null;const{width:c,height:a}=n,h=2**r,l=h*c,f=h*a;let p=Pt(e,{y:o*f,x:s*l},{width:l,height:f});if(!p)return null;for(let u=r;u>0;u--)p=It(p,i);return p}function Bt(t,e,n,r,o=0){const{width:s,height:i}=t,{width:c,height:a}=e,h=r.cols,l=r.rows,f=Math.ceil(c/h-.1/h),p=Math.ceil(a/l-.1/l);let u,m,d,g,k,M,y;const w=f*h,x=w*p*l,b=new Float32Array(x),U=new Float32Array(x),P=new Uint32Array(x),T=new Uint32Array(x);let v,B,A=0;for(let I=0;I<p;I++)for(let V=0;V<f;V++){u=12*(I*f+V),m=n[u],d=n[u+1],g=n[u+2],k=n[u+3],M=n[u+4],y=n[u+5];for(let S=0;S<l;S++){A=(I*l+S)*w+V*h,B=(S+.5)/l;for(let F=0;F<S;F++)v=(F+.5)/h,b[A+F]=(m*v+d*B+g)*s+o,U[A+F]=(k*v+M*B+y)*i+o,P[A+F]=Math.floor(b[A+F]),T[A+F]=Math.floor(U[A+F])}u+=6,m=n[u],d=n[u+1],g=n[u+2],k=n[u+3],M=n[u+4],y=n[u+5];for(let S=0;S<l;S++){A=(I*l+S)*w+V*h,B=(S+.5)/l;for(let F=S;F<h;F++)v=(F+.5)/h,b[A+F]=(m*v+d*B+g)*s+o,U[A+F]=(k*v+M*B+y)*i+o,P[A+F]=Math.floor(b[A+F]),T[A+F]=Math.floor(U[A+F])}}return{offsets_x:b,offsets_y:U,offsets_xi:P,offsets_yi:T,gridWidth:w}}function Ne(t,e){const{coefficients:n,spacing:r}=e,{offsets_x:o,offsets_y:s,gridWidth:i}=Bt(t,t,n,{rows:r[0],cols:r[1]}),{width:c,height:a}=t,h=new Float32Array(c*a),l=180/Math.PI;for(let f=0;f<a;f++)for(let p=0;p<c;p++){const u=f*i+p,m=f===0?u:u-i,d=f===a-1?u:u+i,g=o[m]-o[d],k=s[d]-s[m];if(isNaN(g)||isNaN(k))h[f*c+p]=90;else{let M=Math.atan2(k,g)*l;M=(360+M)%360,h[f*c+p]=M}}return h}function Ee(t,e,n,r,o="nearest"){if(!L(t))return null;o==="majority"&&(t=ee(t));const{pixels:s,mask:i,bandMasks:c,pixelType:a}=t,h=t.width,l=t.height,f=D.getPixelArrayConstructor(a),p=s.length,{width:u,height:m}=e;let d=!1;for(let A=0;A<n.length;A+=3)n[A]===-1&&n[A+1]===-1&&n[A+2]===-1&&(d=!0);const{offsets_x:g,offsets_y:k,offsets_xi:M,offsets_yi:y,gridWidth:w}=Bt({width:h,height:l},e,n,r,o==="majority"?.5:0);let x;const b=(A,I,V,S)=>{const F=A instanceof Float32Array||A instanceof Float64Array?0:.5;for(let N=0;N<m;N++){x=N*w;for(let C=0;C<u;C++){if(g[x]<0||k[x]<0)A[N*u+C]=0;else if(S)A[N*u+C]=I[M[x]+y[x]*h];else{const j=Math.floor(g[x]),W=Math.floor(k[x]),q=Math.ceil(g[x]),X=Math.ceil(k[x]),K=g[x]-j,H=k[x]-W;if(!V||V[j+W*h]&&V[q+W*h]&&V[j+X*h]&&V[q+X*h]){const tt=(1-K)*I[j+W*h]+K*I[q+W*h],_=(1-K)*I[j+X*h]+K*I[q+X*h];A[N*u+C]=(1-H)*tt+H*_+F}else A[N*u+C]=I[M[x]+y[x]*h]}x++}}},U=[];let P;const T=c?.length===p,v=[];for(let A=0;A<p;A++){if(T){const I=new Uint8Array(u*m);b(I,c[A],c[A],!0),v.push(I)}P=new f(u*m),b(P,s[A],T?c[A]:i,o==="nearest"||o==="majority"),U.push(P)}const B=new D({width:u,height:m,pixelType:a,pixels:U,bandMasks:T?v:void 0});if(i!=null)B.mask=new Uint8Array(u*m),b(B.mask,i,i,!0);else if(d){B.mask=new Uint8Array(u*m);for(let A=0;A<u*m;A++)B.mask[A]=g[A]<0||k[A]<0?0:1}return B.updateStatistics(),B}const Q=new Map;Q.set("meter-per-second",1),Q.set("kilometer-per-hour",.277778),Q.set("knots",.514444),Q.set("feet-per-second",.3048),Q.set("mile-per-hour",.44704);const ft=180/Math.PI,ut=5,at=new Rt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function pt(t,e){return Q.get(t)/Q.get(e)||1}function Tt(t){return(450-t)%360}function St(t,e="geographic"){const[n,r]=t,o=Math.sqrt(n*n+r*r);let s=Math.atan2(r,n)*ft;return s=(360+s)%360,e==="geographic"&&(s=Tt(s)),[o,s]}function ne(t,e="geographic"){let n=t[1];e==="geographic"&&(n=Tt(n)),n%=360;const r=t[0];return[r*Math.cos(n/ft),r*Math.sin(n/ft)]}function je(t,e,n,r="geographic"){if(!L(t)||n==null)return t;const o=e==="vector-magdir"?t.clone():yt(t,e),s=o.pixels[1];for(let i=0;i<s.length;i++)s[i]=r==="geographic"?(s[i]+n[i]+270)%360:(s[i]+360-n[i])%360;return e==="vector-magdir"?o:yt(o,"vector-magdir")}function yt(t,e,n="geographic",r=1){if(!L(t))return t;const{pixels:o,width:s,height:i}=t,c=s*i,a=o[0],h=o[1],l=t.pixelType.startsWith("f")?t.pixelType:"f32",f=D.createEmptyBand(l,c),p=D.createEmptyBand(l,c);let u=0;for(let d=0;d<i;d++)for(let g=0;g<s;g++)e==="vector-uv"?([f[u],p[u]]=St([a[u],h[u]],n),f[u]*=r):([f[u],p[u]]=ne([a[u],h[u]],n),f[u]*=r,p[u]*=r),u++;const m=new D({pixelType:l,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[f,p]});return m.updateStatistics(),m}function Ge(t,e,n=1){if(n===1||!L(t))return t;const r=t.clone(),{pixels:o,width:s,height:i}=r,c=o[0];o[1];let a=0;for(let h=0;h<i;h++)for(let l=0;l<s;l++)c[a]*=n,a++;return r.updateStatistics(),r}function Oe(t,e,n,r,o){if(o==null||!o.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/r),height:Math.round(n/r),resolution:t.width/e};const s=o.xmin,i=o.ymax,c=(t.xmax-t.xmin)/e*r,a=(t.ymax-t.ymin)/n*r,h=(c+a)/2;return t.xmin=s+Math.floor((t.xmin-s)/c)*c,t.xmax=s+Math.ceil((t.xmax-s)/c)*c,t.ymin=i+Math.floor((t.ymin-i)/a)*a,t.ymax=i+Math.ceil((t.ymax-i)/a)*a,{extent:t,width:Math.round(t.width/c),height:Math.round(t.height/a),resolution:h}}const ie=Ft(0,0,0);function Ft(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const o=r?-1:1,s=13*o,i=-7*o,c=-2*o,a=-16*o,h=21.75,[l,f]=E(0,e+s,n,h),[p,u]=E(t-5.5,e+i,n,h),[m,d]=E(t+5.5,e+i,n,h),[g,k]=E(t-1.5,e+c,n,h),[M,y]=E(t+1.5,e+c,n,h),[w,x]=E(t-1.5,e+a,n,h),[b,U]=E(t+1.5,e+a,n,h);return[l,f,p,u,g,k,M,y,m,d,w,x,b,U]}function se(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=10,o=n?-1:1,s=5*o,i=20*o,c=25*o,a=45,h=0,l=0,f=2,p=0,u=f*o,m=n?1:-1,d=r/2*m;let[g,k]=[h+d,l-i],[M,y]=[g+f*m,k],[w,x]=[M-p*m,y+u],[b,U]=[h-d,l-c],[P,T]=[b+p*m,U-u],v=Math.ceil(t/ut),B=Math.floor(v/10);v-=8*B;const A=[],I=[];for(let K=0;K<v/2;K++,B--){B<=0&&v%2==1&&K===(v-1)/2&&(b=h,P=b+p*m,U=(U+k)/2,T=U-u);const[H,tt]=E(b,U,e,a);if(B>0){const[_,R]=E(M,U,e,a),[nt,it]=E(g,k,e,a);A.push(_),A.push(R),A.push(H),A.push(tt),A.push(nt),A.push(it)}else{const[_,R]=E(M,y,e,a),[nt,it]=E(w,x,e,a),[Vt,Ct]=E(P,T,e,a);I.push(H),I.push(tt),I.push(Vt),I.push(Ct),I.push(nt),I.push(it),I.push(_),I.push(R)}U+=s,k+=s,y+=s,x+=s,T+=s}const[V,S]=E(h+d,l+i,e,a),F=(r/2+f)*m,[N,C]=E(h+F,l+i,e,a),[j,W]=E(h+d,l-c,e,a),[q,X]=E(h+F,l-c,e,a);return{pennants:A,barbs:I,shaft:[V,S,N,C,j,W,q,X]}}function E(t,e,n,r=1){const o=Math.sqrt(t*t+e*e)/r,s=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[o,(2*Math.PI+s-n)%(2*Math.PI)]}const ot=[0,1,3,6,10,16,21,27,33,40,47,55,63],le=[0,.5,1,1.5,2],re=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function Y(t,e,n,r){const o=pt(r||"knots",n);let s;for(s=1;s<e.length;s++)if(s===e.length-1){if(t<e[s]*o)break}else if(t<=e[s]*o)break;return Math.min(s-1,e.length-2)}function oe(t,e,n,r,o){let s=0;switch(e){case"beaufort_kn":s=Y(t,ot,"knots",n);break;case"beaufort_km":s=Y(t,ot,"kilometer-per-hour",n);break;case"beaufort_ft":s=Y(t,ot,"feet-per-second",n);break;case"beaufort_m":s=Y(t,ot,"meter-per-second",n);break;case"classified_arrow":s=Y(t,o??[],r,n);break;case"ocean_current_m":s=Y(t,le,"meter-per-second",n);break;case"ocean_current_kn":s=Y(t,re,"knots",n)}return s}function ae(t,e){const{style:n,inputUnit:r,outputUnit:o,breakValues:s}=e,i=at.fromJSON(r),c=at.fromJSON(o),a=7*6,h=15;let l=0,f=0;const{width:p,height:u,mask:m}=t,d=t.pixels[0],g=t.pixels[1],k=m!=null?m.filter(x=>x>0).length:p*u,M=new Float32Array(k*a),y=new Uint32Array(h*k),w=e.invertDirection?Ft(0,0,0,!1):ie;for(let x=0;x<u;x++)for(let b=0;b<p;b++){const U=x*p+b;if(!m||m[x*p+b]){const P=(g[U]+360)%360/180*Math.PI,T=oe(d[U],n,i,c,s);for(let B=0;B<w.length;B+=2)M[l++]=(b+.5)/p,M[l++]=(x+.5)/u,M[l++]=w[B],M[l++]=w[B+1]+P,M[l++]=T,M[l++]=d[U];const v=7*(l/a-1);y[f++]=v,y[f++]=v+1,y[f++]=v+2,y[f++]=v+0,y[f++]=v+4,y[f++]=v+3,y[f++]=v+0,y[f++]=v+2,y[f++]=v+3,y[f++]=v+2,y[f++]=v+5,y[f++]=v+3,y[f++]=v+5,y[f++]=v+6,y[f++]=v+3}}return{vertexData:M,indexData:y}}const ct=[];function he(t,e){if(ct.length===0)for(let u=0;u<30;u++)ct.push(se(5*u,0,!e.invertDirection));const n=pt(at.fromJSON(e.inputUnit),"knots"),{width:r,height:o,mask:s}=t,i=t.pixels[0],c=t.pixels[1],a=6,h=[],l=[];let f=0,p=0;for(let u=0;u<o;u++)for(let m=0;m<r;m++){const d=u*r+m,g=i[d]*n;if((!s||s[u*r+m])&&g>=ut){const k=(c[d]+360)%360/180*Math.PI,{pennants:M,barbs:y,shaft:w}=ct[Math.min(Math.floor(g/5),29)];if(M.length+y.length===0)continue;let x=h.length/a;const b=(m+.5)/r,U=(u+.5)/o;for(let P=0;P<M.length;P+=2)h[f++]=b,h[f++]=U,h[f++]=M[P],h[f++]=M[P+1]+k,h[f++]=0,h[f++]=g;for(let P=0;P<y.length;P+=2)h[f++]=b,h[f++]=U,h[f++]=y[P],h[f++]=y[P+1]+k,h[f++]=0,h[f++]=g;for(let P=0;P<w.length;P+=2)h[f++]=b,h[f++]=U,h[f++]=w[P],h[f++]=w[P+1]+k,h[f++]=0,h[f++]=g;for(let P=0;P<M.length/6;P++)l[p++]=x,l[p++]=x+1,l[p++]=x+2,x+=3;for(let P=0;P<y.length/8;P++)l[p++]=x,l[p++]=x+1,l[p++]=x+2,l[p++]=x+1,l[p++]=x+2,l[p++]=x+3,x+=4;l[p++]=x+0,l[p++]=x+1,l[p++]=x+2,l[p++]=x+1,l[p++]=x+3,l[p++]=x+2,x+=4}}return{vertexData:new Float32Array(h),indexData:new Uint32Array(l)}}function ce(t,e){let n=0,r=0;const{width:o,height:s,mask:i}=t,c=t.pixels[0],a=[],h=[],l=pt(at.fromJSON(e.inputUnit),"knots"),f=e.style==="wind_speed"?ut:Number.MAX_VALUE;for(let p=0;p<s;p++)for(let u=0;u<o;u++){const m=c[p*o+u]*l;if((!i||i[p*o+u])&&m<f){for(let g=0;g<4;g++)a[n++]=(u+.5)/o,a[n++]=(p+.5)/s,a[n++]=g<2?-.5:.5,a[n++]=g%2==0?-.5:.5,a[n++]=0,a[n++]=m;const d=4*(n/24-1);h[r++]=d,h[r++]=d+1,h[r++]=d+2,h[r++]=d+1,h[r++]=d+2,h[r++]=d+3}}return{vertexData:new Float32Array(a),indexData:new Uint32Array(h)}}function We(t,e){return e.style==="simple_scalar"?ce(t,e):e.style==="wind_speed"?he(t,e):ae(t,e)}function $e(t,e,n,r=[0,0],o=.5){const{width:s,height:i,mask:c}=t,[a,h]=t.pixels,[l,f]=r,p=Math.round((s-l)/n),u=Math.round((i-f)/n),m=p*u,d=new Float32Array(m),g=new Float32Array(m),k=new Uint8Array(m);for(let y=0;y<u;y++)for(let w=0;w<p;w++){let x=0;const b=y*p+w,U=Math.max(0,y*n+f),P=Math.max(0,w*n+l),T=Math.min(i,U+n),v=Math.min(s,P+n);for(let B=U;B<T;B++)for(let A=P;A<v;A++){const I=B*s+A;if(!c||c[I]){x++;const V=[a[I],h[I]],[S,F]=V;d[b]+=S,g[b]+=F}}if(x>=(T-U)*(v-P)*(1-o)){k[b]=1;const[B,A]=St([d[b]/x,g[b]/x]);d[b]=B,g[b]=A}else k[b]=0,d[b]=0,g[b]=0}const M=new D({width:p,height:u,pixels:[d,g],mask:k});return M.updateStatistics(),M}const z=()=>Z.getLogger("esri.views.2d.engine.flow.dataUtils"),fe=10;async function qe(t,e,n,r){const o=performance.now(),s=ue(e,n),i=performance.now(),c=de(e,s,n.width,n.height),a=performance.now(),h=ge(c),l=performance.now(),f=t==="Streamlines"?xe(h,fe):we(h),p=performance.now();return et("esri-2d-profiler")&&(z().info("I.1","_createFlowFieldFromData (ms)",Math.round(i-o)),z().info("I.2","_getStreamlines (ms)",Math.round(a-i)),z().info("I.3","createAnimatedLinesData (ms)",Math.round(l-a)),z().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-l)),z().info("I.5","createFlowMesh (ms)",Math.round(p-o)),z().info("I.6","Mesh size (bytes)",f.vertexData.buffer.byteLength+f.indexData.buffer.byteLength)),await Promise.resolve(),jt(r),f}function ue(t,e){const n=me(e.data,e.width,e.height,t.smoothing);return t.interpolate?(r,o)=>{const s=Math.floor(r),i=Math.floor(o);if(s<0||s>=e.width)return[0,0];if(i<0||i>=e.height)return[0,0];const c=r-s,a=o-i,h=s,l=i,f=s<e.width-1?s+1:s,p=i<e.height-1?i+1:i,u=n[2*(l*e.width+h)],m=n[2*(l*e.width+f)],d=n[2*(p*e.width+h)],g=n[2*(p*e.width+f)],k=n[2*(l*e.width+h)+1],M=n[2*(l*e.width+f)+1];return[(u*(1-a)+d*a)*(1-c)+(m*(1-a)+g*a)*c,(k*(1-a)+n[2*(p*e.width+h)+1]*a)*(1-c)+(M*(1-a)+n[2*(p*e.width+f)+1]*a)*c]}:(r,o)=>{const s=Math.round(r),i=Math.round(o);return s<0||s>=e.width||i<0||i>=e.height?[0,0]:[n[2*(i*e.width+s)],n[2*(i*e.width+s)+1]]}}function pe(t,e,n,r,o,s,i,c,a){const h=[];let l=n,f=r,p=0,[u,m]=e(l,f);u*=t.velocityScale,m*=t.velocityScale;const d=Math.sqrt(u*u+m*m);let g,k;h.push({x:l,y:f,t:p,speed:d});for(let M=0;M<t.verticesPerLine;M++){let[y,w]=e(l,f);y*=t.velocityScale,w*=t.velocityScale;const x=Math.sqrt(y*y+w*w);if(x<t.minSpeedThreshold)return h;const b=y/x,U=w/x;if(l+=b*t.segmentLength,f+=U*t.segmentLength,p+=t.segmentLength/x,Math.acos(b*g+U*k)>t.maxTurnAngle)return h;if(t.collisions){const P=Math.round(l*a),T=Math.round(f*a);if(P<0||P>i-1||T<0||T>c-1)return h;const v=s[T*i+P];if(v!==-1&&v!==o)return h;s[T*i+P]=o}h.push({x:l,y:f,t:p,speed:x}),g=b,k=U}return h}function de(t,e,n,r){const o=[],s=new At,i=1/Math.max(t.lineCollisionWidth,1),c=Math.round(n*i),a=Math.round(r*i),h=new Int32Array(c*a);for(let f=0;f<h.length;f++)h[f]=-1;const l=[];for(let f=0;f<r;f+=t.lineSpacing)for(let p=0;p<n;p+=t.lineSpacing)l.push({x:p,y:f,sort:s.getFloat()});l.sort((f,p)=>f.sort-p.sort);for(const{x:f,y:p}of l)if(s.getFloat()<t.density){const u=pe(t,e,f,p,o.length,h,c,a,i);if(u.length<2)continue;o.push(u)}return o}function me(t,e,n,r){if(r===0)return t;const o=Math.round(3*r),s=new Array(2*o+1);let i=0;for(let h=-o;h<=o;h++){const l=Math.exp(-h*h/(r*r));s[h+o]=l,i+=l}for(let h=-o;h<=o;h++)s[h+o]/=i;const c=new Float32Array(t.length);for(let h=0;h<n;h++)for(let l=0;l<e;l++){let f=0,p=0;for(let u=-o;u<=o;u++){if(l+u<0||l+u>=e)continue;const m=s[u+o];f+=m*t[2*(h*e+(l+u))],p+=m*t[2*(h*e+(l+u))+1]}c[2*(h*e+l)]=f,c[2*(h*e+l)+1]=p}const a=new Float32Array(t.length);for(let h=0;h<e;h++)for(let l=0;l<n;l++){let f=0,p=0;for(let u=-o;u<=o;u++){if(l+u<0||l+u>=n)continue;const m=s[u+o];f+=m*c[2*((l+u)*e+h)],p+=m*c[2*((l+u)*e+h)+1]}a[2*(l*e+h)]=f,a[2*(l*e+h)+1]=p}return a}function ge(t,e){const n=new At,r=t.reduce((a,h)=>a+h.length,0),o=new Float32Array(4*r),s=new Array(t.length);let i=0,c=0;for(const a of t){const h=i;for(const l of a)o[4*i]=l.x,o[4*i+1]=l.y,o[4*i+2]=l.t,o[4*i+3]=l.speed,i++;s[c++]={startVertex:h,numberOfVertices:a.length,totalTime:a[a.length-1].t,timeSeed:n.getFloat()}}return{lineVertices:o,lineDescriptors:s}}function xe(t,e){const{lineVertices:n,lineDescriptors:r}=t;let o=0,s=0;for(const p of r)o+=2*p.numberOfVertices,s+=6*(p.numberOfVertices-1);const i=new Float32Array(o*9),c=new Uint32Array(s);let a=0,h=0;function l(){c[h++]=a-2,c[h++]=a,c[h++]=a-1,c[h++]=a,c[h++]=a+1,c[h++]=a-1}function f(p,u,m,d,g,k,M,y){const w=a*9;let x=0;i[w+x++]=p,i[w+x++]=u,i[w+x++]=1,i[w+x++]=m,i[w+x++]=k,i[w+x++]=M,i[w+x++]=d/2,i[w+x++]=g/2,i[w+x++]=y,a++,i[w+x++]=p,i[w+x++]=u,i[w+x++]=-1,i[w+x++]=m,i[w+x++]=k,i[w+x++]=M,i[w+x++]=-d/2,i[w+x++]=-g/2,i[w+x++]=y,a++}for(const p of r){const{totalTime:u,timeSeed:m}=p;let d=null,g=null,k=null,M=null,y=null,w=null;for(let x=0;x<p.numberOfVertices;x++){const b=n[4*(p.startVertex+x)],U=n[4*(p.startVertex+x)+1],P=n[4*(p.startVertex+x)+2],T=n[4*(p.startVertex+x)+3];let v=null,B=null,A=null,I=null;if(x>0){v=b-d,B=U-g;const V=Math.sqrt(v*v+B*B);if(v/=V,B/=V,x>1){let S=v+y,F=B+w;const N=Math.sqrt(S*S+F*F);S/=N,F/=N;const C=Math.min(1/(S*v+F*B),e);S*=C,F*=C,A=-F,I=S}else A=-B,I=v;A!==null&&I!==null&&(f(d,g,k,A,I,u,m,T),l())}d=b,g=U,k=P,y=v,w=B,M=T}f(d,g,k,-w,y,u,m,M)}return{vertexData:i,indexData:c}}function we(t){const{lineVertices:e,lineDescriptors:n}=t;let r=0,o=0;for(const A of n){const I=A.numberOfVertices-1;r+=4*I*2,o+=6*I*2}const s=new Float32Array(r*16),i=new Uint32Array(o);let c,a,h,l,f,p,u,m,d,g,k,M,y,w,x=0,b=0;function U(){i[b++]=x-8,i[b++]=x-7,i[b++]=x-6,i[b++]=x-7,i[b++]=x-5,i[b++]=x-6,i[b++]=x-4,i[b++]=x-3,i[b++]=x-2,i[b++]=x-3,i[b++]=x-1,i[b++]=x-2}function P(A,I,V,S,F,N,C,j,W,q,X,K,H,tt){const _=x*16;let R=0;for(const nt of[1,2])for(const it of[1,2,3,4])s[_+R++]=A,s[_+R++]=I,s[_+R++]=V,s[_+R++]=S,s[_+R++]=C,s[_+R++]=j,s[_+R++]=W,s[_+R++]=q,s[_+R++]=nt,s[_+R++]=it,s[_+R++]=H,s[_+R++]=tt,s[_+R++]=F/2,s[_+R++]=N/2,s[_+R++]=X/2,s[_+R++]=K/2,x++}function T(A,I){let V=d+k,S=g+M;const F=Math.sqrt(V*V+S*S);V/=F,S/=F;const N=d*V+g*S;V/=N,S/=N;let C=k+y,j=M+w;const W=Math.sqrt(C*C+j*j);C/=W,j/=W;const q=k*C+M*j;C/=q,j/=q,P(c,a,h,l,-S,V,f,p,u,m,-j,C,A,I),U()}function v(A,I,V,S,F,N){if(d=k,g=M,k=y,M=w,d==null&&g==null&&(d=k,g=M),f!=null&&p!=null){y=A-f,w=I-p;const C=Math.sqrt(y*y+w*w);y/=C,w/=C}d!=null&&g!=null&&T(F,N),c=f,a=p,h=u,l=m,f=A,p=I,u=V,m=S}function B(A,I){d=k,g=M,k=y,M=w,d==null&&g==null&&(d=k,g=M),d!=null&&g!=null&&T(A,I)}for(const A of n){c=null,a=null,h=null,l=null,f=null,p=null,u=null,m=null,d=null,g=null,k=null,M=null,y=null,w=null;const{totalTime:I,timeSeed:V}=A;for(let S=0;S<A.numberOfVertices;S++)v(e[4*(A.startVertex+S)],e[4*(A.startVertex+S)+1],e[4*(A.startVertex+S)+2],e[4*(A.startVertex+S)+3],I,V);B(I,V)}return{vertexData:s,indexData:i}}function kt(t,e){const n=e.pixels,{width:r,height:o}=e,s=new Float32Array(r*o*2),i=e.mask||new Uint8Array(r*o*2);if(e.mask||i.fill(255),t==="vector-uv")for(let c=0;c<r*o;c++)s[2*c]=n[0][c],s[2*c+1]=-n[1][c];else if(t==="vector-magdir")for(let c=0;c<r*o;c++){const a=n[0][c],h=Wt(n[1][c]),l=Math.cos(h-Math.PI/2),f=Math.sin(h-Math.PI/2);s[2*c]=l*a,s[2*c+1]=f*a}return{data:s,mask:i,width:r,height:o}}async function ze(t,e,n,r,o,s){const i=performance.now(),c=Gt(e.spatialReference);if(!c){const w=await Mt(t,e,n,r,o,s);return et("esri-2d-profiler")&&z().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-i)),et("esri-2d-profiler")&&z().info("I.9","Number of parts",1),w}const[a,h]=c.valid,l=h-a,f=Math.ceil(e.width/l),p=e.width/f,u=Math.round(n/f);let m=e.xmin;const d=[],g=performance.now();for(let w=0;w<f;w++){const x=new Ot({xmin:m,xmax:m+p,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});d.push(Mt(t,x,u,r,o,s)),m+=p}const k=await Promise.all(d);et("esri-2d-profiler")&&z().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-g)),et("esri-2d-profiler")&&z().info("I.9","Number of parts",k.length);const M={data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r};let y=0;for(const w of k){for(let x=0;x<w.height;x++)for(let b=0;b<w.width;b++)y+b>=n||(M.data[2*(x*n+y+b)]=w.data[2*(x*w.width+b)],M.data[2*(x*n+y+b)+1]=w.data[2*(x*w.width+b)+1],M.mask[x*n+y+b]=w.mask[x*w.width+b]);y+=w.width}return et("esri-2d-profiler")&&z().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-i)),M}async function Mt(t,e,n,r,o,s){const i={requestProjectedLocalDirections:!0,signal:s};if(o!=null&&(i.timeExtent=o),t.type==="imagery"){await t.load({signal:s});const h=t.rasterInfo.dataType,l=await t.fetchImage(e,n,r,i);return l?.pixelData?.pixelBlock==null?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:kt(h,l.pixelData.pixelBlock)}await t.load({signal:s});const c=t.serviceRasterInfo.dataType,a=await t.fetchPixels(e,n,r,i);return a?.pixelBlock==null?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:kt(c,a.pixelBlock)}export{ze as $,Ee as A,$e as B,ce as C,D,De as E,ke as K,L,Ne as M,Oe as P,Me as Q,qe as R,Ge as U,Ae as Y,We as _,pt as a,be as b,bt as c,Be as d,Pe as e,Qt as f,Kt as g,Te as h,dt as i,Fe as j,Le as k,Ue as l,Ve as m,lt as n,at as o,Ce as p,vt as q,Ie as r,ve as s,Se as t,mt as u,je as v,yt as w,St as x,Re as y,_e as z};
