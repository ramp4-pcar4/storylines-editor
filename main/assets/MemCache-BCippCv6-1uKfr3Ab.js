import{b0 as d}from"./main-DK5A1thH.js";const z=-3,l=z-1;var o;(function(_){_[_.ALL=0]="ALL",_[_.SOME=1]="SOME"})(o||(o={}));class v{get size(){return this._size}constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new d,this._users=new d}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear()}register(t){this._users.push(t)}deregister(t){this._users.removeUnordered(t)}registerRemoveFunc(t,i){this._removeFuncs.push([t,i])}deregisterRemoveFunc(t){this._removeFuncs.filterInPlace(i=>i[0]!==t)}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,-1),this._checkSize()}getSize(t,i){return this._db.get(t.id+i)?.size??0}put(t,i,e,h,r){i=t.id+i;const s=this._db.get(i);if(s&&(this._size-=s.size,t.size-=s.size,this._db.delete(i),s.entry!==e&&this._notifyRemove(i,s.entry,s.size,o.ALL)),h>this._maxSize)return void this._notifyRemove(i,e,h,o.ALL);if(e===void 0)return void console.warn("Refusing to cache undefined entry ");if(!h||h<0)return console.warn(`Refusing to cache entry with size ${h} for key ${i}`),void this._notifyRemove(i,e,0,o.ALL);const n=1+Math.max(r,l)-z;this._db.set(i,new b(e,h,n)),this._size+=h,t.size+=h,this._checkSize()}updateSize(t,i,e,h){i=t.id+i;const r=this._db.get(i);if(r&&r.entry===e){for(this._size-=r.size,t.size-=r.size;h>this._maxSize;){const s=this._notifyRemove(i,e,h,o.SOME);if(!(s!=null&&s>0))return void this._db.delete(i);h=s}r.size=h,this._size+=h,t.size+=h,this._checkSize()}}pop(t,i){i=t.id+i;const e=this._db.get(i);if(e)return this._size-=e.size,t.size-=e.size,this._db.delete(i),++this._hit,e.entry;++this._miss}get(t,i){i=t.id+i;const e=this._db.get(i);if(e!==void 0)return this._db.delete(i),e.lives=e.lifetime,this._db.set(i,e),++this._hit,e.entry;++this._miss}peek(t,i){const e=this._db.get(t.id+i);return e?++this._hit:++this._miss,e?.entry}get performanceInfo(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={},e=new Array;this._db.forEach((s,n)=>{const c=s.lifetime;e[c]=(e[c]||0)+s.size,this._users.forAll(u=>{const{id:f,name:a}=u;if(n.startsWith(f)){const m=i[a]||0;i[a]=m+s.size}})});const h={};this._users.forAll(s=>{const n=s.name;if("hitRate"in s&&typeof s.hitRate=="number"&&!isNaN(s.hitRate)&&s.hitRate>0){const c=i[n]||0;i[n]=c,h[n]=Math.round(100*s.hitRate)+"%"}else h[n]="0%"});const r=Object.keys(i);r.sort((s,n)=>i[n]-i[s]),r.forEach(s=>t[s]=Math.round(i[s]/2**20)+"MB / "+h[s]);for(let s=e.length-1;s>=0;--s){const n=e[s];n&&(t["Priority "+(s+z-1)]=Math.round(n/this._size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forAll(t=>t.resetHitRate())}clear(t){const i=t.id;this._db.forEach((e,h)=>{h.startsWith(i)&&(this._size-=e.size,this._db.delete(h),this._notifyRemove(h,e.entry,e.size,o.ALL))}),t.size=0}clearAll(){this._db.forEach((t,i)=>this._notifyRemove(i,t.entry,t.size,o.ALL)),this._users.forAll(t=>t.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,i,e,h){let r;return this._removeFuncs.some(s=>{if(t.startsWith(s[0])){const n=s[1](i,h,e);return typeof n=="number"&&(r=n),!0}return!1}),r}_checkSize(){this._users.forAll(t=>this._checkSizeLimits(t)),this._checkSizeLimits()}_checkSizeLimits(t){const i=t??this;if(i.maxSize<0||i.size<=i.maxSize)return;const e=t?.id;let h=!0;for(;h;){h=!1;for(const[r,s]of this._db)if(s.lifetime===0&&(!e||r.startsWith(e))){if(this._purgeItem(r,s,t),i.size<=.9*i.maxSize)return;h||=this._db.has(r)}}for(const[r,s]of this._db)if((!e||r.startsWith(e))&&(this._purgeItem(r,s,t),i.size<=.9*i.maxSize))return}_purgeItem(t,i,e=this._users.find(h=>t.startsWith(h.id))){if(this._db.delete(t),i.lives<=1){this._size-=i.size,e&&(e.size-=i.size);const h=this._notifyRemove(t,i.entry,i.size,o.SOME);h!=null&&h>0&&(this._size+=h,e&&(e.size+=h),i.lives=i.lifetime,i.size=h,this._db.set(t,i))}else--i.lives,this._db.set(t,i)}}class b{constructor(t,i,e){this.entry=t,this.size=i,this.lifetime=e,this.lives=e}}export{v as b,z};
