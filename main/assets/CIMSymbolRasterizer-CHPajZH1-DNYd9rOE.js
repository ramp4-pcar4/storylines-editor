import{cm as F,cl as H}from"./main-C6fh4Kls.js";import{n as L}from"./CIMResourceManager-DyRf92xI-DMrreAqC.js";import{V as G,e as O,G as j}from"./CIMSymbolHelper-34UsTwam-CT0ZrrK3.js";import{OverrideHelper as q}from"./OverrideHelper-DgyARgwI-Cb9BG3Mb.js";import{K as S,Q as D}from"./rasterizingUtils-1wASRzSP-5USieIRk.js";import{k}from"./utils-BfXZnjCE-BQ9mf89y.js";import"./fontUtils-C37p4Hgq-B41DvM6l.js";import"./imageUtils-D3tfFRL_-imw6zFhD.js";import"./BidiEngine-DusKzrO8-BlAgW8mu.js";import"./OptimizedGeometry-pzfNw1AT-DfMYw162.js";import"./memoryEstimations-DeWfxwaV-cqSwRHj6.js";import"./GeometryUtils-B8e3Iwyx-DoacOnJx.js";import"./enums-a_LDTPYU-CBIcy3mM.js";import"./defaultCIMValues-BcSaJjm--58G-soMN.js";import"./definitions-MCCItX4r-o3EUznKY.js";import"./mat2d-BQA-1WB--Pnyy0dhf.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./vec2f32-hTAvipMV-C0AQcwEv.js";import"./Rect-DD6XS68q-D_hsV3ag.js";import"./BoundingBox-DlCd_wcU-DBB4UfPl.js";import"./colorUtils-Eg6lOlXm-mswMQzH4.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./FieldsIndex-Bt0Y8aWr-B17gItSB.js";import"./UnknownTimeZone-DxjyzFvs-ChepmuQP.js";import"./timeZoneUtils-d5p0Jda1-DtVkyptK.js";import"./ArcadeExpression-XjY3x7KV-DwyJlRIi.js";import"./TimeOnly-CGkId3bj-B28FfoUX.js";import"./enum-g1DWyQyu-BFudlvHS.js";import"./callExpressionWithFeature-Bk8k1lJI-Kw7IYV7B.js";import"./quantizationUtils-D907S7Bm-IqHecxaB.js";import"./floatRGBA-DRFmbkvz-DQdg9Xg8.js";const A=96/72;class vt{constructor(a){this._spatialReference=a,this._imageDataCanvas=null,this._cimResourceManager=new L}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(a,o,m,v,l,n,g,c,f,M){if(!a)return null;const{data:d}=a;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:P}=d;n||(n=k(P));const s=await q.resolveSymbolOverrides(d,o,this._spatialReference,l,n,g,c),w=this._cimResourceManager,b=[];G.fetchResources(s,w,b),G.fetchFonts(s,w,b),b.length>0&&await Promise.all(b);const{width:e,height:r}=m;let y=z(n,e,r,v,M);const t=G.getEnvelope(s,y,w);if(!t)return null;t.x===1/0&&(t.x=e+2),t.y===1/0&&(t.y=-r/2),t.width===-1/0&&(t.width=e),t.height===-1/0&&(t.height=r);let p=1,R=0,_=0;switch(P.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;t.width>e&&(i=e/t.width);let h=1;t.height>r&&(h=r/t.height),v==="preview"&&(t.width<e&&(i=e/t.width),t.height<r&&(h=r/t.height)),p=Math.min(i,h),R=t.x+t.width/2,_=t.y+t.height/2}break;case"CIMLineSymbol":if(M){_=t.y+t.height/2,R=t.x+t.width/2;const i=t.width-e,h=t.height-r;y={paths:S(y.paths,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+h,ymax:t.height/2-h,width:t.width-2*i,height:t.height-2*h})}}else{(f||t.height>r)&&(p=r/t.height),_=t.y+t.height/2;const i=t.x*p+e/2,h=(t.x+t.width)*p+e/2,C=F(y)?y.paths:H(y)?y.rings:null;if(C===null)throw new Error("Bad geometry, can't rasterise symbol!");C[0][0][0]-=i/p,C[0][2][0]-=(h-e)/p}break;case"CIMPolygonSymbol":if(M){_=t.y+t.height/2,R=t.x+t.width/2;const i=t.width-e,h=t.height-r;y={paths:S(y.rings,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+h,ymax:t.height/2-h,width:t.width-2*i,height:t.height-2*h})}}else{R=t.x+t.width/2,_=t.y+t.height/2;const i=t.x*p+e/2,h=(t.x+t.width)*p+e/2,C=t.y*p+r/2,I=(t.y+t.height)*p+r/2,{rings:u}=y;i<0&&(u[0][0][0]-=i,u[0][3][0]-=i,u[0][4][0]-=i),C<0&&(u[0][0][1]+=C,u[0][1][1]+=C,u[0][4][1]+=C),h>e&&(u[0][1][0]-=h-e,u[0][2][0]-=h-e),I>r&&(u[0][2][1]+=I-r,u[0][3][1]+=I-r)}}const E={type:"cim",data:{type:"CIMSymbolReference",symbol:s}};return this.rasterize(E,e,r,R,_,p,n,1,y)}rasterize(a,o,m,v,l,n,g,c=0,f=null,M=window.devicePixelRatio||1){const{data:d}=a;if(!d||d.type!=="CIMSymbolReference"||!d.symbol)return null;const{symbol:P}=d,s=this._canvas,w=M*A;s.width=o*w,s.height=m*w,g||(g=k(P)),f||(f=z(g,o,m,"legend")),s.width+=2*c,s.height+=2*c;const b=s.getContext("2d",{willReadFrequently:!0}),e=j.createIdentity();return e.translate(-v,-l),e.scale(n*w,-n*w),e.translate(o*w/2+c,m*w/2+c),b.clearRect(0,0,s.width,s.height),new O(b,this._cimResourceManager,e,!0).drawSymbol(P,f),b.getImageData(0,0,s.width,s.height)}}function B(x,a,o,m){return a==="esriGeometryPolygon"?{rings:D(S(x.rings,{xmin:0,ymin:0,width:o,height:m}),-1*o/2,-1*m/2)}:a==="esriGeometryPolyline"?{paths:D(S(x.paths,{xmin:0,ymin:0,width:o,height:m}),-1*o/2,-1*m/2)}:null}function z(x,a,o,m,v){const l=-a/2+1,n=a/2-1,g=o/2-1,c=-o/2+1;if(v&&(x==="esriGeometryPolygon"||x==="esriGeometryPolyline")){const f=B(v,x,a,o);if(f)return f}switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[l,0],[0,0],[n,0]]]};default:return m==="legend"?{rings:[[[l,g],[n,0],[n,c],[l,c],[l,g]]]}:{rings:[[[l,g],[n,g],[n,c],[l,c],[l,g]]]}}}export{vt as CIMSymbolRasterizer};
