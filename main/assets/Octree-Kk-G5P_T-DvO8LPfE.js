import{dJ as Ot,b0 as D,cE as F,gh as m}from"./main-D7vwjMDX.js";import{_ as tt,Y as Rt,A as pt,N as w,P as y,p as et}from"./vec32-BuqRmYBM-ClpcRCNx.js";import{X as ut,d as nt,v as q,M as it,l as k,K as rt,U as T,S as H,a as At}from"./sphere-Cj20syUS-D26RDXx7.js";import{B as bt,z as Ft}from"./mat4-BFStKTjU-WrlKAspo.js";import{D as Et}from"./vec42-D8CJyqHG-DnfLTeQH.js";import{e as M}from"./vec4f64-CjUMzAyX-DPYbdAom.js";import{Q as A,j as Nt,c as gt,J as Mt,K as L,l as Bt}from"./plane-B_adY3_o-CH2S3dla.js";import{s as lt}from"./InterleavedLayout-DcHoXu73-B1G6wAyg.js";function Q(n){return n?{ray:nt(n.ray),c0:n.c0,c1:n.c1}:{ray:nt(),c0:0,c1:Number.MAX_VALUE}}function Xt(n,t=Q()){return At(n,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function Qt(n,t){return dt(n,n.c0,t)}function Yt(n,t){return dt(n,n.c1,t)}function dt(n,t,e){return y(e,n.ray.origin,w(e,n.ray.direction,t))}new ut(()=>Q());function Zt(n){return n?[A(n[0]),A(n[1]),A(n[2]),A(n[3]),A(n[4]),A(n[5])]:[A(),A(),A(),A(),A(),A()]}function St(){return[F(),F(),F(),F(),F(),F(),F(),F()]}function te(n,t){for(let e=0;e<Y;e++)Nt(n[e],t[e]);return n}function ee(n,t,e,i=Lt){const r=bt(gt.get(),t,n);Ft(r,r);for(let s=0;s<jt;++s){const a=Et(Mt.get(),Pt[s],r);pt(i[s],a[0]/a[3],a[1]/a[3],a[2]/a[3])}xt(e,i)}function xt(n,t){L(t[o.FAR_BOTTOM_LEFT],t[o.NEAR_BOTTOM_LEFT],t[o.NEAR_TOP_LEFT],n[B.LEFT]),L(t[o.NEAR_BOTTOM_RIGHT],t[o.FAR_BOTTOM_RIGHT],t[o.FAR_TOP_RIGHT],n[B.RIGHT]),L(t[o.FAR_BOTTOM_LEFT],t[o.FAR_BOTTOM_RIGHT],t[o.NEAR_BOTTOM_RIGHT],n[B.BOTTOM]),L(t[o.NEAR_TOP_LEFT],t[o.NEAR_TOP_RIGHT],t[o.FAR_TOP_RIGHT],n[B.TOP]),L(t[o.NEAR_BOTTOM_LEFT],t[o.NEAR_BOTTOM_RIGHT],t[o.NEAR_TOP_RIGHT],n[B.NEAR]),L(t[o.FAR_BOTTOM_RIGHT],t[o.FAR_BOTTOM_LEFT],t[o.FAR_TOP_LEFT],n[B.FAR])}function $(n,t){for(let e=0;e<Y;e++){const i=n[e];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0}function ne(n,t){for(let e=0;e<Y;e++){const i=n[e];if(!Bt(i,t))return!1}return!0}var B,o;(function(n){n[n.LEFT=0]="LEFT",n[n.RIGHT=1]="RIGHT",n[n.BOTTOM=2]="BOTTOM",n[n.TOP=3]="TOP",n[n.NEAR=4]="NEAR",n[n.FAR=5]="FAR"})(B||(B={})),function(n){n[n.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",n[n.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",n[n.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",n[n.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",n[n.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",n[n.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",n[n.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",n[n.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(o||(o={})),o.FAR_BOTTOM_RIGHT,o.NEAR_BOTTOM_RIGHT,o.NEAR_BOTTOM_LEFT,o.FAR_BOTTOM_LEFT,o.NEAR_BOTTOM_LEFT,o.NEAR_BOTTOM_RIGHT,o.NEAR_TOP_RIGHT,o.NEAR_TOP_LEFT,o.FAR_BOTTOM_RIGHT,o.FAR_BOTTOM_LEFT,o.FAR_TOP_LEFT,o.FAR_TOP_RIGHT,o.NEAR_BOTTOM_RIGHT,o.FAR_BOTTOM_RIGHT,o.FAR_TOP_RIGHT,o.NEAR_TOP_RIGHT,o.FAR_BOTTOM_LEFT,o.NEAR_BOTTOM_LEFT,o.NEAR_TOP_LEFT,o.FAR_TOP_LEFT,o.FAR_TOP_LEFT,o.NEAR_TOP_LEFT,o.NEAR_TOP_RIGHT,o.FAR_TOP_RIGHT;const Y=6,jt=8,Pt=[M(-1,-1,-1,1),M(1,-1,-1,1),M(1,1,-1,1),M(-1,1,-1,1),M(-1,-1,1,1),M(1,-1,1,1),M(1,1,1,1),M(-1,1,1,1)];new ut(Q);const Lt=St();class v{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,e){this.objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new u,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}destroy(){this._degenerateObjects.clear(),u.clearPool(),X[0]=null,j.prune(),P.prune()}add(t,e=t.length){this._objectCount+=e,this._grow(t,e);const i=u.acquire();for(let r=0;r<e;r++){const s=t[r];this._isDegenerate(s)?this._degenerateObjects.add(s):(i.init(this._root),this._add(s,i))}u.release(i)}remove(t,e=null){this._objectCount-=t.length;const i=u.acquire();for(const r of t){const s=e??q(this.objectToBoundingSphere(r),wt);G(s[3])?(i.init(this._root),Ht(r,s,i)):this._degenerateObjects.delete(r)}u.release(i),this._shrink()}update(t,e){if(!G(e[3])&&this._isDegenerate(t))return;const i=Ct(t);this.remove(i,e),this.add(i)}forEachAlongRay(t,e,i){const r=it(t,e);x(this._root,s=>{if(!It(r,s))return!1;const a=s.node;return a.terminals.forAll(d=>{this._intersectsObject(r,d)&&i(d)}),a.residents!==null&&a.residents.forAll(d=>{this._intersectsObject(r,d)&&i(d)}),!0})}forEachAlongRayWithVerticalOffset(t,e,i,r){const s=it(t,e);x(this._root,a=>{if(!Gt(s,a,r))return!1;const d=a.node;return d.terminals.forAll(h=>{this._intersectsObjectWithOffset(s,h,r)&&i(h)}),d.residents!==null&&d.residents.forAll(h=>{this._intersectsObjectWithOffset(s,h,r)&&i(h)}),!0})}forEach(t){x(this._root,e=>{const i=e.node;return i.terminals.forAll(t),i.residents!==null&&i.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,i,r=()=>!0,s=1/0){let a=1/0,d=1/0,h=null;const c=J(t,e),f=l=>{if(--s,!r(l))return;const O=this.objectToBoundingSphere(l);if(!$(i,O))return;const E=S(t,e,T(O)),z=E-O[3],_=E+O[3];z<a&&(a=z,d=_,h=l)};return st(this._root,l=>{if(s<=0||!$(i,l.bounds)||(w(b,c,l.halfSize),y(b,b,T(l.bounds)),S(t,e,b)>d))return!1;const O=l.node;return O.terminals.forAll(E=>f(E)),O.residents!==null&&O.residents.forAll(E=>f(E)),!0},t,e),h}forEachInDepthRange(t,e,i,r,s,a,d){let h=-1/0,c=1/0;const f={setRange:_=>{i===v.DepthOrder.FRONT_TO_BACK?(h=Math.max(h,_.near),c=Math.min(c,_.far)):(h=Math.max(h,-_.far),c=Math.min(c,-_.near))}};f.setRange(r);const l=S(e,i,t),O=J(e,i),E=J(e,-i),z=_=>{if(!d(_))return;const g=this.objectToBoundingSphere(_),I=T(g),Z=S(e,i,I)-l,ft=Z-g[3],mt=Z+g[3];ft>c||mt<h||!$(a,g)||s(_,f)};st(this._root,_=>{if(!$(a,_.bounds)||(w(b,O,_.halfSize),y(b,b,T(_.bounds)),S(e,i,b)-l>c)||(w(b,E,_.halfSize),y(b,b,T(_.bounds)),S(e,i,b)-l<h))return!1;const g=_.node;return g.terminals.forAll(I=>z(I)),g.residents!==null&&g.residents.forAll(I=>z(I)),!0},e,i)}forEachNode(t){x(this._root,e=>t(e.node,e.bounds,e.halfSize,e.depth))}forEachNeighbor(t,e){const i=k(e),r=T(e),s=h=>{const c=this.objectToBoundingSphere(h),f=k(c),l=i+f;return!(et(T(c),r)-l*l<=0)||t(h)};let a=!0;const d=h=>{a&&(a=s(h))};x(this._root,h=>{const c=k(h.bounds),f=i+c;if(et(T(h.bounds),r)-f*f>0)return!1;const l=h.node;return l.terminals.forAll(d),a&&l.residents!==null&&l.residents.forAll(d),a}),a&&this.forEachDegenerateObject(d)}_intersectsObject(t,e){const i=this.objectToBoundingSphere(e);return!(i[3]>0)||rt(i,t)}_intersectsObjectWithOffset(t,e,i){const r=this.objectToBoundingSphere(e);return!(r[3]>0)||rt(i.applyToBoundingSphere(r),t)}_add(t,e){e.advanceTo(this.objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let i=0;i<e.length;i++){const r=u.acquire().init(t);this._add(e.at(i),r),u.release(r)}}_grow(t,e){if(e!==0&&(ot(t,e,i=>this.objectToBoundingSphere(i),N),G(N[3])&&!this._fitsInsideTree(N)))if(ct(this._root.node))q(N,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const i=this._rootBoundsForRootAsSubNode(N);this._placingRootViolatesMaxDepth(i)?this._rebuildTree(N,i):this._growRootAsSubNode(i),u.release(i)}}_rebuildTree(t,e){tt(T(V),T(e.bounds)),V[3]=e.halfSize,ot([t,V],2,r=>r,W);const i=u.acquire().init(this._root);this._root.initFrom(null,W,W[3]),this._root.increaseHalfSize(1.25),x(i,r=>(this.add(r.node.terminals.data,r.node.terminals.length),r.node.residents!==null&&this.add(r.node.residents.data,r.node.residents.length),!0)),u.release(i)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return x(this._root,r=>(i=Math.max(i,r.depth),i+e<=this._maximumDepth)),i+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],i=t;let r=-1/0;const s=this._root.bounds,a=this._root.halfSize;for(let h=0;h<3;h++){const c=s[h]-a-(i[h]-e),f=i[h]+e-(s[h]+a),l=Math.max(0,Math.ceil(c/(2*a))),O=Math.max(0,Math.ceil(f/(2*a)))+1,E=2**Math.ceil(Math.log(l+O)*Math.LOG2E);r=Math.max(r,E),C[h].min=l,C[h].max=O}for(let h=0;h<3;h++){let c=C[h].min,f=C[h].max;const l=(r-(c+f))/2;c+=Math.ceil(l),f+=Math.floor(l);const O=s[h]-a-c*a*2;U[h]=O+(f+c)*a}const d=r*a;return U[3]=d*Tt,u.acquire().initFrom(null,U,d,0)}_growRootAsSubNode(t){const e=this._root.node;tt(T(N),T(this._root.bounds)),N[3]=this._root.halfSize,this._root.init(t),t.advanceTo(N,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let i=0,r=0;for(;r<e.length&&t==null;)i=r++,t=e[i];for(;r<e.length;)if(e[r++])return-1;return i}_isDegenerate(t){return!G(this.objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,i=this._root.halfSize;return t[3]<=i&&t[0]>=e[0]-i&&t[0]<=e[0]+i&&t[1]>=e[1]-i&&t[1]<=e[1]+i&&t[2]>=e[2]-i&&t[2]<=e[2]+i}toJSON(){const{maximumDepth:t,maximumObjectsPerNode:e,_objectCount:i}=this,r=this._nodeToJSON(this._root.node);return{maximumDepth:t,maximumObjectsPerNode:e,objectCount:i,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:r}}}_nodeToJSON(t){const e=t.children.map(s=>s?this._nodeToJSON(s):null),i=t.residents?.map(s=>this.objectToBoundingSphere(s)),r=t.terminals?.map(s=>this.objectToBoundingSphere(s));return{children:e,residents:i,terminals:r}}static fromJSON(t){const e=new v(i=>i,{maximumDepth:t.maximumDepth,maximumObjectsPerNode:t.maximumObjectsPerNode});return e._objectCount=t.objectCount,e._root.initFrom(t.root.node,t.root.bounds,t.root.halfSize,t.root.depth),e}}class u{constructor(){this.bounds=H(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,i,r=this.depth){return this.node=t??u.createEmptyNode(),e&&q(e,this.bounds),this.halfSize=i,this.depth=r,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*Tt}advance(t){let e=this.node.children[t];e||(e=u.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const i=_t[t];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,e,i=!1){for(;;){if(this.isTerminalFor(t))return e&&e(this,-1),!0;if(this.isLeaf()){if(!i)return e&&e(this,-1),!1;this.node.residents=null}const r=this._childIndex(t);e&&e(this,r),this.advance(r)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new D({shrink:!0}),residents:new D({shrink:!0})}}static acquire(){return u._pool.acquire()}static release(t){u._pool.release(t)}static clearPool(){u._pool.prune()}}function x(n,t){let e=u.acquire().init(n);const i=[e];for(;i.length!==0;){if(e=i.pop(),t(e)&&!e.isLeaf())for(let r=0;r<e.node.children.length;r++)e.node.children[r]&&i.push(u.acquire().init(e).advance(r));u.release(e)}}function st(n,t,e,i=v.DepthOrder.FRONT_TO_BACK){let r=u.acquire().init(n);const s=[r];for($t(e,i,at);s.length!==0;){if(r=s.pop(),t(r)&&!r.isLeaf())for(let a=7;a>=0;--a){const d=at[a];r.node.children[d]&&s.push(u.acquire().init(r).advance(d))}u.release(r)}}function Ht(n,t,e){j.clear();const i=e.advanceTo(t,(r,s)=>{j.push(r.node),j.push(s)})?e.node.terminals:e.node.residents;if(i.removeUnordered(n),i.length===0)for(let r=j.length-2;r>=0&&zt(j.data[r],j.data[r+1]);r-=2);}function zt(n,t){return t>=0&&(n.children[t]=null),!!ct(n)&&(n.residents===null&&(n.residents=new D({shrink:!0})),!0)}function It(n,t){return K(T(t.bounds),2*-t.halfSize,R),K(T(t.bounds),2*t.halfSize,p),lt(n.origin,n.direction,R,p)}function Gt(n,t,e){return K(T(t.bounds),2*-t.halfSize,R),K(T(t.bounds),2*t.halfSize,p),e.applyToMinMax(R,p),lt(n.origin,n.direction,R,p)}function ct(n){if(n.terminals.length!==0)return!1;if(n.residents!==null)return n.residents.length===0;for(let t=0;t<n.children.length;t++)if(n.children[t])return!1;return!0}function Dt(n,t){n[0]=Math.min(n[0],t[0]-t[3]),n[1]=Math.min(n[1],t[1]-t[3]),n[2]=Math.min(n[2],t[2]-t[3])}function vt(n,t){n[0]=Math.max(n[0],t[0]+t[3]),n[1]=Math.max(n[1],t[1]+t[3]),n[2]=Math.max(n[2],t[2]+t[3])}function K(n,t,e){e[0]=n[0]+t,e[1]=n[1]+t,e[2]=n[2]+t}function ot(n,t,e,i){if(t===1){const r=e(n[0]);q(r,i)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,p[0]=-1/0,p[1]=-1/0,p[2]=-1/0;for(let r=0;r<t;r++){const s=e(n[r]);G(s[3])&&(Dt(R,s),vt(p,s))}Rt(T(i),R,p,.5),i[3]=Math.max(p[0]-R[0],p[1]-R[1],p[2]-R[2])/2}}function $t(n,t,e){if(!P.length)for(let i=0;i<8;++i)P.push({index:0,distance:0});for(let i=0;i<8;++i){const r=_t[i];P.data[i].index=i,P.data[i].distance=S(n,t,r)}P.sort((i,r)=>i.distance-r.distance);for(let i=0;i<8;++i)e[i]=P.data[i].index}function J(n,t){let e,i=1/0;for(let r=0;r<8;++r){const s=S(n,t,ht[r]);s<i&&(i=s,e=ht[r])}return e}function S(n,t,e){return t*(n[0]*e[0]+n[1]*e[1]+n[2]*e[2])}function G(n){return!isNaN(n)&&n!==-1/0&&n!==1/0&&n>0}u._pool=new Ot(u),function(n){var t;(t=n.DepthOrder||(n.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(v);const _t=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],ht=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],Tt=Math.sqrt(3),X=[null];function Ct(n){return X[0]=n,X}const U=H(),b=F(),R=F(),p=F(),j=new D,wt=H(),N=H(),V=H(),W=H(),C=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],P=new D,at=[0,0,0,0,0,0,0,0];export{Xt as B,ne as G,te as H,v as I,Zt as L,ee as a,B as g,Yt as j,Q as q,Qt as x};
