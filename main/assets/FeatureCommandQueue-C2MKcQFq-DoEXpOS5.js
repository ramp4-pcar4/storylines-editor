import{V as mo}from"./CIMSymbolHelper-34UsTwam-CHoFmTlJ.js";import{n as ho}from"./defaultCIMValues-BcSaJjm--58G-soMN.js";import{o as yo,y as fo}from"./enums-a_LDTPYU-CBIcy3mM.js";import{$ as ce,j as ht,W as Ut}from"./enums-CQnCd4Rx-BH311h3Y.js";import{i as G}from"./TechniqueType-CMl1wqtX-7TDFwBxa.js";import{v as n,kJ as z,an as Ue,f8 as Ye,b3 as vo,ki as es,H as go,fh as bo,h as Gt,a6 as zs,jc as xo,a8 as wo,az as So,es as ts}from"./main-vBMuZyvK.js";import{K as h,F as y,V as Ge,B as R,Z as X,P as w,p as a,O as B,S as $,$ as at,j as Se,y as Et,U as f,e as Vo,J as Ui,A as kt,D as Ni,a as k,L as M,b as U,c as _i,d as Fe,G as ui,z as $t,f as qi,Q as ti,g as E,h as ve,i as J,k as zo,q as Ne,X as qe,R as _,r as ge,m as Bt,n as Po,o as P,s as j,t as We,u as Je,v as et,_ as It,w as Gi,x as pi,C as ze,E as Ps,I as As,H as Ao,M as Si,N as _o,T as To,W as Mo,Y as H,a0 as ci,a1 as is,a2 as Ro,a3 as ss,a4 as os,l as Co,a5 as _s,a6 as Oo,a7 as Do}from"./GraphShaderModule-Baq-N_YO-DC9rpEUt.js";import{U as Io,H as as,m as Fo,O as Ve,E as rs,N as Nt}from"./UpdateTracking2D-GEad80KZ-CmHRvJri.js";import{i as Lo,t as ue,v as ns,x as Eo,K as ls,g as ko,o as $o}from"./definitions-MCCItX4r-o3EUznKY.js";import{E as Bo,C as Vi,D as Ho,s as N,A as Uo,k as Le,H as di,B as vt,K as us,T as Wt,q as No,j as ps}from"./utils-OrDMNKn4-4LAm5L29.js";import{v as qo,s as Ti,c as Wi,o as Ts,C as Go,h as cs,n as ds,i as ms,p as Wo,m as Ko,G as Ms,r as jo,e as Zo,g as Xo,D as Yo,B as Qo,k as Jo,q as ea,u as ta,f as ia,t as sa}from"./constants-oLcGh8d3-CJuD0gcX.js";import{k as oa,E as aa}from"./mat3-DOnW3DjW-C3hbW9XY.js";import{D as Rs,j as q,B as Q,z as Z,M as ee,E as ra,C as ae,A as Ht,e as hs}from"./MapView-DVZSZHRJ-B3TTceJn.js";import{D as _e,Y as Ft,G as yt,F as $e,L as mt,P as ye,R as ii,T as Cs,U as Mi,E as Os,f as ys,H as fs}from"./enums-wEDHPbCF-Cf76M5_x.js";import{u as vs,F as na}from"./VertexArrayObject-CieliEx4-CiBJUnW3.js";import{O as la,L as Ds,d as Is}from"./FramebufferObject-D3QloItC-DzBitGCJ.js";import{Y as si,_ as Fs}from"./Texture-D5XWO2GQ-B9ztnTmU.js";import{c as ua}from"./VertexElementDescriptor-DLvjNrmQ-BHK9ksow.js";import{M as pa,b as ca}from"./rasterizingUtils-1wASRzSP-cE5bQB5C.js";import{o as gs}from"./WGLContainer-qQmF3DRB-RpRclRn6.js";import{m as da}from"./lengthUtils-C61nRlXw-CS00HAbV.js";import{a as ma,_ as zi}from"./streamLayerUtils-Dae818Yl-CG3QJc_N.js";import{s as mi}from"./capabilities-BaKzUyhi-y5w2NMiP.js";import{QueueProcessor as ha}from"./QueueProcessor-BSpvDXZs-Dy3H5gJo.js";let ya=class{get forceStaticPath(){return Ue("esri-cim-animations-enable-status")==="disabled"}get forceAnimatedPath(){return Ue("esri-cim-animations-enable-status")==="forced"}get freezeGlobalTime(){return Ue("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!Ue("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return Ue("esri-cim-animations-freeze-time")!==!1}};const Ki=new ya,Ri={[_e.BYTE]:1,[_e.UNSIGNED_BYTE]:1,[_e.SHORT]:2,[_e.UNSIGNED_SHORT]:2,[_e.HALF_FLOAT]:2,[_e.INT]:4,[_e.UNSIGNED_INT]:4,[_e.FLOAT]:4};let fa=class{constructor(e,t){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(const i in t.vertex){const{data:s,attributes:o}=t.vertex[i],r=vs.createVertex(e,ys.STATIC_DRAW,s);this.vertexBuffers.set(i,{buffer:r,attributes:o})}for(const i in t.index){const{data:s}=t.index[i],o=vs.createIndex(e,ys.STATIC_DRAW,s);this.indexBuffers.set(i,{buffer:o})}for(const i of t.groups)this.groups.push({...i,vertexArrays:new Map});this.parts=t.parts}bind(e,t,i){this._boundPart=i;const{group:s}=this.parts[this._boundPart],o=this.groups[s];if(!o)throw new Error(`Missing group ${s}.`);let r=o.vertexArrays.get(t.stringHash);if(!r){const l=new Set(t.locations.keys()),u=o.index?this.indexBuffers.get(o.index)?.buffer:null,p=new Map,c=new Map;for(const[d,{buffer:m,attributes:v}]of this.vertexBuffers){const g=v.filter(b=>l.has(b.name));g.length>0&&(p.set(d,g),c.set(d,m))}r=new na(e,t.locations,p,c,u),o.vertexArrays.set(t.stringHash,r)}e.bindVAO(r)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:s}=this.parts[this._boundPart],{primitive:o,index:r}=this.groups[s];if(r){const l=this.indexBuffers.get(r);if(!l)throw new Error(`Missing index buffer "${r}".`);const{indexType:u}=l.buffer;if(!u)throw new Error("Buffer type error.");e.drawElements(o,i,u,t*Ri[u])}else e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArrays:e}of this.groups)for(const[t,i]of e)i.disposeVAOOnly();for(const{buffer:e}of this.vertexBuffers.values())e.dispose();for(const{buffer:e}of this.indexBuffers.values())e.dispose()}};const va={position:{type:_e.SHORT,count:2}};let ga=class Ci extends fa{static create(t,i){const s=[];let{stride:o}=i;if(o==null){o=0;for(const[d,{count:m,type:v,offset:g}]of Object.entries(i.layout)){if(g!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");o+=m*Ri[v]}}let r=0;for(const[d,{count:m,offset:v,type:g,normalized:b}]of Object.entries(i.layout)){v!=null&&(r=v);const x=new ua(d,m,g,r,o,b!=null&&b,0);s.push(x),r+=m*Ri[g]}const l={primitive:i.primitive};i.index!=null&&(l.index="indexData");let{count:u}=i;if(u==null&&(u=i.index?i.index.length:i.vertex.byteLength/o,Math.floor(u)!==u))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${o}.`);const p={start:0,count:u,group:0,primitive:i.primitive},c={vertex:{vertexData:{data:i.vertex,attributes:s}},parts:[p],groups:[l]};return i.index!=null&&(c.index={indexData:{data:i.index}}),new Ci(t,c,i.layout)}static fromVertexStream(t,i){return Ci.create(t,{primitive:Cs.TRIANGLE_STRIP,vertex:new Uint16Array(i),layout:va})}constructor(t,i,s){super(t,i),this._spec=s}bind(t,i,s=0){super.bind(t,i,s)}},ke=class extends B{};n([h(a)],ke.prototype,"globalTime",void 0),n([h(f)],ke.prototype,"animationTextureSize",void 0),n([h(H)],ke.prototype,"animationTexture",void 0),n([h(E)],ke.prototype,"toScreen",void 0),n([h(E)],ke.prototype,"toNdc",void 0),n([h(a)],ke.prototype,"mapRotation",void 0),n([h(a)],ke.prototype,"pixelRatio",void 0);var oe;(function(e){e[e.transform=0]="transform",e[e.fromColor=1]="fromColor",e[e.toColor=2]="toColor",e[e.colorMix=3]="colorMix",e[e.toOpacity=4]="toOpacity",e[e.opacityMix=5]="opacityMix",e[e.shift=6]="shift"})(oe||(oe={}));let Ae=class extends B{getVisualVariableData(e){if(!this._vvData){const t=this.getAttributeDataCoords(e);this._vvData=$(this.visualVariableData,t).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(e){if(!this._uv){const t=Bo(e),i=this.size,s=at(t.x),o=at(t.y).multiply(at(256)),r=at(t.z).multiply(at(256)).multiply(at(256)),l=Se(s.add(o).add(r)),u=Et(l,i),p=l.subtract(u).divide(i);this._uv=new f(u,p).add(.5).divide(i)}return this._uv}getFilterData(e){const t=this.getAttributeDataCoords(e);return $(this.filterFlags,t).setDebugName("storage0")}getAnimationData(e){const t=this.getAttributeDataCoords(e);return $(this.animation,t).setDebugName("storage1")}getVVData(e){return this.getVisualVariableData(e)}getDataDrivenData0(e){const t=this.getAttributeDataCoords(e);return $(this.dataDriven0,t).setDebugName("storage30")}getDataDrivenData1(e){const t=this.getAttributeDataCoords(e);return $(this.dataDriven1,t).setDebugName("storage31")}getDataDrivenData2(e){const t=this.getAttributeDataCoords(e);return $(this.dataDriven2,t).setDebugName("storage32")}getGPGPUData(e){const t=this.getAttributeDataCoords(e);return $(this.gpgpu,t).setDebugName("storage4")}getLocalTimeOrigin(e){const t=this.getAttributeDataCoords(e);return $(this.localTimeOrigin,t).x.setDebugName("storage5")}getFilterFlags(e){return Ue("webgl-ignores-sampler-precision")?Vo(this.getFilterData(e).x.multiply(Se(255))):this.getFilterData(e).x.multiply(Se(255))}getLabelVisibility(e){const t=this.getFilterData(e).y.multiply(255);return new a(1).subtract(t)}getAnimationValue(e){return this.getAnimationData(e).x}getSizeValue(e){return this.getVisualVariableData(e).x}getColorValue(e){return this.getVisualVariableData(e).y}getOpacityValue(e){return this.getVisualVariableData(e).z}getRotationValue(e){return this.getVisualVariableData(e).w}};n([h(H)],Ae.prototype,"filterFlags",void 0),n([h(H)],Ae.prototype,"animation",void 0),n([h(H)],Ae.prototype,"gpgpu",void 0),n([h(H)],Ae.prototype,"localTimeOrigin",void 0),n([h(H)],Ae.prototype,"visualVariableData",void 0),n([h(H)],Ae.prototype,"dataDriven0",void 0),n([h(H)],Ae.prototype,"dataDriven1",void 0),n([h(H)],Ae.prototype,"dataDriven2",void 0),n([h(a)],Ae.prototype,"size",void 0);let Oi=class extends B{};n([h(a)],Oi.prototype,"activeReasons",void 0),n([h(a)],Oi.prototype,"highlightAll",void 0);let Pt=class extends B{};n([h(f)],Pt.prototype,"position",void 0),n([h(a)],Pt.prototype,"distance",void 0),n([h(a)],Pt.prototype,"smallSymbolDistance",void 0),n([h(a)],Pt.prototype,"smallSymbolSizeThreshold",void 0);let ie=class extends B{};n([h(E)],ie.prototype,"displayViewScreenMat3",void 0),n([h(E)],ie.prototype,"displayViewMat3",void 0),n([h(E)],ie.prototype,"displayMat3",void 0),n([h(E)],ie.prototype,"viewMat3",void 0),n([h(E)],ie.prototype,"tileMat3",void 0),n([h(a)],ie.prototype,"displayZoomFactor",void 0),n([h(a)],ie.prototype,"requiredZoomFactor",void 0),n([h(f)],ie.prototype,"tileOffset",void 0),n([h(a)],ie.prototype,"currentScale",void 0),n([h(a)],ie.prototype,"currentZoom",void 0),n([h(a)],ie.prototype,"metersPerSRUnit",void 0),n([h(a)],ie.prototype,"rotation",void 0),n([h(a)],ie.prototype,"pixelRatio",void 0);let fe=class extends Ui{};n([y(0,_)],fe.prototype,"id",void 0),n([y(1,a)],fe.prototype,"bitset",void 0),n([y(2,f)],fe.prototype,"pos",void 0);let be=class extends kt{};n([y(14,f)],be.prototype,"nextPos1",void 0),n([y(15,f)],be.prototype,"nextPos2",void 0);let Pe=class extends _s{};class re extends Ni{clip(t,i){let s=new a(0);const o=this.storage.getFilterFlags(t);if(s=s.add(Se(2).multiply(Se(1).subtract(Vi(o,0)))),this.inside?s=s.add(Se(2).multiply(Se(1).subtract(Vi(o,1)))):this.outside?s=s.add(Se(2).multiply(Vi(o,1))):this.highlight&&(s=s.add(Se(2).multiply(Se(1).subtract(this._checkHighlight(o))))),i!=null){const r=new a(1).subtract(k(i.x,this.view.currentZoom)),l=k(i.y,this.view.currentZoom);s=s.add(new a(2).multiply(r.add(l)))}return s}getFragmentOutput(t,i,s=new a(1/255)){const o=new ci;return o.fragColor=this._maybeWriteHittest(i)??this._maybeHighlight(t,s)??t,o}_maybeHighlight(t,i){return this.highlight?new w(t.rgb,k(i,t.a)):null}_checkHighlight(t){let i=this._checkHighlightBit(t,0);for(let s=1;s<Lo;s++)i=i.add(this._checkHighlightBit(t,s));return k(new a(.1),i.add(this.highlight.highlightAll))}_checkHighlightBit(t,i){return Ho(t,i).multiply(N(this.highlight.activeReasons,i))}maybeRunHittest(t,i,s){if(this.hittestRequest==null)return null;const o=this.hittest(t,i,s);let r=M(U(o,this.hittestRequest.distance),new a(2),new a(0));const l=this.storage.getAttributeDataCoords(t.id),u=Uo(l);r=r.add(this.clip(t.id,t.zoomRange));const p=new w(new a(1/255),0,0,0);return{glPointSize:new a(1),glPosition:new w(u,r,1),color:p}}_maybeWriteHittest(t){return this.hittestRequest!=null?t.color:null}}n([Ge],re.prototype,"inside",void 0),n([Ge],re.prototype,"outside",void 0),n([R(Oi)],re.prototype,"highlight",void 0),n([h(Ae)],re.prototype,"storage",void 0),n([h(ie)],re.prototype,"view",void 0),n([R(Pt)],re.prototype,"hittestRequest",void 0);let tt=class extends B{getPatternOffsetAtTileOrigin(e,t=new a(0),i=new a(1)){const s=new f(qo).divide(e);let o=e.multiply(_i(this.maxIntsToLocalOrigin.multiply(s))).add(this.tileOffsetFromLocalOrigin).subtract(new a(.5).multiply(e));return o=new f(o.x.multiply(i).subtract(o.y.multiply(t)),o.x.multiply(t).add(o.y.multiply(i))),Et(o,e)}};n([h(f)],tt.prototype,"tileOffsetFromLocalOrigin",void 0),n([h(f)],tt.prototype,"maxIntsToLocalOrigin",void 0);let xe=class extends B{};n([h(f)],xe.prototype,"size",void 0),n([h(H)],xe.prototype,"texture",void 0);let Ke=class extends B{getColor(e,t,i){return Fe([qi(Le(e),i),t],[$t(e,this.values.first()),this.colors.first()],[ui(e,this.values.last()),this.colors.last()],[!0,()=>{const s=this.values.findIndex(p=>U(p,e)),o=this.values.get(s),r=s.subtract(1),l=this.values.get(r),u=e.subtract(l).divide(o.subtract(l));return j(this.colors.get(r),this.colors.get(s),u)}])}};n([h(X.ofType(w,8))],Ke.prototype,"colors",void 0),n([h(X.ofType(a,8))],Ke.prototype,"values",void 0);let je=class extends B{getOpacity(e){return Fe([Le(e),new a(1)],[$t(e,this.opacityValues.first()),this.opacities.first()],[ui(e,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const t=this.opacityValues.findIndex(l=>U(l,e)),i=this.opacityValues.get(t),s=t.subtract(1),o=this.opacityValues.get(s),r=e.subtract(o).divide(i.subtract(o));return j(this.opacities.get(s),this.opacities.get(t),r)}])}};n([h(X.ofType(a,8))],je.prototype,"opacities",void 0),n([h(X.ofType(a,8))],je.prototype,"opacityValues",void 0);let hi=class extends B{getVVRotationMat4(e){return M(Le(e),ti.identity(),()=>{const t=this.getNormalizedAngle(e).multiply(ms),i=qe(t),s=Ne(t);return new ti(s,i,0,0,i.multiply(new a(-1)),s,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return M(Le(e),E.identity(),()=>{const t=this.getNormalizedAngle(e).multiply(ms),i=qe(t),s=Ne(t);return new E(s,i,0,i.multiply(new a(-1)),s,0,0,0,1)})}getNormalizedAngle(e){const t=ve(this.rotationType,new a(Ti.Arithmatic));return M(t,new a(90).subtract(e),e)}};n([h(a)],hi.prototype,"rotationType",void 0);let gt=class extends B{getSize(e,t){const i=this.minMaxValueAndSize.xy,s=this.minMaxValueAndSize.zw;return M(Le(e),t,()=>{const o=e.subtract(i.x).divide(i.y.subtract(i.x)),r=ge(o,new a(0),new a(1));return s.x.add(r.multiply(s.y.subtract(s.x)))})}};n([h(w)],gt.prototype,"minMaxValueAndSize",void 0);let it=class extends B{getSizeForViewScale(e){return Fe([$t(e,this.values.first()),this.sizes.first()],[ui(e,this.values.last()),this.sizes.last()],[!0,()=>{const t=this.values.findIndex(l=>U(l,e)),i=this.values.get(t),s=t.subtract(1),o=this.values.get(s),r=e.subtract(o).divide(i.subtract(o));return j(this.sizes.get(s),this.sizes.get(t),r)}])}};n([h(X.ofType(a,8))],it.prototype,"sizes",void 0),n([h(X.ofType(a,8))],it.prototype,"values",void 0);let st=class extends B{getSize(e,t){const i=Fe([Le(e),t],[$t(e,this.values.first()),this.sizes.first()],[ui(e,this.values.last()),this.sizes.last()],[!0,()=>{const s=this.values.findIndex(p=>U(p,e)),o=this.values.get(s),r=s.subtract(1),l=this.values.get(r),u=e.subtract(l).divide(o.subtract(l));return j(this.sizes.get(r),this.sizes.get(s),u)}]);return M(Le(i),t,i)}};n([h(X.ofType(a,8))],st.prototype,"sizes",void 0),n([h(X.ofType(a,8))],st.prototype,"values",void 0);let bt=class extends B{getSize(e,t){return M(Le(e),t,e.multiply(this.unitValueToPixelsRatio))}};n([h(a)],bt.prototype,"unitValueToPixelsRatio",void 0);function Ls(e){return e.visualVariableSizeMinMaxValue!=null||e.visualVariableSizeScaleStops!=null||e.visualVariableSizeStops!=null||e.visualVariableSizeUnitValue!=null}function Lt(e,t,i){if(Ls(e)){const s=e.storage.getSizeValue(t);return e.visualVariableSizeMinMaxValue?.getSize(s,i)??e.visualVariableSizeScaleStops?.getSizeForViewScale(e.view.currentScale)??e.visualVariableSizeStops?.getSize(s,i)??e.visualVariableSizeUnitValue?.getSize(s,i)}return i}function xt(e,t,i,s=new It(!1)){if(e.visualVariableColor==null)return i;const o=e.storage.getColorValue(t);return e.visualVariableColor.getColor(o,i,s)}function wt(e,t){if(e.visualVariableOpacity==null)return new a(1);const i=e.storage.getOpacityValue(t);return e.visualVariableOpacity.getOpacity(i)}function Es(e,t){if(e.visualVariableRotation==null)return E.identity();const i=e.storage.getRotationValue(t);return e.visualVariableRotation.getVVRotationMat3(i)}function ba(e,t){if(e.visualVariableRotation==null)return new a(0);const i=e.storage.getRotationValue(t);return e.visualVariableRotation.getNormalizedAngle(i)}let Be=class extends fe{};n([y(3,f)],Be.prototype,"offset",void 0),n([y(4,w)],Be.prototype,"sizing",void 0),n([y(5,w)],Be.prototype,"value1Position2Value2",void 0),n([y(6,w)],Be.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),n([y(7,f)],Be.prototype,"zoomRange",void 0),n([y(8,a)],Be.prototype,"lineLength",void 0);let ks=class extends Pe{},me=class extends re{_vertexPreamble(e,t,i){const{id:s,offset:o,animationPointerAndBaseSizeAndReferenceSize:r,sizing:l}=e,u=r.xy,p=r.z,c=r.w,d=l.xy,m=this._getEvalParams(e,d,i);let v,g;if(e.value1Position2Value2){const F=pe(u,oe.shift,m).a,Ee=e.pos,ot=e.value1Position2Value2.yz,zt=e.value1Position2Value2.x,co=e.value1Position2Value2.w,wi=F.subtract(zt).divide(co.subtract(zt));g=Ee.add(ot.subtract(Ee).multiply(wi)),v=k(new a(1),wi).add(k(new a(0),J(wi)))}else g=e.pos,v=new a(0);const b=l.z,x=N(e.bitset,Ve.bitset.isStroke),S=l.w,V=N(e.bitset,Ve.bitset.scaleSymbolsProportionally),A=pe(u,oe.transform,m),I=Fe([ve(N(e.bitset,Ve.bitset.isMapAligned),new a(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new a(0)]),L=new zo(Ne(I),qe(I.multiply(-1)),qe(I),Ne(I)).multiply(A.xy),C=A.z.subtract(I).subtract(t.multiply(Wi)),O=A.w,D=N(e.bitset,Ve.bitset.isSDF),T=Lt(this,s,new a(c)).divide(new a(c));return{baseSize:p,animationPointer:u,strokeWidth:b,isOutline:x,unscaledDistanceToPx:S,scaleSymbolsProportionally:V,isSDF:D,position:this._getScreenPosition({id:s,pos:g,offset:o,referenceSize:c,translation:L,rotation:C,scale:O,vvScale:T}),evalParams:m,vvScale:T,scale:O,clip:v}}_getScreenPosition(e){const{pos:t,translation:i,rotation:s,scale:o,offset:r,id:l,vvScale:u}=e,p=ba(this,l).multiply(Math.PI/180),c=i.x.multiply(4/3),d=i.y.multiply(-1).multiply(4/3),m=qe(p),v=Ne(p),g=v.multiply(c).add(J(m).multiply(d)),b=m.multiply(c).add(v.multiply(d)),x=qe(s.subtract(p)),S=Ne(s.subtract(p)),V=new a(0),A=new a(1),{pixelRatio:I}=this.animationInfo,L=new E(A,V,V,V,A,V,g.multiply(I),b.multiply(I),A),C=new E(S,x.multiply(-1),V,x,S,V,0,0,A),O=o.multiply(u).multiply(I).multiply(4/3),D=C.multiply(O),T=this.animationInfo.toScreen.multiply(new _(t,1)),F=L.multiply(T).xy,Ee=D.multiply(new _(r,0)).xy;return F.add(Ee)}_clip(e,t){let i=super.clip(e,t);const s=$t(this._getLocalTimeOrigin(e),new a(0));return Ki.forceGlobalTimeOrigin||(i=i.add(Fe([s,()=>new a(2)],[!0,()=>new a(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new _(e,1)).xy}_getEvalParams(e,t,i){const{globalTime:s,animationTextureSize:o,animationTexture:r}=this.animationInfo;return{globalTime:s,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:o,animationTexture:r,pixelDimensions:t,lineLength:i}}_getColor(e,t){return M(ve(t.isSDF,new a(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return $(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=$(this.mosaicInfo.texture,e),s=new a(.5).subtract(di(i)).multiply(t.distanceToPx).multiply(Ts),o=ge(new a(.5).subtract(s),new a(0),new a(1)),r=t.color.multiply(o),l=t.outlineSize.multiply(.5),u=Bt(s).subtract(l),p=ge(new a(.5).subtract(u),new a(0),new a(1)),c=t.outlineColor.multiply(p);return new a(1).subtract(c.a).multiply(r).add(c)}};function pe(e,t,i){const s=e.add(new f(t,0)),o=$(i.animationTexture,s.add(.5).divide(i.animationTextureSize)).xy;return e=e.add(o),Po({animationPointer:e,...i},w,null,r=>{const{out:l}=r;if(!l)throw new Error("out is null");return Io({...r,out:l})})}n([h(xe)],me.prototype,"mosaicInfo",void 0),n([h(ke)],me.prototype,"animationInfo",void 0),n([h(tt)],me.prototype,"localTileOffset",void 0),n([R(Ke)],me.prototype,"visualVariableColor",void 0),n([R(je)],me.prototype,"visualVariableOpacity",void 0),n([R(gt)],me.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(it)],me.prototype,"visualVariableSizeScaleStops",void 0),n([R(st)],me.prototype,"visualVariableSizeStops",void 0),n([R(bt)],me.prototype,"visualVariableSizeUnitValue",void 0),n([R(hi)],me.prototype,"visualVariableRotation",void 0);let ji=class extends Be{};n([y(9,w)],ji.prototype,"tlbr",void 0);let oi=class extends kt{};n([y(13,f)],oi.prototype,"nextPos1",void 0),n([y(14,f)],oi.prototype,"nextPos2",void 0);let $s=class extends ks{},Bs=class extends me{_fragmentPoly(e){const t=Et(e.uv,new a(1)),i=j(e.tlbr.xy,e.tlbr.zw,t);return this._getColor(i,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth})}_vertexPoly(e){const{position:t,animationPointer:i,evalParams:s,isOutline:o,unscaledDistanceToPx:r,vvScale:l,strokeWidth:u,scaleSymbolsProportionally:p,scale:c,isSDF:d,baseSize:m,clip:v}=this._vertexPreamble(e,new a(0),e.lineLength||new a(0)),g=this._toNdc(t);let b=pe(i,oe.fromColor,s);b=new w(b.rgb.multiply(b.a),b.a);let x=pe(i,oe.toColor,s);x=new w(x.rgb.multiply(x.a),x.a);let S=pe(i,oe.colorMix,s);S=new w(S.rgb.multiply(S.a),S.a);const V=pe(i,oe.toOpacity,s).a,A=pe(i,oe.opacityMix,s).a,I=xt(this,e.id,b,qi(vt(e.bitset,Ve.bitset.colorLocked),new It(o))),L=j(I,x,S),C=wt(this,e.id),O=j(C,V,A),D=L.multiply(O),T=this.clip(e.id,e.zoomRange).add(v.multiply(2)),F=r.multiply(l);return{unscaledDistanceToPx:r,vvScale:l,strokeWidth:u,scaleSymbolsProportionally:p,scale:c,isSDF:d,baseSize:m,ndc:g,color:D,z:T,isOutline:o,evalParams:s,distanceToPx:F}}};function xa(e,t){return Je(e,Oo(t))}function Qe(e,t,i){const s=i.subtract(t),o=xa(e.subtract(t),s),r=ge(o.divide(et(s)),new a(0),new a(1));return pi(e,t.add(r.multiply(i.subtract(t))))}function W(e){const t=Bt(e);return k(t.x.add(t.y).add(t.z),new a(1.05))}function K(e,t,i,s){const o=new E(i.x.multiply(s.y).subtract(s.x.multiply(i.y)),s.x.multiply(t.y).subtract(t.x.multiply(s.y)),t.x.multiply(i.y).subtract(i.x.multiply(t.y)),i.y.subtract(s.y),s.y.subtract(t.y),t.y.subtract(i.y),s.x.subtract(i.x),t.x.subtract(s.x),i.x.subtract(t.x)),r=t.x.multiply(i.y.subtract(s.y)),l=i.x.multiply(s.y.subtract(t.y)),u=s.x.multiply(t.y.subtract(i.y)),p=r.add(l).add(u);return new a(1).divide(p).multiply(o.multiply(new _(1,e)))}function wa(e,t,i,s){return ve(W(K(e,t,i,s)),new a(1))}function yi(e,t,i,s){const o=i.subtract(t),r=s.subtract(t),l=No(o,r),u=is(Gi(l,new a(Wo)),U(l,new a(-.05)));return Fe([is(Ro(u),wa(e.xy,t,i,s)),new a(-1)],[!0,()=>{const p=Qe(e,t,i),c=Qe(e,i,s),d=Qe(e,s,t);return We(We(p,c),d)}])}function St(e){return e.distance.add(1)}function fi(e,t,i){const{viewMat3:s,tileMat3:o}=e.view,r=s.multiply(o),l=r.multiply(new _(t.pos,1)),u=r.multiply(new _(i.nextPos1,1)),p=r.multiply(new _(i.nextPos2,1));return yi(e.hittestRequest.position,l.xy,u.xy,p.xy)}function Sa(e,t,i){return pi(e,i).subtract(t)}let ft=class extends fe{};n([y(3,w)],ft.prototype,"color",void 0),n([y(4,f)],ft.prototype,"zoomRange",void 0);let Ie=class extends re{constructor(){super(...arguments),this.type="FillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const i=wt(this,e.id),s=xt(this,e.id,e.color).multiply(i),o=this.view.displayViewScreenMat3.multiply(new _(e.pos.xy,1)),r=this.clip(e.id,e.zoomRange);return{glPosition:new w(o.xy,r,1),color:s,...this.maybeRunHittest(e,t,null)}}fragment(e){return this.getFragmentOutput(e.color,e,new a(0))}hittest(e,t){return fi(this,e,t)}};n([R(Ke)],Ie.prototype,"visualVariableColor",void 0),n([R(je)],Ie.prototype,"visualVariableOpacity",void 0),n([z(0,P(ft)),z(1,P(be))],Ie.prototype,"vertex",null),n([z(0,P(Pe))],Ie.prototype,"fragment",null);let Xe=class extends ft{};n([y(5,w)],Xe.prototype,"tlbr",void 0),n([y(6,a)],Xe.prototype,"width",void 0),n([y(7,a)],Xe.prototype,"height",void 0),n([y(8,f)],Xe.prototype,"offset",void 0),n([y(9,f)],Xe.prototype,"scale",void 0),n([y(10,a)],Xe.prototype,"angle",void 0);let Va=class extends Pe{};function Hs(e,t,i,s,o){const r=ve(N(o,Ko),Se(1)),l=di(new w(e,0));return M(r,ss(s.divide(t.x),i.divide(t.y),0,J(i.divide(t.x)),s.divide(t.y),0,ps(os(l,0)),ps(os(0,l)),1),ss(s.divide(t.x),i.divide(t.y),0,J(i.divide(t.x)),s.divide(t.y),0,0,0,1))}function Us(e,t){const i=e.view.requiredZoomFactor,s=new f(t.width,t.height),o=s.multiply(t.scale).multiply(i),r=t.angle.multiply(Wi),l=qe(r),u=Ne(r),p=Hs(t.id,o,l,u,t.bitset),c=e.localTileOffset.getPatternOffsetAtTileOrigin(s,l,u),d=i.multiply(t.scale).multiply(t.offset.subtract(c)).divide(o),m=new _(t.pos,1),v=p.multiply(m).xy.subtract(d),g=t.tlbr.divide(e.mosaicInfo.size.xyxy);let b=N(t.bitset,Ms);return e.visualVariableColor!=null&&(b=M(Le(e.storage.getColorValue(t.id)),new a(0),b)),{tileTextureCoord:v,tlbr:g,sampleAlphaOnly:b}}function Ns(e,t){const i=Et(t.tileTextureCoord,new a(1)),s=j(t.tlbr.xy,t.tlbr.zw,i);let o=$(e.mosaicInfo.texture,s);return o=M(U(t.sampleAlphaOnly,new a(.5)),o.aaaa,o),t.color.multiply(o)}let At=class extends Ie{constructor(){super(...arguments),this.type="ComplexFillShader"}vertex(e,t){return{...super.vertex(e,t),...Us(this,e)}}fragment(e){const t=Ns(this,e);return this.getFragmentOutput(t,e,new a(0))}};n([h(xe)],At.prototype,"mosaicInfo",void 0),n([h(tt)],At.prototype,"localTileOffset",void 0),n([z(0,P(Xe)),z(1,P(be))],At.prototype,"vertex",null),n([z(0,P(Va))],At.prototype,"fragment",null);let Di=class extends Bs{constructor(){super(...arguments),this.type="AnimatedFillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const{distanceToPx:i,ndc:s,z:o,color:r,isOutline:l,strokeWidth:u,isSDF:p,baseSize:c,scale:d,scaleSymbolsProportionally:m}=this._vertexPoly(e),v=this.view.requiredZoomFactor,g=e.sizing.xy,b=g.multiply(v),x=new a(0),S=qe(x),V=Ne(x),A=Hs(e.id,b,S,V,e.bitset),I=this.localTileOffset.getPatternOffsetAtTileOrigin(g,S,V),L=v.multiply(e.offset.subtract(I)).divide(b),C=new _(e.pos,1),O=A.multiply(C).xy.subtract(L),D=e.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new w(s,o,1),tlbr:D,uv:O,color:r.multiply(new a(1).subtract(l)),outlineColor:r.multiply(l),distanceToPx:i,strokeWidth:u.multiply(j(new a(1),d,m)),isOutline:l,isSDF:p,...this.maybeRunHittest(e,t,{pos:e.pos,size:c,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new E(1,0,0,0,1,0,0,0,1),placementMat3:new E(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:i,isSDF:p})}}fragment(e){const t=this._fragmentPoly(e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return fi(this,e,t)}};n([z(0,P(ji)),z(1,P(oi))],Di.prototype,"vertex",null),n([z(0,P($s))],Di.prototype,"fragment",null);let De=class extends fe{};n([y(3,w)],De.prototype,"color",void 0),n([y(4,f)],De.prototype,"offset",void 0),n([y(5,f)],De.prototype,"normal",void 0),n([y(6,a)],De.prototype,"halfWidth",void 0),n([y(7,a)],De.prototype,"referenceHalfWidth",void 0),n([y(8,f)],De.prototype,"zoomRange",void 0);let qs=class extends Pe{},ai=class extends B{};function Zi(e){return ze(new a(jo).multiply(k(e,new a(Zo))),new a(1))}function Xi(e,t){const{halfWidth:i,normal:s}=e,o=Zi(i),r=et(s).multiply(i);return ge(o.multiply(i.subtract(r)).divide(t.add(o).subtract(new a(1))),new a(0),new a(1))}function za(e,t){const{id:i,halfWidth:s,referenceHalfWidth:o}=t;if(Ls(e)){const r=new a(2).multiply(o),l=Lt(e,i,r);return new a(.5).multiply(s.divide(ze(o,new a(sa)))).multiply(l)}return s}function vi(e,t){const{id:i,offset:s,pos:o,normal:r,zoomRange:l}=t,{displayViewScreenMat3:u,displayViewMat3:p}=e.view,c=xt(e,i,t.color),d=wt(e,i),m=za(e,t),v=new a(.5).multiply(e.antialiasingControls.antialiasing),g=ze(m.add(v),new a(.45)).add(new a(.1).multiply(v)),b=Zi(g).multiply(g).multiply(s),x=p.multiply(new _(b,new a(0))),S=u.multiply(new _(o,new a(1))).add(x),V=new a(2).multiply(k(m,new a(0))).add(e.clip(i,l)),A=new w(S.xy,V,1);return{color:c,opacity:d,halfWidth:g,normal:r,scaledOffset:b,scaledHalfWidth:m,glPosition:new w(A.xy,V,1)}}function gi(e,t){const{opacity:i,color:s}=e,o=Xi(e,t);return i.multiply(s).multiply(o)}n([h(a)],ai.prototype,"antialiasing",void 0),n([h(a)],ai.prototype,"blur",void 0);let he=class extends re{constructor(){super(...arguments),this.type="LineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const i=vi(this,e);return{...i,...this.maybeRunHittest(e,t,i.halfWidth)}}fragment(e){const t=gi(e,this.antialiasingControls.blur);return this.getFragmentOutput(t,e)}hittest(e,t,i){const{viewMat3:s,tileMat3:o}=this.view,r=s.multiply(o),l=r.multiply(new _(e.pos,1)),u=r.multiply(new _(t.nextPos1,1)),p=r.multiply(new _(t.nextPos2,1)),{distance:c,smallSymbolDistance:d,smallSymbolSizeThreshold:m}=this.hittestRequest,v=k(i,m.multiply(.5)).multiply(c.subtract(d)),g=this.hittestRequest.position;return We(Qe(g,l.xy,u.xy),Qe(g,l.xy,p.xy)).subtract(i).add(v)}};n([h(ai)],he.prototype,"antialiasingControls",void 0),n([R(Ke)],he.prototype,"visualVariableColor",void 0),n([R(je)],he.prototype,"visualVariableOpacity",void 0),n([R(gt)],he.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(it)],he.prototype,"visualVariableSizeScaleStops",void 0),n([R(st)],he.prototype,"visualVariableSizeStops",void 0),n([R(bt)],he.prototype,"visualVariableSizeUnitValue",void 0),n([z(0,P(De)),z(1,P(be))],he.prototype,"vertex",null),n([z(0,P(qs))],he.prototype,"fragment",null);let Kt=class extends ji{};n([y(10,a)],Kt.prototype,"accumulatedDistance",void 0),n([y(11,f)],Kt.prototype,"normal",void 0),n([y(12,f)],Kt.prototype,"segmentDirection",void 0);let Pa=class extends $s{},Ii=class extends Bs{constructor(){super(...arguments),this.type="AnimatedLineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){const{animationPointerAndBaseSizeAndReferenceSize:i}=e,s=i.xy,{distanceToPx:o,ndc:r,z:l,color:u,isOutline:p,strokeWidth:c,isSDF:d,baseSize:m,scale:v,scaleSymbolsProportionally:g,evalParams:b}=this._vertexPoly(e),x=e.sizing.xy,S=x.x.multiply(m).divide(x.y),V=pe(s,oe.shift,b).a,A=e.accumulatedDistance.subtract(V),{normal:I}=e,L=e.normal.y,C=A.divide(this.view.displayZoomFactor).add(Je(e.segmentDirection,e.offset)).divide(S),O=L.add(1).divide(2),D=new f(C,O),T=e.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new w(r,l,1),tlbr:T,uv:D,color:u.multiply(new a(1).subtract(p)),outlineColor:u.multiply(p),distanceToPx:o,strokeWidth:c.multiply(j(new a(1),v,g)),isOutline:p,isSDF:d,halfWidth:m.divide(2),normal:I,...this.maybeRunHittest(e,t,{pos:e.pos,size:m,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new E(1,0,0,0,1,0,0,0,1),placementMat3:new E(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:o,isSDF:d})}}fragment(e){const t=this._fragmentPoly(e),{halfWidth:i,normal:s}=e,o=Zi(i),r=et(s).multiply(i),l=ge(o.multiply(i.subtract(r)).divide(o.subtract(new a(1))),new a(0),new a(1));return this.getFragmentOutput(t.multiply(l),e)}hittest(e,t,i){const{viewMat3:s,tileMat3:o}=this.view,r=s.multiply(o),l=r.multiply(new _(e.pos,1)),u=r.multiply(new _(t.nextPos1,1)),p=r.multiply(new _(t.nextPos2,1)),{distance:c,smallSymbolDistance:d,smallSymbolSizeThreshold:m}=this.hittestRequest,v=k(i,m.multiply(.5)).multiply(c.subtract(d)),g=this.hittestRequest.position;return We(Qe(g,l.xy,u.xy),Qe(g,l.xy,p.xy)).subtract(i).add(v)}};n([z(0,P(Kt)),z(1,P(oi))],Ii.prototype,"vertex",null),n([z(0,P(Pa))],Ii.prototype,"fragment",null);let Fi=class extends Be{};n([y(9,f)],Fi.prototype,"uv",void 0),n([y(10,a)],Fi.prototype,"angle",void 0);let _t=class extends kt{};n([y(11,f)],_t.prototype,"offsetNextVertex1",void 0),n([y(12,f)],_t.prototype,"offsetNextVertex2",void 0),n([y(13,f)],_t.prototype,"textureUVNextVertex1",void 0),n([y(14,f)],_t.prototype,"textureUVNextVertex2",void 0);let Aa=class extends ks{};function Te(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}let ri=class extends me{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=e.uv.divide(this.mosaicInfo.size),{position:s,animationPointer:o,evalParams:r,isOutline:l,unscaledDistanceToPx:u,vvScale:p,strokeWidth:c,scaleSymbolsProportionally:d,scale:m,isSDF:v,baseSize:g,clip:b}=this._vertexPreamble(e,e.angle,e.lineLength||new a(0)),x=this._toNdc(s);let S=pe(o,oe.fromColor,r);S=new w(S.rgb.multiply(S.a),S.a);let V=pe(o,oe.toColor,r);V=new w(V.rgb.multiply(V.a),V.a);let A=pe(o,oe.colorMix,r);A=new w(A.rgb.multiply(A.a),A.a);const I=pe(o,oe.toOpacity,r).a,L=pe(o,oe.opacityMix,r).a,C=xt(this,e.id,S,qi(vt(e.bitset,Ve.bitset.colorLocked),new It(l))),O=j(C,V,A),D=wt(this,e.id),T=j(D,I,L),F=O.multiply(T),Ee=this.clip(e.id,e.zoomRange).add(b.multiply(2)),ot=u.multiply(p);return{glPosition:new w(x,Ee,1),uv:i,color:F.multiply(new a(1).subtract(l)),outlineColor:F.multiply(l),distanceToPx:ot,strokeWidth:c.multiply(j(new a(1),m,d)),isOutline:l,isSDF:v,...this.maybeRunHittest(e,t,{pos:e.pos,size:g,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new E(1,0,0,0,1,0,0,0,1),placementMat3:new E(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:ot,isSDF:v})}}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return Ki.spotlightAnimatedSymbols&&(t=t.add(new w(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return M(Gi(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){const{position:s,distance:o,smallSymbolDistance:r}=this.hittestRequest,l=o.subtract(r),{viewMat3:u,tileMat3:p}=this.view,c=u.multiply(p).multiply(new _(i.pos,1)).xy,d=i.size.multiply(.5);return pi(c,s).subtract(d).add(l)}_hittestMarker(e,t,i){const s=this._vertexPreamble({...e},e.angle,new a(0)).position,o=this._vertexPreamble({...e,offset:t.offsetNextVertex1},e.angle,new a(0)).position,r=this._vertexPreamble({...e,offset:t.offsetNextVertex2},e.angle,new a(0)).position,l=this.hittestRequest.position,u=this.hittestRequest.distance,p=yi(l,s,o,r);return M(U(p,u),p,this._hittestSamples(s,o,r,e,t,i))}_hittestSamples(e,t,i,s,o,r){const{outlineSize:l,isSDF:u,distanceToPx:p}=r,c=this.hittestRequest.position,d=this.hittestRequest.distance,m=K(c.add(new f(J(d),J(d))),e,t,i),v=K(c.add(new f(0,J(d))),e,t,i),g=K(c.add(new f(d,J(d))),e,t,i),b=K(c.add(new f(J(d),0)),e,t,i),x=K(c,e,t,i),S=K(c.add(new f(d,0)),e,t,i),V=K(c.add(new f(J(d),d)),e,t,i),A=K(c.add(new f(0,d)),e,t,i),I=K(c.add(new f(d,d)),e,t,i),L=s.uv.divide(this.mosaicInfo.size),C=o.textureUVNextVertex1.divide(this.mosaicInfo.size),O=o.textureUVNextVertex2.divide(this.mosaicInfo.size),D={color:new w(1,1,1,1),outlineSize:l,outlineColor:new w(1,1,1,1),isSDF:u,distanceToPx:p};let T=new a(0);return T=T.add(W(m).multiply(this._getColor(Te(m,L,C,O),D).a)),T=T.add(W(v).multiply(this._getColor(Te(v,L,C,O),D).a)),T=T.add(W(g).multiply(this._getColor(Te(g,L,C,O),D).a)),T=T.add(W(b).multiply(this._getColor(Te(b,L,C,O),D).a)),T=T.add(W(x).multiply(this._getColor(Te(x,L,C,O),D).a)),T=T.add(W(S).multiply(this._getColor(Te(S,L,C,O),D).a)),T=T.add(W(V).multiply(this._getColor(Te(V,L,C,O),D).a)),T=T.add(W(A).multiply(this._getColor(Te(A,L,C,O),D).a)),T=T.add(W(I).multiply(this._getColor(Te(I,L,C,O),D).a)),k(T,new a(.05)).multiply(St(this.hittestRequest))}};n([z(0,P(Fi)),z(1,P(_t))],ri.prototype,"vertex",null),n([z(0,P(Aa))],ri.prototype,"fragment",null);let te=class extends Co{constructor(){super(...arguments),this.symbologyPlane=ce.FILL,this._input=null}},bi=class extends te{render(e,t){const{context:i,painter:s}=e,{target:o}=t,{freezeGlobalTime:r}=Ki,l=0,u=s.textureManager.animationStore.getTexture(i,l),p=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],c=Array.from(oa(hs(),p)),d=Array.from(aa(hs(),c,o.transforms.displayViewScreenMat3)),m=t.instance.getInput(),v=s.textureManager.getMosaicInfo(i,t.textureKey,!1),{optionalAttributes:g}=m,b=g.zoomRange,x=g.value1Position2Value2,S="accumulatedDistance"in g&&g.accumulatedDistance,V="segmentDirection"in g&&g.segmentDirection,A="normal"in g&&g.normal;s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,m.uniforms),...Q(e,t.target),mosaicInfo:v,animationInfo:{globalTime:r===!1?e.time/1e3:r,animationTextureSize:[u.descriptor.width,u.descriptor.height],animationTexture:{unit:6,texture:u},toScreen:d,toNdc:p,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio},localTileOffset:Ht(t.target)},defines:{...Z(e)},optionalAttributes:{zoomRange:b,value1Position2Value2:x,accumulatedDistance:S,segmentDirection:V,normal:A},useComputeBuffer:!0}),s.setPipelineState({...ee(e)}),s.submitDraw(e,t),r===!1&&o.requestRender()}},_a=class extends bi{constructor(){super(...arguments),this.type=G.AnimatedMarker,this.symbologyPlane=ce.MARKER,this.shaders={geometry:new ri}}},Ta=class extends bi{constructor(){super(...arguments),this.type=G.AnimatedMarkerShift,this.symbologyPlane=ce.MARKER,this.shaders={geometry:new ri}}},Ma=class extends bi{constructor(){super(...arguments),this.type=G.AnimatedFill,this.symbologyPlane=ce.FILL,this.shaders={geometry:new Di}}},Ra=class extends bi{constructor(){super(...arguments),this.type=G.AnimatedLine,this.symbologyPlane=ce.LINE,this.shaders={geometry:new Ii}}},Gs=class extends Ui{};n([y(0,f)],Gs.prototype,"pos",void 0);let Ca=class extends Pe{},Ws=class extends B{};n([h(a)],Ws.prototype,"dotSize",void 0);let jt=class extends B{};n([h(H)],jt.prototype,"locations",void 0),n([h(a)],jt.prototype,"pixelRatio",void 0),n([h(a)],jt.prototype,"tileZoomFactor",void 0);const Oa=1e-6;let nt=class extends Ni{constructor(){super(...arguments),this.type="DotDensityPointShader"}vertex(e){const t=new E(1,0,0,0,-1,0,0,1,1).multiply(new _(e.pos.xy.divide(ue),1)),i=$(this.draw.locations,t.xy),s=ze(this.instance.dotSize.divide(2),new a(1));let o=new a(0);o=o.add(k(i.a,new a(Oa)).multiply(2));let r=s.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new _(e.pos.add(.5),1)),u=new w(l.xy,o,1),p=this.instance.dotSize.divide(r),c=new a(-1).divide(s.divide(r));return r=r.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:r,color:i,ratio:p,invEdgeRatio:c}}fragment(e){const t=et(e.glPointCoord.subtract(.5)).multiply(2),i=Ps(new a(0),new a(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),s=new ci;return s.fragColor=e.color.multiply(i),s}};n([h(Ws)],nt.prototype,"instance",void 0),n([h(jt)],nt.prototype,"draw",void 0),n([h(ie)],nt.prototype,"view",void 0),n([z(0,P(Gs))],nt.prototype,"vertex",null),n([z(0,P(Ca))],nt.prototype,"fragment",null);let Ks=class extends fe{};n([y(3,a)],Ks.prototype,"inverseArea",void 0);let Zt=class extends B{};n([h(X.ofType(w,2))],Zt.prototype,"isActive",void 0),n([h(X.ofType(w,8))],Zt.prototype,"colors",void 0),n([h(a)],Zt.prototype,"dotValue",void 0);let lt=class extends B{};n([h(H)],lt.prototype,"dotTexture0",void 0),n([h(H)],lt.prototype,"dotTexture1",void 0),n([h(a)],lt.prototype,"tileZoomFactor",void 0),n([h(a)],lt.prototype,"pixelRatio",void 0),n([h(a)],lt.prototype,"tileDotsOverArea",void 0);let ut=class extends re{constructor(){super(...arguments),this.type="DotDensityPolygonShader"}_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new E(2/ue,0,0,0,-2/ue,0,-1,1,1).multiply(new _(e.pos,1)),i=this.clip(e.id),s=new w(t.xy,i,1),o=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),r=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(ue).divide(this.draw.pixelRatio),u=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),p=this._dotThreshold(r,this.instance.dotValue,this.draw.tileDotsOverArea),c=e.pos.add(.5).divide(l);return{glPosition:s,color:new w(0,0,0,0),textureCoords:c,thresholds0:u,thresholds1:p}}fragment(e){const t=new ci,i=$(this.draw.dotTexture0,e.textureCoords),s=$(this.draw.dotTexture1,e.textureCoords),o=e.thresholds0.subtract(i),r=e.thresholds1.subtract(s);let l;const u=ti.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),p=ti.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const c=k(new a(0),o),d=k(new a(0),r),m=Je(c,o).add(Je(d,r)),v=k(m,new a(0)),g=new a(1).subtract(v),b=m.add(v),x=o.multiply(c).divide(b),S=r.multiply(d).divide(b),V=u.multiply(x).add(p.multiply(S));l=g.multiply(V)}else{const c=ze(us(o),us(r)),d=k(c,new a(0)),m=new a(1).subtract(d),v=k(c,o),g=k(c,r),b=u.multiply(v).add(p.multiply(g));l=m.multiply(b)}return t.fragColor=l,t}hittest(e){return St(this.hittestRequest)}};n([Ge],ut.prototype,"blending",void 0),n([h(Zt)],ut.prototype,"instance",void 0),n([h(lt)],ut.prototype,"draw",void 0),n([z(0,P(Ks))],ut.prototype,"vertex",null),n([z(0,P(Pe))],ut.prototype,"fragment",null);const Da={pos:{count:2,type:_e.UNSIGNED_SHORT}};let Ia=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){const t=ue,i=ue,s=new si(t,i);s.samplingMode=yt.NEAREST,s.wrapMode=Mi.CLAMP_TO_EDGE;const o=new la(e,new Ds(Os.DEPTH24_STENCIL8,t,i));this._dotFBO=new Is(e,s,o)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){const t=ue,i=t*t,s=2,o=new Int16Array(i*s);for(let r=0;r<t;r++)for(let l=0;l<t;l++)o[s*(l+r*t)]=l,o[s*(l+r*t)+1]=r;this._dotMesh=ga.create(e,{primitive:Cs.POINTS,vertex:o,count:i,layout:Da})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){const s=new bo(i);this._dotTextures=[this._allocDotDensityTexture(e,t,s),this._allocDotDensityTexture(e,t,s)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const s=new Float32Array(t*t*4);for(let r=0;r<s.length;r++)s[r]=i.getFloat();const o=new si;return o.dataType=Ft.FLOAT,o.samplingMode=yt.NEAREST,o.width=t,o.height=t,new Fs(e,o,s)}},Fa=class extends te{constructor(){super(...arguments),this.type=G.DotDensity,this.shaders={polygon:new ut,point:new nt,fill:new Ie},this._resources=new Map}render(e,t){Rs(e)||q(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...Q(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...Z(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:q(e)}),i.setPipelineState(ee(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){const{context:i,painter:s,requiredLevel:o}=e,r=t.instance.getInput().uniforms,l=this._getOrCreateResourcesRecord(i),u=l.getDotDensityTextures(i,ue,r.seed),p=1/2**(o-t.target.key.level),c=ue,d=c*window.devicePixelRatio*c*window.devicePixelRatio,m=1/p*(1/p),v=r.dotScale?e.state.scale/r.dotScale:1,g=r.dotValue*v*m;s.setShader({shader:this.shaders.polygon,uniforms:{...Q(e,t.target),instance:{isActive:r.isActive,colors:r.colors,dotValue:Math.max(1,g)},draw:{dotTexture0:{unit:ns,texture:u[0]},dotTexture1:{unit:Eo,texture:u[1]},tileZoomFactor:p,pixelRatio:window.devicePixelRatio,tileDotsOverArea:d/(ue*window.devicePixelRatio*ue*window.devicePixelRatio)}},defines:{...Z(e),blending:r.blending},optionalAttributes:{},useComputeBuffer:!1});const b=i.getViewport();i.setViewport(0,0,ue,ue);const x=i.getBoundFramebufferObject(),S=l.getFBO(i);i.bindFramebuffer(S),i.setClearColor(0,0,0,0),i.clear(ii.COLOR),s.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),s.updatePipelineState(i),s.submitDraw(e,t),i.bindFramebuffer(x),i.setViewport(b.x,b.y,b.width,b.height);const V=l.getFBO(i).colorTexture,A={shader:this.shaders.point,uniforms:{view:ra(e,t.target),instance:{dotSize:r.dotSize},draw:{locations:{unit:ns,texture:V},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...Z(e)},optionalAttributes:{},useComputeBuffer:!1};s.setPipelineState(ee(e)),s.submitDrawMesh(i,A,l.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Ia,this._resources.set(e,t)),t}},La=class extends te{constructor(){super(...arguments),this.type=G.ComplexFill,this.shaders={geometry:new At}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,o.uniforms),...Q(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ht(t.target)},defines:{...Z(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(e)}),s.setPipelineState(ee(e)),s.submitDraw(e,t)}};function Vt(e){const t=1/e;return{antialiasing:t,blur:0+t}}let He=class extends fe{};n([y(3,f)],He.prototype,"offset",void 0),n([y(4,w)],He.prototype,"color",void 0),n([y(5,f)],He.prototype,"normal",void 0),n([y(6,a)],He.prototype,"halfWidth",void 0),n([y(7,a)],He.prototype,"referenceHalfWidth",void 0),n([y(8,f)],He.prototype,"zoomRange",void 0);let js=class extends qs{};function Yi(e,t,i){const{id:s,bitset:o}=t,r=N(o,Xo),l=U(r,new a(.5)),u=vi(e,t),p=M(l,u.halfWidth,new a(0)),c=wt(e,s),d=xt(e,s,t.color),m=M(l,M(vt(o,Yo),d,t.color),d.multiply(c)),v=e.view.displayViewScreenMat3.multiply(new _(t.pos.xy,1)),g=e.clip(t.id),b=new w(v.xy,g,1),x=M(l,u.glPosition,b),S=i&&e.maybeRunHittest(t,i,l);return{isOutline:r,color:m,opacity:new a(1),halfWidth:p,normal:u.normal,glPosition:x,...S}}let Oe=class extends re{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}};n([h(ai)],Oe.prototype,"antialiasingControls",void 0),n([R(Ke)],Oe.prototype,"visualVariableColor",void 0),n([R(je)],Oe.prototype,"visualVariableOpacity",void 0),n([R(gt)],Oe.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(it)],Oe.prototype,"visualVariableSizeScaleStops",void 0),n([R(st)],Oe.prototype,"visualVariableSizeStops",void 0),n([R(bt)],Oe.prototype,"visualVariableSizeUnitValue",void 0);class ni extends Oe{constructor(){super(...arguments),this.type="OutlineFillShader"}vertex(t,i){return Yi(this,t,i)}fragment(t){const{color:i,isOutline:s}=t,o=U(s,new a(.5)),r=gi(t,this.antialiasingControls.blur),l=M(o,r,i),u=M(o,new a(1/255),new a(0));return this.getFragmentOutput(l,t,u)}hittest(t,i,s){return M(s,St(this.hittestRequest),fi(this,t,i))}}n([z(0,P(He)),z(1,P(be))],ni.prototype,"vertex",null),n([z(0,P(js))],ni.prototype,"fragment",null);let Li=class extends ft{};n([y(5,w)],Li.prototype,"tlbr",void 0),n([y(6,a)],Li.prototype,"inverseRasterizationScale",void 0);let Ea=class extends Pe{};function ka(e){const t=new a(1),i=new a(0);return new E(t.divide(e.x),i.divide(e.y),0,J(i.divide(e.x)),t.divide(e.y),0,0,0,1)}function Zs(e,t){const i=t.tlbr.xy,s=t.tlbr.zw,o=s.x.subtract(i.x),r=i.y.subtract(s.y),l=new f(o,r).multiply(t.inverseRasterizationScale),u=l.multiply(e.view.requiredZoomFactor),p=ka(u),c=e.localTileOffset.getPatternOffsetAtTileOrigin(l).divide(u),d=new _(t.pos,1);return{tileTextureCoord:p.multiply(d).xy.subtract(c),tlbr:t.tlbr.divide(e.mosaicInfo.size.xyxy)}}function Xs(e,t){const i=Et(e.tileTextureCoord,new a(1)),s=j(e.tlbr.xy,e.tlbr.zw,i),o=$(t.texture,s);return e.color.multiply(o)}class Tt extends Ie{constructor(){super(...arguments),this.type="PatternFillShader"}vertex(t,i){return{...super.vertex(t,i),...Zs(this,t)}}fragment(t){const i=Xs(t,this.mosaicInfo);return this.getFragmentOutput(i,t,new a(0))}}n([h(xe)],Tt.prototype,"mosaicInfo",void 0),n([h(tt)],Tt.prototype,"localTileOffset",void 0),n([z(0,P(Li)),z(1,P(be))],Tt.prototype,"vertex",null),n([z(0,P(Ea))],Tt.prototype,"fragment",null);let Ei=class extends He{};n([y(9,w)],Ei.prototype,"tlbr",void 0),n([y(10,a)],Ei.prototype,"inverseRasterizationScale",void 0);let Ys=class extends js{},Mt=class extends ni{constructor(){super(...arguments),this.type="PatternOutlineFillShader"}vertex(e,t){return{...Yi(this,e,t),...Zs(this,e)}}fragment(e){const{isOutline:t}=e,i=U(t,new a(.5)),s=gi(e,this.antialiasingControls.blur),o=Xs(e,this.mosaicInfo),r=M(i,s,o),l=M(i,new a(1/255),new a(0));return this.getFragmentOutput(r,e,l)}};n([h(xe)],Mt.prototype,"mosaicInfo",void 0),n([h(tt)],Mt.prototype,"localTileOffset",void 0),n([z(0,P(Ei)),z(1,P(be))],Mt.prototype,"vertex",null),n([z(0,P(Ys))],Mt.prototype,"fragment",null);const bs=1/Qo;let Re=class extends fe{};n([y(3,w)],Re.prototype,"color",void 0),n([y(4,w)],Re.prototype,"tlbr",void 0),n([y(5,a)],Re.prototype,"angle",void 0),n([y(6,a)],Re.prototype,"aux1",void 0),n([y(7,a)],Re.prototype,"aux2",void 0),n([y(8,f)],Re.prototype,"aux3",void 0),n([y(9,f)],Re.prototype,"aux4",void 0),n([y(10,f)],Re.prototype,"zoomRange",void 0);let $a=class extends Ys{},Rt=class extends Oe{constructor(){super(...arguments),this.type="ComplexOutlineFillShader"}vertex(e,t){const{aux1:i,aux2:s,aux3:o,aux4:r}=e,l={...e,width:i,height:s,offset:o,scale:r.multiply(bs)},u={...e,halfWidth:i,referenceHalfWidth:s,offset:o,normal:r.subtract(Go).multiply(bs)},p=Yi(this,u),c=Us(this,l),d=U(p.isOutline,new a(.5));return{...p,...c,...this.maybeRunHittest(e,t,d)}}fragment(e){const{isOutline:t}=e,i=U(t,new a(.5)),s=gi(e,this.antialiasingControls.blur),o=Ns(this,e),r=M(i,s,o),l=M(i,new a(1/255),new a(0));return this.getFragmentOutput(r,e,l)}hittest(e,t,i){return M(i,St(this.hittestRequest),fi(this,e,t))}};n([h(xe)],Rt.prototype,"mosaicInfo",void 0),n([h(tt)],Rt.prototype,"localTileOffset",void 0),n([z(0,P(Re)),z(1,P(be))],Rt.prototype,"vertex",null),n([z(0,P($a))],Rt.prototype,"fragment",null);let Ba=class extends te{constructor(){super(...arguments),this.type=G.ComplexOutlineFill,this.shaders={geometry:new Rt}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,r=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,r.uniforms),...Q(e,t.target),antialiasingControls:Vt(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ht(t.target)},defines:{...Z(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:q(e)}),s.setPipelineState(ee(e)),s.submitDraw(e,t)}},Ha=class extends te{constructor(){super(...arguments),this.type=G.Fill,this.shaders={geometry:new Ie}}render(e,t){const{painter:i}=e,s=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,s.uniforms),...Q(e,t.target)},defines:Z(e),optionalAttributes:s.optionalAttributes,useComputeBuffer:q(e)}),i.setPipelineState(ee(e)),i.submitDraw(e,t)}},Ct=class extends ft{};n([y(5,w)],Ct.prototype,"tlbr",void 0),n([y(6,f)],Ct.prototype,"relativePosition",void 0),n([y(7,a)],Ct.prototype,"gradientMethod",void 0),n([y(8,f)],Ct.prototype,"relativeGradientSize",void 0);class Ua extends Pe{}let Xt=class extends Ie{constructor(){super(...arguments),this.type="GradientFillShader"}vertex(e,t){const{tlbr:i,relativePosition:s,gradientMethod:o,relativeGradientSize:r}=e,l=M(vt(e.bitset,rs.isAbsolute),this.view.displayZoomFactor,new a(1));return{...super.vertex(e,t),tlbr:i,relativePosition:s,gradientMethod:o,gradientSize:r.multiply(l),isDiscrete:N(e.bitset,rs.isDiscrete)}}fragment(e){const{tlbr:t,relativePosition:i,gradientMethod:s,gradientSize:o,isDiscrete:r}=e,l=M(U(r,new a(.5)),o.subtract(1),new f(0)),u=Fe([ve(s,new a(as.rectangular)),()=>{const v=Bt(i).add(l).divide(o);return Wt(ze(v.x,v.y))}],[ve(s,new a(as.circular)),Wt(As(Je(i,i)).add(l.x).divide(o.x))],[!0,Wt(i.x.add(l.x).divide(o.x))]),p=new f(ge(u,new a(0),new a(1)),.5),c=j(t.xy,t.zw,p).divide(this.mosaicInfo.size),d=$(this.mosaicInfo.texture,c),m=e.color.a;return this.getFragmentOutput(d.multiply(m),e,new a(0))}};n([h(xe)],Xt.prototype,"mosaicInfo",void 0),n([z(0,P(Ct)),z(1,P(be))],Xt.prototype,"vertex",null),n([z(0,P(Ua))],Xt.prototype,"fragment",null);let Na=class extends te{constructor(){super(...arguments),this.type=G.GradientFill,this.shaders={geometry:new Xt},this.symbologyPlane=ce.FILL}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,o.uniforms),...Q(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...Z(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(e)}),s.setPipelineState(ee(e)),s.submitDraw(e,t)}},qa=class extends te{constructor(){super(...arguments),this.type=G.OutlineFill,this.shaders={geometry:new ni}}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,o.uniforms),...Q(e,t.target),antialiasingControls:Vt(s)},defines:{...Z(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(e)}),i.setPipelineState(ee(e)),i.submitDraw(e,t)}},Ga=class extends te{constructor(){super(...arguments),this.type=G.PatternFill,this.shaders={geometry:new Tt}}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,o.uniforms),...Q(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ht(t.target)},defines:{...Z(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(e)}),s.setPipelineState(ee(e)),s.submitDraw(e,t)}},Wa=class extends te{constructor(){super(...arguments),this.type=G.PatternOutlineFill,this.shaders={geometry:new Mt}}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,r=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,r.uniforms),...Q(e,t.target),antialiasingControls:Vt(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:Ht(t.target)},defines:{...Z(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:q(e)}),s.setPipelineState(ee(e)),s.submitDraw(e,t)}},ki=class{constructor(e,t,i,s){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=s}};function Ka(e,t){const{textureFloatLinear:i,colorBufferFloat:s}=e.capabilities,o=s?.textureFloat,r=s?.textureHalfFloat,l=s?.floatBlend,u=e.driverTest.floatBufferBlend.result;if(!o&&!r)throw new Gt("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(l&&u||r))throw new Gt("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));const p=o&&l&&u,c=r,d=i,m=!!s?.R32F,v=!!s?.R16F;if(p&&d)return d||t.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new ki(Ft.FLOAT,d?yt.LINEAR:yt.NEAREST,m?$e.RED:$e.RGBA,m?fs.R32F:$e.RGBA);if(c)return new ki(Ft.HALF_FLOAT,yt.LINEAR,v?$e.RED:$e.RGBA,v?fs.R16F:$e.RGBA);throw new Gt("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}new ki(Ft.HALF_FLOAT,yt.NEAREST,$e.RGBA,$e.RGBA);const ja=()=>zs.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");let Za=class{destroy(){this._accumulateFramebuffer=es(this._accumulateFramebuffer),this._resolveGradientTexture=es(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){const t=Ka(e,ja());this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==Ft.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){const{dataType:s,samplingMode:o,pixelFormat:r,internalFormat:l}=this.loadQualityProfile(e),u=new si(t,i);u.pixelFormat=r,u.internalFormat=l,u.dataType=s,u.samplingMode=o,u.wrapMode=Mi.CLAMP_TO_EDGE;const p=new Ds(Os.DEPTH24_STENCIL8,t,i);this._accumulateFramebuffer=new Is(e,u,p)}else{const{width:s,height:o}=this._accumulateFramebuffer;s===t&&o===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){const s=new si;s.wrapMode=Mi.CLAMP_TO_EDGE,this._resolveGradientTexture=new Fs(e,s),this._prevGradientHash=null}return this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t),this._resolveGradientTexture}};function Qs(e){return e?.25:1}let Js=class extends fe{};n([y(5,f)],Js.prototype,"offset",void 0);let Xa=class extends Pe{},$i=class extends B{};n([h(a)],$i.prototype,"radius",void 0),n([h(a)],$i.prototype,"isFieldActive",void 0);let Ot=class extends re{constructor(){super(...arguments),this.type="HeatmapAccumulateShader",this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,s=e.offset,o=i.multiply(this.storage.getVVData(e.id).x).add(new a(1).subtract(i)),r=this.view.displayViewScreenMat3.multiply(new _(e.pos,1)).add(this.view.displayViewMat3.multiply(new _(s,0)).multiply(t)),l=this.clip(e.id);return{glPosition:new w(r.xy,l,1),offset:s,fieldValue:o,color:new w(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,s=et(t),o=k(s,new a(1)),r=new a(1).subtract(s.multiply(s)),l=r.multiply(r),u=o.multiply(l).multiply(i).multiply(new a(Qs(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new w(u),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,s=t.multiply(i).multiply(new _(e.pos,1));return Sa(s.xy,this.kernelControls.radius,this.hittestRequest.position)}};n([Ge],Ot.prototype,"usesHalfFloatPrecision",void 0),n([h($i)],Ot.prototype,"kernelControls",void 0),n([z(0,P(Js))],Ot.prototype,"vertex",null),n([z(0,P(Xa))],Ot.prototype,"fragment",null);let eo=class extends Ui{};n([y(0,f)],eo.prototype,"position",void 0);let Ya=class extends _s{},Yt=class extends B{};n([h(H)],Yt.prototype,"texture",void 0),n([h(f)],Yt.prototype,"minAndInvRange",void 0),n([h(a)],Yt.prototype,"normalization",void 0);let to=class extends B{};n([h(H)],to.prototype,"texture",void 0);let pt=class extends Ni{constructor(){super(...arguments),this.type="HeatmapResolveShader",this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new w(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let s=$(t.texture,e.uv).r.divide(new a(Qs(this.usesHalfFloatPrecision)));s=s.multiply(t.normalization),s=s.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const o=$(i.texture,new f(s,.5)),r=new ci;return r.fragColor=new w(o.rgb.multiply(o.a),o.a),r}};n([Ge],pt.prototype,"usesHalfFloatPrecision",void 0),n([h(Yt)],pt.prototype,"accumulatedDensity",void 0),n([h(to)],pt.prototype,"gradient",void 0),n([z(0,P(eo))],pt.prototype,"vertex",null),n([z(0,P(Ya))],pt.prototype,"fragment",null);let Qa=class extends te{constructor(){super(...arguments),this.type=G.Heatmap,this.drawPhase=ht.MAP|ht.HITTEST|ht.DEBUG,this.shaders={accumulate:new Ot,resolve:new pt},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:s,state:o}=e,r=t.instance.getInput(),{isFieldActive:l}=r.uniforms,u=this._getOrCreateResourcesRecord(i),p=u.loadQualityProfile(i);q(e)||this._bind(e,u,r),s.setShader({shader:this.shaders.accumulate,uniforms:{...Q(e,t.target),kernelControls:{radius:xs(r,o),isFieldActive:l?1:0}},defines:{...Z(e),...p.defines},optionalAttributes:{},useComputeBuffer:q(e)});const c=q(e)?er:so;s.setPipelineState(c),s.submitDraw(e,t)}getStencilReference(e){return io(e)}renderResolvePass(e,t){if(q(e))return;const{context:i,painter:s}=e,o=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!o?.initialized)return;const{defines:r}=o.loadQualityProfile(i),{minDensity:l,maxDensity:u,radius:p}=t.getInput().uniforms,c=8,d=9,m=o.accumulateFramebuffer,v=o.resolveGradientTexture,g={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:c,texture:m.colorTexture},minAndInvRange:[l,1/(u-l)],normalization:3/(p*p*Math.PI)},gradient:{texture:{unit:d,texture:v}}},defines:r,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(m.colorTexture,c),i.bindTexture(v,d),s.setPipelineState(tr),s.submitDrawMesh(i,g,s.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Za,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:s,state:o,pixelRatio:r}=e,l=s.getBoundFramebufferObject(),u=s.getViewport();this._prevFBO=l,this._prevViewport=u;const{gradient:p,gradientHash:c}=i.uniforms;t.ensureResolveGradientTexture(s,c,p);const{width:d,height:m}=u,v=Ja(xs(i,o),r),g=d*v,b=m*v,x=t.ensureAccumulateFBO(s,g,b);s.blitFramebuffer(l,x,ii.STENCIL),s.bindFramebuffer(x),s.setViewport(0,0,x.width,x.height),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(ii.COLOR),this._isBound=!0}};function Ja(e,t){const i=t>1.5?.25:.5;return e<1/(2*i)?1:i}function io(e){return e.key.level+1}const so={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:io,compare:mt.GEQUAL,mask:255,op:{fail:ye.KEEP,zFail:ye.KEEP,zPass:ye.REPLACE}}}},er={...so,stencil:!1},tr={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function xs(e,t){const{referenceScale:i,radius:s}=e.uniforms;return s*(i!==0?i/t.scale:1)}const ir=360/254;var ne;(function(e){e[e.Color=0]="Color",e[e.Outline=1]="Outline",e[e.Halo=2]="Halo"})(ne||(ne={}));class de extends fe{}n([y(3,w)],de.prototype,"color",void 0),n([y(4,f)],de.prototype,"offset",void 0),n([y(5,f)],de.prototype,"textureUV",void 0),n([y(6,f)],de.prototype,"fontAndReferenceSize",void 0),n([y(7,w)],de.prototype,"outlineColor",void 0),n([y(8,w)],de.prototype,"haloColor",void 0),n([y(9,f)],de.prototype,"outlineAndHaloSize",void 0),n([y(10,f)],de.prototype,"zoomRange",void 0),n([y(11,a)],de.prototype,"clipAngle",void 0),n([y(12,w)],de.prototype,"referenceSymbol",void 0),n([y(15,a)],de.prototype,"visibility",void 0);let Bi=class extends kt{};n([y(13,f)],Bi.prototype,"offsetNextVertex1",void 0),n([y(14,f)],Bi.prototype,"offsetNextVertex2",void 0);let sr=class extends Pe{},se=class extends re{constructor(){super(...arguments),this.type="TextShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=ne.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t){const{clipAngle:i,zoomRange:s,visibility:o}=e,r=i.multiply(ir),l=Bt(this.view.rotation.subtract(r)),u=We(new a(360).subtract(l),l);let p=new a(0);const c=Ao(this.view.currentZoom.multiply(ls)).divide(ls),d=s.x,m=s.y,v=new a(1).subtract(k(d,c)).multiply(2),g=k(new a(90),u).multiply(2),b=new a(2).multiply(new a(1).subtract(k(c,m)));return p=p.add(t.multiply(v)),p=p.add(t.multiply(g)),p=p.add(b),o&&(p=p.add(o)),p}vertex(e,t){const i=N(e.bitset,Jo),s=new a(1).subtract(i);let o=e.fontAndReferenceSize[0];const r=e.fontAndReferenceSize[1];let l=o.divide(cs);const u=this.textRenderPassType===ne.Outline?e.outlineColor:this.textRenderPassType===ne.Halo?e.haloColor:this._getVertexColor(e),p=this.view.displayViewScreenMat3.multiply(new _(e.pos,1));let c=e.offset,d=new a(1),m=E.identity(),v=new f(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const A=e.referenceSymbol,I=A.xy,L=A.z,C=this._unpackDirection(A.w),O=Lt(this,e.id,L).divide(2),D=C.multiply(O.add(ko));v=I.add(D),c=c.add(v)}else d=Lt(this,e.id,r).divide(r),o=o.multiply(d),l=l.multiply(d),c=c.multiply(d),m=Es(this,e.id),c=m.multiply(new _(c,0)).xy;const g=N(e.bitset,ea),b=this._getViewRotationMatrix(g).multiply(new _(c,0));let x=this.isLabel?this.clipLabel(e,g):this.clip(e.id,e.zoomRange);x=this.isBackgroundPass?x.add(s.multiply(2)):x.add(i.multiply(2));let S=new a(0);if(this.textRenderPassType===ne.Outline&&(x=x.add(M(ve(e.outlineAndHaloSize.x,new a(0)),new a(2),new a(0))),S=new a(e.outlineAndHaloSize.x).divide(l).divide(ds)),this.textRenderPassType===ne.Halo){const A=e.outlineAndHaloSize.x,I=new a(e.outlineAndHaloSize.y);x=x.add(M(ve(I,new a(0)),new a(2),new a(0))),S=I.add(A).divide(l).divide(ds)}const V=this.isLabel?U(x,new a(1)):new It(!1);return{glPosition:new w(p.xy.add(b.xy),x,1),color:u,size:l,textureUV:e.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new a(.105*cs).divide(o).divide(this.view.pixelRatio),outlineDistanceOffset:S,...this.maybeRunHittest(e,t,{vvSizeAdjustment:d,vvRotation:m,labelOffset:v,labelClipped:V})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,s=new a(1).subtract(e);return t.multiply(e).add(i.multiply(s))}fragment(e){const t=new a(.25),i=new a(1).subtract(t),s=$(this.mosaicInfo.texture,e.textureUV).a;let o=i.subtract(e.outlineDistanceOffset);this.highlight&&(o=o.divide(2));const r=e.antialiasingWidth,l=Ps(o.subtract(r),o.add(r),s);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:s,labelOffset:o,labelClipped:r}){let l,u,p;this.isLabel?(l=new _(e.offset.add(o),0),u=new _(t.offsetNextVertex1.add(o),0),p=new _(t.offsetNextVertex2.add(o),0)):(l=s.multiply(new _(e.offset.multiply(i),0)),u=s.multiply(new _(t.offsetNextVertex1.multiply(i),0)),p=s.multiply(new _(t.offsetNextVertex2.multiply(i),0)));const{viewMat3:c,tileMat3:d}=this.view,m=c.multiply(d).multiply(new _(e.pos,1)),v=m.add(d.multiply(l)).xy,g=m.add(d.multiply(u)).xy,b=m.add(d.multiply(p)).xy,x=yi(this.hittestRequest.position,v.xy,g.xy,b.xy);return this.isLabel?M(r,St(this.hittestRequest),x):x}_unpackDirection(e){const t=new Si(e),i=_o(t,new Si(2)),s=To(t,new Si(3));return new f(new a(i).subtract(1),new a(s).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new It(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),s=this.visualVariableOpacity.getOpacity(i);t=t.multiply(s)}return t}};n([R(Ke)],se.prototype,"visualVariableColor",void 0),n([R(je)],se.prototype,"visualVariableOpacity",void 0),n([R(hi)],se.prototype,"visualVariableRotation",void 0),n([R(gt)],se.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(it)],se.prototype,"visualVariableSizeScaleStops",void 0),n([R(st)],se.prototype,"visualVariableSizeStops",void 0),n([R(bt)],se.prototype,"visualVariableSizeUnitValue",void 0),n([h(xe)],se.prototype,"mosaicInfo",void 0),n([Ge],se.prototype,"textRenderPassType",void 0),n([Ge],se.prototype,"isBackgroundPass",void 0),n([Ge],se.prototype,"isLabel",void 0),n([z(0,P(de)),z(1,P(Bi))],se.prototype,"vertex",null),n([z(0,P(sr))],se.prototype,"fragment",null);let or=class extends te{constructor(){super(...arguments),this.type=G.Label,this.shaders={geometry:new se},this.drawPhase=ht.LABEL|ht.LABEL_ALPHA|ht.HITTEST,this.symbologyPlane=ce.TEXT}render(e,t){const{context:i,painter:s}=e,o=Z(e),r={...ee(e),stencil:{write:!1,test:{ref:()=>255,compare:mt.GREATER,mask:255,op:{fail:ye.KEEP,zFail:ye.KEEP,zPass:ye.KEEP}}}},l=t.instance.getInput(),u={shader:this.shaders.geometry,uniforms:{...ae(e,t.target,l.uniforms),...Q(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,textRenderPassType:ne.Color,isBackgroundPass:!0,isLabel:!0},optionalAttributes:l.optionalAttributes,useComputeBuffer:q(e)};s.setPipelineState(r),s.setShader(u),s.submitDraw(e,t),s.setShader({...u,defines:{...o,textRenderPassType:ne.Halo,isBackgroundPass:!1,isLabel:!0}}),s.submitDraw(e,t),s.setShader({...u,defines:{...o,textRenderPassType:ne.Color,isBackgroundPass:!1,isLabel:!0}}),s.submitDraw(e,t)}};function ar(e){return k(new a(0),e).multiply(2).subtract(1)}class ct extends De{}n([y(9,a)],ct.prototype,"accumulatedDistance",void 0),n([y(10,a)],ct.prototype,"totalLength",void 0),n([y(11,a)],ct.prototype,"gradientSize",void 0),n([y(12,f)],ct.prototype,"segmentDirection",void 0),n([y(13,w)],ct.prototype,"tlbr",void 0);let oo=class extends B{};n([h(a)],oo.prototype,"isColorPass",void 0);let Qt=class extends he{constructor(){super(...arguments),this.type="GradientStrokeShader"}vertex(e,t){const{totalLength:i,gradientSize:s,segmentDirection:o,tlbr:r}=e,l=vi(this,e),u=N(e.bitset,Nt.isAlongLine),p=i.divide(this.view.displayZoomFactor),c=M(vt(e.bitset,Nt.isAbsoluteSize),()=>{const v=M(U(u,new a(.5)),p,l.halfWidth);return s.divide(v)},s),d=e.accumulatedDistance.add(Je(o,l.scaledOffset).divide(p)),m=r.divide(this.mosaicInfo.size.xyxy);return{...l,tlbr:m,relativePositionAlongLine:d,relativeGradientSize:c,isAlongLine:N(e.bitset,Nt.isAlongLine),isDiscrete:N(e.bitset,Nt.isDiscrete),...this.maybeRunHittest(e,t,l.halfWidth)}}fragment(e){const{isAlongLine:t,isDiscrete:i,relativePositionAlongLine:s,relativeGradientSize:o,normal:r,tlbr:l}=e,u=Xi(e,this.antialiasingControls.blur),p=ar(r.y).multiply(We(et(r),new a(1))),c=new a(.5).multiply(p).add(new a(.5)),d=M(U(t,new a(.5)),s,c),m=M(U(i,new a(.5)),o.subtract(1),new a(0)),v=Wt(d.add(m).divide(o)),g=j(l.xy,l.zw,new f(ge(v,new a(0),new a(1)),.5)),b=$(this.mosaicInfo.texture,g),x=e.opacity.multiply(u),S=this.getFragmentOutput(b.multiply(x),e),V=k(new a(.5),this.technique.isColorPass).multiply(Ue("gradient-depth-epsilon")),A=k(new a(0),r.y).multiply(new a(Ue("gradient-depth-bias")).subtract(V));return S.glFragDepth=ge(et(r).add(A),new a(0),new a(1)),S}};n([h(xe)],Qt.prototype,"mosaicInfo",void 0),n([h(oo)],Qt.prototype,"technique",void 0),n([z(0,P(ct)),z(1,P(be))],Qt.prototype,"vertex",null);let rr=class extends te{constructor(){super(...arguments),this.type=G.GradientStroke,this.shaders={geometry:new Qt},this.symbologyPlane=ce.LINE}_getShaderOptions(e,t,i){const{context:s,painter:o,pixelRatio:r}=e,l=t.instance.getInput();return{shader:this.shaders.geometry,uniforms:{...ae(e,t.target,l.uniforms),...Q(e,t.target),antialiasingControls:Vt(r),mosaicInfo:o.textureManager.getMosaicInfo(s,t.textureKey),technique:{isColorPass:i}},defines:{...Z(e)},optionalAttributes:l.optionalAttributes,useComputeBuffer:q(e)}}render(e,t){const{painter:i}=e;if(q(e)||Rs(e)){const r=ee(e);return i.setPipelineState(r),i.setShader(this._getShaderOptions(e,t,1)),void i.submitDraw(e,t)}e.context.setClearDepth(1),e.context.clear(ii.DEPTH);const s={color:!1,depth:{write:{zNear:0,zFar:1},test:mt.LESS},stencil:{write:!1,test:{ref:r=>r.stencilRef,compare:mt.EQUAL,mask:255,op:{fail:ye.KEEP,zFail:ye.KEEP,zPass:ye.KEEP}}}};i.setShader(this._getShaderOptions(e,t,0)),i.setPipelineState(s),i.submitDraw(e,t);const o={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:mt.LEQUAL},stencil:{write:!1,test:{ref:r=>r.stencilRef,compare:mt.EQUAL,mask:255,op:{fail:ye.KEEP,zFail:ye.KEEP,zPass:ye.KEEP}}}};i.setShader(this._getShaderOptions(e,t,1)),i.setPipelineState(o),i.submitDraw(e,t)}},nr=class extends te{constructor(){super(...arguments),this.type=G.Line,this.shaders={geometry:new he},this.symbologyPlane=ce.LINE}render(e,t){const{painter:i,pixelRatio:s}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,o.uniforms),...Q(e,t.target),antialiasingControls:Vt(s)},defines:{...Z(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(e)}),i.setPipelineState(ee(e)),i.submitDraw(e,t)}};class dt extends De{}n([y(9,a)],dt.prototype,"accumulatedDistance",void 0),n([y(10,f)],dt.prototype,"segmentDirection",void 0),n([y(11,a)],dt.prototype,"offsetAlongLine",void 0),n([y(12,a)],dt.prototype,"capType",void 0),n([y(13,w)],dt.prototype,"tlbr",void 0);class Hi extends he{constructor(){super(...arguments),this.type="TexturedLineShader"}_getDistanceRatio(t,i){const s=N(t.bitset,ta);return s.multiply(ze(i,new a(.25)).multiply(new a(2))).add(new a(1).subtract(s).multiply(Ye(1)))}_getSDFAlpha(t){const{halfWidth:i,normal:s,tlbr:o,patternSize:r,accumulatedDistance:l,offsetAlongLine:u,dashToPx:p,capType:c}=t,d=r.x.divide(pa).multiply(p),m=_i(l.add(u).divide(d)),v=j(o.xy,o.zw,new f(m,.5)),g=di($(this.mosaicInfo.texture,v)).multiply(2).subtract(1).multiply(ca).multiply(p),b=s.y.multiply(i),x=Fe([ve(c,new a(1)),g.subtract(i)],[ve(c,new a(2)),As(Mo(ze(g,new a(0)),new a(2)).add(b.multiply(b))).subtract(i)],[!0,g]),S=ge(new a(.25).subtract(x),new a(0),new a(1));return new w(S)}_getPatternColor(t){const{halfWidth:i,normal:s,color:o,accumulatedDistance:r,patternSize:l,sampleAlphaOnly:u,tlbr:p}=t,c=l.y.multiply(new a(2).multiply(i).divide(l.x)),d=_i(r.divide(c)),m=new a(.5).multiply(s.y).add(new a(.5)),v=j(p.xy,p.zw,new f(m,d));let g=$(this.mosaicInfo.texture,v);return this.visualVariableColor!=null&&(g=M(U(u,new a(.5)),new w(o.a),o)),g}vertex(t,i){const{segmentDirection:s,tlbr:o,bitset:r}=t,l=vi(this,t),u=t.accumulatedDistance.divide(this.view.displayZoomFactor).add(Je(s,l.scaledOffset)),p=new f(o.z.subtract(o.x),o.w.subtract(o.y)),c=o.divide(this.mosaicInfo.size.xyxy),d=N(r,ia),m=N(r,Ms),v=M(U(d,new a(.5)),this._getDistanceRatio(t,l.scaledHalfWidth),new a(1));return{...l,tlbr:c,patternSize:p,accumulatedDistance:u,isSDF:d,sampleAlphaOnly:m,dashToPx:v,offsetAlongLine:t.offsetAlongLine,capType:t.capType,...this.maybeRunHittest(t,i,l.halfWidth)}}fragment(t){const{color:i,opacity:s,isSDF:o}=t,r=Xi(t,this.antialiasingControls.blur),l=M(U(o,new a(.5)),this._getSDFAlpha(t),this._getPatternColor(t)),u=i.multiply(s).multiply(r).multiply(l);return this.getFragmentOutput(u,t)}}n([h(xe)],Hi.prototype,"mosaicInfo",void 0),n([z(0,P(dt)),z(1,P(be))],Hi.prototype,"vertex",null);let lr=class extends te{constructor(){super(...arguments),this.type=G.TexturedLine,this.shaders={geometry:new Hi},this.symbologyPlane=ce.LINE}render(e,t){const{context:i,painter:s,pixelRatio:o}=e,r=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,r.uniforms),...Q(e,t.target),antialiasingControls:Vt(o),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...Z(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:q(e)}),s.setPipelineState(ee(e)),s.submitDraw(e,t)}};class Ce extends fe{}n([y(3,w)],Ce.prototype,"color",void 0),n([y(4,w)],Ce.prototype,"outlineColor",void 0),n([y(5,f)],Ce.prototype,"offset",void 0),n([y(6,f)],Ce.prototype,"textureUV",void 0),n([y(7,w)],Ce.prototype,"sizing",void 0),n([y(8,a)],Ce.prototype,"placementAngle",void 0),n([y(9,a)],Ce.prototype,"sdfDecodeCoeff",void 0),n([y(10,f)],Ce.prototype,"zoomRange",void 0);class Dt extends kt{}n([y(11,f)],Dt.prototype,"offsetNextVertex1",void 0),n([y(12,f)],Dt.prototype,"offsetNextVertex2",void 0),n([y(13,f)],Dt.prototype,"textureUVNextVertex1",void 0),n([y(14,f)],Dt.prototype,"textureUVNextVertex2",void 0);class ur extends Pe{}function Me(e,t,i,s){return t.multiply(e.x).add(i.multiply(e.y)).add(s.multiply(e.z))}function Pi(e){return e.multiply(e).divide(128)}class we extends re{constructor(){super(...arguments),this.type="MarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(t,i){const s=Pi(t.sizing.x),o=Pi(t.sizing.y),r=Pi(t.sizing.z),l=t.placementAngle,u=N(t.bitset,Ve.bitset.isSDF),p=N(t.bitset,Ve.bitset.isMapAligned),c=N(t.bitset,Ve.bitset.scaleSymbolsProportionally),d=vt(t.bitset,Ve.bitset.colorLocked),m=wt(this,t.id),v=xt(this,t.id,t.color,d).multiply(m),g=this.view.displayViewScreenMat3.multiply(new _(t.pos.xy,1)),b=Lt(this,t.id,r).divide(r),x=s.multiply(b),S=t.offset.xy.multiply(b);let V=o.multiply(c.multiply(b.subtract(1)).add(1));V=We(V,ze(x.subtract(.99),new a(0)));const A=ze(V,new a(1)),I=We(V,new a(1)),L=E.fromRotation(l.multiply(Wi)),C=Es(this,t.id),O=this._getViewRotationMatrix(p).multiply(C).multiply(L).multiply(new _(S.xy,0)),D=this.clip(t.id,t.zoomRange),T=new w(g.xy.add(O.xy),D,1),F=t.textureUV.divide(this.mosaicInfo.size),Ee=t.outlineColor.multiply(I),ot=N(t.bitset,Ve.bitset.overrideOutlineColor),zt=t.sdfDecodeCoeff.multiply(x);return{glPosition:T,color:v,textureUV:F,outlineColor:Ee,outlineSize:A,distanceToPx:zt,isSDF:u,overrideOutlineColor:ot,...this.maybeRunHittest(t,i,{pos:t.pos,size:x,sizeCorrection:b,isMapAligned:p,vvRotationMat3:C,placementMat3:L,outlineSize:A,distanceToPx:zt,isSDF:u})}}fragment(t){const i=this._getColor(t.textureUV,t);return this.getFragmentOutput(i,t)}hittest(t,i,s){return M(Gi(s.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(t,i,s),this._hittestMarker(t,i,s))}_getViewRotationMatrix(t){const i=this.view.displayViewMat3,s=this.view.displayMat3,o=new a(1).subtract(t);return i.multiply(t).add(s.multiply(o))}_getViewScreenMatrix(t){const i=this.view.viewMat3.multiply(this.view.tileMat3),s=this.view.tileMat3,o=new a(1).subtract(t);return i.multiply(t).add(s.multiply(o))}_getColor(t,i){return M(ve(i.isSDF,new a(1)),this._getSDFColor(t,i),this._getSpriteColor(t,i))}_getSpriteColor(t,i){return $(this.mosaicInfo.texture,t).multiply(i.color)}_getSDFColor(t,i){const s=$(this.mosaicInfo.texture,t),o=new a(.5).subtract(di(s)).multiply(i.distanceToPx).multiply(Ts),r=ge(new a(.5).subtract(o),new a(0),new a(1)),l=i.color.multiply(r);let u=i.outlineSize;this.highlight&&(u=ze(u,i.overrideOutlineColor.multiply(4)));const p=u.multiply(.5),c=Bt(o).subtract(p),d=ge(new a(.5).subtract(c),new a(0),new a(1)),m=j(i.outlineColor,i.color,i.overrideOutlineColor).multiply(d);return new a(1).subtract(m.a).multiply(l).add(m)}_hittestSmallMarker(t,i,s){const{position:o,distance:r,smallSymbolDistance:l}=this.hittestRequest,u=r.subtract(l),{viewMat3:p,tileMat3:c}=this.view,d=p.multiply(c).multiply(new _(s.pos,1)).xy,m=s.size.multiply(.5);return pi(d,o).subtract(m).add(u)}_hittestMarker(t,i,s){const{pos:o,sizeCorrection:r,isMapAligned:l}=s,u=new _(t.offset.multiply(r),0),p=new _(i.offsetNextVertex1.multiply(r),0),c=new _(i.offsetNextVertex2.multiply(r),0),{viewMat3:d,tileMat3:m}=this.view,v=d.multiply(m).multiply(new _(o,1)),g=this._getViewScreenMatrix(l).multiply(s.vvRotationMat3).multiply(s.placementMat3),b=v.add(g.multiply(u)).xy,x=v.add(g.multiply(p)).xy,S=v.add(g.multiply(c)).xy,V=this.hittestRequest.position,A=this.hittestRequest.distance,I=yi(V,b,x,S);return M(U(I,A),I,this._hittestSamples(b,x,S,t,i,s))}_hittestSamples(t,i,s,o,r,l){const{outlineSize:u,isSDF:p,distanceToPx:c}=l,d=this.hittestRequest.position,m=this.hittestRequest.distance,v=K(d.add(new f(J(m),J(m))),t,i,s),g=K(d.add(new f(0,J(m))),t,i,s),b=K(d.add(new f(m,J(m))),t,i,s),x=K(d.add(new f(J(m),0)),t,i,s),S=K(d,t,i,s),V=K(d.add(new f(m,0)),t,i,s),A=K(d.add(new f(J(m),m)),t,i,s),I=K(d.add(new f(0,m)),t,i,s),L=K(d.add(new f(m,m)),t,i,s),C=o.textureUV.divide(this.mosaicInfo.size),O=r.textureUVNextVertex1.divide(this.mosaicInfo.size),D=r.textureUVNextVertex2.divide(this.mosaicInfo.size),T={color:new w(1),outlineColor:new w(1),overrideOutlineColor:new a(1),outlineSize:u,distanceToPx:c,isSDF:p};let F=new a(0);return F=F.add(W(v).multiply(this._getColor(Me(v,C,O,D),T).a)),F=F.add(W(g).multiply(this._getColor(Me(g,C,O,D),T).a)),F=F.add(W(b).multiply(this._getColor(Me(b,C,O,D),T).a)),F=F.add(W(x).multiply(this._getColor(Me(x,C,O,D),T).a)),F=F.add(W(S).multiply(this._getColor(Me(S,C,O,D),T).a)),F=F.add(W(V).multiply(this._getColor(Me(V,C,O,D),T).a)),F=F.add(W(A).multiply(this._getColor(Me(A,C,O,D),T).a)),F=F.add(W(I).multiply(this._getColor(Me(I,C,O,D),T).a)),F=F.add(W(L).multiply(this._getColor(Me(L,C,O,D),T).a)),k(F,new a(.05)).multiply(St(this.hittestRequest))}}n([R(Ke)],we.prototype,"visualVariableColor",void 0),n([R(je)],we.prototype,"visualVariableOpacity",void 0),n([R(hi)],we.prototype,"visualVariableRotation",void 0),n([R(gt)],we.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(it)],we.prototype,"visualVariableSizeScaleStops",void 0),n([R(st)],we.prototype,"visualVariableSizeStops",void 0),n([R(bt)],we.prototype,"visualVariableSizeUnitValue",void 0),n([h(xe)],we.prototype,"mosaicInfo",void 0),n([z(0,P(Ce)),z(1,P(Dt))],we.prototype,"vertex",null),n([z(0,P(ur))],we.prototype,"fragment",null);let pr=class extends te{constructor(){super(...arguments),this.type=G.Marker,this.shaders={geometry:new we},this.symbologyPlane=ce.MARKER}render(e,t){const{context:i,painter:s}=e,o=t.instance.getInput();s.setShader({shader:this.shaders.geometry,uniforms:{...ae(e,t.target,o.uniforms),...Q(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...Z(e)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(e)}),s.setPipelineState(ee(e)),s.submitDraw(e,t)}},cr=class{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map(([s,o])=>`${s}.${o}`).join("."),i=xo(t);this._locationInfo={hash:i,stringHash:t,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map(s=>`${s}.${e[s]}`).join(".")}.${Object.keys(i).filter(s=>i[s]).map(s=>`${s}_${i[s].toString()}`).join(".")}.${Object.keys(t).filter(s=>this.optionPropertyKeys.has(s)).join(".")}`}getProgram(e,t,i,s){let o="",r="";for(const l in i)if(i[l]){const u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;o+=u,r+=u}return o+=this.vertexShader,r+=this.fragmentShader,new Do(o,r,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const i in this.required){const s=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:s.type,uniformArrayElementType:ws(s),uniformArrayLength:Ss(s)})}for(const i in e){const s=this.options[i];if(e[i])for(const o in s){const r=s[o];t.push({uniformHydrated:null,shaderModulePath:`${i}.${o}`,uniformName:o,uniformType:r.type,uniformArrayElementType:ws(r),uniformArrayLength:Ss(r)})}}return t}};const ws=e=>e.type==="array"?e.elementType?.type:void 0,Ss=e=>e.type==="array"?e.size:void 0,dr={hittestDist:a,hittestPos:f},mr={filterFlags:H,animation:H,visualVariableData:H,dataDriven0:H,dataDriven1:H,dataDriven2:H,gpgpu:H,size:a},hr={displayViewScreenMat3:E,displayViewMat3:E,displayMat3:E,viewMat3:E,tileMat3:E,displayZoomFactor:a,requiredZoomFactor:a,tileOffset:f,currentScale:a,currentZoom:a,metersPerSRUnit:a};let yr=class extends cr{constructor(){super(...arguments),this.vertexShader=gs("materials/pie/pie.vert"),this.fragmentShader=gs("materials/pie/pie.frag"),this.required={...mr,...hr,outlineWidth:a,colors:X,defaultColor:w,othersColor:w,outlineColor:w,donutRatio:a,sectorThreshold:a},this.options={hittestUniforms:dr,visualVariableSizeMinMaxValue:{minMaxValueAndSize:w},visualVariableSizeScaleStops:{sizes:{...X.ofType(a,8),type:"array",elementType:a,size:8},values:{...X.ofType(a,8),type:"array",elementType:a,size:8}},visualVariableSizeStops:{sizes:{...X.ofType(a,8),type:"array",elementType:a,size:8},values:{...X.ofType(a,8),type:"array",elementType:a,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:a},visualVariableOpacity:{opacities:{...X.ofType(a,8),type:"array",elementType:a,size:8},opacityValues:{...X.ofType(a,8),type:"array",elementType:a,size:8}},highlightUniforms:{highlightAll:a,activeReasons:a}},this.locations={pos:{index:0,type:f},id:{index:1,type:_},bitset:{index:2,type:a},offset:{index:3,type:f},texCoords:{index:4,type:f},size:{index:5,type:f},referenceSize:{index:6,type:a},zoomRange:{index:7,type:f}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...X.ofType(w,e),type:"array",elementType:w,size:e}}},fr=class extends te{constructor(){super(...arguments),this.type=G.PieChart,this.shaders={geometry:new yr},this.symbologyPlane=ce.MARKER}render(e,t){const{painter:i}=e,{instance:s,target:o}=t,r=this.shaders.geometry,l=s.getInput(),u=l.uniforms.numberOfFields,p=q(e),c=Q(e,o),d=Z(e);r.setNumberOfFields(u),i.setShader({shader:r,uniforms:{...ae(e,t.target,l.uniforms.shader),...c.storage,...c.view,...c.highlight,highlightUniforms:c.highlight,hittestUniforms:c.hittestRequest?{hittestDist:c.hittestRequest?.distance,hittestPos:c.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!l.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!l.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!l.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!l.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!l.uniforms.shader.visualVariableOpacity,HITTEST:p,highlight:c.highlight?1:0,...d,numberOfFields:u},optionalAttributes:{},useComputeBuffer:p}),i.setPipelineState(ee(e)),i.submitDraw(e,t)}},vr=class extends te{constructor(){super(...arguments),this.type=G.Text,this.shaders={geometry:new se},this.symbologyPlane=ce.TEXT}render(e,t){const{context:i,painter:s}=e,o=Z(e),r=t.instance.getInput(),l={shader:this.shaders.geometry,uniforms:{...ae(e,t.target,r.uniforms),...Q(e,t.target),mosaicInfo:s.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...o,isBackgroundPass:!0,isLabel:!1,textRenderPassType:ne.Color},optionalAttributes:r.optionalAttributes,useComputeBuffer:q(e)};s.setShader(l),s.setPipelineState(ee(e)),s.submitDraw(e,t),s.setShader({...l,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:ne.Halo}}),s.submitDraw(e,t),s.setShader({...l,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:ne.Outline}}),s.submitDraw(e,t),s.setShader({...l,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:ne.Color}}),s.submitDraw(e,t)}};const Y={fill:new Ha,patternFill:new Ga,complexFill:new La,gradientFill:new Na,outlineFill:new qa,patternOutlineFill:new Wa,complexOutlineFill:new Ba,marker:new pr,pieChart:new fr,line:new nr,texturedLine:new lr,gradientStroke:new rr,text:new vr,label:new or,heatmap:new Qa,dotDensity:new Fa,animatedMarker:new _a,animatedMarkerShift:new Ta,animatedFill:new Ma,animatedLine:new Ra};function Dn(){for(const e in Y)Y[e].startup()}function In(e){for(const t in Y)Y[t].shutdown(e)}function li(e,t){const i=e.slice(0,t),s=t-i.length;for(let o=0;o<s;o++){const r=i[i.length-1];i.push(r)}return i}function gr(e){if(!e)return[0,0,0,0];const{r:t,g:i,b:s,a:o}=e;return[t*(o/255),i*(o/255),s*(o/255),o]}const Jt=8,ao=Jt-2,ro=()=>zs.getLogger("esri.views.2d.layers.features.support.rendererUtils");function no(e){return e.map(t=>br(t)?xr(t.clone()):t)}function br(e){return(e.type==="size"||e.type==="color"||e.type==="opacity")&&e.stops!=null}function xr(e){return e.stops=Vr(e.type,e.stops??[]),e}function rt(e,t,i){return(1-i)*e+i*t}function wr(e,t){const[i,...s]=t,o=s.pop(),r=s[0].value,l=s[s.length-1].value,u=(l-r)/ao,p=[];for(let c=r;c<l;c+=u){let d=0;for(;c>=s[d].value;)d++;const m=s[d],v=t[d-1],g=c-v.value,b=m.value===v.value?1:g/(m.value-v.value);if(e==="color"){const x=s[d],S=t[d-1],V=x.color.clone();V.r=rt(S.color.r,V.r,b),V.g=rt(S.color.g,V.g,b),V.b=rt(S.color.b,V.b,b),V.a=rt(S.color.a,V.a,b),p.push({value:c,color:V,label:x.label})}else if(e==="size"){const x=s[d],S=t[d-1],V=ts(x.size),A=rt(ts(S.size),V,b);p.push({value:c,size:A,label:x.label})}else{const x=s[d],S=rt(t[d-1].opacity,x.opacity,b);p.push({value:c,opacity:S,label:x.label})}}return[i,...p,o]}function Sr(e){const[t,...i]=e,s=i.pop();for(;i.length>ao;){let o=0,r=0;for(let l=1;l<i.length;l++){const u=i[l-1],p=i[l],c=Math.abs(p.value-u.value);c>r&&(r=c,o=l)}i.splice(o,1)}return[t,...i,s]}function Vr(e,t){return t.length<=Jt?t:(ro().warn(`Found ${t.length} Visual Variable stops, but MapView only supports ${Jt}. Displayed stops will be simplified.`),t.length>2*Jt?wr(e,t):Sr(t))}function zr(){const{supportsColorBufferFloat:e,supportsColorBufferFloatBlend:t,supportsColorBufferHalfFloat:i}=mi();return e&&t||i}function Fn(e){if(!e)return!0;switch(e.type){case"dot-density":break;case"heatmap":if(!zr()){const t=mi(),i=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(s=>!t[s]).join(", ");return ro().errorOnce(new Gt("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${i}`)),!1}}return!0}const Pr=1.25,qt=128,Ar=128;function _r(e){if(!e.stops?.length)return null;const t=e.stops.sort((r,l)=>r.value-l.value),i=li(t,8),s=i.map(({value:r})=>r),o=i.map(({color:r})=>gr(r));return{values:s,colors:o}}function Tr(e){if(!e.stops?.length)return null;const t=e.stops.sort((s,o)=>s.value-o.value),i=li(t,8);return{opacityValues:i.map(({value:s})=>s),opacities:i.map(({opacity:s})=>s)}}function Mr(e){return{rotationType:e.rotationType==="geographic"?Ti.Geographic:Ti.Arithmatic}}function Ai(e){if(!e.stops?.length)return null;if(e.stops.some(s=>s.useMaxValue||s.useMinValue))return(s,o)=>{const r=s.statisticsByLevel.get(o.key.level),l=e.stops.map(p=>({value:p.useMaxValue?r?.get(e.field)?.maxValue??0:p.useMinValue?r?.get(e.field)?.minValue??0:p.value,size:p.size?Ye(p.size):$o})).sort((p,c)=>p.value-c.value),u=li(l,8);return{values:u.map(({value:p})=>p),sizes:u.map(({size:p})=>p)}};const t=e.stops.sort((s,o)=>s.value-o.value),i=li(t,8);return{values:i.map(({value:s})=>s),sizes:i.map(({size:s})=>Ye(s))}}function Rr(e){return t=>{const{state:i}=t;return{unitValueToPixelsRatio:So(i.spatialReference)/da[e.valueUnit??"meters"]/i.resolution}}}function Vs(e,t){const i=t.length;if(e<t[0].value||i===1)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const o=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+o*(t[s].size-t[s-1].size)}return t[i-1].size}function Cr(e){const{minDataValue:t,maxDataValue:i,minSize:s,maxSize:o}=e;if(typeof s=="object"&&typeof o=="object")return(r,l)=>{const u=r.state.scale,p=Ye(Vs(u,s.stops)),c=Ye(Vs(u,o.stops));return{minMaxValueAndSize:[t,i,p,c]}};if(typeof s=="object"||typeof o=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[t,i,Ye(s),Ye(o)]}}const Ze={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function lo(e,t=Ar,i=Pr){if(e.visualVariableSizeMinMaxValue)return typeof e.visualVariableSizeMinMaxValue=="function"?qt:Math.max(e.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,t);if(e.visualVariableSizeScaleStops){if(typeof e.visualVariableSizeScaleStops=="function")return qt;const s=e.visualVariableSizeScaleStops.sizes;return Math.max(s[s.length-1]*i,t)}if(e.visualVariableSizeStops){if(typeof e.visualVariableSizeStops=="function")return qt;const s=e.visualVariableSizeStops.sizes;return Math.max(s[s.length-1]*i,t)}return e.visualVariableSizeUnitValue?2*qt:0}function Ln(e){const t={...Ze};if(!e||!("visualVariables"in e)||!e.visualVariables)return t;for(const i of no(e.visualVariables))switch(i.type){case"color":t.visualVariableColor=_r(i);break;case"opacity":t.visualVariableOpacity=Tr(i);break;case"rotation":t.visualVariableRotation=Mr(i);break;case"size":switch(Or(i)){case"field-stops":t.visualVariableSizeStops=Ai(i);break;case"scale-stops":i.target==="outline"?t.visualVariableSizeOutlineScaleStops=Ai(i):t.visualVariableSizeScaleStops=Ai(i);break;case"min-max":t.visualVariableSizeMinMaxValue=Cr(i);break;case"unit-value":t.visualVariableSizeUnitValue=Rr(i)}break}return t}function Or(e){return typeof e.minDataValue=="number"&&typeof e.maxDataValue=="number"&&e.minSize!=null&&e.maxSize!=null?"min-max":e?.valueExpression==="$view.scale"&&Array.isArray(e.stops)?"scale-stops":e.field==null&&e?.valueExpression==="$view.scale"||!(Array.isArray(e.stops)||"levels"in e&&e.levels)?e.field!=null||e?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function Dr(e){return!!(e.visualVariableSizeMinMaxValue||e.visualVariableSizeScaleStops||e.visualVariableSizeStops||e.visualVariableSizeUnitValue||e.visualVariableSizeOutlineScaleStops)}function En(e){return!!e.visualVariableRotation}function uo(e){return e.spriteRasterizationParam?e.spriteRasterizationParam:{type:"sprite-rasterization-param",resource:{type:"CIMPictureMarker",url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAJOgAACToAYJjBRwAAAAsSURBVEhL7c0xAQAwDASh+jf9lcCU7TDA27ECKqACKqACKqACKqACKqDjYPuLVfSmMPfafQAAAABJRU5ErkJggg==",size:16,invertBackfaceTexture:!1,scaleX:1,textureFilter:fo.Picture},overrides:[]}}function Ir(e){return e.minScale||e.maxScale?{minScale:e.minScale??0,maxScale:e.maxScale??0}:null}function le(e){if(e==null)return null;if(Array.isArray(e)){const[t,i,s,o]=e;return[t,i,s,255*o]}return typeof e=="string"?e:{...e,defaultValue:le(e?.defaultValue)}}async function kn(e,t){const{cimResourceManager:i,cimAnalyzer:s,scaleExpression:o}=t.schemaOptions;await Promise.all(mo.fetchResources(e.symbol,i,[]));const r=s.analyzeSymbolReference(e,!1),l={scaleInfo:Ir(e),scaleExpression:o},u=[];for(const p of r)switch(p.type){case"marker":u.push(...Fr(p,t,l));break;case"fill":u.push(...Ur(p,t,l));break;case"outlineFill":u.push(...$r(p,t,l));break;case"gradientFill":u.push(...qr(p,t,l));break;case"line":u.push(...Wr(p,t,l));break;case"gradientStroke":u.push(...Zr(p,t,l));break;case"text":u.push(...Yr(p,t,l))}return u}function Fr(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:r}=o,l=e.isOutline?{...Ze,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation};if(e.animationParams){const{hasShiftAnimation:u}=e.animationParams.params,p=u?Y.animatedMarkerShift:Y.animatedMarker;return Lr(r.ensureInstance(p,{uniforms:l,optionalAttributes:{zoomRange:!0,value1Position2Value2:e.animationParams.params.hasShiftAnimation,lineLength:u}}),e,Ze,i)}return Er(r.ensureInstance(Y.marker,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,s,i)}function Lr(e,t,i,s){return t.animationParams?[e.createMeshInfo({pixelDimensions:t.pixelDimensions,texelDimensions:t.texelDimensions,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,sprite:uo(t),animations:t.animationParams,scaleInfo:s.scaleInfo,scaleSymbolsProportionally:t.scaleSymbolsProportionally,strokeWidth:t.outlineWidth,isMapAligned:t.alignment===yo.MAP,colorLocked:t.colorLocked,isStroke:t.isStroke,baseSize:t.baseSize,placement:t.markerPlacement,referenceSize:t.referenceSize,angleToLine:!!t.markerPlacement&&t.markerPlacement.placement&&"angleToLine"in t.markerPlacement.placement&&t.markerPlacement.placement.angleToLine,sizeRatio:t.sizeRatio,patternHeight:null})]:[]}function Qi(e,t,i,s){return t.animationParams?[e.createMeshInfo({effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,sprite:uo(t),animations:t.animationParams,scaleInfo:s.scaleInfo,scaleSymbolsProportionally:!1,strokeWidth:1,isMapAligned:!0,colorLocked:t.colorLocked||!1,isStroke:!1,baseSize:"width"in t?t.width:-1,placement:null,referenceSize:2,angleToLine:!1,sizeRatio:1,patternHeight:t.type==="fill"&&t.spriteRasterizationParam?t.height:null,joinType:"join"in t?t.join:"round",capType:"cap"in t?t.cap:"round",miterLimit:"miterLimit"in t&&t.miterLimit||2})]:[]}function Er(e,t,i,{scaleInfo:s,scaleExpression:o}){const r=Dr(i);return[e.createMeshInfo({size:t.size,scaleX:t.scaleX,anchorX:t.anchorPoint.x,anchorY:t.anchorPoint.y,angle:t.rotation,color:le(t.color)??[0,0,0,0],colorLocked:t.colorLocked,frameHeight:t.frameHeight,widthRatio:t.widthRatio,scaleInfo:s,offsetX:t.offsetX,offsetY:t.offsetY,outlineColor:le(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineWidth,referenceSize:t.referenceSize||ho.CIMVectorMarker.size,rotateClockwise:t.rotateClockwise,scaleFactor:o??1,sizeRatio:t.sizeRatio,alignment:t.alignment,isAbsoluteAnchorPoint:t.isAbsoluteAnchorPoint,scaleSymbolsProportionally:t.scaleSymbolsProportionally,sprite:t.spriteRasterizationParam,hasSizeVV:r,placement:t.markerPlacement,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,transforms:t.transform,minPixelBuffer:lo(i)})]}function kr(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:r}=o,l={visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity};if(e.animationParams){const u=Y.animatedFill;return Qi(r.ensureInstance(u,{uniforms:{...l,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,Ze,i)}return Hr(r.ensureInstance(Y.fill,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function $r(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:r}=o;return Br(r.ensureInstance(Y.outlineFill,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function Br(e,t,i){const s=le(t.color)??[0,0,0,0],o=le(t.outlineColor)??[0,0,0,0];return[e.createMeshInfo({color:s,outlineColor:o,width:t.outlineWidth,referenceWidth:t.referenceWidth,capType:t.cap,joinType:t.join,miterLimit:t.miterLimit,outlineUsesColorVV:!t.outlineColorLocked,hasSizeVV:!1,scaleInfo:i.scaleInfo,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,outlineEffects:t.outlineEffects?{type:"cim-effect-infos",effectInfos:t.outlineEffects}:null})]}function Hr(e,t,{scaleInfo:i}){return[e.createMeshInfo({color:le(t.color)??[0,0,0,0],scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Ur(e,t,i){if(!e.spriteRasterizationParam)return kr(e,t,i);const{uniforms:s,schemaOptions:o}=t,{store:r}=o,l={visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity};if(e.animationParams){const u=Y.animatedFill;return Qi(r.ensureInstance(u,{uniforms:{...l,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),e,Ze,i)}return Nr(r.ensureInstance(Y.complexFill,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,s.visualVariableColor!=null,i)}function Nr(e,t,i,{scaleInfo:s}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=!!t.hasUnresolvedReplacementColor&&(!i||t.colorLocked),r=t.sampleAlphaOnly&&!o,l=t.spriteRasterizationParam;return[e.createMeshInfo({color:le(t.color)??[0,0,0,0],height:t.height,aspectRatio:t.scaleX,offsetX:t.offsetX,offsetY:t.offsetY,scaleX:1,scaleY:1,angle:t.angle,applyRandomOffset:t.applyRandomOffset,sampleAlphaOnly:r,scaleProportionally:l.resource.type==="CIMHatchFill",sprite:l,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function qr(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:r}=o;return Gr(r.ensureInstance(Y.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function Gr(e,t,{scaleInfo:i}){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=t.spriteRasterizationParam;return[e.createMeshInfo({color:le(t.color)??[0,0,0,0],angle:t.angle,gradientMethod:t.gradientMethod,gradientSize:t.gradientSize,gradientSizeUnits:t.gradientSizeUnits,gradientType:t.gradientType,sprite:s,scaleInfo:i,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Wr(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:r}=o,l=e.isOutline?{...Ze,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue};if(e.animationParams){const{hasShiftAnimation:c}=e.animationParams.params,d=Y.animatedLine;return Qi(r.ensureInstance(d,{uniforms:{...l,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,accumulatedDistance:!0,segmentDirection:!0,normal:!0,lineLength:c}}),e,Ze,i)}const u={uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}},p=!!(l.visualVariableSizeMinMaxValue||l.visualVariableSizeScaleStops||l.visualVariableSizeStops||l.visualVariableSizeUnitValue);return e.spriteRasterizationParam?jr(r.ensureInstance(Y.texturedLine,u),e,p,i):Kr(r.ensureInstance(Y.line,u),e,p,i)}function Ji(e,t,{scaleInfo:i}){return{color:le(e.color)??[0,0,0,0],width:e.width,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,scaleInfo:i,hasSizeVV:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}}function Kr(e,t,i,s){if(t.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const o=Ji(t,i,s);return[e.createMeshInfo(o)]}function jr(e,t,i,s){const{spriteRasterizationParam:o,scaleDash:r,sampleAlphaOnly:l}=t;if(!o)throw new Error("InternalError: Sprite should be defined");return[e.createMeshInfo({...Ji(t,i,s),offsetAlongLine:t.offsetAlongLine??0,shouldScaleDash:r??!1,shouldSampleAlphaOnly:l,isSDF:o.resource.type!=="CIMPictureStroke"&&o.resource.type!=="CIMGradientStroke",sprite:o})]}function Zr(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:r}=o;return Xr(r.ensureInstance(Y.gradientStroke,{uniforms:e.isOutline?{...Ze,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops}:{visualVariableColor:null,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo}}),e,i)}function Xr(e,t,i){if(!t.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=t.spriteRasterizationParam;return[e.createMeshInfo({...Ji(t,!1,i),gradientMethod:t.gradientMethod,gradientSize:t.gradientSize,gradientSizeUnits:t.gradientSizeUnits,gradientType:t.gradientType,sprite:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null})]}function Yr(e,t,i){const{uniforms:s,schemaOptions:o}=t,{store:r}=o;return Qr(r.ensureInstance(Y.text,{uniforms:{visualVariableColor:e.colorLocked?null:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1,visibility:!1}}),e,s,i)}function Qr(e,t,i,{scaleInfo:s,scaleExpression:o}){return[e.createMeshInfo({boxBackgroundColor:le(t.backgroundColor),boxBorderLineColor:le(t.borderLineColor),boxBorderLineSize:t.borderLineWidth??0,color:le(t.color)??[0,0,0,0],offsetX:t.offsetX,offsetY:t.offsetY,postAngle:t.angle,fontSize:t.size,referenceSize:t.referenceSize,decoration:t.decoration,haloColor:le(t.haloColor)??[0,0,0,0],haloSize:t.haloSize??0,outlineColor:le(t.outlineColor)??[0,0,0,0],outlineSize:t.outlineSize,lineWidth:t.lineWidth||512,lineHeightRatio:1,horizontalAlignment:t.horizontalAlignment??"center",verticalAlignment:t.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:t.textRasterizationParam,scaleInfo:s,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null,placement:t.markerPlacement,transforms:t.transform,scaleFactor:o??1,minPixelBuffer:lo(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,labelClassId:-1})]}function $n(e,t){return{type:"simple",filters:t,capabilities:{maxTextureSize:mi().maxTextureSize},bindings:ei(e)}}function Bn(e,t){const i=mi();return{type:"multi",target:"feature",keyField:ma,filters:t,capabilities:{maxTextureSize:i.maxTextureSize},bindings:{[zi.TrackLine]:ei(e.trackLines.renderer),[zi.LatestObservation]:ei(e.latestObservations.renderer),[zi.PreviousObservation]:ei(e.previousObservations.renderer)}}}function xi(e){switch(e){case"opacity":return Ut.OPACITY;case"color":return Ut.COLOR;case"rotation":return Ut.ROTATION;case"size":return Ut.SIZE;default:return null}}function ei(e){if(!e)return[];switch(e.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return po(e);case"dot-density":return Jr(e);case"pie-chart":return en(e);case"heatmap":return tn(e)}}function Jr(e){const t=[];for(const i of e.attributes)t.push({binding:t.length,expression:i.valueExpression,field:i.field});return t}function en(e){const t=po(e);let i=4;for(const s of e.attributes)t.push({binding:i++,expression:s.valueExpression,field:s.field});return t}function tn({valueExpression:e,field:t}){return e||t?[{binding:0,expression:e,field:t}]:[]}function po(e){return!("visualVariables"in e)||!e.visualVariables?.length?[]:no(e.visualVariables).map(t=>nn(t)).filter(wo)}function sn(e){return e.valueExpression==="$view.scale"?null:{binding:xi(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression,valueRepresentation:e.valueRepresentation}}function on(e){return{binding:xi(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}function an(e){return{binding:xi(e.type),field:e.field,normalizationField:e.normalizationField,expression:e.valueExpression}}function rn(e){return{binding:xi(e.type),expression:e.valueExpression,field:e.field}}function nn(e){switch(e.type){case"size":return sn(e);case"color":return on(e);case"opacity":return an(e);case"rotation":return rn(e)}}class ln{constructor(){this.type="override-batch",this.messages=[],this._resovler=go()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(t){this.messages.push(t)}}class Hn{constructor(t){this.updateTracking=new Fo({debugName:"FeatureCommandQueue"}),this.process=t.process,this._queueProcessor=new ha({concurrency:1,process:async i=>{if(i.type==="override-batch"){const s=this._nextOverrideBatch;if(s==null)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,await this.process(s),void s.resolve()}return this.process(i)}})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(t){return vo(this.updateTracking.addPromise(this._doPush(t)))}async _doPush(t){const i=this._queueProcessor,s=i.last();switch(t.type){case"update":case"highlight":return s?.type===t.type?void 0:i.push(t);case"override":case"edit":return this._pushOverride(t)}}_pushOverride(t){return this._nextOverrideBatch==null&&(this._nextOverrideBatch=new ln,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(t),this._nextOverrideBatch.promise}}export{Ln as $,Qr as A,Fn as B,Dn as C,Ze as E,ga as F,fa as I,In as O,Xr as P,lo as Q,Gr as S,Kr as V,Y as X,En as Z,$n as a,Br as b,Hr as c,Lr as d,kn as e,Ir as f,Er as g,po as h,Dr as i,Bn as n,Ki as t,gr as u,Hn as v,Nr as w,Qi as x,jr as z};
