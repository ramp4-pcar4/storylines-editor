import{im as Y,cg as _,E as j,bw as Q,am as Z,T as J,a8 as K,eQ as W,c as O}from"./main-DK5A1thH.js";import{h as $}from"./TimeExtent-gZaEUVeW-DaDBMnur.js";import{N as H}from"./quantizationUtils-Cndke4AR-C-yFTim2.js";import{A as X,M as ee}from"./heatmapUtils--OU2Fakh-CU7rUz5B.js";import{F as ne}from"./utils-BG7WTOnW-0dD0ASRJ.js";import{p as le}from"./ClassBreaksDefinition-B_vYk3bu-BFm4eQQf.js";const te=()=>K.getLogger("esri.rest.support.generateRendererUtils");function N(e,n){return Number(e.toFixed(n))}function Je(e){const n=P(e),l=[],a=n.uniqueValues.length;for(let t=0;t<a;t++){const c=n.uniqueValues[t],u=n.valueFrequency[t],i=c.toString();l.push({value:c,count:u,label:i})}return{uniqueValues:l}}function ae(e,n){const{normalizationTotal:l}=e;return{classBreaks:ie(e,n),normalizationTotal:l}}function ie(e,n){const l=e.definition,{classificationMethod:a,normalizationType:t,definedInterval:c}=l,u=l.breakCount??1,i=[];let r=e.values;if(r.length===0)return[];r=r.sort((f,o)=>f-o);const[h,d]=n??[r.at(0),r.at(-1)];if(a==="equal-interval")if(r.length>=u){const f=(d-h)/u;let o=h;for(let s=1;s<u;s++){const m=N(h+s*f,6);i.push({minValue:o,maxValue:m,label:x(o,m,t)}),o=m}i.push({minValue:o,maxValue:d,label:x(o,d,t)})}else r.forEach(f=>{i.push({minValue:f,maxValue:f,label:x(f,f,t)})});else if(a==="natural-breaks"){const f=P(r),o=e.valueFrequency||f.valueFrequency,s=oe(f.uniqueValues,o,u);let m=h;for(let p=1;p<u;p++)if(f.uniqueValues.length>p){const g=N(f.uniqueValues[s[p]],6);i.push({minValue:m,maxValue:g,label:x(m,g,t)}),m=g}i.push({minValue:m,maxValue:d,label:x(m,d,t)})}else if(a==="quantile")if(r.length>=u&&h!==d){let f=h,o=Math.ceil(r.length/u),s=0;for(let m=1;m<u;m++){let p=o+s-1;p>r.length&&(p=r.length-1),p<0&&(p=0),i.push({minValue:f,maxValue:r[p],label:x(f,r[p],t)}),f=r[p],s+=o,o=Math.ceil((r.length-s)/(u-m))}i.push({minValue:f,maxValue:d,label:x(f,d,t)})}else{let f=-1;for(let o=0;o<r.length;o++){const s=r[o];s!==f&&(f=s,i.push({minValue:f,maxValue:s,label:x(f,s,t)}),f=s)}}else if(a==="standard-deviation"){const f=re(r),o=ce(r,f);if(o===0)i.push({minValue:r[0],maxValue:r[0],label:x(r[0],r[0],t)});else{const s=ue(h,d,u,f,o)*o;let m=0,p=h;for(let V=u;V>=1;V--){const v=N(f-(V-.5)*s,6);i.push({minValue:p,maxValue:v,label:x(p,v,t)}),p=v,m++}let g=N(f+.5*s,6);i.push({minValue:p,maxValue:g,label:x(p,g,t)}),p=g,m++;for(let V=1;V<=u;V++)g=m===2*u?d:N(f+(V+.5)*s,6),i.push({minValue:p,maxValue:g,label:x(p,g,t)}),p=g,m++}}else if(a==="defined-interval"){if(!c)return i;const[f,o]=n??[r.at(0),r.at(-1)],s=Math.ceil((o-f)/c);let m=f;for(let p=1;p<s;p++){const g=N(f+p*c,6);i.push({minValue:m,maxValue:g,label:x(m,g,t)}),m=g}i.push({minValue:m,maxValue:o,label:x(m,o,t)})}return i}function x(e,n,l){let a=null;return a=e===n?l&&l==="percent-of-total"?e+"%":e.toString():l&&l==="percent-of-total"?e+"% - "+n+"%":e+" - "+n,a}function P(e){const n=[],l=[];let a=Number.MIN_VALUE,t=1,c=-1;for(let u=0;u<e.length;u++){const i=e[u];i===a?(t++,l[c]=t):i!==null&&(n.push(i),a=i,t=1,l.push(t),c++)}return{uniqueValues:n,valueFrequency:l}}function oe(e,n,l){const a=e.length,t=[];l>a&&(l=a);for(let u=0;u<l;u++)t.push(Math.round(u*a/l-1));t.push(a-1);let c=U(t,e,n,l);return se(c.mean,c.sdcm,t,e,n,l)&&(c=U(t,e,n,l)),t}function U(e,n,l,a){let t=[],c=[],u=[],i=0;const r=[],h=[];for(let s=0;s<a;s++){const m=z(s,e,n,l);r.push(m.sbMean),h.push(m.sbSdcm),i+=h[s]}let d,f=i,o=!0;for(;o||i<f;){o=!1,t=[];for(let s=0;s<a;s++)t.push(e[s]);for(let s=0;s<a;s++)for(let m=e[s]+1;m<=e[s+1];m++)if(d=n[m],s>0&&m!==e[s+1]&&Math.abs(d-r[s])>Math.abs(d-r[s-1]))e[s]=m;else if(s<a-1&&e[s]!==m-1&&Math.abs(d-r[s])>Math.abs(d-r[s+1])){e[s+1]=m-1;break}f=i,i=0,c=[],u=[];for(let s=0;s<a;s++){c.push(r[s]),u.push(h[s]);const m=z(s,e,n,l);r[s]=m.sbMean,h[s]=m.sbSdcm,i+=h[s]}}if(i>f){for(let s=0;s<a;s++)e[s]=t[s],r[s]=c[s],h[s]=u[s];i=f}return{mean:r,sdcm:h}}function se(e,n,l,a,t,c){let u=0,i=0,r=0,h=0,d=!0;for(let f=0;f<2&&d;f++){f===0&&(d=!1);for(let o=0;o<c-1;o++)for(;l[o+1]+1!==l[o+2];){l[o+1]=l[o+1]+1;const s=z(o,l,a,t);r=s.sbMean,u=s.sbSdcm;const m=z(o+1,l,a,t);if(h=m.sbMean,i=m.sbSdcm,!(u+i<n[o]+n[o+1])){l[o+1]=l[o+1]-1;break}n[o]=u,n[o+1]=i,e[o]=r,e[o+1]=h,d=!0}for(let o=c-1;o>0;o--)for(;l[o]!==l[o-1]+1;){l[o]=l[o]-1;const s=z(o-1,l,a,t);r=s.sbMean,u=s.sbSdcm;const m=z(o,l,a,t);if(h=m.sbMean,i=m.sbSdcm,!(u+i<n[o-1]+n[o])){l[o]=l[o]+1;break}n[o-1]=u,n[o]=i,e[o-1]=r,e[o]=h,d=!0}}return d}function ue(e,n,l,a,t){let c=Math.max(a-e,n-a)/t/l;return c=c>=1?1:c>=.5?.5:.25,c}function re(e){let n=0;for(let l=0;l<e.length;l++)n+=e[l];return n/=e.length,n}function ce(e,n){let l=0;for(let a=0;a<e.length;a++){const t=e[a];l+=(t-n)*(t-n)}return l/=e.length,Math.sqrt(l)}function z(e,n,l,a){let t=0,c=0;for(let r=n[e]+1;r<=n[e+1];r++){const h=a[r];t+=l[r]*h,c+=h}c<=0&&te().warn("Exception in Natural Breaks calculation");const u=t/c;let i=0;for(let r=n[e]+1;r<=n[e+1];r++)i+=a[r]*(l[r]-u)**2;return{sbMean:u,sbSdcm:i}}const fe="<Null>",me="equal-interval",de=1,pe=5,he=10,ge=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,be=new Set(["esriFieldTypeDate","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeOID","esriFieldTypeBigInteger"]),Ve=new Set(["esriFieldTypeTimeOnly","esriFieldTypeDateOnly"]),xe=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function F(e){return e==null||typeof e=="string"&&!e?fe:e}function ve(e){const n=e.normalizationField!=null||e.normalizationType!=null,l=e.minValue!=null||e.maxValue!=null,a=!!e.sqlExpression&&e.supportsSQLExpression;return!n&&!l&&!a}function Ke(e){const{outStatisticTypes:n}=e,l=e.returnDistinct?[...new Set(e.values)]:e.values,a=l.filter(u=>u!=null).sort(),t=a.length,c={count:t,min:a[0],max:a[t-1]};return e.supportsNullCount&&(c.nullcount=l.length-t),!e.percentileParams||n?.include?.length&&!n.include.includes("median")||n?.exclude?.length&&n.exclude.includes("median")||(c.median=B(l,e.percentileParams)),c}function ye(e){const{values:n,useSampleStdDev:l,supportsNullCount:a,outStatisticTypes:t}=e;let c=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,i=null,r=null,h=null,d=null,f=0;const o=e.minValue==null?-1/0:e.minValue,s=e.maxValue==null?1/0:e.maxValue;for(const p of n)Number.isFinite(p)?p>=o&&p<=s&&(i=i===null?p:i+p,c=Math.min(c,p),u=Math.max(u,p),f++):typeof p=="string"&&f++;if(f&&i!=null){r=i/f;let p=0;for(const g of n)Number.isFinite(g)&&g>=o&&g<=s&&(p+=(g-r)**2);d=l?f>1?p/(f-1):0:f>0?p/f:0,h=Math.sqrt(d)}else c=null,u=null;const m={avg:r,count:f,max:u,min:c,stddev:h,sum:i,variance:d};return a&&(m.nullcount=n.length-f),!e.percentileParams||t?.include?.length&&!t.include.includes("median")||t?.exclude?.length&&t.exclude.includes("median")||(m.median=B(n,e.percentileParams)),m}function B(e,n){const{fieldType:l,value:a,orderBy:t,isDiscrete:c}=n,u=Te(l,t==="desc");if((e=[...e].filter(s=>s!=null).sort((s,m)=>u(s,m))).length===0)return null;if(a<=0)return e[0];if(a>=1)return e[e.length-1];const i=(e.length-1)*a,r=Math.floor(i),h=r+1,d=i%1,f=e[r],o=e[h];return h>=e.length||c||typeof f=="string"||typeof o=="string"?f:f*(1-d)+o*d}function Te(e,n){if(e){if(be.has(e))return A(n);if(Ve.has(e))return E(n,!1);if(e==="esriFieldTypeTimestampOffset")return Me(n);const u=E(n,!0);if(e==="esriFieldTypeString")return u;if(e==="esriFieldTypeGUID"||e==="esriFieldTypeGlobalID")return(i,r)=>u(L(i),L(r))}const l=n?1:-1,a=A(n),t=E(n,!0),c=G(n);return(u,i)=>typeof u=="number"&&typeof i=="number"?a(u,i):typeof u=="string"&&typeof i=="string"?t(u,i):c(u,i)??l}const w=(e,n)=>e==null?n==null?0:1:n==null?-1:null,k=(e,n)=>e==null?n==null?0:-1:n==null?1:null;function G(e){return e?w:k}const Fe=(e,n)=>k(e,n)??(e===n?0:new Date(e).getTime()-new Date(n).getTime()),Ie=(e,n)=>w(e,n)??(e===n?0:new Date(n).getTime()-new Date(e).getTime());function Me(e){return e?Ie:Fe}const Ne=(e,n)=>k(e,n)??(e===n?0:e<n?-1:1),ze=(e,n)=>w(e,n)??(e===n?0:e<n?1:-1);function E(e,n){if(!n)return e?ze:Ne;const l=G(e);return e?(a,t)=>l(a,t)??((a=a.toUpperCase())>(t=t.toUpperCase())?-1:a<t?1:0):(a,t)=>l(a,t)??((a=a.toUpperCase())<(t=t.toUpperCase())?-1:a>t?1:0)}const Se=(e,n)=>w(e,n)??n-e,De=(e,n)=>k(e,n)??e-n;function A(e){return e?Se:De}function L(e){return e.slice(24,36)+e.slice(19,23)+e.slice(16,18)+e.slice(14,16)+e.slice(11,13)+e.slice(9,11)+e.slice(6,8)+e.slice(4,6)+e.slice(2,4)+e.slice(0,2)}function We(e,n,l){let a;for(a in e)n?.include?.length&&!n.include.includes(a)||n?.exclude?.length&&n.exclude.includes(a)?delete e[a]:xe.includes(a)&&(Number.isFinite(e[a])||(e[a]=null));return l&&["avg","stddev","variance"].forEach(t=>{e[t]!=null&&(e[t]=Math.ceil(e[t]??0))}),e}function He(e){const n={};for(let l of e)(l==null||typeof l=="string"&&l.trim()==="")&&(l=null),n[l]==null?n[l]={count:1,data:l}:n[l].count++;return{count:n}}function C(e){return e?.type!=="coded-value"?[]:e.codedValues.map(n=>n.code)}function Xe(e,n,l,a){const t=e.count,c=[];if(l&&n){const u=[],i=C(n[0]);for(const r of i)if(n[1]){const h=C(n[1]);for(const d of h)if(n[2]){const f=C(n[2]);for(const o of f)u.push(`${F(r)}${a}${F(d)}${a}${F(o)}`)}else u.push(`${F(r)}${a}${F(d)}`)}else u.push(r);for(const r of u)t.hasOwnProperty(r)||(t[r]={data:r,count:0})}for(const u in t){const i=t[u];c.push({value:i.data,count:i.count,label:i.label})}return{uniqueValueInfos:c}}function we(e,n,l,a){let t=null;switch(n){case"log":e!==0&&(t=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(a)&&a!==0&&(t=e/a*100);break;case"field":Number.isFinite(l)&&l!==0&&(t=e/l);break;case"natural-log":e>0&&(t=Math.log(e));break;case"square-root":e>0&&(t=e**.5)}return t}function ke(e,n,l){const a=$e({field:n.field,normalizationType:n.normalizationType,normalizationField:n.normalizationField,classificationMethod:n.classificationMethod,standardDeviationInterval:n.standardDeviationInterval,definedInterval:n.definedInterval,breakCount:n.numClasses||pe});return e=qe(e,n.minValue,n.maxValue),ae({definition:a,values:e,normalizationTotal:n.normalizationTotal},l)}function qe(e,n,l){const a=n??-1/0,t=l??1/0;return e.filter(c=>Number.isFinite(c)&&c>=a&&c<=t)}function $e(e){const{breakCount:n,field:l,normalizationField:a,normalizationType:t}=e,c=e.classificationMethod||me,u=c==="standard-deviation"?e.standardDeviationInterval||de:void 0,i=c==="defined-interval"?e.definedInterval:void 0;return new le({breakCount:n,classificationField:l,classificationMethod:c,normalizationField:t==="field"?a:void 0,normalizationType:t,standardDeviationInterval:u,definedInterval:i})}function en(e,n){let l=e.classBreaks;const a=l.length,t=l[0]?.minValue,c=l[a-1]?.maxValue,u=n==="standard-deviation",i=ge;return l=l.map(r=>{const h=r.label,d={minValue:r.minValue,maxValue:r.maxValue,label:h};if(u&&h){const f=h.match(i),o=f?.map(s=>+s.trim())??[];o.length===2?(d.minStdDev=o[0],d.maxStdDev=o[1],o[0]<0&&o[1]>0&&(d.hasAvg=!0)):o.length===1&&(h.includes("<")?(d.minStdDev=null,d.maxStdDev=o[0]):h.includes(">")&&(d.minStdDev=o[0],d.maxStdDev=null))}return d}),{minValue:t,maxValue:c,classBreakInfos:l,normalizationTotal:e.normalizationTotal}}function nn(e,n){const l=Ee(e,n);if(l.min==null&&l.max==null)return{bins:[],minValue:l.min,maxValue:l.max,normalizationTotal:n.normalizationTotal};const a=l.intervals,t=l.min??0,c=l.max??0,u=a.map((i,r)=>({minValue:a[r][0],maxValue:a[r][1],count:0}));for(const i of e)if(i!=null&&i>=t&&i<=c){const r=Ce(a,i);r>-1&&u[r].count++}return{bins:u,minValue:t,maxValue:c,normalizationTotal:n.normalizationTotal}}function Ee(e,n,l=!1){const{field:a,classificationMethod:t,standardDeviationInterval:c,definedInterval:u,normalizationType:i,normalizationField:r,normalizationTotal:h,minValue:d,maxValue:f}=n,o=n.numBins||he;let s=null,m=null,p=null;if((!t||t==="equal-interval")&&!i){if(d!=null&&f!=null)s=d,m=f;else{const g=ye({values:e,minValue:d,maxValue:f,useSampleStdDev:!i,supportsNullCount:ve({normalizationType:i,normalizationField:r,minValue:d,maxValue:f})});s=g.min??null,m=g.max??null}p=Oe(s??0,m??0,o)}else{const{classBreaks:g}=ke(e,{field:a,normalizationType:i,normalizationField:r,normalizationTotal:h,classificationMethod:t,standardDeviationInterval:c,definedInterval:u,minValue:d,maxValue:f,numClasses:o},d!=null&&f!=null?[d,f]:void 0);s=g[0]?.minValue,m=g[g.length-1]?.maxValue,p=g.map(V=>[V.minValue,V.maxValue])}if(l){const g=p.at(-1)[1];p.push([g,g])}return{min:s,max:m,intervals:p}}function Ce(e,n){let l=-1;for(let a=e.length-1;a>=0;a--)if(n>=e[a][0]){l=a;break}return l}function Oe(e,n,l){const a=(n-e)/l,t=[];let c,u=e;for(let i=1;i<=l;i++)c=u+a,c=Number(c.toFixed(16)),t.push([u,i===l?n:c]),u=c;return t}let T=null;const Ue=/^(?<hh>([0-1][0-9])|([2][0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?([.](?<ms>\d+))?$/;function Ae(e,n,l){return e.x<0?e.x+=n:e.x>l&&(e.x-=n),e}function ln(e,n,l,a){const t=Y(l)?_(l):null,c=t?Math.round((t.valid[1]-t.valid[0])/n.scale[0]):null;return e.map(u=>{const i=new j(u.geometry);return H(n,i,i),u.geometry=t?Ae(i,c??0,a[0]):i,u})}function tn(e,n=18,l,a,t){const c=new Float64Array(a*t);n=Math.round(W(n));let u=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;const r=ee(l);for(const{geometry:h,attributes:d}of e){const{x:f,y:o}=h,s=Math.max(0,f-n),m=Math.max(0,o-n),p=Math.min(t,o+n),g=Math.min(a,f+n),V=+r(d);for(let v=m;v<p;v++)for(let I=s;I<g;I++){const S=v*a+I,D=X(I-f,v-o,n)*V,y=c[S]+=D;u=Math.min(u,y),i=Math.max(i,y)}}return{min:u,max:i}}function Le(e){const n=Ue.exec(e);if(!n)return null;const{hh:l,mm:a,ss:t,ms:c}=n.groups;return Number(l)*$.hours+Number(a)*$.minutes+Number(t)*$.seconds+Number(c||0)}async function an(e,n,l=!0){if(!n)return[];const{field:a,field2:t,field3:c,fieldDelimiter:u,fieldInfos:i,timeZone:r}=e,h=a&&i?.find(y=>y.name.toLowerCase()===a.toLowerCase()),d=!!h&&Q(h),f=!!h&&ne(h),o=e.valueExpression,s=e.normalizationType,m=e.normalizationField,p=e.normalizationTotal,g=[],V=e.viewInfoParams;let v=null,I=null;if(o){if(!T){const{arcadeUtils:y}=await Z();T=y}T.hasGeometryOperations(o)&&await T.enableGeometryOperations(),v=T.createFunction(o),I=V?T.getViewInfo({viewingMode:V.viewingMode,scale:V.scale,spatialReference:new J(V.spatialReference)}):null}const S=e.fieldInfos,D=!(n[0]&&"declaredClass"in n[0]&&n[0].declaredClass==="esri.Graphic")&&S?{fields:S}:null;return n.forEach(y=>{const M=y.attributes;let b;if(o){const q=D?{...y,layer:D}:y,R=T.createExecContext(q,I,r);b=T.executeFunction(v,R)}else M&&(b=M[a],t?(b=`${F(b)}${u}${F(M[t])}`,c&&(b=`${b}${u}${F(M[c])}`)):typeof b=="string"&&l&&(f?b=b?new Date(b).getTime():null:d&&(b=b?Le(b):null)));if(s&&typeof b=="number"&&isFinite(b)){const q=M&&parseFloat(M[m]);b=we(b,s,q,p)}g.push(b)}),g}function on(e){const n=e.field,l=e.normalizationType,a=e.normalizationField;let t;return l==="field"?t="(NOT "+a+" = 0)":l!=="log"&&l!=="natural-log"&&l!=="square-root"||(t=`(${n} > 0)`),t}function sn(e,n,l){const a=n!=null?e+" >= "+n:"",t=l!=null?e+" <= "+l:"";let c="";return c=a&&t?Pe(a,t):a||t,c?"("+c+")":""}function Pe(e,n){let l=e??"";return n!=null&&n&&(l=l?"("+l+") AND ("+n+")":n),l}function un(e,n){if(e&&e.spatialRelationship!=="intersects")return new O(n,"Only 'intersects' spatialRelationship is supported for featureFilter")}function rn(e,n,l){const a=Be({layer:e,fields:n});if(a.length)return new O(l,"Unknown fields: "+a.join(", ")+". You can only use fields defined in the layer schema");const t=Ge({layer:e,fields:n});return t.length?new O(l,"Unsupported fields: "+t.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true"):void 0}function Be(e){const n=e.layer;return e.fields.filter(l=>!n.getField(l))}function Ge(e){const n=e.layer;return e.fields.filter(l=>{const a=n.getFieldUsageInfo(l);return!a||!a.supportsStatistics})}export{ve as A,ae as B,B as E,Oe as H,ln as J,ke as K,We as L,He as P,nn as R,F as T,an as W,Ee as X,ye as Y,Ce as Z,Xe as a,tn as b,Te as c,we as d,Le as e,sn as f,$e as g,Je as h,rn as i,en as j,Ke as k,un as l,on as m,xe as n,Pe as t};
