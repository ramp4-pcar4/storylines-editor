import{ec as mt,dD as v,dU as F,hZ as m}from"./main-B-qqJ5ov.js";import{A as Z,X as Ot,_ as Rt,L as q,j as k,p as Q}from"./vec32-D9GsKZ1t-Cpv9XLxo.js";import{X as ht,d as tt,C as w,l as et,a as J,G as nt,F as T,b as z}from"./sphere-BenPORjV-D7fb-jY0.js";import{B as pt,z as At}from"./mat4-DX7gBViE-wsQhA476.js";import{D as bt}from"./vec42-D8CJyqHG-DnfLTeQH.js";import{e as M}from"./vec4f64-hf2nxvhQ-CaAr8PTM.js";import{y as A,j as Ft,o as Et,J as Nt,G as L}from"./plane-Dt8R0KeE-cjZbO2Lx.js";import{l as at}from"./Util-BjGjeg6f-08Szkf4F.js";function lt(o){return o?{ray:tt(o.ray),c0:o.c0,c1:o.c1}:{ray:tt(),c0:0,c1:Number.MAX_VALUE}}new ht(()=>lt());function Xt(o){return o?[A(o[0]),A(o[1]),A(o[2]),A(o[3]),A(o[4]),A(o[5])]:[A(),A(),A(),A(),A(),A()]}function gt(){return[F(),F(),F(),F(),F(),F(),F(),F()]}function Vt(o,t){for(let e=0;e<dt;e++)Ft(o[e],t[e]);return o}function Wt(o,t,e,n=xt){const s=pt(Et.get(),t,o);At(s,s);for(let r=0;r<Bt;++r){const a=bt(Nt.get(),St[r],s);Rt(n[r],a[0]/a[3],a[1]/a[3],a[2]/a[3])}Mt(e,n)}function Mt(o,t){L(t[i.FAR_BOTTOM_LEFT],t[i.NEAR_BOTTOM_LEFT],t[i.NEAR_TOP_LEFT],o[B.LEFT]),L(t[i.NEAR_BOTTOM_RIGHT],t[i.FAR_BOTTOM_RIGHT],t[i.FAR_TOP_RIGHT],o[B.RIGHT]),L(t[i.FAR_BOTTOM_LEFT],t[i.FAR_BOTTOM_RIGHT],t[i.NEAR_BOTTOM_RIGHT],o[B.BOTTOM]),L(t[i.NEAR_TOP_LEFT],t[i.NEAR_TOP_RIGHT],t[i.FAR_TOP_RIGHT],o[B.TOP]),L(t[i.NEAR_BOTTOM_LEFT],t[i.NEAR_BOTTOM_RIGHT],t[i.NEAR_TOP_RIGHT],o[B.NEAR]),L(t[i.FAR_BOTTOM_RIGHT],t[i.FAR_BOTTOM_LEFT],t[i.FAR_TOP_LEFT],o[B.FAR])}function C(o,t){for(let e=0;e<dt;e++){const n=o[e];if(n[0]*t[0]+n[1]*t[1]+n[2]*t[2]+n[3]>=t[3])return!1}return!0}var B,i;(function(o){o[o.LEFT=0]="LEFT",o[o.RIGHT=1]="RIGHT",o[o.BOTTOM=2]="BOTTOM",o[o.TOP=3]="TOP",o[o.NEAR=4]="NEAR",o[o.FAR=5]="FAR"})(B||(B={})),function(o){o[o.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",o[o.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",o[o.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",o[o.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",o[o.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",o[o.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",o[o.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",o[o.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(i||(i={})),i.FAR_BOTTOM_RIGHT,i.NEAR_BOTTOM_RIGHT,i.NEAR_BOTTOM_LEFT,i.FAR_BOTTOM_LEFT,i.NEAR_BOTTOM_LEFT,i.NEAR_BOTTOM_RIGHT,i.NEAR_TOP_RIGHT,i.NEAR_TOP_LEFT,i.FAR_BOTTOM_RIGHT,i.FAR_BOTTOM_LEFT,i.FAR_TOP_LEFT,i.FAR_TOP_RIGHT,i.NEAR_BOTTOM_RIGHT,i.FAR_BOTTOM_RIGHT,i.FAR_TOP_RIGHT,i.NEAR_TOP_RIGHT,i.FAR_BOTTOM_LEFT,i.NEAR_BOTTOM_LEFT,i.NEAR_TOP_LEFT,i.FAR_TOP_LEFT,i.FAR_TOP_LEFT,i.NEAR_TOP_LEFT,i.NEAR_TOP_RIGHT,i.FAR_TOP_RIGHT;const dt=6,Bt=8,St=[M(-1,-1,-1,1),M(1,-1,-1,1),M(1,1,-1,1),M(-1,1,-1,1),M(-1,-1,1,1),M(1,-1,1,1),M(1,1,1,1),M(-1,1,1,1)];new ht(lt);const xt=gt();class I{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,e){this.objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),U[0]=null,j.prune(),P.prune()}add(t,e=t.length){this._objectCount+=e,this._grow(t,e);const n=l.acquire();for(let s=0;s<e;s++){const r=t[s];this._isDegenerate(r)?this._degenerateObjects.add(r):(n.init(this._root),this._add(r,n))}l.release(n)}remove(t,e=null){this._objectCount-=t.length;const n=l.acquire();for(const s of t){const r=e??w(this.objectToBoundingSphere(s),vt);D(r[3])?(n.init(this._root),jt(s,r,n)):this._degenerateObjects.delete(s)}l.release(n),this._shrink()}update(t,e){if(!D(e[3])&&this._isDegenerate(t))return;const n=Dt(t);this.remove(n,e),this.add(n)}forEachAlongRay(t,e,n){const s=et(t,e);x(this._root,r=>{if(!It(s,r))return!1;const a=r.node;return a.terminals.forAll(u=>{this._intersectsObject(s,u)&&n(u)}),a.residents!==null&&a.residents.forAll(u=>{this._intersectsObject(s,u)&&n(u)}),!0})}forEachAlongRayWithVerticalOffset(t,e,n,s){const r=et(t,e);x(this._root,a=>{if(!Lt(r,a,s))return!1;const u=a.node;return u.terminals.forAll(h=>{this._intersectsObjectWithOffset(r,h,s)&&n(h)}),u.residents!==null&&u.residents.forAll(h=>{this._intersectsObjectWithOffset(r,h,s)&&n(h)}),!0})}forEach(t){x(this._root,e=>{const n=e.node;return n.terminals.forAll(t),n.residents!==null&&n.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,n,s=()=>!0,r=1/0){let a=1/0,u=1/0,h=null;const c=K(t,e),f=d=>{if(--r,!s(d))return;const O=this.objectToBoundingSphere(d);if(!C(n,O))return;const E=S(t,e,T(O)),G=E-O[3],_=E+O[3];G<a&&(a=G,u=_,h=d)};return ot(this._root,d=>{if(r<=0||!C(n,d.bounds)||(q(b,c,d.halfSize),k(b,b,T(d.bounds)),S(t,e,b)>u))return!1;const O=d.node;return O.terminals.forAll(E=>f(E)),O.residents!==null&&O.residents.forAll(E=>f(E)),!0},t,e),h}forEachInDepthRange(t,e,n,s,r,a,u){let h=-1/0,c=1/0;const f={setRange:_=>{n===I.DepthOrder.FRONT_TO_BACK?(h=Math.max(h,_.near),c=Math.min(c,_.far)):(h=Math.max(h,-_.far),c=Math.min(c,-_.near))}};f.setRange(s);const d=S(e,n,t),O=K(e,n),E=K(e,-n),G=_=>{if(!u(_))return;const g=this.objectToBoundingSphere(_),H=T(g),Y=S(e,n,H)-d,Tt=Y-g[3],ft=Y+g[3];Tt>c||ft<h||!C(a,g)||r(_,f)};ot(this._root,_=>{if(!C(a,_.bounds)||(q(b,O,_.halfSize),k(b,b,T(_.bounds)),S(e,n,b)-d>c)||(q(b,E,_.halfSize),k(b,b,T(_.bounds)),S(e,n,b)-d<h))return!1;const g=_.node;return g.terminals.forAll(H=>G(H)),g.residents!==null&&g.residents.forAll(H=>G(H)),!0},e,n)}forEachNode(t){x(this._root,e=>t(e.node,e.bounds,e.halfSize,e.depth))}forEachNeighbor(t,e){const n=J(e),s=T(e),r=h=>{const c=this.objectToBoundingSphere(h),f=J(c),d=n+f;return!(Q(T(c),s)-d*d<=0)||t(h)};let a=!0;const u=h=>{a&&(a=r(h))};x(this._root,h=>{const c=J(h.bounds),f=n+c;if(Q(T(h.bounds),s)-f*f>0)return!1;const d=h.node;return d.terminals.forAll(u),a&&d.residents!==null&&d.residents.forAll(u),a}),a&&this.forEachDegenerateObject(u)}_intersectsObject(t,e){const n=this.objectToBoundingSphere(e);return!(n[3]>0)||nt(n,t)}_intersectsObjectWithOffset(t,e,n){const s=this.objectToBoundingSphere(e);return!(s[3]>0)||nt(n.applyToBoundingSphere(s),t)}_add(t,e){e.advanceTo(this.objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let n=0;n<e.length;n++){const s=l.acquire().init(t);this._add(e.at(n),s),l.release(s)}}_grow(t,e){if(e!==0&&(st(t,e,n=>this.objectToBoundingSphere(n),N),D(N[3])&&!this._fitsInsideTree(N)))if(ut(this._root.node))w(N,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const n=this._rootBoundsForRootAsSubNode(N);this._placingRootViolatesMaxDepth(n)?this._rebuildTree(N,n):this._growRootAsSubNode(n),l.release(n)}}_rebuildTree(t,e){Z(T(V),T(e.bounds)),V[3]=e.halfSize,st([t,V],2,s=>s,W);const n=l.acquire().init(this._root);this._root.initFrom(null,W,W[3]),this._root.increaseHalfSize(1.25),x(n,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),l.release(n)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return x(this._root,s=>(n=Math.max(n,s.depth),n+e<=this._maximumDepth)),n+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],n=t;let s=-1/0;const r=this._root.bounds,a=this._root.halfSize;for(let h=0;h<3;h++){const c=r[h]-a-(n[h]-e),f=n[h]+e-(r[h]+a),d=Math.max(0,Math.ceil(c/(2*a))),O=Math.max(0,Math.ceil(f/(2*a)))+1,E=2**Math.ceil(Math.log(d+O)*Math.LOG2E);s=Math.max(s,E),$[h].min=d,$[h].max=O}for(let h=0;h<3;h++){let c=$[h].min,f=$[h].max;const d=(s-(c+f))/2;c+=Math.ceil(d),f+=Math.floor(d);const O=r[h]-a-c*a*2;X[h]=O+(f+c)*a}const u=s*a;return X[3]=u*_t,l.acquire().initFrom(null,X,u,0)}_growRootAsSubNode(t){const e=this._root.node;Z(T(N),T(this._root.bounds)),N[3]=this._root.halfSize,this._root.init(t),t.advanceTo(N,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let n=0,s=0;for(;s<e.length&&t==null;)n=s++,t=e[n];for(;s<e.length;)if(e[s++])return-1;return n}_isDegenerate(t){return!D(this.objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,n=this._root.halfSize;return t[3]<=n&&t[0]>=e[0]-n&&t[0]<=e[0]+n&&t[1]>=e[1]-n&&t[1]<=e[1]+n&&t[2]>=e[2]-n&&t[2]<=e[2]+n}toJSON(){const{maximumDepth:t,maximumObjectsPerNode:e,_objectCount:n}=this,s=this._nodeToJSON(this._root.node);return{maximumDepth:t,maximumObjectsPerNode:e,objectCount:n,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:s}}}_nodeToJSON(t){const e=t.children.map(r=>r?this._nodeToJSON(r):null),n=t.residents?.map(r=>this.objectToBoundingSphere(r)),s=t.terminals?.map(r=>this.objectToBoundingSphere(r));return{children:e,residents:n,terminals:s}}static fromJSON(t){const e=new I(n=>n,{maximumDepth:t.maximumDepth,maximumObjectsPerNode:t.maximumObjectsPerNode});return e._objectCount=t.objectCount,e._root.initFrom(t.root.node,t.root.bounds,t.root.halfSize,t.root.depth),e}}class l{constructor(){this.bounds=z(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,n,s=this.depth){return this.node=t??l.createEmptyNode(),e&&w(e,this.bounds),this.halfSize=n,this.depth=s,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*_t}advance(t){let e=this.node.children[t];e||(e=l.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const n=ct[t];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,e,n=!1){for(;;){if(this.isTerminalFor(t))return e&&e(this,-1),!0;if(this.isLeaf()){if(!n)return e&&e(this,-1),!1;this.node.residents=null}const s=this._childIndex(t);e&&e(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new v({shrink:!0}),residents:new v({shrink:!0})}}static acquire(){return l._pool.acquire()}static release(t){l._pool.release(t)}static clearPool(){l._pool.prune()}}function x(o,t){let e=l.acquire().init(o);const n=[e];for(;n.length!==0;){if(e=n.pop(),t(e)&&!e.isLeaf())for(let s=0;s<e.node.children.length;s++)e.node.children[s]&&n.push(l.acquire().init(e).advance(s));l.release(e)}}function ot(o,t,e,n=I.DepthOrder.FRONT_TO_BACK){let s=l.acquire().init(o);const r=[s];for(Ht(e,n,it);r.length!==0;){if(s=r.pop(),t(s)&&!s.isLeaf())for(let a=7;a>=0;--a){const u=it[a];s.node.children[u]&&r.push(l.acquire().init(s).advance(u))}l.release(s)}}function jt(o,t,e){j.clear();const n=e.advanceTo(t,(s,r)=>{j.push(s.node),j.push(r)})?e.node.terminals:e.node.residents;if(n.removeUnordered(o),n.length===0)for(let s=j.length-2;s>=0&&Pt(j.data[s],j.data[s+1]);s-=2);}function Pt(o,t){return t>=0&&(o.children[t]=null),!!ut(o)&&(o.residents===null&&(o.residents=new v({shrink:!0})),!0)}function It(o,t){return y(T(t.bounds),2*-t.halfSize,R),y(T(t.bounds),2*t.halfSize,p),at(o.origin,o.direction,R,p)}function Lt(o,t,e){return y(T(t.bounds),2*-t.halfSize,R),y(T(t.bounds),2*t.halfSize,p),e.applyToMinMax(R,p),at(o.origin,o.direction,R,p)}function ut(o){if(o.terminals.length!==0)return!1;if(o.residents!==null)return o.residents.length===0;for(let t=0;t<o.children.length;t++)if(o.children[t])return!1;return!0}function zt(o,t){o[0]=Math.min(o[0],t[0]-t[3]),o[1]=Math.min(o[1],t[1]-t[3]),o[2]=Math.min(o[2],t[2]-t[3])}function Gt(o,t){o[0]=Math.max(o[0],t[0]+t[3]),o[1]=Math.max(o[1],t[1]+t[3]),o[2]=Math.max(o[2],t[2]+t[3])}function y(o,t,e){e[0]=o[0]+t,e[1]=o[1]+t,e[2]=o[2]+t}function st(o,t,e,n){if(t===1){const s=e(o[0]);w(s,n)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,p[0]=-1/0,p[1]=-1/0,p[2]=-1/0;for(let s=0;s<t;s++){const r=e(o[s]);D(r[3])&&(zt(R,r),Gt(p,r))}Ot(T(n),R,p,.5),n[3]=Math.max(p[0]-R[0],p[1]-R[1],p[2]-R[2])/2}}function Ht(o,t,e){if(!P.length)for(let n=0;n<8;++n)P.push({index:0,distance:0});for(let n=0;n<8;++n){const s=ct[n];P.data[n].index=n,P.data[n].distance=S(o,t,s)}P.sort((n,s)=>n.distance-s.distance);for(let n=0;n<8;++n)e[n]=P.data[n].index}function K(o,t){let e,n=1/0;for(let s=0;s<8;++s){const r=S(o,t,rt[s]);r<n&&(n=r,e=rt[s])}return e}function S(o,t,e){return t*(o[0]*e[0]+o[1]*e[1]+o[2]*e[2])}function D(o){return!isNaN(o)&&o!==-1/0&&o!==1/0&&o>0}l._pool=new mt(l),function(o){var t;(t=o.DepthOrder||(o.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(I||(I={}));const ct=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],rt=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],_t=Math.sqrt(3),U=[null];function Dt(o){return U[0]=o,U}const X=z(),b=F(),R=F(),p=F(),j=new v,vt=z(),N=z(),V=z(),W=z(),$=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],P=new v,it=[0,0,0,0,0,0,0,0],Ut=I;export{Wt as B,Xt as N,Vt as S,Ut as y};
