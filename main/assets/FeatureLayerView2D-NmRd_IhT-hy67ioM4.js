import{v as h,S as f,i as Q,a0 as ut,aS as Ae,b as ye,b9 as K,o as C,bE as ct,bt as Me,bi as we,ag as dt,aq as pt,a2 as Pe,n as ht,K as g,ah as pe,aL as ft,aA as yt,a1 as x,hC as ke,aU as Ne,j2 as mt,j as et,J as gt,$ as he,I as bt,P as ae,bV as Fe,fl as Ue,hm as St,bh as vt,f4 as H,ax as _t,ai as Be,eQ as Le,j3 as De,ex as wt,j4 as je,j5 as It,j6 as Je,j7 as Vt,j8 as Ft,eH as oe,ey as ve,iJ as xt,ae as tt,eC as it,eD as Et,eB as Rt}from"./main-B-qqJ5ov.js";import{t as Ot}from"./compilerUtils-CV1QYWI8-DaNCNvT1.js";import{c as $e}from"./Container-BcuL1ZEG-eFqRz1Fv.js";import{k as Qe}from"./featureConversionUtils-D6hFQ4Af-7zE_Etyc.js";import ee from"./FeatureFilter-BCFHgLVU-BjKM0TLY.js";import{T as Ct}from"./timeSupport-ohWmWReZ-DMzenDTW.js";import{O as Ie}from"./FeatureSet-BkVNthuN-DcxIfkHg.js";import{b as me}from"./Query-BrwMGK8U-CyKS3Qe-.js";import{X as Tt,Y as zt}from"./LayerView-Bish-E63-B3t2STnz.js";import{i as qt}from"./UpdatingHandles-CUu3u1ms-HMNQlS0m.js";import{j as At,Z as He,G as Ge}from"./TechniqueInstance-DGTKoOL6-D7wFepa6.js";import{s as Mt,E as le,R as L,h as Pt,N as We}from"./MapView-BGOJJ8ch-RBEkjehQ.js";import{_ as kt,u as te,o as S,Q as A,h as xe,r as E,W as ge,U as Nt,b as ue,N as k,c as ie,l as Ee}from"./FeatureCommandQueue-DzV-HBIG-C4AVTHkV.js";import{D as Re,k as G,bt as Ut,bu as Bt}from"./UpdateTracking2D-Du_WIf4G-CEm4QtSq.js";import{i as rt}from"./CircularArray-DaQg3PQl-BXS52LZy.js";import"./Tile-D75RMC64-C3MLariM.js";import{s as Y}from"./TileKey-C5IL-JBr-DkZT6W2U.js";import{i as Lt}from"./WGLContainer-LxgEo4I_-z-5hqvPk.js";import{q as Dt}from"./workers-PiCjreoO-DJYvxXtl.js";import{h as jt}from"./ReactiveMap-CFk6jPfN-Dn1cGCMX.js";import{L as be}from"./arcgisLayerUrl-HNYh8jvG-B2O143Ys.js";import{m as Jt}from"./lengthUtils-DKpMe5qR-n4iUZvey.js";import{i as q}from"./sizeVariableUtils-t52KcLLi-D0hbQF8b.js";import{p as $t}from"./OrderByInfo-GD2XnU8e-BfhSowvj.js";import{Q as Qt}from"./labelingInfo-DGVNul26-DCh9yBVo.js";import{x as Ht}from"./heatmapUtils-seiMkkkR-PGEGurXS.js";import{r as j,o as ce}from"./enums-CpSG_SL3-BMD3Tb1v.js";import{V as Gt}from"./SDFHelper-B6k8Ig6R-D_Hsq5xp.js";import"./LabelMetric-BeluzH3o-iJy2d-T9.js";import{l as de}from"./definitions-DJSdSb77-DkoRHaVx.js";import{n as Wt}from"./capabilities-agoTWNzb-CtsNgRyk.js";import{i as Kt}from"./HighlightCounter-DFWq7PnG-L3ompOf4.js";import{x as Zt}from"./FeatureEffect-CDEk9Es7-fZVtYN6D.js";import{i as Ke}from"./floorFilterUtils-4r-vVdzs-C43jLoAE.js";import{m as _e,h as Yt}from"./popupUtils-nV1O8RUO-DBurfy_S.js";import{n as Xt}from"./RefreshableLayerView-BdQpGYly--EvADpmp.js";import"./parser-DyDJ-rlI-DLxk7ym2.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-DX7gBViE-wsQhA476.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./OptimizedFeature-EIithYlr-Cq64mIT3.js";import"./OptimizedFeatureSet-DfZGBuxJ-C08BOAgi.js";import"./TimeExtent-Cn0Jofqr-1iB3KTqK.js";import"./Field-C6hA1tZj-7h8v-exC.js";import"./fieldType-CD2CL2hr-B0GoEBDi.js";import"./layerViewUtils-DURAPenP-CiWQP0sU.js";import"./enums-DBi1-Mm2-CUS1pvQe.js";import"./Program-DLVwTiPA-C0UmoMsx.js";import"./BufferObject-BM_7mcDb-D9oo6-zU.js";import"./Texture-BCt2hphT-DvUofMVc.js";import"./TileContainer-D48pXXgL-D3BTBoIw.js";import"./Cyclical-C_9rKUUQ-Cho4ih7V.js";import"./CollectionFlattener-DkHuHn5E-Bg67MlaP.js";import"./projection-BA9M1R7d-BrWcDNEF.js";import"./projectBuffer-CvCBvJ6W-D4VBeyna.js";import"./TileInfo-CWIRDhZl-Bhhxrbtd.js";import"./TileKey-B_6qmYK--BtZdR-Xy.js";import"./themeUtils-YjM7iIiX-B6kY6GUl.js";import"./uuid-Dj9mdEVg-BaKSCiyT.js";import"./signal-CETehA7D-DKHdUMxd.js";import"./Map-1zd11DKO-T8pE1fte.js";import"./Basemap-BEqqSTw9-RRlL9tT1.js";import"./loadAll-e978YItg-fzRL7yQg.js";import"./PortalItem-CctGdnxF-CGvGDFAo.js";import"./writeUtils-D5qlLkwk--aMa2nHm.js";import"./TablesMixin-C8RojhYs-D26TS8Sr.js";import"./Layer-ChoECxvZ-Bet1V6UW.js";import"./GraphicsCollection-CWTXNZOX-CNRwzKrA.js";import"./HeightModelInfo-C5vFqzyF-DO96zinI.js";import"./ViewingMode-CyR_b1T8-_s7_Gbsk.js";import"./vec2f64-CeODonrJ-CkkJCdRC.js";import"./vec2-tHZ6OaOy-xCj1obDt.js";import"./normalizeUtils-Bxmy9MNI-CeIR1clc.js";import"./normalizeUtilsCommon-CRJlkfEA-CfUHeklq.js";import"./utils-9sQxfkoa-CrB3apxj.js";import"./utils-Bq23Xwmj-ubNLJvr4.js";import"./mat3-CC4Foazl-BWjyqE2v.js";import"./vec2f32-CVhmN3Me-DxoqVD7C.js";import"./unitBezier-CGtWxaCq-BRwEDigF.js";import"./Scheduler-B7UX7Wr5-BLeBwT6v.js";import"./vec32-D9GsKZ1t-Cpv9XLxo.js";import"./imageUtils-BA2D6Uf1-BmZoJuj0.js";import"./Version-CoKzbupV-MlNsQfpJ.js";import"./ColorBackground-gVZldRLm-DXkRr50W.js";import"./QueueProcessor-DbfV9fLy-BkAb7mV-.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./utils-SPbpQbmm-DQY8PVIo.js";import"./VertexArrayObject-M4iRGGoi-dWrHi2CG.js";import"./VertexElementDescriptor-BAy1DPb3-BOhpDZGx.js";import"./constants-Bqe1QJ4u-F8oTIn7N.js";import"./BidiEngine-Bdqv5H5j-Dyqh9XG-.js";import"./GeometryUtils-NHgB9gGQ-ByZ36CAa.js";import"./Rect-DD6XS68q-D_hsV3ag.js";import"./BindType-9iOk18Ed-CRW1cdX4.js";import"./Util-BjGjeg6f-08Szkf4F.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./vec4f64-hf2nxvhQ-CaAr8PTM.js";import"./ProgramTemplate-DQOm6Omy-YRxsVikh.js";import"./vec3f32-BS0cezmI-B_madU1n.js";import"./StyleDefinition-Ct4HIk9T-B82pTf0h.js";import"./config-nuMERBvb-MDUrh2eL.js";import"./earcut-XDcq3zAf-BcwyrT7l.js";import"./labelUtils-BW14kBqX-DfWgPm_B.js";import"./floatRGBA-4pIJN00G-as-qSsVU.js";import"./jsonUtils-wIllKWI4-NUUMETJf.js";let fe=class extends we{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer?.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};h([f({type:Boolean})],fe.prototype,"isAggregate",void 0),fe=h([Q("esri.AggregateGraphic")],fe);const Oe=fe;let v=class extends et{constructor(e){super(e),this._filter=null,this.duration=g("mapview-transitions-duration"),this._excludedEffectView=new $e(e),this._includedEffectView=new $e(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}get transitioningToEmpty(){return!this._excludedEffectView.final&&!this._includedEffectView.final}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransition(){this._includedEffectView.endTransition(),this._excludedEffectView.endTransition(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),i=e,r=i?.includedEffect,s=i?.excludedEffect,a=this._includedEffectView.canTransitionTo(r)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=r,this._excludedEffectView.effect=s,this._set("featureEffect",i),this._filter=i?.filter||t?.filter||null,a||this.endTransition()}};h([f()],v.prototype,"_filter",void 0),h([f()],v.prototype,"_excludedEffectView",void 0),h([f()],v.prototype,"_includedEffectView",void 0),h([f()],v.prototype,"duration",void 0),h([f()],v.prototype,"excludedEffects",null),h([f()],v.prototype,"featureEffect",null),h([f()],v.prototype,"filter",null),h([f()],v.prototype,"hasEffects",null),h([f()],v.prototype,"includedEffects",null),h([f({value:0})],v.prototype,"scale",null),h([f()],v.prototype,"transitioning",null),h([f()],v.prototype,"transitioningToEmpty",null),v=h([Q("esri.layers.effects.FeatureEffectView")],v);const ei=v;let X=class extends Ie{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){const i=gt.fromJSON(t.spatialReference),r=[];for(let s=0;s<e.length;s++){const a=e[s],n=Oe.fromJSON(a),o=a.geometry?.spatialReference;n.geometry==null||o||(n.geometry.spatialReference=i);const l=a.aggregateGeometries,u=n.aggregateGeometries;if(l&&u!=null)for(const d in u){const c=u[d],p=l[d],y=p?.spatialReference;c==null||y||(c.spatialReference=i)}r.push(n)}return r}};h([f({type:[Oe],json:{write:!0}})],X.prototype,"features",void 0),h([ut("features")],X.prototype,"readFeatures",null),X=h([Q("esri.rest.support.AggregateFeatureSet")],X);const ti=X;let ii=class{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}entries(){return this._instanceById.entries()}updateStart(){this._instanceByIdNext=new Map}updateEnd(){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const e of this._instanceById.keys())this._instanceByIdNext.has(e)||this._instanceById.delete(e);for(const[e,t]of this._instanceByIdNext.entries()){const i=this._instanceById.get(e);i?i.setInput(t.getInput()):this._instanceById.set(e,t)}this._instanceByIdNext=null}values(){return this._instanceById.values()}ensureInstance(e,t){let i;if(typeof t=="object"&&"optionalAttributes"in t&&"uniforms"in t){i=`${e.type}${JSON.stringify(t.optionalAttributes)}`;const s=t.uniforms;if(typeof s=="object")for(const a in s)i+=`${a}.${s[a]!=null}`}else i=`${e.type}.${JSON.stringify(t)}`;const r=St(i);if(this._instanceByIdNext){const s=new He(Ge(r),e,t);return this._instanceByIdNext.set(r,s),s}if(!this._instanceById.has(r)){const s=new He(Ge(r),e,t);this._instanceById.set(r,s)}return this._instanceById.get(r)}getInstance(e){return this._instanceById.get(e)}};const ri=1e3;let si=class{constructor(e,t,i,r){this.getStage=e,this.getSubscriptionVersion=t,this.version=i,this._tileInfoView=r,this._pendingUpdates=new rt(ri),this._locked=!1,this._tiles=new Map}destroy(){for(const e of this.tiles())e.destroy();this._pendingUpdates.clear(),this._tiles.clear()}tiles(){return this._tiles.values()}size(){return this._tiles.size}setTiles(e){this._tiles.clear();for(const t of e)this._tiles.set(t.key.id,t)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1,this.flush()}enqueueUpdate(e){this._pendingUpdates.enqueue(e)}update(e){if(!this._locked)for(;this._pendingUpdates.size;){const t=this._pendingUpdates.peek();if(t==null||t.inner.attributeEpoch>e)break;this._updateTile(t),this._pendingUpdates.dequeue()}}removeTile(e){const t=this._tiles.get(e);g("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),t?.destroy(),this._tiles.delete(e)}isTileDone(e){const t=this._tiles.get(e.id);return!!t&&t.isReady}flush(){for(;this._pendingUpdates.size;){const e=this._pendingUpdates.dequeue();e!=null&&this._updateTile(e)}for(const e of this._tiles.values())e.upload()}_updateTile(e){const{inner:t,objectIdMap:i}=e,r=this.getSubscriptionVersion(t.id);if(r!==t.subscriptionVesrion){if(g("esri-2d-update-debug")){const o=`${t.subscriptionVesrion} != ${r}`;console.debug(`Version[${o}] Tile[${t.id}] FeatureContainer - Dropping message, outdated version]`,t)}return}if(g("esri-2d-update-debug")){const o=t.debugInfo?.chunkId??"<EnsureEnd>";console.debug(`Version[${t.version}] Tile[${t.id}] Chunk[${o}] RenderState.updateTile [${t.type}]`,t)}const s=this._ensureTile(t.id);if(t.type==="update"){const[o,...l]=t.modify;s.onMessage({type:"update",modify:o,remove:t.remove,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});for(const u of l){const d=this._tiles.get(u.tileId);d&&d.onMessage({type:"update",modify:u,remove:t.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:i})}return}if(t.append==null)return void s.onMessage({type:"append",clear:t.clear,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});const[a,...n]=t.append;s.onMessage({type:"append",clear:t.clear,append:a,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});for(const o of n){const l=this._tiles.get(o.tileId);l&&l.onMessage({type:"update",modify:o,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:i})}}_ensureTile(e){if(!this._tiles.has(e)){const t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t)}return this._tiles.get(e)}_createTile(e){g("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const t=new Y(e),i=this._tileInfoView.getTileBounds(vt(),t),r=this._tileInfoView.getTileResolution(t.level),s=new Lt(t,r,i[0],i[3],!0);if(s.stage=this.getStage(),!s.stage){const a=new C("featurelayerview:webgl","Cannot create tile with empty stage");x.getLogger("esri.views.2d.layers.features.RenderState").error(a)}return s}_copyPixelBufferedEntitiesInto(e){let t=7;const i=this._tileInfoView.getLODInfoAt(e.key);for(let r=-1;r<=1;r++)for(let s=-1;s<=1;s++){if(r===0&&s===0)continue;const a=e.key.getNormalizedNeighbor(s,r,i).id,n=this._tiles.get(a);if(n!=null){const o=1<<t;e.copyPixelBufferedEntitesFrom(n,o,s,r)}t--}}},ai=class{constructor(e,t){this.id=e,this.version=t,this._resolver=ye(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}},ni=class extends At{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new qt,this._hitTestsRequests=[],this._store=new ii,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._layerView=e,this.addTransitionable(this._layerView.featureEffectView)}renderChildren(e){if(this._updateAttributeView(),this._renderState?.update(this.attributeView.currentEpoch),this._renderState){const t=Array.from(this._renderState.tiles()).filter(i=>i.needsUpload);t.length&&(t[Math.floor(Math.random()*t.length)].upload(),t.length>=2&&this.requestRender());for(const i of this._renderState.tiles())i.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(i.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender())}for(const t of this.children)t.setTransform(e.state);switch(super.renderChildren(e),e.drawPhase){case le.MAP:return this._renderMapPhase(e);case le.HIGHLIGHT:return this._renderHighlightPhase(e);case le.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getHeatmapInstance(e){if(this._instanceStore==null||!(e.drawPhase&S.heatmap.drawPhase))return null;for(const t of this._instanceStore.values())if(oi(t))return t;return null}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter(e=>this._visibleTiles.has(e.key.id)):[]}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&this._layerView.view.labelManager.requestUpdate()}updateSubscriptions(e){for(const{tileId:t,version:i}of e.subscribe)if(this._subscriptions.has(t))this._subscriptions.get(t).version=i;else{const r=new ai(t,i);this._subscriptions.set(t,r),this.updatingHandles.addPromise(r.promise)}for(const t of e.unsubscribe)this._subscriptions.get(t)?.destroy(),this._subscriptions.delete(t),this.removeTile(t)}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){g("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new si(()=>this._stage,t=>this._subscriptions.get(t)?.version,e,this.tileInfoView)}getDisplayStatistics(e,t){const i=this._statisticsByLevel.get(e);return i?i.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let i=this._statisticsByLevel.get(e);i||(i=new Map,this._statisticsByLevel.set(e,i));for(const r of t)i.set(r.fieldName,{minValue:r.minValue,maxValue:r.maxValue})}editStart(){this._renderState?.lockUploads(),this.attributeView.lockTextureUploads(),this._lockStatisticUpdates=!0}editEnd(){this._renderState?.unlockUploads(),this.attributeView.unlockTextureUploads(),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this.requestRender()}swapRenderState(){this._renderStateNext&&(g("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderStateNext=null),this._renderState&&this._renderState.flush(),this.requestRender()}setVisibleTiles(e){this._visibleTiles=e}async onMessage(e,t){he(t);const i=e.inner;if(!this._subscriptions.has(i.id))return;const r=this._subscriptions.get(i.id);if(r.version!==i.subscriptionVesrion){if(g("esri-2d-update-debug")){const a=`${i.subscriptionVesrion} != ${r.version}`;console.debug(`Version[${a}] Tile[${i.id}] FeatureContainer - Dropping message, outdated version]`,i)}return}const s=this._renderStateNext??this._renderState;if(!s)throw new Error("InternalError: No renderState defined");s.version!==i.version&&console.error(`InternalError: Version mismatch. [renderState: ${s.version}, message: ${i.version}]`),s.enqueueUpdate(e),this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find(({x:r,y:s})=>r===e.x&&s===e.y);const i=ye();return t?t.resolvers.push(i):(t={x:e.x,y:e.y,resolvers:[i]},this._hitTestsRequests.push(t)),this.requestRender(),i.promise}getSortKeys(e){const t=new Set(e),i=new Map;for(const r of this.children)if(r.getSortKeys(t).forEach((s,a)=>i.set(a,s)),i.size===t.size)break;return i}get hasAnimation(){return this.hasLabels}doRender(e){const{minScale:t,maxScale:i}=this._layer.effectiveScaleRange,r=e.state.scale;r<=(t||1/0)&&r>=i&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){if(this._getHeatmapInstance(e)==null)super.setStencilReference(e);else for(const t of this.children)t.stencilRef=S.heatmap.getStencilReference(t)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,L.All),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&Pt(e,!1,t=>{this._renderFeatures(t,L.Highlight)})}_renderLabelPhase(e){this._renderFeatures(e,L.All)}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,L.InsideEffect),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,L.OutsideEffect),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){const{context:t}=e,i=e.painter.effects.hittest,r=t.getBoundFramebufferObject(),s=t.getViewport(),a=e.passOptions,n=e.drawPhase;i.bind(e),e.passOptions=i.createOptions(e,this._hitTestsRequests),e.drawPhase=le.HITTEST;const{distance:o,smallSymbolDistance:l}=e.passOptions,u=Math.max(o,l);for(const d of this.children)d.visible&&d.containsScreenPoint(e.state,e.passOptions.position,2*u)&&this._renderTile(d,e,L.All);i.draw(e),i.unbind(),t.bindFramebuffer(r),t.restoreViewport(s),e.passOptions=a,e.drawPhase=n}_renderFeatures(e,t){const i=this._getHeatmapInstance(e);i!=null?this._renderHeatmapFeatures(e,t,i):this._renderGeometryFeatures(e,t)}_renderGeometryFeatures(e,t){for(const i of this.children)i.visible&&this._renderTile(i,e,t)}_renderHeatmapFeatures(e,t,i){for(const r of this.children)r.visible&&this._renderTile(r,e,t,Re.Heatmap);i.techniqueRef.renderResolvePass(e,i)}_renderTile(e,t,i,r){const s=g("featurelayer-force-marker-text-draw-order")?We.STRICT_MARKERS_AND_TEXT:We.BATCHING,a=e.getDisplayList(this._instanceStore,s);t.selection=i,a?.render(t,r)}};function oi(e){return e.techniqueRef.type===Re.Heatmap}async function li(e){const t=await Dt("FeaturePipelineWorker",{client:e,strategy:"dedicated"});return new ui(t)}let ui=class{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger")}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}};const ci=10;let O=class extends et{constructor(){super(...arguments),this.events=new bt,this._updatingStrategy=!0,this._tileToEvent=new jt,this._fetchStatus={outstanding:0,done:0}}get hasAllFeatures(){return this._hasAllData()&&(this._strategyInfo?.willQueryAllFeatures??!1)}get hasAllFeaturesInView(){return this._hasAllData()}get hasFullGeometries(){return this._hasAllData()&&(this._strategyInfo?.willQueryFullResolutionGeometry??!1)}onEvent(e){switch(e.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(e);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=e.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",e);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),e.done&&(this._fetchStatus={done:0,outstanding:0})}}_hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}_hasAllTileData(){for(const e of this._tileToEvent.values())if(e.peekLast()?.type!=="loaded")return!1;return!0}_handleTileEvent(e){switch(e.type){case"subscribe":{const t=new rt(ci);t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"unsubscribe":this._tileToEvent.delete(e.tile);break;case"loaded":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"error":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t),this.events.emit("error",e);break}}}};h([f({readOnly:!0})],O.prototype,"hasAllFeatures",null),h([f({readOnly:!0})],O.prototype,"hasAllFeaturesInView",null),h([f({readOnly:!0})],O.prototype,"hasFullGeometries",null),h([f()],O.prototype,"_updatingStrategy",void 0),h([f()],O.prototype,"_strategyInfo",void 0),h([f()],O.prototype,"_tileToEvent",void 0),O=h([Q("esri.views.2d.layers.features.FeatureSourceEventLog")],O);function R(e){switch(e.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":return"esriGeometryPolygon";case"multipatch":return"esriGeometryMultiPatch";case"multipoint":return"esriGeometryMultipoint";default:return null}}function w(e,t){const i=e.featureReduction;return i&&i.type!=="selection"&&(!("maxScale"in i)||!i.maxScale||i.maxScale<t.scale)?i:null}const di=Math.PI;function st(e,t){switch(t.transformationType){case q.Additive:return pi(e,t);case q.Constant:return hi(t,e);case q.ClampedLinear:return fi(e,t);case q.Proportional:return yi(e,t);case q.Stops:return mi(e,t);case q.RealWorldSize:return gi(e,t);case q.Identity:return e;case q.Unknown:return null}}function F(e,t){return typeof e=="number"?e:st(t,e)}function pi(e,t){return e+(F(t.minSize,e)||t.minDataValue)}function hi(e,t){const i=e.stops;let r=i?.length&&i[0].size;return r==null&&(r=e.minSize),F(r,t)}function fi(e,t){const i=t.minDataValue,r=t.maxDataValue,s=(e-i)/(r-i),a=F(t.minSize,e),n=F(t.maxSize,e);return e<=i?a:e>=r?n:a+s*(n-a)}function yi(e,t){const i=e/t.minDataValue,r=F(t.minSize,e),s=F(t.maxSize,e);let a=null;return a=i*r,tt(a,r,s)}function mi(e,t){const[i,r,s]=bi(e,t.cache.ipData);if(i===r)return F(t.stops[i].size,e);{const a=F(t.stops[i].size,e);return a+(F(t.stops[r].size,e)-a)*s}}function gi(e,t){const i=Jt[t.valueUnit],r=F(t.minSize,e),s=F(t.maxSize,e),{valueRepresentation:a}=t;let n=null;return n=a==="area"?2*Math.sqrt(e/di)/i:a==="radius"||a==="distance"?2*e/i:e/i,tt(n,r,s)}function bi(e,t){if(!t)return;let i=0,r=t.length-1;return t.some((s,a)=>e<s?(r=a,!0):(i=a,!1)),[i,r,(e-t[i])/(t[r]-t[i])]}function z(e){return(e.labelsVisible&&e.labelingInfo?.every(t=>t.deconflictionStrategy!=="none"))??!1}function N(e,t){const i=w(e,t);if(i?.labelsVisible&&i.labelingInfo?.length)return i.labelingInfo.every(r=>r.deconflictionStrategy!=="none")}function Si(e){return t=>H(st(t,e))}function M(e){const t=e!=null&&"visualVariables"in e&&e.visualVariables;if(!t)return null;for(const i of t)if(i.type==="size")return Si(i);return null}function U(e,t,i,r){const s=e.subtypeCode!=null?`${e.subtypeField} = ${e.subtypeCode}`:null,a=Fe(e.definitionExpression,s),n=e.customParameters??{};return r&&(n.token=r),{type:"feature",mutable:{sourceRefreshVersion:i,availableFields:t.availableFields,dataFilter:{queryScaleRanges:e.queryScaleRanges??[],definitionExpression:a,gdbVersion:e.gdbVersion,historicMoment:e.historicMoment?.getTime(),timeExtent:e.timeExtent?.toJSON(),customParameters:n}}}}function vi(e,t,i=0){if(t==null)return e[i]=0,e[i+1]=0,e[i+2]=0,void(e[i+3]=0);const{r,g:s,b:a,a:n}=t;e[i]=r*n/255,e[i+1]=s*n/255,e[i+2]=a*n/255,e[i+3]=n}async function T(e,t){if(!e)return[];switch(e.type){case"simple-fill":return Ve(e,t);case"picture-fill":return Ci(e,t);case"simple-marker":return Ze(e,t);case"picture-marker":return Vi(e,t);case"simple-line":return J(e,t,!1);case"text":return xi(e,t);case"label":return Ei(e,t);case"cim":return te(e.data,t);case"web-style":{const i=await e.fetchCIMSymbol();return te(i.data,t)}case"line-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-line`),J(new Rt,t,!1);case"point-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-marker`),Ze(new Et,t);case"polygon-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-fill`),Ve(new it,t);case"mesh-3d":case"label-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Ignoring`),[];case"CIMSymbolReference":throw new Error("InternalError: CIMSymbolReference should already be resolved")}}async function _i(e,t){const{schemaOptions:i}=t,{store:r}=i,s=new Array(de),a=new Array(de/4);for(let c=0;c<de;c++){const p=c<e.attributes.length?e.attributes[c].color:null;s[c]=[0,0,0,0],vi(s[c],p)}for(let c=0;c<de/4;c++)a[c]=[0,0,0,0],a[c][0]=4*c<e.attributes.length?1:0,a[c][1]=4*c+1<e.attributes.length?1:0,a[c][2]=4*c+2<e.attributes.length?1:0,a[c][3]=4*c+3<e.attributes.length?1:0;const n={uniforms:{isActive:a,colors:s,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},optionalAttributes:{}},o=r.ensureInstance(S.dotDensity,n).createMeshInfo({effects:null}),l=[],u=new it({color:e.backgroundColor??[0,0,0,0],outline:null}),d=await T(u,t);if(l.push(...d),l.push(o),e.outline){const c=J(e.outline,t,!0);l.push(...c)}return l}async function wi(e,t){const{store:i}=t,{radius:r,minDensity:s,maxDensity:a,referenceScale:n,field:o,valueExpression:l,colorStops:u}=e,d=Ht(u);return[i.ensureInstance(S.heatmap,{uniforms:{radius:H(r),minDensity:s,maxDensity:a,referenceScale:n,isFieldActive:!(!o&&!l),gradient:d,gradientHash:d.join(",")},optionalAttributes:{}}).createMeshInfo({effects:null})]}async function Ii(e,t){const{store:i}=t,r=e.outline?.width||0,s=E(e),a=i.ensureInstance(S.pieChart,{uniforms:{shader:{outlineWidth:Math.round(H(r)),defaultColor:ue(e.defaultColor),outlineColor:ue(e.outline?.color),othersColor:ue(e.othersCategory?.color),donutRatio:e.holePercentage,sectorThreshold:e.othersCategory?.threshold||0,colors:e.attributes.map(n=>ue(n.color)),visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:e.attributes.length},optionalAttributes:{}}).createMeshInfo({size:e.size,outlineWidth:r,effects:null,scaleInfo:null,minPixelBuffer:k(s)});return[...e.backgroundFillSymbol?await Ve(e.backgroundFillSymbol,{schemaOptions:t,path:"",uniforms:ge}):[],a]}function at(e){if(e.style==="path"){if(e.path==null)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:e.path,asFill:!0}}}const t=G.fromSimpleMarker(e);if("outline"in e&&e.outline&&e.outline.style!=="none"&&e.outline.style!=="solid"){if(!t||!t.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:t.symbolLayers[0],overrides:[]}}return{type:"sprite-rasterization-param",resource:Gt(t),overrides:[]}}async function Ze(e,t){const{uniforms:i,schemaOptions:r}=t,{store:s}=r;if(e.style==="path"||e.outline&&e.outline.style!=="solid"&&e.outline.style!=="none"){const p=G.fromSimpleMarker(e);if(!p||!p.symbolLayers)throw new Error("Error handling marker! ");if(i.visualVariableRotation&&(p.angleAlignment="Map"),e.style!=="path"){const y=p.symbolLayers[0];if(ie(t.uniforms)){const m=k(t.uniforms,0,1);if(m>y.size){const I=m/y.size;y.size=m;const V=y.markerGraphics?.[0].symbol;(V.symbolLayers&&V.symbolLayers[0]).width*=I}}}return te({type:"CIMSymbolReference",symbol:p},t)}const a=s.ensureInstance(S.marker,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=at(e);let o=e.color?.toArray()??[0,0,0,0];n.resource.type==="CIMVectorMarker"&&(o=[255,255,255,255]);const l=e.style==="triangle"?124/116:1,u=e.size,d=u*l,c=i.visualVariableColor!=null&&(e.style==="cross"||e.style==="x");return[a.createMeshInfo({type:"simple",color:o,height:u,width:d,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ee(i)?j.MAP:j.SCREEN,outlineColor:e.outline?.color?.toArray()??[0,0,0,0],outlineSize:e.outline?.width??1,referenceSize:u,sprite:n,overrideOutlineColor:c,hasSizeVV:ie(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:k(i)})]}function Vi(e,t){const{uniforms:i,schemaOptions:r}=t,{store:s}=r,a=s.ensureInstance(S.marker,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=G.createPictureMarkerRasterizationParam(e);return n?[a.createMeshInfo({type:"picture",color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ee(i)?j.MAP:j.SCREEN,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:n,overrideOutlineColor:!1,hasSizeVV:ie(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:k(i)})]:[]}function Fi(e,t,i){const{uniforms:r,schemaOptions:s}=i,{store:a}=s,n=a.ensureInstance(S.marker,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,visualVariableRotation:r.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),o=at(e),l=6,u=l*t.width,d=u,c=e.color?.toArray()??t.color?.toArray()??[0,0,0,0],p=e.style==="cross"||e.style==="x";let y;switch(e.placement){case"begin-end":y=ce.Both;break;case"begin":y=ce.JustBegin;break;case"end":y=ce.JustEnd;break;default:y=ce.None}const m={type:"cim-marker-placement-param",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:y,offsetAlongLine:0},overrides:[]};return[n.createMeshInfo({type:"simple",color:c,height:d,width:u,offsetX:0,offsetY:0,angle:0,alignment:Ee(r)?j.MAP:j.SCREEN,outlineColor:c,outlineSize:p?t.width:0,referenceSize:d/l,sprite:o,overrideOutlineColor:p&&r.visualVariableColor!=null,hasSizeVV:ie(r),placement:m,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:k(r)})]}function xi(e,t){const{uniforms:i,schemaOptions:r}=t,{store:s}=r;return[s.ensureInstance(S.text,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}}).createMeshInfo({boxBackgroundColor:e.backgroundColor?.toArray(),boxBorderLineColor:e.borderLineColor?.toArray(),boxBorderLineSize:e.borderLineSize??0,color:e.color?.toArray()??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:e.haloColor?.toArray()??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:[0,0,0,0],outlineSize:0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:e.font.toJSON(),textString:e.text,symbol:G.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:k(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}function Ei(e,t){const{schemaOptions:i,uniforms:r}=t,{store:s}=i,a=e.symbol,{allowOverrun:n,repeatLabel:o,repeatLabelDistance:l}=e,u={maxScale:e.maxScale??0,minScale:e.minScale??0},d=s.ensureInstance(S.label,{uniforms:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:r.visualVariableRotation,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}}),c=e.labelPlacement,[p,y]=Ut(c);return[d.createMeshInfo({boxBackgroundColor:a.backgroundColor?.toArray(),boxBorderLineColor:a.borderLineColor?.toArray(),boxBorderLineSize:a.borderLineSize??0,color:a.color?.toArray()??[0,0,0,0],offsetX:a.xoffset,offsetY:a.yoffset,postAngle:a.angle,fontSize:a.font.size,decoration:a.font.decoration,outlineColor:[0,0,0,0],outlineSize:0,haloColor:a.haloColor?.toArray()??[0,0,0,0],haloSize:a.haloSize??0,lineWidth:a.lineWidth,lineHeightRatio:a.lineHeight,horizontalAlignment:p,verticalAlignment:y,repeatLabel:o,repeatLabelDistance:H(l),allowOverrun:n,labelPosition:e.labelPosition,scaleInfo:u,minPixelBuffer:k(r),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:a.font.toJSON(),textString:a.text,symbol:G.createCIMTextSymbolfromTextSymbol(a),primitiveName:"label-override"},useLegacyLabelEvaluationRules:e.labelExpressionInfo?.expression==null,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.labelExpressionInfo?.expression??e.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1})]}function Ce(e,t){const i=e.width;return{outlineColor:e.color?.toArray()||[0,0,0,1],width:i,referenceWidth:i,capType:e.cap??"round",joinType:e.join??"round",miterLimit:e.miterLimit,hasSizeVV:t}}function Ri(e,t){const{uniforms:i,schemaOptions:r}=t,{store:s}=r,a=e.color?.toArray()??[0,0,0,0],n={type:"sprite-rasterization-param",resource:{type:"fill-style",style:e.style},overrides:[]};if(e.outline?.style==="solid")return[s.ensureInstance(S.patternOutlineFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...Ce(e.outline,!!i.visualVariableSizeOutlineScaleStops),sprite:n,scaleInfo:null,effects:null})];const o=[],l=s.ensureInstance(S.patternFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:e.color?.toArray()??[0,0,0,0],sprite:n,scaleInfo:null,effects:null});return o.push(l),e.outline&&o.push(...J(e.outline,t,!0)),o}function Oi(e,t){const{uniforms:i,schemaOptions:r}=t,{store:s}=r,a=e.color?.toArray()??[0,0,0,0];if(e.style!=="none"&&e.outline?.style==="solid")return[s.ensureInstance(S.outlineFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...Ce(e.outline,!!i.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null})];const n=[];if(e.style!=="none"){const o=s.ensureInstance(S.fill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,scaleInfo:null,effects:null});n.push(o)}return e.outline&&n.push(...J(e.outline,t,!0)),n}async function Ve(e,t){if(e.type==="cim")return te(e.data,t);const{style:i}=e;return i&&i!=="none"&&i!=="solid"?Ri(e,t):Oi(e,t)}function Ci(e,t){const{outline:i}=e,{uniforms:r,schemaOptions:s}=t,{store:a}=s,n=[],o=G.createPictureFillRasterizationParam(e);if(!o)return[];const{width:l,height:u,xoffset:d,yoffset:c,xscale:p,yscale:y}=e,m={color:[255,255,255,255],sprite:o,height:u,aspectRatio:l/u,offsetX:d,offsetY:c,scaleX:p,scaleY:y,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if(i?.style==="solid")return[a.ensureInstance(S.complexOutlineFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({...m,...Ce(i,!!r.visualVariableSizeOutlineScaleStops)})];const I=a.ensureInstance(S.complexFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity},optionalAttributes:{zoomRange:!1}});return n.push(I.createMeshInfo(m)),i&&n.push(...J(i,t,!0)),n}function J(e,t,i){const{color:r,style:s,width:a,cap:n,join:o}=e,{schemaOptions:l}=t,{store:u}=l,d=[],c=i?{...ge,visualVariableSizeScaleStops:t.uniforms.visualVariableSizeOutlineScaleStops}:t.uniforms,p={uniforms:{visualVariableColor:c.visualVariableColor,visualVariableOpacity:c.visualVariableOpacity,visualVariableSizeMinMaxValue:c.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:c.visualVariableSizeScaleStops,visualVariableSizeStops:c.visualVariableSizeStops,visualVariableSizeUnitValue:c.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1}},y={color:r?.toArray()??[0,0,0,0],width:a,referenceWidth:a,capType:n,joinType:o,miterLimit:e.miterLimit,hasSizeVV:ie(c),effects:null,scaleInfo:null};if(s==null||s==="solid"){const m=u.ensureInstance(S.line,p).createMeshInfo(y);d.push(m)}else if(s!=="none"){const m=u.ensureInstance(S.texturedLine,p).createMeshInfo({...y,offsetAlongLine:0,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:Bt(s,n)},overrides:[]}});d.push(m)}return e.marker!=null&&d.push(...Fi(e.marker,e,t)),d}async function re(e,t,i){const r=t.labelsVisible&&t.labelingInfo||[],s=R(t),a=Qt(r,s);return{type:"label",classes:await Promise.all(a.map((n,o)=>Ti(e,n,o,i)))}}async function Ti(e,t,i,r){const s=await T(t,{path:`${i}`,schemaOptions:e,uniforms:r});return{maxScale:t.maxScale,minScale:t.minScale,expression:t.labelExpressionInfo?.expression??t.labelExpression,where:t.where,meshes:s}}async function se(e,t){if(!t)return{type:"simple",meshes:[]};switch(t.type){case"simple":return zi(e,t);case"dot-density":return qi(e,t);case"class-breaks":return Ai(e,t);case"unique-value":return Mi(e,t);case"dictionary":return Pi(t);case"heatmap":return ki(e,t);case"pie-chart":return Ni(e,t)}}async function zi(e,t){const i=t.getSymbols(),r=i.length?i[0]:null,s=E(t);return{type:"simple",meshes:await T(r,{schemaOptions:e,uniforms:s,path:"renderer.symbol"})}}async function qi(e,t){const i=E(t);return{type:"dot-density",meshes:await _i(t,{schemaOptions:e,uniforms:i,path:"renderer.symbol"})}}async function Ai(e,t){const i=E(t),r=t.backgroundFillSymbol,s=t.normalizationType,a=s==="log"?"esriNormalizeByLog":s==="percent-of-total"?"esriNormalizeByPercentOfTotal":s==="field"?"esriNormalizeByField":null,n=t.classBreakInfos.map(async d=>({meshes:await T(d.symbol,{path:`renderer-stop-${d.minValue}-${d.maxValue}`,schemaOptions:e,uniforms:i}),min:d.minValue,max:d.maxValue})),o=(await Promise.all(n)).sort((d,c)=>d.min-c.min),l=await T(r,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{...ge,visualVariableSizeOutlineScaleStops:i.visualVariableSizeOutlineScaleStops}}),u=await T(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:i});return{type:"interval",field:t.field,expression:t.valueExpression,backgroundFill:l,defaultSymbol:u,intervals:o,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,normalizationType:a,isMaxInclusive:t.isMaxInclusive}}async function Mi(e,t){const i=[],r=E(t),s=await T(t.backgroundFillSymbol,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{...ge,visualVariableSizeOutlineScaleStops:r.visualVariableSizeOutlineScaleStops}}),a=await T(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:r});for(const n of t.uniqueValueInfos??[]){const o=await T(n.symbol,{path:`renderer-unique-value-${n.value}`,schemaOptions:e,uniforms:r});i.push({value:""+n.value,symbol:o})}return{type:"map",field:t.field,expression:t.valueExpression,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,backgroundFill:s,defaultSymbol:a,map:i}}function Pi(e){const t=E(e),i=e.scaleExpression,r=i!=null&&i!=="1"?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0;return{type:"dictionary",fieldMap:e.fieldMap,scaleExpression:r,visualVariableUniforms:t}}async function ki(e,t){return{type:"heatmap",meshes:await wi(t,e)}}async function Ni(e,t){return{type:"pie-chart",meshes:await Ii(t,e)}}async function Ui(e,t){const i=t.renderer,r=E(i);return{symbology:await se(e,i),labels:await re(e,t,r)}}async function P(e,t,i,r){const s=i.featureReduction;if(s)switch(s.type){case"binning":return Li(s,e,t,i,r);case"cluster":return Di(s,e,t,i,r)}const a=ji(i.orderBy,i.renderer,i.objectIdField),n=xe(i.renderer,t.filters),o=await Ui(e,i),l=Te(o.symbology);return{storage:n,mesh:{properties:{sortKey:a,timeZone:t.timeZone,returnMeshObjectId:l,displayRefreshVersion:r},strategy:{type:"feature"},factory:o}}}function nt(e,t){return e.fields.map(i=>({...i.toJSON(),type:Bi(i,t)}))}function Bi(e,t){const{onStatisticExpression:i,onStatisticField:r,statisticType:s}=e;switch(s){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(i){const{returnType:n}=i;return n?n==="string"?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const a=t.find(n=>n.name===r);return a?a.type:"esriFieldTypeString"}}}async function Li(e,t,i,r,s){const a=nt(e,r.fields),n=e.renderer,o=await se(t,n),l=xe(n,[null,null]),u=E(n),d=await re(t,{geometryType:"polygon",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},u),c=Te(o),p=e.binType==="geohash"?{type:"geohash",fixBinLevel:e.fixedBinLevel??3}:{type:"grid",size:H(e.size),fixedBinLevel:e.fixedBinLevel};return{storage:l,mesh:{properties:{sortKey:null,timeZone:i.timeZone,returnMeshObjectId:c,displayRefreshVersion:s},strategy:{type:"binning",fields:a,index:p,featureFilter:i.filters[0]},factory:{labels:d,symbology:o}}}}async function Di(e,t,i,r,s){const a=nt(e,r.fields),n={type:"cluster",feature:await se(t,e.effectiveFeatureRenderer),cluster:await se(t,e.effectiveClusterRenderer)},o=E(e.effectiveFeatureRenderer),l={type:"cluster",feature:await re(t,r,o),cluster:await re(t,{geometryType:"point",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},o)},u=xe(e.effectiveFeatureRenderer,[null,null]),d=Te(n);return{storage:u,mesh:{properties:{sortKey:null,timeZone:i.timeZone,displayRefreshVersion:s,returnMeshObjectId:d},strategy:{type:"cluster",fields:a,featureFilter:i.filters[0],clusterRadius:H(e.clusterRadius/2)},factory:{labels:l,symbology:n}}}}function ji(e,t,i){const r=t!=null&&t.type==="unique-value"&&t.orderByClassesEnabled;if(e!=="default"||r||(e=[new $t({field:i,order:"descending"})]),e!=="default"&&e?.length){e.length;const s=e[0],a=s.order==="ascending"?"asc":"desc";return s.field?{field:s.field,order:a}:s.valueExpression?{expression:s.valueExpression,order:a}:null}return r?{byRenderer:!0,order:"asc"}:null}function Z(e){return e.techniqueType===Re.AnimatedMarker}function Te(e){return!!(e.type==="simple"&&e.meshes.some(Z)||e.type==="interval"&&(e.intervals.some(t=>t.meshes.some(Z))||e.backgroundFill.some(Z))||e.type==="map"&&(e.map.some(t=>t.symbol.some(Z))||e.backgroundFill.some(Z)))}let Ji=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=z(t);return[{vvEvaluators:{0:M(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,editingInfo:r,objectIdField:s,globalIdField:a,datesInUnknownTimezone:n,orderBy:o,parsedUrl:l}=t,u=t.fieldsIndex.toJSON(),d=R(t),c=t.timeInfo?.toJSON(),p=t.spatialReference.toJSON(),y=ae(l);let m=s;if(o?.length){const I=!o[0].valueExpression&&o[0].field;I&&(m=I)}return{type:"feature-service",source:y,isSourceHosted:be(y.path),orderByFields:m,outSpatialReference:e.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:n,globalIdField:a,fieldsIndex:u,geometryType:d,objectIdField:s,timeInfo:c,spatialReference:p,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:r?.lastEditDate?.getTime(),snapshotInfo:null}}}createSourceSchema(e,t){const{definitionExpression:i,customParameters:r,timeExtent:s,apiKey:a}=this.layer;return U({definitionExpression:i,customParameters:r,timeExtent:s},e,t,a)}createProcessorSchema(e,t,i){const{fields:r,geometryType:s,orderBy:a,objectIdField:n,renderer:o,labelingInfo:l,labelsVisible:u}=this.layer,d={featureReduction:null,fields:r.map(c=>c.toJSON()),geometryType:s,labelingInfo:l,labelsVisible:u,objectIdField:n,orderBy:a??"default",renderer:o?.clone()};return P(e,t,d,i)}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:i,apiKey:r,renderer:s}=t,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters),o=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,apiKey:r,customParameters:n,definitionExpression:i,labelingInfo:a,orderBy:o,renderer:s}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer}}};function ze(e,t){const i=e.extent,r=t?.clone().intersection(i),s=r!=null?r.width*r.height:0,a=t?t.width*t.height:0,n=a===0?0:s/a,o=g("featurelayer-snapshot-point-coverage");return!isNaN(n)&&n>=o}function $(e,t){return e.floorInfo!=null&&(e.floorInfo.viewAllLevelIds.length>0||t.floors.length>0)}function qe(e,t,i){const r=$i(e,t?.where,i);return r&&(t??=new ee,t.where=r),t}function $i(e,t,i){if(e.floorInfo==null||!i.floors?.length)return t;let r=i.floors;const{floorField:s,viewAllLevelIds:a}=e.floorInfo;a.length&&(r=a);const n=r.filter(l=>l!=="").map(l=>"'"+l+"'");if(n.push("''"),t?.includes(s)){let l=new RegExp("AND \\("+s+".*NULL\\)","g");t=t.replace(l,""),l=new RegExp("\\("+s+".*NULL\\)","g"),t=(t=t.replace(l,"")).replaceAll(/\s+/g," ").trim()}let o="("+s+" IN ({ids}) OR "+s+" IS NULL)";return o=o.replace("{ids}",n.join(", ")),Fe(t,o)}let Qi=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:M(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,editingInfo:r,objectIdField:s,typeIdField:a,globalIdField:n,datesInUnknownTimezone:o,orderBy:l,subtypeField:u,refreshInterval:d}=t,c=t.fieldsIndex.toJSON(),p=R(t),y=t.timeInfo?.toJSON(),m=t.spatialReference.toJSON(),I=t.types?.map(B=>B.toJSON()),V=ae(this.layer.parsedUrl);this.layer.dynamicDataSource&&(V.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let W=this.layer.objectIdField;if(l?.length){const B=!l[0].valueExpression&&l[0].field;B&&(W=B)}const Se=r?.lastEditDate==null&&d>0,ne=!!g("featurelayer-snapshot-enabled")&&t.geometryType==="point"&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!Se,lt=ne&&ze(e,t.fullExtent);return{type:"feature-service",source:V,isSourceHosted:be(V.path),orderByFields:W,outSpatialReference:e.spatialReference.toJSON(),metadata:{typeIdField:a??void 0,types:I,timeReferenceUnknownClient:o,subtypeField:u,globalIdField:n,fieldsIndex:c,geometryType:p,objectIdField:s,timeInfo:y,spatialReference:m,subtypes:this.layer.subtypes?.map(B=>B.toJSON())},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:r?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:ne,supportsSnapshotMaxThreshold:lt,snapshotCountThresholds:{min:g("featurelayer-snapshot-point-min-threshold"),max:g("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:i,customParameters:r,gdbVersion:s,historicMoment:a,subtypeCode:n,subtypeField:o,timeExtent:l,apiKey:u}=this.layer;return U({definitionExpression:i,customParameters:r,gdbVersion:s,historicMoment:a,subtypeCode:n,subtypeField:o,timeExtent:l},e,t,u)}createProcessorSchema(e,t,i){const{fields:r,renderer:s,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,d={fields:r.map(c=>c.toJSON()),renderer:s?.clone(),featureReduction:w(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return P(e,t,d,i)}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return $(this.layer,e)}addFilters(e,t){return qe(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:i,renderer:r,gdbVersion:s,apiKey:a,subtypeCode:n}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null,l=t.historicMoment?.getTime()??void 0,u=JSON.stringify(t.customParameters),d=w(t,e),c=JSON.stringify(t.orderBy),p=$(this.layer,e)?e.floors:null;return{outFields:this.layer.outFields,apiKey:a,customParameters:u,definitionExpression:i,featureReduction:d,floors:p,gdbVersion:s,historicMoment:l,labelingInfo:o,orderBy:c,renderer:r,subtypeCode:n}}};function Hi(e){if(!("openPorts"in e))throw new C("source-not-supported")}class Ye{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){const i=this.layer,r=N(i,t)??z(i);return[{vvEvaluators:{0:M(i.renderer)},deconflictionEnabled:r}]}async createServiceOptions(t){const i=this.layer,{capabilities:r,objectIdField:s}=i,a=i.fieldsIndex.toJSON(),n=R(i),o=i.timeInfo?.toJSON(),l=i.spatialReference.toJSON();return Hi(i.source),{type:"memory",source:await i.source.openPorts(),orderByFields:s,outSpatialReference:t.spatialReference.toJSON(),metadata:{fieldsIndex:a,geometryType:n,objectIdField:s,timeInfo:o,spatialReference:l,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(t,i){const{definitionExpression:r,timeExtent:s}=this.layer;return U({definitionExpression:r,timeExtent:s,customParameters:null},t,i,null)}createProcessorSchema(t,i,r){const{fields:s,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:l,orderBy:u,objectIdField:d}=this.layer,c={fields:s.map(p=>p.toJSON()),renderer:a?.clone(),featureReduction:w(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:d,orderBy:u??"default"};return P(t,i,c,r)}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:r,renderer:s}=i,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=w(i,t),o=JSON.stringify(i.orderBy);return{outFields:this.layer.outFields,orderBy:o,definitionExpression:r,renderer:s,labelingInfo:a,featureReduction:n}}}class Gi{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){const i=this.layer,r=N(i,t)??z(i);return[{vvEvaluators:{0:M(i.renderer)},deconflictionEnabled:r}]}async createServiceOptions(t){const i=this.layer,{capabilities:r,objectIdField:s}=i,a=i.fieldsIndex.toJSON(),n=R(i),o=i.spatialReference.toJSON();return{type:"memory",source:await i.source.openPorts(),orderByFields:s,outSpatialReference:t.spatialReference.toJSON(),metadata:{fieldsIndex:a,geometryType:n,objectIdField:s,spatialReference:o,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:i.timeInfo?.toJSON(),timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(t,i){const{definitionExpression:r}=this.layer;return U({definitionExpression:r,customParameters:null},t,i,null)}createProcessorSchema(t,i,r){const{fields:s,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u}=this.layer,d={fields:s.map(c=>c.toJSON()),renderer:a?.clone(),featureReduction:w(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u,orderBy:"default"};return P(t,i,d,r)}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:r,renderer:s}=i;return{definitionExpression:r,renderer:s,labelingInfo:this.layer.labelsVisible?this.layer.labelingInfo:null,featureReduction:w(i,t)}}}let Wi=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:M(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,objectIdField:r}=t,s=t.fieldsIndex.toJSON(),a=R(t),n=t.timeInfo?.toJSON(),o=t.spatialReference.toJSON(),l=t.source.getSource(),u=this.layer.objectIdField,d=ae(i);return d.query.maxRecordCount=l.maxRecordCount,{type:"ogc",source:l,orderByFields:u,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:s,geometryType:a,objectIdField:r,timeInfo:n,spatialReference:o,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:d.query.maxRecordCount,supportsCompactGeometry:d.query.supportsCompactGeometry,supportsDefaultSpatialReference:d.query.supportsDefaultSpatialReference,supportsFormatPBF:d.query.supportsFormatPBF,supportsMaxRecordCountFactor:d.query.supportsMaxRecordCountFactor,supportsQuantization:d.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t){const{customParameters:i,timeExtent:r,apiKey:s}=this.layer;return U({customParameters:i,timeExtent:r},e,t,s)}createProcessorSchema(e,t,i){const{fields:r,renderer:s,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,d={fields:r.map(c=>c.toJSON()),renderer:s?.clone(),featureReduction:w(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return P(e,t,d,i)}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{renderer:i,apiKey:r}=t,s=this.layer.labelsVisible?this.layer.labelingInfo:null;return{apiKey:r,customParameters:JSON.stringify(t.customParameters),featureReduction:w(t,e),labelingInfo:s,orderBy:JSON.stringify(t.orderBy),renderer:i}}},Ki=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:M(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,objectIdField:r,globalIdField:s,orderBy:a,refreshInterval:n}=t,o=t.fieldsIndex.toJSON(),l=R(t),u=t.timeInfo?.toJSON(),d=t.spatialReference.toJSON(),c=ae(this.layer.parsedUrl);let p=this.layer.objectIdField;if(a?.length){const V=!a[0].valueExpression&&a[0].field;V&&(p=V)}const y=n>0,m=!!g("featurelayer-snapshot-enabled")&&t.geometryType==="point"&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!y,I=m&&ze(e,t.fullExtent);return{type:"feature-service",source:c,isSourceHosted:be(c.path),orderByFields:p,outSpatialReference:e.spatialReference.toJSON(),metadata:{globalIdField:s,fieldsIndex:o,geometryType:l,objectIdField:r,timeInfo:u,spatialReference:d,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:m,supportsSnapshotMaxThreshold:I,snapshotCountThresholds:{min:g("featurelayer-snapshot-point-min-threshold"),max:g("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:i,customParameters:r,timeExtent:s}=this.layer;return U({definitionExpression:i,customParameters:r,timeExtent:s},e,t,null)}createProcessorSchema(e,t,i){const{fields:r,renderer:s,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,d={fields:r.map(c=>c.toJSON()),renderer:s?.clone(),featureReduction:w(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return P(e,t,d,i)}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return $(this.layer,e)}addFilters(e,t){return qe(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:i,renderer:r,outFields:s}=t,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters),o=w(t,e);return{outFields:s,orderBy:JSON.stringify(t.orderBy),definitionExpression:i,renderer:r,labelingInfo:a,featureReduction:o,customParameters:n,floors:$(this.layer,e)?e.floors:null}}},Zi=class{constructor(e){this.layer=e}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return null}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:M(t.renderer)},deconflictionEnabled:i}]}getUpdateHashProperties(e){const t=this.layer,{renderer:i}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null,s=JSON.stringify(t.customParameters),a=w(t,e),n=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,labelingInfo:r,featureReduction:a,customParameters:s,orderBy:n,renderer:i}}async createServiceOptions(e){const t=R(this.layer);return{type:"parquet",source:{urls:this.layer.urls.items},outSpatialReference:e.spatialReference.toJSON(),geometryInfo:this.layer.source.geometryInfo,metadata:{spatialReference:this.layer.spatialReference,fieldsIndex:this.layer.fieldsIndex.toJSON(),objectIdField:this.layer.objectIdField,geometryType:t,types:null,subtypes:null,timeInfo:null,typeIdField:null,subtypeField:null,globalIdField:null,timeReferenceUnknownClient:null}}}createSourceSchema(e,t){return{type:"parquet",mutable:{sourceRefreshVersion:t,availableFields:e.availableFields,dataFilter:{customParameters:this.layer.customParameters??null}}}}createProcessorSchema(e,t,i){const r={fields:this.layer.fields.map(s=>s.toJSON()),renderer:this.layer.renderer?.clone(),featureReduction:w(this.layer,t),geometryType:this.layer.geometryType,labelingInfo:this.layer.labelingInfo,labelsVisible:this.layer.labelsVisible,objectIdField:this.layer.objectIdField,orderBy:this.layer.orderBy};return P(e,t,r,i)}};class Yi{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){const i=this.layer,r=N(i,t)??z(i);return[{vvEvaluators:{0:M(i.renderer)},deconflictionEnabled:r}]}async createServiceOptions(t){const i=this.layer,{objectIdField:r}=i,s=R(i),a=i.timeInfo?.toJSON()||null,n=i.spatialReference?i.spatialReference.toJSON():null;return{type:"stream",source:this.layer.parsedUrl,outSpatialReference:t.spatialReference.toJSON(),metadata:{fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:s,objectIdField:r,timeInfo:a,timeReferenceUnknownClient:null,spatialReference:n,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}}createSourceSchema(t,i){const{definitionExpression:r,geometryDefinition:s,customParameters:a}=this.layer;return{type:"stream",mutable:{sourceRefreshVersion:i,availableFields:t.availableFields,dataFilter:{geometryDefinition:s?.toJSON(),definitionExpression:r,customParameters:a??null,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(t,i,r){const{fields:s,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u}=this.layer,d={fields:s.map(c=>c.toJSON()),renderer:a?.clone(),featureReduction:w(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u,orderBy:"default"};return P(t,i,d,r)}get hasRequiredSupport(){return A(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:r,renderer:s}=i,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(i.customParameters);return{definitionExpression:r,renderer:s,labelingInfo:a,featureReduction:w(i,t),customParameters:n,geometryDefinition:i.geometryDefinition,definitionExpressoin:i.definitionExpression}}}async function Xi(e,{subtypeField:t,sublayers:i}){const r=await Promise.all(i.map(({renderer:s})=>se(e,s)));return{type:"subtype",subtypeField:t,renderers:i.reduce((s,{subtypeCode:a},n)=>({...s,[a]:r[n]}),{})}}function er(e,t){const i=Wt();return{type:"subtype",filters:e.filters,capabilities:{maxTextureSize:i.maxTextureSize},subtypeField:t.subtypeField,target:"feature",bindings:t.sublayers.reduce((r,{renderer:s,subtypeCode:a})=>{const n=Nt(s);return{...r,[a]:n}},{})}}async function tr(e,{subtypeField:t,sublayers:i}){const r=await Promise.all(i.map(s=>{const a=E(s.renderer),n={...s,geometryType:s.geometryType??null};return re(e,n,a)}));return{type:"subtype",subtypeField:t,renderers:i.reduce((s,{subtypeCode:a},n)=>({...s,[a]:r[n]}),{})}}async function ir(e,t,i,r){return{storage:er(t,i),mesh:{properties:{timeZone:t.timeZone,displayRefreshVersion:r,returnMeshObjectId:!1,sortKey:null},strategy:{type:"feature"},factory:{symbology:await Xi(e,i),labels:await tr(e,i)}}}}class rr{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every(i=>z(i))}]}async createServiceOptions(t){const i=this.layer,{capabilities:r,datesInUnknownTimezone:s,editingInfo:a,globalIdField:n,objectIdField:o,refreshInterval:l,subtypeField:u}=i,d=i.fieldsIndex.toJSON(),c=R(i),p=i.timeInfo?.toJSON(),y=i.spatialReference.toJSON(),m=ae(this.layer.parsedUrl),I=o,V=a?.lastEditDate==null&&l>0,W=!!g("featurelayer-snapshot-enabled")&&i.geometryType==="point"&&r?.query.supportsPagination&&!r?.operations.supportsEditing&&!V,Se=W&&ze(t,i.fullExtent);return{type:"feature-service",source:m,isSourceHosted:be(m.path),orderByFields:I,outSpatialReference:t.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:s,subtypeField:u,globalIdField:n,fieldsIndex:d,geometryType:c,objectIdField:o,timeInfo:p,spatialReference:y,subtypes:this.layer.subtypes?.map(ne=>ne.toJSON()),typeIdField:null,types:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,lastEditDate:a?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:W,supportsSnapshotMaxThreshold:Se,snapshotCountThresholds:{min:g("featurelayer-snapshot-point-min-threshold"),max:g("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(t,i){const{definitionExpression:r,customParameters:s,gdbVersion:a,historicMoment:n,subtypeField:o,timeExtent:l,apiKey:u}=this.layer,d={queryScaleRanges:this.layer.sublayers.items.map(c=>({subtypeCode:c.subtypeCode,minScale:c.minScale,maxScale:c.maxScale})),definitionExpression:r,customParameters:s,gdbVersion:a,historicMoment:n,subtypeField:o,timeExtent:l};return U(d,t,i,u)}createProcessorSchema(t,i,r){const s={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,a=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:a.labelingInfo,labelsVisible:a.labelsVisible,renderer:a.renderer,subtypeCode:a.subtypeCode,orderBy:null}))};return ir(t,i,s,r)}hasFilters(t){return $(this.layer,t)||sr(this.layer,t)}addFilters(t,i){t=qe(this.layer,t,i);const r=this.layer.sublayers.filter(a=>!ot(a,i)).map(a=>a.subtypeCode);if(!r.length)return t;t??=new ee;const s=`NOT ${this.layer.subtypeField} IN (${r.join(",")})`;return t.where=Fe(t.where,s),t}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:r,gdbVersion:s,apiKey:a}=i,n=i.historicMoment?.getTime()??void 0,o=JSON.stringify(i.customParameters),l=$(this.layer,t)?t.floors:null,u=this.layer.sublayers.map(({renderer:d,labelsVisible:c,labelingInfo:p,visible:y})=>({renderer:d,labelsVisible:c,labelingInfo:p,visible:y}));return{outFields:this.layer.outFields,gdbVersion:s,definitionExpression:r,historicMoment:n,customParameters:o,apiKey:a,sublayers:u,floors:l}}setGraphicOrigin(t){const i=this.layer.fieldsIndex.get(this.layer.subtypeField),r=t.attributes[i.name],s=this.layer.sublayers.find(a=>a.subtypeCode===r);t.layer=t.sourceLayer=s}}function sr(e,t){return e.sublayers.some(i=>!ot(i,t))}function ot(e,t){return e.visible&&(e.minScale===0||Ue(t.scale,e.minScale)||t.scale<e.minScale)&&(e.maxScale===0||Ue(t.scale,e.maxScale)||t.scale>e.maxScale)}async function b(e,t){try{return await e}catch(i){if(i.name!=="no-queryEngine")throw i;return t}}function D(e,t){const i=new Set;for(const r of e instanceof Set?e.values():e.keys())t.has(r)||i.add(r);return i}class ar{constructor(t,i,r){const s=r?t.getTileCoverage(r,0,!0,"closest"):null,a=t.getTileCoverage(i,0,!0,"closest");if(this._tileKeys=new Map,s)for(const n of s.keys())this._tileKeys.set(n.id,n);if(a)for(const n of a.keys())this._tileKeys.set(n.id,n)}get coverageSet(){return new Set(this._tileKeys.keys())}keys(){return this._tileKeys.values()}}class nr{constructor(t){this.version=t}}class or{constructor(t){this._subscriptions=new Map,this._visible=new Set,this._paused=new Set,this._version=0,this._config=t}destroy(){}get _coverageSet(){return this._coverage?.coverageSet??new Set}suspend(){this._suspendedOverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){this._coverage==null&&(this._coverage=this._suspendedOverage,this._suspendedOverage=null,this._updateSubscriptions())}update(t,i){return this._version=(this._version+1)%Number.MAX_SAFE_INTEGER,this._updateCoverage(t,i),this._updateSubscriptions(),new Set(this._visible)}_updateCoverage(t,i){this._coverage=new ar(this._config.tileInfoView,t,i)}_updateSubscriptions(){const t=this._coverageSet,i=this._updateVisibility(),r=D(i,t),s=D(this._subscriptions,i),a=D(t,this._subscriptions),n=D(s,t),o=D(r,n),l=D(o,this._paused);this._visible=i;for(const u of a.values())this._subscriptions.set(u,new nr(this._version));for(const u of l.values())this._paused.add(u);for(const u of n.values())this._subscriptions.delete(u),this._paused.delete(u);(a.size||n.size||l.size)&&this._sendUpdateSubscriptions(a,n,l)}_sendUpdateSubscriptions(t,i,r){const s=Array.from(t.values()).map(a=>({tileId:a,version:this._subscriptions.get(a).version}));this._config.updateSubscriptions({subscribe:s,unsubscribe:Array.from(i.values()),pause:Array.from(r.values())})}_updateVisibility(){const t=new Set,i=new Set;if(!this._coverage)return t;for(const a of this._coverage.keys()){if(this._config.isDone(a)){t.add(a.id);continue}this._addVisibleParent(t,i,a)||this._addVisibleChildren(t,a)||t.add(a.id)}const r=new Y(0,0,0,0),s=new Y(0,0,0,0);for(const a of i){r.id=a;for(const n of t)s.id=n,r.containsChild(s)&&t.delete(n)}return t}_addVisibleParent(t,i,r){let s=!1;for(const a of this._visible.values())new Y(a).containsChild(r)&&(t.add(a),i.add(a),s=!0);return s}_addVisibleChildren(t,i){let r=!1;for(const s of this._visible.values()){const a=new Y(s);i.containsChild(a)&&(t.add(s),r=!0)}return r}}const lr=e=>{let t=class extends e{constructor(...i){super(...i),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([pe(()=>{const i=this.layer;return[i&&"elevationInfo"in i?i.elevationInfo?.featureExpressionInfo:null,i&&"displayField"in i?i.displayField:null,i&&"timeInfo"in i&&i.timeInfo,i&&"renderer"in i&&i.renderer,i&&"labelingInfo"in i&&i.labelingInfo,i&&"floorInfo"in i&&i.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),_t),Be(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),Be(()=>{const i=this.layer;return i&&"sublayers"in i?i.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];const{layer:i,layer:{fieldsIndex:r},requiredFields:s}=this;return"outFields"in i&&i.outFields?Le(r,[...De(r,i.outFields),...s]):Le(r,s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(i){this._override("featureEffect",i)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(i){x.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(i){throw new Error("missing implementation")}createQuery(){const i={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},r=this.filter!=null?this.filter.createQuery(i):new me(i);if("floorInfo"in this.layer&&this.layer.floorInfo){const s=Ke(this);s!=null&&(r.where=r.where?`(${r.where}) AND (${s})`:s)}return this.timeExtent!=null&&(r.timeExtent=r.timeExtent!=null?r.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),r}createAggregateQuery(){const i={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new me(i)}queryFeatures(i,r){throw new Error("missing implementation")}queryObjectIds(i,r){throw new Error("missing implementation")}queryFeatureCount(i,r){throw new Error("missing implementation")}queryExtent(i,r){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(i,r){return this._validateFetchPopupFeatures(i,r),this._fetchPopupFeatures(i,r)}_loadArcadeModules(i){return i.expressionInfos?.length||Array.isArray(i.content)&&i.content.some(r=>r.type==="expression")?wt():Promise.resolve()}_handleRequiredFieldsChange(){const i=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",i),i.then(()=>{this._updatingRequiredFieldsPromise===i&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const i=this.view.type==="3d",{layer:r,layer:{fieldsIndex:s,objectIdField:a}}=this,n="renderer"in r&&r.renderer,o="orderBy"in r&&r.orderBy,l="featureReduction"in r?r.featureReduction:null,u=new Set,d=await Promise.allSettled([n?n.collectRequiredFields(u,s):null,je(u,r),i&&"elevationInfo"in r?It(u,r):null,this.filter!=null?Je(u,r,this.filter):null,i||this.featureEffect==null?null:Je(u,r,this.featureEffect.filter),!i&&l?Vt(u,r,l):null,!i&&o?Ft(u,r,o):null]);if("timeInfo"in r&&r.timeInfo&&this.timeExtent&&oe(u,r.fieldsIndex,[r.timeInfo.startField,r.timeInfo.endField]),"floorInfo"in r&&r.floorInfo&&oe(u,r.fieldsIndex,[r.floorInfo.floorField]),r.type==="feature"&&i&&r.infoFor3D!=null&&(r.globalIdField==null&&x.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),oe(u,r.fieldsIndex,[r.globalIdField])),r.type==="subtype-group"){ve(u,s,r.subtypeField);const p=r.sublayers.map(y=>Promise.all([y.renderer?.collectRequiredFields(u,s),je(u,y)]));await Promise.allSettled(p)}if(r.type==="catalog-footprint"&&r.parent){const p=r.parent;oe(u,s,[p.itemNameField,p.itemSourceField,p.itemTypeField,p.maxScaleField,p.minScaleField])}for(const p of d)p.status==="rejected"&&x.getLogger(this).error(p.reason);ve(u,s,a),i&&"displayField"in r&&r.displayField&&ve(u,s,r.displayField);const c=Array.from(u).sort();this._set("requiredFields",c)}_validateFetchPopupFeatures(i,r){if(r!=null)for(const s of i){const a=s.origin&&"layer"in s.origin?s.origin.layer:s.layer;if("popupEnabled"in a&&!a.popupEnabled)throw new C("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if(s.isAggregate){const n="featureReduction"in a?a.featureReduction:null;if(!(n&&"popupTemplate"in n&&n.popupEnabled&&n.popupTemplate))throw new C("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a})}else if("popupTemplate"in a&&!_e(a,r))throw new C("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})}}_popupFeatureHasRequiredFields(i,r){return xt(r,i)}async _fetchPopupFeatures(i,r){const s=new Array(i.length),a=new Map,n=await this._createPopupQuery(i.map(o=>o.origin?.layer??o.layer),r);for(let o=0;o<i.length;o++){const l=i[o];if(l.isAggregate){s[o]=l;continue}const u=l.origin?.layer??l.layer;if(!u||!("popupEnabled"in u))continue;const d=De(this.layer.fieldsIndex,n.outFields),c=_e(u,r);if(c==null)continue;const p=await this._loadArcadeModules(c);he(r),p&&p.arcadeUtils.hasGeometryOperations(c)||!this._popupFeatureHasRequiredFields(l,d)?a.set(l.getObjectId(),{graphic:l,index:o}):s[o]=l}if(this.layer.type==="stream"||this.layer.type==="parquet"||a.size===0)return s.filter(Boolean);n.objectIds=Array.from(a.keys());try{const o=await this.layer.queryFeatures(n,r);for(const l of o.features){const{graphic:{geometry:u,origin:d},index:c}=a.get(l.getObjectId());l.geometry||=u,l.origin=d,s[c]=l}}catch{}return s.filter(Boolean)}async _createPopupQuery(i,r){const s=this.layer.createQuery(),a=new Set;let n=!1;const o=i??[this.layer];for(const l of o){if(!("popupEnabled"in l))continue;const u=_e(l,r);if(u==null)continue;const d=await this._loadArcadeModules(u);he(r);const c=d&&d.arcadeUtils.hasGeometryOperations(u);n=!(this.layer.geometryType!=="point"&&!c);const p=await Yt(this.layer,u);he(r);for(const y of p)a.add(y)}if(s.returnGeometry=n,s.returnZ=n,s.returnM=n,s.outFields=Array.from(a),s.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const l=Ke(this);l!=null&&(s.where=s.where?`(${s.where}) AND (${l})`:l)}return s}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return h([f()],t.prototype,"_updatingRequiredFieldsPromise",void 0),h([f({readOnly:!0})],t.prototype,"availableFields",null),h([f({readOnly:!0})],t.prototype,"dataUpdating",void 0),h([f({type:Zt})],t.prototype,"featureEffect",null),h([f({type:ee})],t.prototype,"filter",void 0),h([f()],t.prototype,"layer",void 0),h([f({type:Number})],t.prototype,"maximumNumberOfFeatures",null),h([f({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),h([f({readOnly:!0})],t.prototype,"requiredFields",void 0),h([f()],t.prototype,"suspended",void 0),h([f()],t.prototype,"view",void 0),t=h([Q("esri.views.layers.FeatureLayerView")],t),t};function ur(e,t){const i=new Set;return e&&e.forEach(r=>i.add(r)),t&&t.forEach(r=>i.add(r)),i.has("*")?["*"]:Array.from(i)}const Xe=4294967294;let _=class extends lr(Xt(Tt(zt))){constructor(){super(...arguments),this._commandsQueue=new kt({process:e=>{switch(e.type){case"edit-by-feature":case"edit-by-id":return this._doEdit(e);case"update":return this._doUpdate();case"highlight":return this._updateHighlights()}}}),this._visibilityOverrides=new Set,this._highlightCounter=new Kt,this._lastAvailableFields=[],this._lastTargetState=null,this.eventLog=new O,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._fields=null,this.featureEffectView=new ei}destroy(){this._workerProxy?.destroy(),this._workerAttached.reject(Ae()),this._commandsQueue.destroy()}initialize(){this._workerAttached=ye(),K(this._workerAttached.promise),this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransition()}async _initProxy(){const e=this.layer;if("isTable"in e&&e.isTable)throw new C("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if(e.geometryType==="mesh")throw new C("featurelayerview:geometry-type-not-supported",`Geometry type of ${e.geometryType} is not supported`,{layer:e});if((e.type==="feature"||e.type==="subtype-group")&&ct(e)?.operations.supportsQuery===!1)throw new C("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});this._workerProxy&&this._workerProxy.destroy();const t=this._createClientOptions();this._workerProxy=await li(t)}async _attachProxy(){const e={service:await this.layerAdapter.createServiceOptions(this.view),tileInfoJSON:this.view?.featuresTilingScheme?.tileInfo?.toJSON()};let t=[];Array.isArray(e.service.source)&&(t=e.service.source);try{await this._workerProxy.pipeline.onAttach(e,{transferList:t}),this._workerAttached.resolve()}catch(i){this._workerAttached.reject(Ae()),Me(i)}}async _detachProxy(){return this._workerProxy.pipeline.onDetach()}async getWorker(){return await this._workerAttached.promise,this._workerProxy}get hasAllFeatures(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllFeatures}get hasAllFeaturesInView(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllFeaturesInView}get hasFullGeometries(){return this.layer.visible&&!this.suspended&&this.eventLog.hasFullGeometries}get labelingCollisionInfos(){const e=this.layerAdapter.getLabelingDeconflictionInfo(this.view),t=this.layer.geometryType,i=!this.suspended;return e.map(({vvEvaluators:r,deconflictionEnabled:s})=>({container:this.featureContainer,vvEvaluators:r,deconflictionEnabled:s,geometryType:t,visible:i}))}get layerAdapter(){switch(this.layer.type){case"feature":return this.layer.source.type==="memory"?new Ye(this.layer):new Qi(this.layer);case"geojson":case"csv":case"wfs":return new Ye(this.layer);case"parquet":return new Zi(this.layer);case"subtype-group":return new rr(this.layer);case"ogc-feature":return new Wi(this.layer);case"stream":return new Yi(this.layer);case"oriented-imagery":return new Ki(this.layer);case"knowledge-graph-sublayer":return new Gi(this.layer);case"catalog-footprint":return new Ji(this.layer);default:Ot(this.layer)}return null}get timeExtent(){return Ct(this.layerAdapter.timeOptions,this.view?.timeExtent,this._get("timeExtent"))}getDisplayStatistics(e,t){return this.featureContainer?.getDisplayStatistics(e,t)}async queryHeatmapStatistics(e){return(await this.getWorker()).pipeline.queryHeatmapStatistics(e)}highlight(e,t="default"){let i;e instanceof we?i=[e.getObjectId()]:typeof e=="number"||typeof e=="string"?i=[e]:dt.isCollection(e)&&e.length>0?i=e.map(s=>s?.getObjectId()).toArray():Array.isArray(e)&&e.length>0&&(i=typeof e[0]=="number"||typeof e[0]=="string"?e:e.map(s=>s?.getObjectId()));const r=i?.filter(pt);return r?.length?(this._addHighlights(r,t),Pe(()=>this._removeHighlights(r,t))):Pe()}getHighlightIds(){return Array.from(this._highlightCounter.ids())}hasHighlight(){return!this._highlightCounter.empty}async hitTest(e,t){const i=await this.featureContainer.hitTest(t);if(i.length===0)return null;const r=await this.getWorker(),{features:s,aggregates:a}=await r.pipeline.getDisplayFeatures(i),n=this.featureContainer.getSortKeys(i),o=({displayId:l},{displayId:u})=>n.has(l)&&n.has(u)?n.get(l)-n.get(u):l-u;return s.sort(o).reverse(),a.sort(o).reverse(),[...a.map(l=>this._createGraphicHit(e,Oe.fromJSON(l))),...s.map(l=>this._createGraphicHit(e,we.fromJSON(l)))]}async queryStatistics(){const e=await this.getWorker();return b(e.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}async querySummaryStatistics(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForSummaryStatistics(this._cleanUpQuery(e),s,i);return b(a,{})}async queryAggregateSummaryStatistics(e,t,i){const r={...t,scale:this.view.scale},s=(await this.getWorker()).aggregates.executeQueryForSummaryStatistics(this._cleanUpAggregateQuery(e),r,i);return b(s,{})}async queryUniqueValues(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForUniqueValues(this._cleanUpQuery(e),s,i);return b(a,{uniqueValueInfos:[]})}async queryAggregateUniqueValues(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.aggregates.executeQueryForUniqueValues(this._cleanUpAggregateQuery(e),s,i);return b(a,{uniqueValueInfos:[]})}async queryClassBreaks(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForClassBreaks(this._cleanUpQuery(e),s,i);return b(a,{classBreakInfos:[]})}async queryAggregateClassBreaks(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.aggregates.executeQueryForClassBreaks(this._cleanUpAggregateQuery(e),s,i);return b(a,{classBreakInfos:[]})}async queryHistogram(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForHistogram(this._cleanUpQuery(e),s,i);return b(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}async queryAggregateHistogram(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.aggregates.executeQueryForHistogram(this._cleanUpAggregateQuery(e),s,i);return b(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then(i=>{const r=Ie.fromJSON(i);return r.features.forEach(s=>this._setLayersForFeature(s)),r})}async queryVisibleFeatures(e,t){const i=(await this.getWorker()).pipeline.queryVisibleFeatures(this._cleanUpQuery(e),t),r=await b(i,{features:[]}),s=Ie.fromJSON(r);return s.features.forEach(a=>this._setLayersForFeature(a)),s}async queryAggregates(e,t){const i=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t),r=await b(i,{features:[]}),s=ti.fromJSON(r);return s.features.forEach(a=>this._setLayersForFeature(a)),s}async queryAggregateIds(e,t){const i=(await this.getWorker()).aggregates.executeQueryForIds(this._cleanUpAggregateQuery(e),t);return b(i,[])}async queryAggregateCount(e,t){const i=(await this.getWorker()).aggregates.executeQueryForCount(this._cleanUpAggregateQuery(e),t);return b(i,0)}async queryAggregateJSON(e,t){const i=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t);return b(i,{features:[]})}async queryFeaturesJSON(e,t){const i=(await this.getWorker()).features.executeQuery(this._cleanUpQuery(e),t);return b(i,{features:[]})}async queryObjectIds(e,t){const i=(await this.getWorker()).features.executeQueryForIds(this._cleanUpQuery(e),t);return b(i,[])}async queryFeatureCount(e,t){const i=(await this.getWorker()).features.executeQueryForCount(this._cleanUpQuery(e),t);return b(i,0)}async queryExtent(e,t){const i=(await this.getWorker()).features.executeQueryForExtent(this._cleanUpQuery(e),t),r=await b(i,{count:0,extent:null});return{count:r.count,extent:ht.fromJSON(r.extent)}}async getSampleFeatures(e){return(await this.getWorker()).pipeline.getSampleFeatures(e)}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._subscriptionManager)return;this.view.animation&&!this._lastTargetState&&(this._lastTargetState=e.state.clone()),!this.view.animation&&this._lastTargetState&&(this._lastTargetState=null);const t=this._subscriptionManager.update(e.targetState,this._lastTargetState);this.featureContainer.setVisibleTiles(t)}attach(){g("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),K(this._updatingHandles.addPromise(this._workerAttached.promise)),K(this._attachProxy()),this.featureContainer=new ni(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._subscriptionManager=new or({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:e=>{this.featureContainer.updateSubscriptions(e),K(this._updatingHandles.addPromise(this.getWorker().then(t=>t.pipeline.updateSubscriptions(e))))},isDone:e=>this.featureContainer.isDone(e)}),this.requestUpdate(),this.addAttachHandles([pe(()=>JSON.stringify({displayRefreshVersion:this._displayRefreshVersion,timeExtent:this.timeExtent,clips:this.clips,filter:this.filter,featureEffect:this.featureEffect,sourceRefreshVersion:this._sourceRefreshVersion,timeZone:this.view.timeZone,effect:this.featureEffect,...this.layerAdapter.getUpdateHashProperties(this.view)}),()=>this._update(),ft),pe(()=>this.updateSuspended,e=>{e||(this._subscriptionManager.resume(),this.view.labelManager.requestUpdate())}),pe(()=>this.visible,e=>{this.view.labelManager.requestUpdate()})]),this.layer.type!=="stream"&&this.layer.type!=="parquet"&&this.layer.type!=="catalog-footprint"&&this.addAttachHandles(this.layer.on("edits",e=>this._edit(e)))}detach(){g("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._detachProxy(),this._fields=null,this.featureContainer.destroy(),this.featureContainer=null,this._commandsQueue.clear(),this.container.removeAllChildren(),this._subscriptionManager=yt(this._subscriptionManager),this._workerProxy.pipeline.onDetach(),this._workerAttached=ye(),K(this._workerAttached.promise),this._lastAvailableFields=[],this._lastSchema=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const e="renderer"in this.layer&&this.layer.renderer!=null,t=this._commandsQueue.updateTracking.updating,i=this._updatingRequiredFieldsPromise!=null,r=this.featureContainer.updatingHandles.updating,s=this.updateRequested||e&&(t||i)||r||this._pipelineUpdating||this.dataUpdating;if(g("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${s}
  -> updateRequested ${this.updateRequested}
  -> hasRenderer ${e}
  -> updatingRequiredFields ${i}
  -> hasPendingCommand ${t}
  -> dataUpdating ${this.dataUpdating}
  -> processing ${this._pipelineUpdating}
  -> updatingContainer ${r}
`);for(const a of this.featureContainer.subscriptions())console.log(`    -> Tile[${a.id}] Done: ${a.done}`)}return s}_createClientOptions(){const e=this;return{get container(){return e.featureContainer},setUpdating:t=>{this._set("_pipelineUpdating",t.pipeline),this._set("dataUpdating",t.data)},emitEvent:t=>{this.emit(t.name,t.event)},get eventLog(){return e.eventLog},fetch:t=>Promise.all(t.map(i=>e.view.stage.painter.textureManager.rasterizeItem(i))),fetchDictionary:t=>Promise.all(t.map(i=>this._fetchDictionaryRequest(i)))}}async _fetchDictionaryRequest(e){try{if(this.layer.type==="subtype-group")throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const t=this.layer.renderer;if(!t||t.type!=="dictionary")throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const i=this._lastSchema.processor.mesh.factory.symbology;if(i.type!=="dictionary")throw new Error("InternalError: Expected schema to be of type 'dictionary'");const r={cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,store:this.featureContainer.instanceStore,scaleExpression:i.scaleExpression};this._fields||(this._fields=this.layer.fields.map(n=>n.toJSON()));const s=i.visualVariableUniforms,a=await t.getSymbolAsync(e.feature,{fields:this._fields});return!a||!a.data?{type:"dictionary-response",meshes:[]}:{type:"dictionary-response",meshes:await te(a.data,{uniforms:s,path:"renderer",schemaOptions:r})}}catch{return{type:"dictionary-response",meshes:[]}}}_cleanUpQuery(e){const t=me.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t.toJSON()}_cleanUpAggregateQuery(e){const t=me.from(e)||this.createAggregateQuery();t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference);const i=t.objectIds??[];for(const r of t.aggregateIds??[])i.push(r);return t.objectIds=i,t.aggregateIds=[],t.toJSON()}async _update(){return this._commandsQueue.push({type:"update"})}async _edit(e){if(this.updateSuspended)return void this._subscriptionManager.suspend();const t=this._getEffectiveEdit(e);return t?this._commandsQueue.push(t).catch(Me):void 0}async doRefresh(e){this.attached&&(this.updateSuspended&&e||(e?this.incrementSourceRefreshVersion():this.incrementDisplayRefreshVersion()))}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%Xe+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%Xe+1}_getEffectiveEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,i=e.deletedFeatures.some(o=>o.objectId===-1||!o.objectId),r=t&&this.availableFields.includes(t);if(i&&!r)return x.getLogger(this).error(new C("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null;const s=this.layer,a=e.historicMoment?.getTime()??null,n="layerId"in s&&e.editedFeatures?.find(o=>o.layerId===s.layerId);if(n&&this._canEditByFeature(n)){const o=Mt(this.layer.geometryType),{adds:l,deletes:u,updates:d}=n.editedFeatures,c=this.layer.objectIdField,p=l.map(m=>Qe(m,o,!1,!1)),y=d.map(m=>Qe(m.current,o,!1,!1));return{type:"edit-by-feature",added:p,removed:u.map(m=>"attributes"in m?{globalId:t?m.attributes[t]:null,objectId:c?m.attributes[c]:null}:m),updated:y,historicMoment:a}}return{type:"edit-by-id",added:e.addedFeatures,updated:e.updatedFeatures,removed:e.deletedFeatures,historicMoment:a}}_canEditByFeature(e){const{adds:t,updates:i}=e.editedFeatures;return t.every(r=>this.view.spatialReference.equals(r.geometry?.spatialReference))&&i.every(r=>this.view.spatialReference.equals(r.current.geometry?.spatialReference))}async _doUpdate(){"featureReduction"in this.layer&&this.layer.featureReduction&&this.layer.featureReduction!==this._lastFeatureReduction&&(this.layer.featureReduction=this.layer.featureReduction?.clone(),this._lastFeatureReduction=this.layer.featureReduction);try{if(await this._updateRequiredFields(),this.destroyed||!this.layerAdapter?.hasRequiredSupport||!this._subscriptionManager)return;const e=this.featureContainer.instanceStore;this.featureContainer.attributeView.lockTextureUploads(),e.updateStart();const t=this.featureEffect,i={store:e,cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},r=this._createViewSchemaConfig(),s={source:this.layerAdapter.createSourceSchema(r,this._sourceRefreshVersion),processor:await this.layerAdapter.createProcessorSchema(i,r,this._displayRefreshVersion)},a=ke(this._lastSchema?.source.mutable,s.source.mutable)||ke(this._lastSchema?.processor,s.processor);if(!a)return this.featureContainer.requestRender(),this.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(),void(this.featureEffectView.featureEffect=t);this._lastSchema=s,this._fields=null;const n=Math.round(performance.now());g("esri-2d-update-debug")&&console.debug(`Id[${this.layer.uid}] Version[${n}] FeatureLayerView2D._doUpdate`,{changes:a}),await(await this.getWorker()).pipeline.updateSchema(s,n),e.updateEnd(),this.featureEffectView.featureEffect=t,this.featureEffectView.endTransition(),this.featureContainer.restartAllAnimations(),this.featureContainer.attributeView.unlockTextureUploads(),this.featureContainer.swapRenderState(),this.featureContainer.requestRender(),g("esri-2d-update-debug")&&console.debug(`Version[${n}] FeatureLayerView2D.updateEnd`),this.requestUpdate()}catch(e){g("esri-2d-update-debug")&&console.error("Encountered an error during update",e)}}async _doEdit(e){const t=await this.getWorker();try{this.featureContainer.editStart(),await t.pipeline.onEdits(e),this.featureContainer.editEnd()}catch(i){Ne(i)}}get hasFilter(){const e=this.layerAdapter.hasFilters?.(this.view)??!1;return this.filter!=null||this.timeExtent!=null||this._visibilityOverrides.size>0||e}_getEffectiveAvailableFields(e){const t=ur(this._lastAvailableFields,e);return this._lastAvailableFields=t,mt(this.layer.fieldsIndex,t)}_createViewSchemaConfig(){const e=[cr(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter),this.featureEffect?.filter?.toJSON()??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),filters:e,scale:this.view.scale,timeZone:this.view.timeZone}}_addHighlights(e,t){this._highlightCounter.addGroup(e,t),this._commandsQueue.push({type:"highlight"})}_removeHighlights(e,t){this._highlightCounter.deleteGroup(e,t),this._commandsQueue.push({type:"highlight"})}async _updateHighlights(){const e=[];for(const r of this._highlightCounter.ids()){const s=this._highlightCounter.getHighlightGroups(r),a=this._getHighlightBits(s);e.push({objectId:r,highlightFlags:a})}const t=await this.getWorker();if(this.destroyed)return;const i=t.pipeline.updateHighlight({highlights:e}).catch(r=>{Ne(r)||x.getLogger(this).error(r)});this._updatingHandles.addPromise(i)}_setLayersForFeature(e){e.layer=e.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin&&this.layerAdapter.setGraphicOrigin(e)}_createGraphicHit(e,t){return this._setLayersForFeature(t),t.geometry!=null&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};function cr(e,t,i,r,s){s&&(s=s.clone());const a=s!=null?s.timeExtent:null,n=i!=null&&a!=null?i.intersection(a):i||a;n&&(s??=new ee,s.timeExtent=n),s=t.addFilters?.(s,e)??s;let o=s?.toJSON()??null;return r.size&&(o??=new ee().toJSON(),o.hiddenIds=Array.from(r)),o}h([f()],_.prototype,"_commandsQueue",void 0),h([f()],_.prototype,"_sourceRefreshVersion",void 0),h([f()],_.prototype,"_displayRefreshVersion",void 0),h([f({readOnly:!0})],_.prototype,"_pipelineUpdating",void 0),h([f({readOnly:!0})],_.prototype,"hasAllFeatures",null),h([f({readOnly:!0})],_.prototype,"hasAllFeaturesInView",null),h([f({readOnly:!0})],_.prototype,"hasFullGeometries",null),h([f()],_.prototype,"featureEffectView",void 0),h([f()],_.prototype,"labelingCollisionInfos",null),h([f()],_.prototype,"layerAdapter",null),h([f({readOnly:!0})],_.prototype,"timeExtent",null),h([f()],_.prototype,"updating",void 0),_=h([Q("esri.views.2d.layers.FeatureLayerView2D")],_);const dr=_,ua=Object.freeze(Object.defineProperty({__proto__:null,default:dr},Symbol.toStringTag,{value:"Module"}));export{ua as F,b as n,dr as r};
