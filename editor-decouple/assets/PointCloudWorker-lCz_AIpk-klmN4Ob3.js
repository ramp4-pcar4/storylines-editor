import{jH as O,a8 as x,ar as I}from"./main-Dt6SBPaS.js";import{v as C}from"./quat-DQgq9Ar5-CCvWdZLJ.js";import{e as k}from"./quatf64-C16JxGFv-BKWK1F8U.js";import{w as F}from"./vec32-Cj8pVsU0-Di-lTX65.js";import{u as A,o as w}from"./vec3f32-GX_cKsFD-UJPpzdNc.js";import{o as R}from"./projectionUtils-B-CplN3q-B9fSc15M.js";import{a as U,p as B,n as J}from"./PointCloudUniqueValueRenderer-HFZvjGLQ-UxXMe0Lp.js";import{n as N,O as V,G as q,o as T}from"./I3SBinaryReader-QlZXHlLJ-DMJtz3zk.js";import{i as G}from"./orientedBoundingBox-CSC169JG-BVzNfhnF.js";import"./mat3f64-BnNZDR5l-Bz3OL2oI.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./RendererLegendOptions-Bil_IDab-BTmeNMco.js";import"./ColorStop-CL7v3R-A-DYAnP6Ya.js";import"./VertexAttribute-hUz6pozM-Bx3V-z96.js";import"./mat3-DOnW3DjW-C3hbW9XY.js";import"./mat4f64-xsZDPPj0-Dq35B4BL.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./spatialReferenceEllipsoidUtils-BK0OQJn2-Bmmci8bC.js";import"./computeTranslationToOriginAndRotation-e-ft1lOz-WNgOIMY5.js";import"./mat4-OOmHNWi7-C1MkrqH6.js";import"./plane-Cf3Koz3c-BWlKi-Yp.js";import"./vectorStacks-5ZZtmT9E-tebler1e.js";import"./vec2f64-CkowXrDb-3zFQ3LNH.js";import"./ViewingMode-CdRKcXnc-Dab70bGf.js";function z(f,t,l,n){const{rendererJSON:c,isRGBRenderer:b}=f;let o=null,a=null;if(t&&b)o=t;else if(t&&c?.type==="pointCloudUniqueValueRenderer"){a=U.fromJSON(c);const r=a.colorUniqueValueInfos;o=new Uint8Array(3*n);const u=g(a.fieldTransformType);for(let e=0;e<n;e++){const i=(u?u(t[e]):t[e])+"";for(let s=0;s<r.length;s++)if(r[s].values.includes(i)){o[3*e]=r[s].color.r,o[3*e+1]=r[s].color.g,o[3*e+2]=r[s].color.b;break}}}else if(t&&c?.type==="pointCloudStretchRenderer"){a=B.fromJSON(c);const r=a.stops;o=new Uint8Array(3*n);const u=g(a.fieldTransformType);for(let e=0;e<n;e++){const i=u?u(t[e]):t[e],s=r.length-1;if(i<r[0].value)o[3*e]=r[0].color.r,o[3*e+1]=r[0].color.g,o[3*e+2]=r[0].color.b;else if(i>=r[s].value)o[3*e]=r[s].color.r,o[3*e+1]=r[s].color.g,o[3*e+2]=r[s].color.b;else for(let m=1;m<r.length;m++)if(i<r[m].value){const p=(i-r[m-1].value)/(r[m].value-r[m-1].value);o[3*e]=r[m].color.r*p+r[m-1].color.r*(1-p),o[3*e+1]=r[m].color.g*p+r[m-1].color.g*(1-p),o[3*e+2]=r[m].color.b*p+r[m-1].color.b*(1-p);break}}}else if(t&&c?.type==="pointCloudClassBreaksRenderer"){a=J.fromJSON(c);const r=a.colorClassBreakInfos;o=new Uint8Array(3*n);const u=g(a.fieldTransformType);for(let e=0;e<n;e++){const i=u?u(t[e]):t[e];for(let s=0;s<r.length;s++)if(i>=r[s].minValue&&i<=r[s].maxValue){o[3*e]=r[s].color.r,o[3*e+1]=r[s].color.g,o[3*e+2]=r[s].color.b;break}}}else o=new Uint8Array(3*n).fill(255);if(l&&a?.colorModulation){const r=a.colorModulation.minValue,u=a.colorModulation.maxValue,e=.3;for(let i=0;i<n;i++){const s=l[i],m=s>=u?1:s<=r?e:e+(1-e)*(s-r)/(u-r);o[3*i]=m*o[3*i],o[3*i+1]=m*o[3*i+1],o[3*i+2]=m*o[3*i+2]}}return o}function Z(f,t){if(f.encoding==null||f.encoding===""){const l=N(t,f);if(l.vertexAttributes.position==null)return;const n=V(t,l.vertexAttributes.position),c=l.header.fields,b=[c.offsetX,c.offsetY,c.offsetZ],o=[c.scaleX,c.scaleY,c.scaleZ],a=n.length/3,r=new Float64Array(3*a);for(let u=0;u<a;u++)r[3*u]=n[3*u]*o[0]+b[0],r[3*u+1]=n[3*u+1]*o[1]+b[1],r[3*u+2]=n[3*u+2]*o[2]+b[2];return r}if(f.encoding==="lepcc-xyz")return q(t).result}function h(f,t,l){return f?.attributeInfo.useElevation?t?j(t,l):null:f?.attributeInfo.storageInfo?T(f.attributeInfo.storageInfo,f.buffer,l,!0):null}function j(f,t){const l=new Float64Array(t);for(let n=0;n<t;n++)l[n]=f[3*n+2];return l}function E(f,t,l,n,c){const b=f.length/3;let o=0;for(let a=0;a<b;a++){let r=!0;for(let u=0;u<n.length&&r;u++){const{filterJSON:e}=n[u],i=c[u].values[a];switch(e.type){case"pointCloudValueFilter":{const s=e.mode==="exclude";e.values.includes(i)===s&&(r=!1);break}case"pointCloudBitfieldFilter":{const s=M(e.requiredSetBits),m=M(e.requiredClearBits);(i&s)===s&&!(i&m)||(r=!1);break}case"pointCloudReturnFilter":{const s=15&i,m=i>>>4&15,p=m>1,S=s===1,v=s===m;let y=!1;for(const d of e.includedReturns)if(d==="last"&&v||d==="firstOfMany"&&S&&p||d==="lastOfMany"&&v&&p||d==="single"&&!p){y=!0;break}y||(r=!1);break}}}r&&(l[o]=a,f[3*o]=f[3*a],f[3*o+1]=f[3*a+1],f[3*o+2]=f[3*a+2],t[3*o]=t[3*a],t[3*o+1]=t[3*a+1],t[3*o+2]=t[3*a+2],o++)}return o}function g(f){switch(f){default:case null:case"none":return t=>t;case"low-four-bit":return t=>15&t;case"high-four-bit":return t=>(240&t)>>4;case"absolute-value":return t=>Math.abs(t);case"modulo-ten":return t=>t%10}}function M(f){let t=0;for(const l of f||[])t|=1<<l;return t}class X{transform(t){const l=this._transform(t),n=[l.points.buffer,l.rgb.buffer];l.pointIdFilterMap!=null&&n.push(l.pointIdFilterMap.buffer);for(const c of l.attributes)"buffer"in c.values&&O(c.values.buffer)&&c.values.buffer!==l.rgb.buffer&&n.push(c.values.buffer);return Promise.resolve({result:l,transferList:n})}_transform(t){const l=Z(t.schema,t.geometryBuffer);let n=l.length/3,c=null;const b=new Array,o=h(t.primaryAttributeData,l,n);t.primaryAttributeData!=null&&o&&b.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:o});const a=h(t.modulationAttributeData,l,n);t.modulationAttributeData!=null&&a&&b.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:a});let r=z(t.rendererInfo,o,a,n);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const e=t.filterAttributesData.filter(x).map(i=>{const s=h(i,l,n),m={attributeInfo:i.attributeInfo,values:s};return b.push(m),m});c=new Uint32Array(n),n=E(l,r,c,t.filterInfo,e)}for(const e of t.userAttributesData){const i=h(e,l,n);b.push({attributeInfo:e.attributeInfo,values:i})}3*n<r.length&&(r=new Uint8Array(r.buffer.slice(0,3*n))),_(l,n,t.elevationOffset);const u=Y(l,n,G.fromData(t.obbData),I.fromJSON(t.inSR),I.fromJSON(t.outSR));return{obbData:t.obbData,points:u,rgb:r,attributes:b,pointIdFilterMap:c}}}function Y(f,t,l,n,c){if(!R(f,n,0,f,c,0,t))throw new Error("Can't reproject");const b=A(l.center),o=w(),a=w(),r=A(l.halfSize);C(D,l.quaternion);const u=new Float32Array(3*t);for(let e=0;e<t;e++){let i=3*e;o[0]=f[i]-b[0],o[1]=f[i+1]-b[1],o[2]=f[i+2]-b[2],F(a,o,D),r[0]=Math.max(r[0],Math.abs(a[0])),r[1]=Math.max(r[1],Math.abs(a[1])),r[2]=Math.max(r[2],Math.abs(a[2])),u[i++]=o[0],u[i++]=o[1],u[i]=o[2]}return l.halfSize=r,u}function _(f,t,l){if(l!==0)for(let n=0;n<t;n++)f[3*n+2]+=l}const D=k();function vt(){return new X}export{vt as default};
