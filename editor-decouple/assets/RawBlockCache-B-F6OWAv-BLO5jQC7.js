import{l as N}from"./main-D6SnduPa.js";import{r as O,I as P,V as Q}from"./rasterProjectionHelper-DGqzGF1m-DgJb-slE.js";class U{constructor(n=15e3,t=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=n,this._interval=Math.min(n,t)}decreaseRefCount(n,t){const e=n+"/"+t,o=this._cachedBlocks;if(o.has(e)){const l=o.get(e);return l.refCount--,l.refCount<=0&&(o.delete(e),l.controller&&l.controller.abort()),l.refCount}return 0}getBlock(n,t){const e=n+"/"+t,o=this._cachedBlocks;if(o.has(e)){const l=o.get(e);return l.ts=Date.now(),l.refCount++,o.delete(e),o.set(e,l),l.block}return null}putBlock(n,t,e,o){const l=this._cachedBlocks,c=n+"/"+t;if(l.has(c)){const s=l.get(c);s.ts=Date.now(),s.refCount++}else l.set(c,{block:e,ts:Date.now(),refCount:1,controller:o});this._trim(),this._updateTimer()}deleteBlock(n,t){const e=this._cachedBlocks,o=n+"/"+t;e.has(o)&&e.delete(o)}updateMaxSize(n){this._size=n,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(this._timer!=null)return;const n=this._cachedBlocks;this._timer=setInterval(()=>{const t=Array.from(n),e=Date.now();for(let o=0;o<t.length&&t[o][1].ts<=e-this._duration;o++)n.delete(t[o][0]);n.size===0&&this._clearTimer()},this._interval)}_trim(){const n=this._cachedBlocks;if(this._size===-1||this._size>=n.size)return;const t=Array.from(n);for(let e=0;e<t.length-this._size;e++)n.delete(t[e][0])}_clearTimer(){this._timer!=null&&(clearInterval(this._timer),this._timer=null)}}const u=new Map,h=new U;function F(r,n,t){const e=[];return n!=null&&e.push(`sliceId=${n}`),t!=null&&e.push(`bandIds=${t.join(",")}`),e.length?`${r}?${e.join("&")}`:r}function G(r,n){const t={extent:null,rasterInfo:n,cache:new Map},e=u.get(r);return e?(e.push(t),e.length-1):(u.set(r,[t]),0)}function J(r,n){const t=u.get(r);t&&(t[n]=null,t.some(e=>e!=null)||u.delete(r))}function K(r,n,t){const e=u.get(r);if(!e)return n==null?h.decreaseRefCount(r,t):0;if(n==null||e[n]==null)return h.decreaseRefCount(r,t);const o=e[n]?.cache,l=o?.get(t);if(o&&l){if(l.refCount--,l.refCount===0){o.delete(t);for(let c=0;c<e.length;c++)e[c]?.cache.delete(t);l.controller&&l.controller.abort()}return l.refCount}return 0}function ee(r,n,t){const e=u.get(r);if(!e)return n==null?h.getBlock(r,t):null;if(n==null||e[n]==null){for(let l=0;l<e.length;l++){const c=e[l]?.cache.get(t);if(c)return c.refCount++,c.block}return h.getBlock(r,t)}const o=e[n]?.cache.get(t);if(o)return o.refCount++,o.block;for(let l=0;l<e.length;l++){if(l===n||!e[l])continue;const c=e[l]?.cache,s=c?.get(t);if(c&&s)return s.refCount++,c.set(t,s),s.block}return null}function te(r,n,t,e,o=null){const l=u.get(r);if(!l)return void(n==null&&h.putBlock(r,t,e,o));if(n==null||l[n]==null)return void h.putBlock(r,t,e,o);const c={refCount:1,block:e,isResolved:!1,isRejected:!1,controller:o};e.then(()=>c.isResolved=!0).catch(()=>c.isRejected=!0),l[n]?.cache.set(t,c)}function ne(r,n,t){const e=u.get(r);e?n!=null&&e[n]!=null?e[n]?.cache.delete(t):h.deleteBlock(r,t):n==null&&h.deleteBlock(r,t)}function X(r,n){const t=u.get(r);return t?t[n]??null:null}function le(r,n,t,e,o,l,c=null){const s=X(r,n);if(!s)return;const m=s.extent,{cache:k,rasterInfo:p}=s;if(m&&m.xmin===t.xmin&&m.xmax===t.xmax&&m.ymin===t.ymin&&m.ymax===t.ymax)return;e=e??0;const C=t.clone().normalize(),{spatialReference:M,transform:R}=p,w=new Set;for(let x=0;x<C.length;x++){const a=C[x];if(a.xmax-a.xmin<=e||a.ymax-a.ymin<=e)continue;let i=O(a,M,c);if(i==null||R!=null&&(i=R.inverseTransform(i),i==null))continue;const D=new N({x:e,y:e,spatialReference:a.spatialReference});if(o==null&&!(o=P(D,M,a,c)))return;const{pyramidLevel:g,pyramidResolution:S,excessiveReading:A}=Q(o,p,l||"closest");if(A)return;const{storageInfo:f}=p,{origin:b}=f,{x:v,y:z}=S,I=Math.max(0,Math.floor((i.xmin-b.x)/v)),$=Math.max(0,Math.floor((b.y-i.ymax)/z)),H=Math.ceil(i.width/v-.1),V=Math.ceil(i.height/z-.1),T=g>0?f.pyramidBlockWidth:f.blockWidth,j=g>0?f.pyramidBlockHeight:f.blockHeight,d=f.blockBoundary[g];if(!d)continue;const _=1,W=Math.max(d.minCol,Math.floor(I/T)-_),E=Math.max(d.minRow,Math.floor($/j)-_),L=Math.min(d.maxCol,Math.floor((I+H-1)/T)+_),q=Math.min(d.maxRow,Math.floor(($+V-1)/j)+_);for(let y=E;y<=q;y++)for(let B=W;B<=L;B++)w.add(`${g}/${y}/${B}`)}k.forEach((x,a)=>{if(!w.has(a)){const i=k.get(a);(i==null||i.isResolved||i.isRejected)&&k.delete(a)}}),s.extent={xmin:t.xmin,ymin:t.ymin,xmax:t.xmax,ymax:t.ymax}}export{te as O,F as P,ne as U,G as V,J as X,K as Y,ee as Z,le as t};
