import{by as fe,v as T,I as A,J as Fe,U as Te,L as Re,t as pe,P as U,B as Ue,n as k,an as Ne,aQ as Me,b3 as Oe,Y as ye,af as $e,b as Je,di as Ve,a8 as ze,ao as Ge}from"./main-BrXQBr3M.js";import{o as v,ad as He,ae,w as C,c as M,j as E,ao as We,K as De,X as ve,Z as Ee,J as j,aj as Q,H as Y,an as Be,h as B,G as Qe,d as _,D as _e,ap as qe,aq as ee,z as oe}from"./arcade-Dg73dEoh-Dqa0c1h3.js";import{a as p,r as y}from"./unitConversion-BXECx7w3-CV75JlJR.js";import{R as Ke,q as xe,p as Xe,c as se,e as Ye,a as et,b as tt,N as ne,j as nt,F as it,E as rt,L as W,B as at,d as te,f as Z,k as le}from"./featureSetUtils-BEDibABs-BrX5BcVQ.js";import{n as ot}from"./ImmutableArray-CiJxhY8_-Kqx7aWRu.js";import{n as st}from"./portalUtils-SFTmSBN_-CnXTo5yT.js";import{D as lt,e as Se}from"./SpatialFilter-zxnOyqfk-CnkAYbco.js";import{h as ke,I as de}from"./shared-Y9GMqi1u-FdqztdY1.js";import{D}from"./WhereClause-nZnXFKnG-B5BHwoCA.js";import{Y as je}from"./FeatureLayer-Co7yvE-_-DGLzYjDQ.js";import{y as P}from"./Field-Cj6Pz3TI-BT1_6DON.js";import{y as dt,f as ct,c as ut}from"./utils-DuaeuwP5-t1uDCGxn.js";import{i as K}from"./NetworkElement-DAgLH18H-CoD8P_We.js";import"./number-ZeBaww6r-CQBQ-G0V.js";import"./TimeOnly-C3SOkmg2-CtsxsW96.js";import"./featureConversionUtils-DRaHTjrY-fgjzbpdH.js";import"./OptimizedFeatureSet-D6mgsKNr-DozTzjts.js";import"./memoryEstimations-iHVpvWPf-Bcit1dlR.js";import"./OptimizedGeometry-1qDYm3YK-NqjQEvGQ.js";import"./FieldsIndex-Y7EBAYp0-BqfCvCRQ.js";import"./timeZoneUtils-z3WjfjXQ-8JPN5aIG.js";import"./uuid-Dj9mdEVg-BaKSCiyT.js";import"./fieldType-VTpxE-EM-CC-owBT-.js";import"./MD5-CHHr-oed-SuyrCYQ0.js";import"./RelationshipQuery-BgG1nLP1-r4LQIEKU.js";import"./Query-CxQYWcUQ-B-eUtOfF.js";import"./TimeExtent-gZaEUVeW-D2eGsof2.js";import"./FeatureType-MZ846Ius-BvNwmkUY.js";import"./labelingInfo-D9WqyhOx-POivzOFk.js";import"./SimpleRenderer-ADQlYl8U-DqPI9se2.js";import"./commonProperties-BLIn8DYU-BQFd4ays.js";import"./colorRamps-KMmVdCPJ-CmpjMakp.js";import"./ColorStop-DoHCvOqO-CN19nLxS.js";import"./visualVariableUtils-BO-_wo28-DfrVsYLw.js";import"./lengthUtils-wU9RRIqK-BTv_PZij.js";import"./UniqueValueRenderer-BmoLL_Ee-B6g7RAOV.js";import"./diffUtils-BSe9IE26-BhPEeZ3Z.js";import"./RendererLegendOptions-f5mIImtQ-C9HuzuEm.js";import"./styleUtils-DxAOZq5S-C08OtaT1.js";import"./NormalizationBinParametersMixin-ZkplD1Sk-D7EQSx5U.js";import"./labelUtils-Dd5sr1UJ-D35jm2Km.js";import"./Layer-B8q-l4yV-CrUv4jz5.js";import"./PortalItem-CJetnHeq-DARRzPZU.js";import"./operatorsWorkerConnection-DkxyJ5dM-Bx35Sx0S.js";import"./workers-0oosFQiO-CKblg_PO.js";import"./Queue-B8H6jIv7-C4vOEIQq.js";import"./intl-DLmy-Li5-DRUw9zN4.js";import"./PortalLayer-rRU66wtN-CGrt1Fj6.js";import"./layerContainerType-ChWdCT09-G5sdAsSy.js";import"./ElevationInfo-DkWlof50-Bezaxy73.js";import"./portalItemUtils-DsrxEt4W-DPSqOdgS.js";import"./projection-m8vi7Cxv-DG9zGNlV.js";import"./queryZScale-DBCLQqDI-BY98U1gi.js";import"./FeatureSet-Dxf4LeOj-Di7NLuoW.js";import"./ArcGISService-CdvDPeWS-btR957ts.js";import"./ScaleRangeLayer-DIxukUBC-C1pkfLgo.js";import"./jsonUtils-DzmXEA9_-BnStZKpJ.js";import"./parser-hXQyB-Qx-Dp0xTp_H.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-BFStKTjU-uiUWvEP6.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./popupUtils-BiEhUPlu-BC3pJCmj.js";import"./scaleUtils-DtnDbXa5-DIW3fzgY.js";import"./displayFilterUtils-CGSKf3_R-13WNll6z.js";import"./EditBusLayer-CK3C7PC1-C34JI5f2.js";import"./FeatureEffect-ChYAnxbf-D5BpY9rO.js";import"./FeatureFilter-C7FajlY_-Ccw3sCjO.js";import"./HeightModelInfo-BkDck4B0-DuW1KdQ_.js";import"./jsonUtils-DQiDyVGY-BfpgCWfZ.js";import"./typeUtils-I5iG5ZKA-DzHUxJgf.js";import"./ClassBreaksRenderer-D97YzbWp-C6I_4ju-.js";import"./LRUCache-BLmkvs7b-Cf0KRICn.js";import"./MemCache-BCippCv6-DnYe-hpD.js";import"./Version-BTMwSXf1-CLS208tz.js";import"./utils-BYqzY6_X-Dq82pUKM.js";import"./defaultCIMValues-gWpu7WSC-cjxb95kj.js";import"./enums-f9UUstHQ-hLTu4V1l.js";import"./heatmapUtils--OU2Fakh-BWGHg30d.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./vec4f64-CjUMzAyX-DPYbdAom.js";import"./RefreshableLayer-yYqabqcs-CdaCD0C8.js";import"./TemporalLayer-DxgXU1f--CqhZG0jm.js";import"./versionUtils-DDW8eV12-DBlOlu1K.js";import"./styleUtils-DbPBpaXg-DJNds7J4.js";import"./interfaces-Cwm0pihk-Ptzy6gTd.js";var Ae;(function(n){n[n.RTJunctionJunctionConnectivity=1]="RTJunctionJunctionConnectivity",n[n.RTContainment=2]="RTContainment",n[n.RTAttachment=3]="RTAttachment",n[n.RTJunctionEdgeConnectivity=4]="RTJunctionEdgeConnectivity",n[n.RTEdgeJunctionEdgeConnectivity=5]="RTEdgeJunctionEdgeConnectivity"})(Ae||(Ae={})),new fe({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation"});const O=new fe({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new fe({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let S=class extends ye{constructor(n){super(n),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(n,t){return new K({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId})}writeFromNetworkElement(n,t){n&&(t.fromGlobalId=n.globalId,t.fromNetworkSourceId=n.networkSourceId,t.fromTerminalId=n.terminalId)}readToNetworkElement(n,t){return new K({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId})}writeToNetworkElement(n,t){n&&(t.toGlobalId=n.globalId,t.toNetworkSourceId=n.networkSourceId,t.toTerminalId=n.terminalId)}};T([A({type:String,json:{write:!0}})],S.prototype,"globalId",void 0),T([A({type:O.apiValues,json:{type:O.jsonValues,read:O.read,write:O.write}})],S.prototype,"associationType",void 0),T([A({type:K,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId"]}}})],S.prototype,"fromNetworkElement",void 0),T([Fe("fromNetworkElement")],S.prototype,"readFromNetworkElement",null),T([Te("fromNetworkElement")],S.prototype,"writeFromNetworkElement",null),T([A({type:K,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId"]}}})],S.prototype,"toNetworkElement",void 0),T([Fe("toNetworkElement")],S.prototype,"readToNetworkElement",null),T([Te("toNetworkElement")],S.prototype,"writeToNetworkElement",null),T([A({type:Re,json:{write:!0}})],S.prototype,"geometry",void 0),T([A({type:String,json:{write:!0}})],S.prototype,"errorMessage",void 0),T([A({type:Number,json:{write:!0}})],S.prototype,"percentAlong",void 0),T([A({type:Number,json:{write:!0}})],S.prototype,"errorCode",void 0),T([A({type:Boolean,json:{write:!0}})],S.prototype,"isContentVisible",void 0),T([A({type:Number,json:{write:!0}})],S.prototype,"status",void 0),S=T([pe("esri.rest.networks.support.Association")],S);const mt=S;var ue;let V=ue=class extends ye{static from(n){return $e(ue,n)}constructor(n){super(n),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};T([A({type:Boolean,json:{write:!0}})],V.prototype,"returnDeletes",void 0),T([A({type:[K],json:{write:!0}})],V.prototype,"elements",void 0),T([A({type:[O.apiValues],json:{type:O.jsonValues,read:O.read,write:O.write}})],V.prototype,"types",void 0),T([A({type:String,json:{write:!0}})],V.prototype,"gdbVersion",void 0),T([A({type:Date,json:{type:Number,write:{writer:(n,t)=>{t.moment=n?.getTime()}}}})],V.prototype,"moment",void 0),V=ue=T([pe("esri.rest.networks.support.QueryAssociationsParameters")],V);const ft=V;let ie=class extends ye{constructor(n){super(n),this.associations=[]}};T([A({type:[mt],json:{write:!0}})],ie.prototype,"associations",void 0),ie=T([pe("esri.rest.networks.support.QueryAssociationsResult")],ie);const pt=ie;function yt(n){const{returnDeletes:t,elements:r,gdbVersion:w,moment:g}=n.toJSON();return{returnDeletes:t,elements:JSON.stringify(r.map(e=>({globalId:e.globalId,networkSourceId:e.networkSourceId,terminalId:e.terminalId}))),types:JSON.stringify(n.types.map(e=>O.toJSON(e))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:w,moment:g}}async function wt(n,t,r){const w=dt(n),g={...yt(t),f:"json"},e=ct({...w.query,...g}),i=ut(e,{...r,method:"post"}),o=`${w.path}/associations/query`,{data:l}=await Je(o,i),f=pt.fromJSON(l);return t.types.includes("connectivity")&&Ve(ze.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-rest-networks-support-QueryAssociationsParameters.html#types",version:"4.29",warnOnce:!0}),f}function It(n){if(n.length===1){if(k(n[0]))return oe("distinct",n[0],-1);if(B(n[0]))return oe("distinct",n[0].toArray(),-1)}return oe("distinct",n,-1)}function ce(n,t,r){const w=n.getVariables();if(w.length>0){const g={};for(const e of w)g[e]=t.evaluateIdentifier(r,{name:e});n.parameters=g}return n}function m(n,t,r=null){for(const w in n)if(w.toLowerCase()===t.toLowerCase())return n[w];return r}function Ce(n){if(n===null)return null;const t={type:m(n,"type",""),name:m(n,"name","")};if(t.type==="range")t.range=m(n,"range",[]);else{t.codedValues=[];for(const r of m(n,"codedValues",[]))t.codedValues.push({name:m(r,"name",""),code:m(r,"code",null)})}return t}function me(n){if(n===null)return null;const t={},r=m(n,"wkt");r!==null&&(t.wkt=r);const w=m(n,"wkid");return w!==null&&(t.wkid=w),t}function Le(n){if(n===null)return null;const t={hasZ:m(n,"hasz",!1),hasM:m(n,"hasm",!1)},r=m(n,"spatialreference");r!=null&&(t.spatialReference=me(r));const w=m(n,"x",null);if(w!==null)return t.x=w,t.y=m(n,"y",null),t.hasZ&&(t.z=m(n,"z",null)),t.hasM&&(t.m=m(n,"m",null)),t;const g=m(n,"rings",null);if(g!==null)return t.rings=g,t;const e=m(n,"paths",null);if(e!==null)return t.paths=e,t;const i=m(n,"points",null);if(i!==null)return t.points=i,t;for(const o of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const l=m(n,o,null);l!==null&&(t[o]=l)}return t}function gt(n,t){for(const r of t)if(r===n)return!0;return!1}function ht(n){return!!n.layerDefinition&&!!n.featureSet&&gt(n.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&k(n.layerDefinition.fields)!==!1&&k(n.featureSet.features)!==!1}function q(n){return n?.toLowerCase()==="utc"?"UTC":n?.toLowerCase()==="unknown"?"Unknown":n}async function bt(n,t,r,w,g,e,i){const o=await n.getFeatureSetInfo();if((o?.layerId??null)===null||!g.layerIdLookup.get(o.layerId))return null;const l=n.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),f=[];switch(r){case"connected":f.push("connectivity"),f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity"),f.push("junction-edge-midspan-connectivity"),f.push("junction-junction-connectivity");break;case"container":case"content":f.push("containment");break;case"structure":case"attached":f.push("attachment");break;case"junctionedge":f.push("junction-edge-from-connectivity"),f.push("junction-edge-to-connectivity");break;case"midspan":f.push("junction-edge-midspan-connectivity");break;default:throw new p(e,y.InvalidParameter,i)}let c=null,s=!1;if(w!==null&&w!==""&&w!==void 0){for(const u of g.terminals)u.terminalName===w&&(c=u.terminalId);c===null&&(s=!0)}const a=[];if(!s){const u=new K({globalId:t.field(n.globalIdField),networkSourceId:g.layerIdLookup.get(o.layerId).sourceId,...c?{terminalId:c}:""}),x=await wt(l,new ft({types:f,elements:[u]}));let N=0;for(const I of x.associations){let F=null,z="",R="";if(I.fromNetworkElement?.globalId===u.globalId?(F=I.toNetworkElement,R="to"):I.toNetworkElement?.globalId===u.globalId&&(F=I.fromNetworkElement,R="from"),!F)continue;switch(r){case"attached":if(I.associationType!=="attachment"||R!=="to")continue;break;case"structure":if(I.associationType!=="attachment"||R!=="from")continue;break;case"container":if(I.associationType!=="containment"||R!=="from")continue;break;case"content":if(I.associationType!=="containment"||R!=="to")continue;break;case"connected":break;case"junctionedge":I.associationType==="junction-edge-to-connectivity"?z="to":I.associationType==="junction-edge-from-connectivity"&&(z="from");break;case"midspan":if(I.associationType!=="junction-edge-midspan-connectivity")continue}const G=g.sourceIdLookup.get(F.networkSourceId)?.className??"";a.push(new Ge({geometry:null,attributes:{objectId:N++,globalId:F.globalId,percentAlong:I.percentAlong??0,isContentVisible:I.isContentVisible?0:1,className:G,side:z}}))}}const d=new je({source:a,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new P({name:"objectId",alias:"objectId",type:"oid"}),new P({name:"globalId",alias:"globalId",type:"global-id"}),new P({name:"percentAlong",alias:"percentAlong",type:"double"}),new P({name:"side",alias:"side",type:"string"}),new P({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new P({name:"className",alias:"className",type:"string"})]});return ne(d)}function Yn(n){n.mode==="async"&&(n.functions.timezone=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,2,t,r),He(e[0])||ae(e[0]))return"Unknown";if(C(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?q("unknown"):q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof M)||e[1].hasField("type")===!1)throw new p(t,y.InvalidParameter,r);const l=e[1].field("type");if(U(l)===!1)throw new p(t,y.InvalidParameter,r);switch(E(l).toLowerCase()){case"preferredtimezone":return q(e[0].preferredTimeZone);case"editfieldsinfo":return q(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return q(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&U(e[1].field("fieldname")))return q(e[0].fieldTimeZone(E(e[1].field("fieldname"))))}throw new p(t,y.InvalidParameter,r)}const i=We(e[0],De(t));if(i===null)return null;const o=i.timeZone;return o==="system"?Ue.systemTimeZoneCanonicalName:o.toLowerCase()==="utc"?"UTC":o.toLowerCase()==="unknown"?"Unknown":o})},n.functions.sqltimestamp=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,1,3,t,r);const i=e[0];if(ve(i)){if(e.length===1)return i.toSQLWithKeyword();if(e.length===2)return i.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new p(t,y.InvalidParameter,r)}if(ae(i))return i.toSQLWithKeyword();if(C(i)){if(e.length!==3)throw new p(t,y.InvalidParameter,r);await i.load();const o=E(e[1]);if(ae(e[2]))return e[2].toSQLWithKeyword();if(ve(e[2])===!1)throw new p(t,y.InvalidParameter,r);const l=i.fieldTimeZone(o);return l==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(l).toSQLWithKeyword()}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"sqltimestamp",min:2,max:4}),n.functions.featuresetbyid=function(t,r){return n.standardFunctionAsync(t,r,(w,g,e)=>{if(v(e,2,4,t,r),Ee(e[0])){const i=E(e[1]);let o=j(e[2],null);const l=Q(j(e[3],!0));if(o===null&&(o=["*"]),k(o)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetById(i,l,o)}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"featuresetbyid",min:2,max:4}),n.functions.getfeatureset=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,2,t,r),Y(e[0])){let i=j(e[1],"datasource");return i===null&&(i="datasource"),i=E(i).toLowerCase(),Ke(e[0].fullSchema(),i,t.lrucache,t.interceptor,t.spatialReference??null)}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"getfeatureset",min:1,max:2}),n.functions.featuresetbyportalitem=function(t,r){return n.standardFunctionAsync(t,r,(w,g,e)=>{if(v(e,2,5,t,r),e[0]===null)throw new p(t,y.PortalRequired,r);if(e[0]instanceof Be){const c=E(e[1]),s=E(e[2]);let a=j(e[3],null);const d=Q(j(e[4],!0));if(a===null&&(a=["*"]),k(a)===!1)throw new p(t,y.InvalidParameter,r);let u;return u=t.services?.portal?t.services.portal:Ne.getDefault(),u=st(e[0],u),xe(c,s,t.spatialReference??null,a,d,u,t.lrucache,t.interceptor)}if(U(e[0])===!1)throw new p(t,y.PortalRequired,r);const i=E(e[0]),o=E(e[1]);let l=j(e[2],null);const f=Q(j(e[3],!0));if(l===null&&(l=["*"]),k(l)===!1)throw new p(t,y.InvalidParameter,r);return xe(i,o,t.spatialReference??null,l,f,t.services?.portal??Ne.getDefault(),t.lrucache,t.interceptor)})},n.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),n.functions.featuresetbyname=function(t,r){return n.standardFunctionAsync(t,r,(w,g,e)=>{if(v(e,2,4,t,r),Ee(e[0])){const i=E(e[1]);let o=j(e[2],null);const l=Q(j(e[3],!0));if(o===null&&(o=["*"]),k(o)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetByName(i,l,o)}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"featuresetbyname",min:2,max:4}),n.functions.featureset=function(t,r){return n.standardFunction(t,r,(w,g,e)=>{v(e,1,1,t,r);const i={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(U(e[0])){const o=JSON.parse(e[0]);o.layerDefinition!==void 0?(i.layerDefinition=o.layerDefinition,i.featureSet=o.featureSet,o.layerDefinition.spatialReference&&(i.layerDefinition.spatialReference=o.layerDefinition.spatialReference)):(i.featureSet.features=o.features,i.featureSet.geometryType=o.geometryType,i.layerDefinition.geometryType=i.featureSet.geometryType,i.layerDefinition.objectIdField=o.objectIdFieldName??"",i.layerDefinition.typeIdField=o.typeIdFieldName,i.layerDefinition.globalIdField=o.globalIdFieldName,i.layerDefinition.fields=o.fields,o.spatialReference&&(i.layerDefinition.spatialReference=o.spatialReference))}else{if(!(e[0]instanceof M))throw new p(t,y.InvalidParameter,r);{const o=JSON.parse(e[0].castToText(!0)),l=m(o,"layerdefinition");if(l!==null){i.layerDefinition.geometryType=m(l,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.globalIdField=m(l,"globalidfield",""),i.layerDefinition.objectIdField=m(l,"objectidfield",""),i.layerDefinition.typeIdField=m(l,"typeidfield",""),i.layerDefinition.hasZ=m(l,"hasz",!1)===!0,i.layerDefinition.hasM=m(l,"hasm",!1)===!0;const f=m(l,"spatialreference");f&&(i.layerDefinition.spatialReference=me(f));const c=[];for(const a of m(l,"fields",[])){const d={name:m(a,"name",""),alias:m(a,"alias",""),type:m(a,"type",""),nullable:m(a,"nullable",!0),editable:m(a,"editable",!0),length:m(a,"length",null),domain:Ce(m(a,"domain"))};c.push(d)}i.layerDefinition.fields=c;const s=m(o,"featureset");if(s){const a={};for(const d of c)a[d.name.toLowerCase()]=d.name;for(const d of m(s,"features",[])){const u={},x=m(d,"attributes",{});for(const N in x)u[a[N.toLowerCase()]]=x[N];i.featureSet.features.push({attributes:u,geometry:Le(m(d,"geometry"))})}}}else{i.layerDefinition.hasZ=m(o,"hasz",!1)===!0,i.layerDefinition.hasM=m(o,"hasm",!1)===!0,i.layerDefinition.geometryType=m(o,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.objectIdField=m(o,"objectidfieldname",""),i.layerDefinition.typeIdField=m(o,"typeidfieldname","");const f=m(o,"spatialreference");f&&(i.layerDefinition.spatialReference=me(f));const c=[],s=m(o,"fields",null);if(!k(s))throw new p(t,y.InvalidParameter,r);for(const u of s){const x={name:m(u,"name",""),alias:m(u,"alias",""),type:m(u,"type",""),nullable:m(u,"nullable",!0),editable:m(u,"editable",!0),length:m(u,"length",null),domain:Ce(m(u,"domain"))};c.push(x)}i.layerDefinition.fields=c;const a={};for(const u of c)a[u.name.toLowerCase()]=u.name;let d=m(o,"features",null);if(k(d))for(const u of d){const x={},N=m(u,"attributes",{});for(const I in N)x[a[I.toLowerCase()]]=N[I];i.featureSet.features.push({attributes:x,geometry:Le(m(u,"geometry",null))})}else d=null,i.featureSet.features=d}}}if(ht(i)===!1)throw new p(t,y.InvalidParameter,r);return i.layerDefinition.geometryType||(i.layerDefinition.geometryType="esriGeometryNull"),Xe.create(i,t.spatialReference)})},n.signatures.push({name:"featureset",min:1,max:1}),n.functions.filter=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),k(e[0])||B(e[0])){const i=[];let o,l=e[0];if(l instanceof ot&&(l=l.toArray()),!Qe(e[1]))throw new p(t,y.InvalidParameter,r);o=e[1].createFunction(t);for(const f of l){const c=o(f);Me(c)?await c===!0&&i.push(f):c===!0&&i.push(f)}return i}if(C(e[0])){const i=await e[0].load(),o=D.create(e[1],{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),l=o.getVariables();if(l.length>0){const f={};for(const c of l)f[c]=n.evaluateIdentifier(t,{name:c});o.parameters=f}return new se({parentfeatureset:e[0],whereclause:o})}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"filter",min:2,max:2}),n.functions.orderby=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),C(e[0])){const i=new Ye(e[1]);return new et({parentfeatureset:e[0],orderbyclause:i})}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"orderby",min:2,max:2}),n.functions.top=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),C(e[0]))return new tt({parentfeatureset:e[0],topnum:e[1]});if(k(e[0]))return _(e[1])>=e[0].length?e[0].slice():e[0].slice(0,_(e[1]));if(B(e[0]))return _(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,_(e[1]));throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"top",min:2,max:2}),n.functions.first=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,1,t,r),C(e[0])){const i=await e[0].first(w.abortSignal);if(i!==null){const o=_e.createFromGraphicLikeObject(i.geometry,i.attributes,e[0],t.timeZone);return o._underlyingGraphic=i,o}return i}return k(e[0])?e[0].length===0?null:e[0][0]:B(e[0])?e[0].length()===0?null:e[0].get(0):null})},n.signatures.push({name:"first",min:1,max:1}),n.functions.attachments=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,1,2,t,r);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof M){if(e[1].hasField("minsize")&&(i.minsize=_(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=Q(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=_(e[1].field("maxsize"))),e[1].hasField("types")){const o=qe(e[1].field("types"),!1);o.length>0&&(i.types=o)}}else if(e[1]!==null)throw new p(t,y.InvalidParameter,r)}if(Y(e[0])){const o=e[0]._layer;let l;if(C(o))l=o;else{if(o==null||!ke(o))return[];l=ne(o,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await l.load(),l.queryAttachments(e[0].field(l.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata)}if(e[0]===null)return[];throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"attachments",min:1,max:2}),n.functions.featuresetbyrelationshipname=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,2,4,t,r);const i=e[0],o=E(e[1]);let l=j(e[2],null);const f=Q(j(e[3],!0));if(l===null&&(l=["*"]),k(l)===!1)throw new p(t,y.InvalidParameter,r);if(e[0]===null)return null;if(!Y(e[0]))throw new p(t,y.InvalidParameter,r);const c=i._layer;let s;if(C(c))s=c;else{if(c==null||!ke(c))return null;s=ne(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}s=await s.load();const a=s.relationshipMetaData().filter(I=>I.name===o);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return nt(s,a[0],i.field(s.objectIdField),s.spatialReference,l,f,t.lrucache,t.interceptor);let d=s.serviceUrl();if(!d)return null;d=d.charAt(d.length-1)==="/"?d+a[0].relatedTableId.toString():d+"/"+a[0].relatedTableId.toString();const u=await it(d,s.spatialReference,l,f,t.lrucache,t.interceptor);await u.load();let x=u.relationshipMetaData();if(x=x.filter(I=>I.id===a[0].id),i.hasField(a[0].keyField)===!1||i.field(a[0].keyField)===null){const I=await s.getFeatureByObjectId(i.field(s.objectIdField),[a[0].keyField]);if(I){const F=D.create(x[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return F.parameters={id:I.attributes[a[0].keyField]},u.filter(F)}return new lt({parentfeatureset:u})}const N=D.create(x[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return N.parameters={id:i.field(a[0].keyField)},u.filter(N)})},n.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),n.functions.featuresetbyassociation=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{v(e,2,3,t,r);const i=e[0],o=E(j(e[1],"")).toLowerCase(),l=U(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!Y(e[0]))throw new p(t,y.InvalidParameter,r);let f=i._layer;if(f instanceof je&&(f=ne(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),f===null||C(f)===!1)return null;await f.load();const c=f.serviceUrl(),s=await rt(c,t.spatialReference,!0);if(s.unVersion>=8)return await bt(f,i,o,l,s,t,r);const a=s.associations;let d=null,u=null,x=!1;if(l!==null&&l!==""&&l!==void 0){for(const b of s.terminals)b.terminalName===l&&(u=b.terminalId);u===null&&(x=!0)}const N=a.getFieldsIndex(),I=N.get("TOGLOBALID").name,F=N.get("FROMGLOBALID").name,z=N.get("TOTERMINALID").name,R=N.get("FROMTERMINALID").name,G=N.get("FROMNETWORKSOURCEID").name,X=N.get("TONETWORKSOURCEID").name,H=N.get("ASSOCIATIONTYPE").name,Ze=N.get("ISCONTENTVISIBLE").name,Pe=N.get("OBJECTID").name;for(const b of f.fields)if(b.type==="global-id"){d=i.field(b.name);break}let $=null,we=new W(new P({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),Ie=new W(new P({name:"side",alias:"side",type:"string"}),D.create("''",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));const L="globalid",ge="globalId",he={};for(const b in s.lkp)he[b]=s.lkp[b].sourceId;const J=new at(new P({name:"classname",alias:"classname",type:"string"}),null,he);let h="";switch(o){case"midspan":{h=`((${I}='${d}') OR ( ${F}='${d}')) AND (${H} IN (5))`,J.codefield=D.create(`CASE WHEN (${I}='${d}') THEN ${G} ELSE ${X} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const b=de(Z.findField(a.fields,F));b.name=L,b.alias=L,$=new W(b,D.create(`CASE WHEN (${F}='${d}') THEN ${I} ELSE ${F} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),we=s.unVersion>=4?new le(Z.findField(a.fields,N.get("PERCENTALONG").name)):new W(new P({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{h=`((${I}='${d}') OR ( ${F}='${d}')) AND (${H} IN (4,6))`,J.codefield=D.create(`CASE WHEN (${I}='${d}') THEN ${G} ELSE ${X} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const b=de(Z.findField(a.fields,F));b.name=L,b.alias=L,$=new W(b,D.create(`CASE WHEN (${F}='${d}') THEN ${I} ELSE ${F} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),Ie=new W(new P({name:"side",alias:"side",type:"string"}),D.create(`CASE WHEN (${H}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let b=`${I}='@T'`,be=`${F}='@T'`;u!==null&&(b+=` AND ${z}=@A`,be+=` AND ${R}=@A`),h="(("+b+") OR ("+be+"))",h=ee(h,"@T",d??""),b=ee(b,"@T",d??""),u!==null&&(b=ee(b,"@A",u.toString()),h=ee(h,"@A",u.toString())),J.codefield=D.create("CASE WHEN "+b+` THEN ${G} ELSE ${X} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const re=de(Z.findField(a.fields,F));re.name=L,re.alias=L,$=new W(re,D.create("CASE WHEN "+b+` THEN ${F} ELSE ${I} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"container":h=`${I}='${d}' AND ${H} = 2`,u!==null&&(h+=` AND ${z} = `+u.toString()),J.codefield=G,h="( "+h+" )",$=new te(Z.findField(a.fields,F),L,L);break;case"content":h=`(${F}='${d}' AND ${H} = 2)`,u!==null&&(h+=` AND ${R} = `+u.toString()),J.codefield=X,h="( "+h+" )",$=new te(Z.findField(a.fields,I),L,L);break;case"structure":h=`(${I}='${d}' AND ${H} = 3)`,u!==null&&(h+=` AND ${z} = `+u.toString()),J.codefield=G,h="( "+h+" )",$=new te(Z.findField(a.fields,F),L,ge);break;case"attached":h=`(${F}='${d}' AND ${H} = 3)`,u!==null&&(h+=` AND ${R} = `+u.toString()),J.codefield=X,h="( "+h+" )",$=new te(Z.findField(a.fields,I),L,ge);break;default:throw new p(t,y.InvalidParameter,r)}return x&&(h="1 <> 1"),new Z({parentfeatureset:a,adaptedFields:[new le(Z.findField(a.fields,Pe)),new le(Z.findField(a.fields,Ze)),$,Ie,J,we],extraFilter:h?D.create(h,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}):null})})},n.signatures.push({name:"featuresetbyassociation",min:2,max:6}),n.functions.groupby=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,3,3,t,r),!C(e[0]))throw new p(t,y.InvalidParameter,r);const i=await e[0].load(),o=[],l=[];let f=!1,c=[];if(U(e[1]))c.push(e[1]);else if(e[1]instanceof M)c.push(e[1]);else if(k(e[1]))c=e[1];else{if(!B(e[1]))throw new p(t,y.InvalidParameter,r);c=e[1].toArray()}for(const s of c)if(U(s)){const a=D.create(E(s),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),d=Se(a)===!0?E(s):"%%%%FIELDNAME";o.push({name:d,expression:a}),d==="%%%%FIELDNAME"&&(f=!0)}else{if(!(s instanceof M))throw new p(t,y.InvalidParameter,r);{const a=s.hasField("name")?s.field("name"):"%%%%FIELDNAME",d=s.hasField("expression")?s.field("expression"):"";if(a==="%%%%FIELDNAME"&&(f=!0),!a)throw new p(t,y.InvalidParameter,r);o.push({name:a,expression:D.create(d||a,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(c=[],U(e[2]))c.push(e[2]);else if(k(e[2]))c=e[2];else if(B(e[2]))c=e[2].toArray();else{if(!(e[2]instanceof M))throw new p(t,y.InvalidParameter,r);c.push(e[2])}for(const s of c){if(!(s instanceof M))throw new p(t,y.InvalidParameter,r);{const a=s.hasField("name")?s.field("name"):"",d=s.hasField("statistic")?s.field("statistic"):"",u=s.hasField("expression")?s.field("expression"):"";if(!a||!d||!u)throw new p(t,y.InvalidParameter,r);l.push({name:a,statistic:d.toLowerCase(),expression:D.create(u,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(f){const s={};for(const d of i.fields)s[d.name.toLowerCase()]=1;for(const d of o)d.name!=="%%%%FIELDNAME"&&(s[d.name.toLowerCase()]=1);for(const d of l)d.name!=="%%%%FIELDNAME"&&(s[d.name.toLowerCase()]=1);let a=0;for(const d of o)if(d.name==="%%%%FIELDNAME"){for(;s["field_"+a.toString()]===1;)a++;s["field_"+a.toString()]=1,d.name="FIELD_"+a.toString()}}for(const s of o)ce(s.expression,n,t);for(const s of l)ce(s.expression,n,t);return e[0].groupby(o,l)})},n.signatures.push({name:"groupby",min:3,max:3}),n.functions.distinct=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(C(e[0])){v(e,2,2,t,r);const i=await e[0].load(),o=[];let l=[];if(U(e[1]))l.push(e[1]);else if(e[1]instanceof M)l.push(e[1]);else if(k(e[1]))l=e[1];else{if(!B(e[1]))throw new p(t,y.InvalidParameter,r);l=e[1].toArray()}let f=!1;for(const c of l)if(U(c)){const s=D.create(E(c),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),a=Se(s)===!0?E(c):"%%%%FIELDNAME";o.push({name:a,expression:s}),a==="%%%%FIELDNAME"&&(f=!0)}else{if(!(c instanceof M))throw new p(t,y.InvalidParameter,r);{const s=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",a=c.hasField("expression")?c.field("expression"):"";if(s==="%%%%FIELDNAME"&&(f=!0),!s)throw new p(t,y.InvalidParameter,r);o.push({name:s,expression:D.create(a||s,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(f){const c={};for(const a of i.fields)c[a.name.toLowerCase()]=1;for(const a of o)a.name!=="%%%%FIELDNAME"&&(c[a.name.toLowerCase()]=1);let s=0;for(const a of o)if(a.name==="%%%%FIELDNAME"){for(;c["field_"+s.toString()]===1;)s++;c["field_"+s.toString()]=1,a.name="FIELD_"+s.toString()}}for(const c of o)ce(c.expression,n,t);return e[0].groupby(o,[])}return It(e)})},n.functions.getfeaturesetinfo=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,1,1,t,r),!C(e[0]))return null;const i=await e[0].getFeatureSetInfo();return i?M.convertObjectToArcadeDictionary({layerId:i.layerId,layerName:i.layerName,itemId:i.itemId,serviceLayerUrl:i.serviceLayerUrl,webMapLayerId:i.webMapLayerId??null,webMapLayerTitle:i.webMapLayerTitle??null,className:null,objectClassId:null},De(t),!1,!1):null})},n.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),n.functions.filterbysubtypecode=function(t,r){return n.standardFunctionAsync(t,r,async(w,g,e)=>{if(v(e,2,2,t,r),C(e[0])){const i=await e[0].load(),o=e[1];if(!Oe(o))throw new p(t,y.InvalidParameter,r);if(i.subtypeField){const f=D.create(`${i.subtypeField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new se({parentfeatureset:e[0],whereclause:f})}if(i.typeIdField===null||i.typeIdField==="")throw new p(t,y.FeatureSetDoesNotHaveSubtypes,r);const l=D.create(`${i.typeIdField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new se({parentfeatureset:e[0],whereclause:l})}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{Yn as registerFunctions};
