import{iv as R,a5 as T,iw as E,a as L,d6 as C,ix as A,a8 as x,c as B,ck as p,aJ as Y,z as Z,ci as $,b5 as b}from"./main-BrXQBr3M.js";import{V as v}from"./featureConversionUtils-DRaHTjrY-fgjzbpdH.js";import{O as X}from"./PooledRBush-J5-OtqBl-BPvUcKNI.js";import{K as j,r as z}from"./timeSupport-_0FhDj9z-BU_U-AYv.js";import{o as U}from"./optimizedFeatureQueryEngineAdapter-Bx4OOJmK-CCXYJ5FT.js";import{$ as M}from"./normalizeUtils-b-vZURob-Cu-Bjt2-.js";import{T as K,p as O,h as w}from"./queryUtils-OXllLZed-BpQENmsE.js";import{h as k,v as J,d as Q}from"./QueryEngine-DEm6IK5j-CZ6Vwi1q.js";const q=5e4,u={minX:0,minY:0,maxX:0,maxY:0};function N(e){u.minX=e[0],u.minY=e[1],u.maxX=e[2],u.maxY=e[3]}function V(e,t,s){N(t),e.search(u,s)}class D{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new X(9,T("esri-csp-restrictions")?t=>({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const t=new Array(this._idByBounds.size);let s=0;this._idByBounds.forEach((i,n)=>{t[s++]=n}),this._indexInvalid=!1,this._index.clear(),this._index.load(t)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(t=>this._idByBounds.has(t))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const t=E();for(const s of this._boundsById.values())s&&(t[0]=Math.min(s[0],t[0]),t[1]=Math.min(s[1],t[1]),t[2]=Math.max(s[2],t[2]),t[3]=Math.max(s[3],t[3]));return t}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(t){const s=this._boundsById.get(t);this._boundsById.delete(t),s&&(this._idByBounds.delete(s),this._indexInvalid||this._index.remove(s))}forEachInBounds(t,s){this._loadIndex(),V(this._index,t,i=>s(this._idByBounds.get(i)))}get(t){return this._boundsById.get(t)}has(t){return this._boundsById.has(t)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(t,s){if(!this._indexInvalid){const i=this._boundsById.get(t);i&&(this._index.remove(i),this._idByBounds.delete(i))}this._boundsById.set(t,s),s&&(this._idByBounds.set(s,t),this._indexInvalid||(this._boundsToLoad.push(s),this._boundsToLoad.length>q&&this._loadIndex()))}}const G=R();let ae=class{constructor(e){this.geometryInfo=e,this._boundsStore=new D,this._featuresById=new Map,this._usedMemory=0,this.events=new L,this.featureAdapter=U}get usedMemory(){return this._usedMemory}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach(t=>{t.geometry!=null&&t.geometry.coords&&(e+=t.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(this.fullBounds==null)return null;const[t,s,i,n]=this.fullBounds;return{xmin:t,ymin:s,xmax:i,ymax:n,spatialReference:j(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map(s=>this._upsert(s));return this._emitChanged(),t.filter(C)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged(),this._usedMemory=0}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const s=this._featuresById.get(t);s&&this._remove(s)}this._emitChanged()}forEachBounds(e,t){for(const s of e){const i=this._boundsStore.get(s.objectId);i&&t(A(G,i))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach(t=>e(t))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,s=>{t(this._featuresById.get(s))})}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(t==null)return void x.getLogger("esri.layers.graphics.data.FeatureStore").error(new B("featurestore:invalid-feature","feature id is missing",{feature:e}));const s=this._featuresById.get(t);let i;if(s?(e.displayId=s.displayId,i=this._boundsStore.get(t),this._boundsStore.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0):this.onFeatureAdd!=null&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);i=v(i??p(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),i!=null&&this._boundsStore.set(t,i),this._featuresById.set(t,e),this._usedMemory+=this.estimateFeatureUsedMemory?.(e)??0}_upsert(e){const t=e?.objectId;if(t==null)return x.getLogger("esri.layers.graphics.data.FeatureStore").error(new B("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const s=this._featuresById.get(t);if(!s)return this._add(e),e;this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0;const{geometry:i,attributes:n}=e;for(const r in n)s.attributes[r]=n[r];return i&&(s.geometry=i,this._boundsStore.set(t,v(p(),i,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),this._usedMemory+=this.estimateFeatureUsedMemory?.(s)??0,s}_remove(e){this.onFeatureRemove!=null&&this.onFeatureRemove(e);const t=e.objectId;return this._boundsStore.delete(t),this._featuresById.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(e)??0,e}};async function oe(e,t,s){const i=Y(s),{point:n,distance:r,returnEdge:l,vertexMode:m}=t;if(!l&&m==="none")return{candidates:[]};let o=Z(t.query);o=await e.schedule(()=>K(o,e.definitionExpression,e.spatialReference),i),o=await e.reschedule(()=>k(o,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),i);const h=!$(n.spatialReference,e.spatialReference);h&&await O(n.spatialReference,e.spatialReference);const c=typeof r=="number"?r:r.x,y=typeof r=="number"?r:r.y,f={xmin:n.x-c,xmax:n.x+c,ymin:n.y-y,ymax:n.y+y,spatialReference:n.spatialReference},a=h?w(f,e.spatialReference):f;if(!a)return{candidates:[]};const _=(await M(b(n),null,{signal:i}))[0],g=(await M(b(a),null,{signal:i}))[0];if(_==null||g==null)return{candidates:[]};const d=new J(await e.reschedule(()=>e.searchFeatures(Q(g.toJSON())),i),o,e);await e.reschedule(()=>e.executeObjectIdsQuery(d),i),await e.reschedule(()=>e.executeTimeQuery(d),i),await e.reschedule(()=>e.executeAttributesQuery(d),i),await e.reschedule(()=>H(e,d,i),i);const I=_.toJSON(),S=h?w(I,e.spatialReference):I,F=h?Math.max(a.xmax-a.xmin,a.ymax-a.ymin)/2:r;return d.createSnappingResponse({...t,point:S,distance:F},n.spatialReference)}async function H(e,t,s){const{query:i}=t,{spatialRel:n}=i;if(!t?.items?.length||!i.geometry||!n)return;const r=await z(n,i.geometry,e.geometryType,e.hasZ,e.hasM),l=await e.runSpatialFilter(t.items,m=>r(m.geometry),s);t.items=l}export{ae as K,D as S,oe as W};
