import{v as f,aa as Q,ai as X,db as Z,aC as C,s as U,T as A,b7 as tt,h as q,e as et,z as D,k as it,A as rt,b as W,ae as ot,iv as N,iG as R,kK as k,iz as M,kL as st,Y as at,I as _,t as J,E as F,l as nt}from"./main-B4Df0LaK.js";import{K as lt,O}from"./projection-m8vi7Cxv-P0aHseLn.js";import{fromJSON as pt}from"./jsonUtils-DQiDyVGY-P5aowspj.js";import{O as mt}from"./FeatureSet-Dxf4LeOj-Cuy3f4QT.js";import{y as ht}from"./utils-DuaeuwP5-DBiJ7leT.js";import{o as T}from"./GraphicsCollection-rAFZo1AJ-Bbjpliw4.js";import{p as ct,z as ut,H as dt}from"./BitmapTechnique-BX6dC711-BHsZz-1I.js";import{n as ft}from"./BitmapContainer-DI2lgxqV-wbaHb1sY.js";import{D as yt}from"./LayerView2D-CCfp06E--ByJ8R3dv.js";import{d as E}from"./GraphicContainer-CEP0E1kz-BgmJsdM5.js";import{F as G}from"./GraphicsView2D-yiocyXG3-DHET2X26.js";import{v as gt}from"./LayerView-D3XoMhlx-BHKQ6F80.js";import{j as _t,D as wt}from"./rasterProjectionHelper-BV-HUScL-CMP3BfjW.js";import{_ as xt}from"./VertexStream-BTTQGT6f-BSnYECmh.js";import{v as bt,N as vt}from"./MaterialPrograms-B05fGOwm-_9rkPVFf.js";import{G as z,U as St,F as Vt,X as $}from"./enums-DBi1-Mm2-CUS1pvQe.js";import{f as It}from"./FramebufferObject-DQw0QX3p-BCIlsdBI.js";import{L as Pt}from"./rasterUtils-eBoM3Jzs-CtHQqDsW.js";import{H as B,O as Ct}from"./Texture-DXSFJsEu-8olzdxqB.js";import"./typeUtils-I5iG5ZKA-BeqRh46j.js";import"./ClassBreaksRenderer-D97YzbWp-CtJdejPA.js";import"./commonProperties-BLIn8DYU--vz_kHwx.js";import"./colorRamps-KMmVdCPJ-DCQwoqqB.js";import"./ColorStop-DoHCvOqO-D9aiP1VA.js";import"./visualVariableUtils-BO-_wo28-B8tOwVyW.js";import"./lengthUtils-wU9RRIqK-DlT8aqEI.js";import"./RendererLegendOptions-f5mIImtQ-nRDunNrC.js";import"./LRUCache-BLmkvs7b-cUIyUQIL.js";import"./MemCache-BCippCv6-h83PFZZD.js";import"./Version-BTMwSXf1-BezFgHmo.js";import"./FieldsIndex-Y7EBAYp0-CMDb93he.js";import"./timeZoneUtils-z3WjfjXQ-CFy5i1k0.js";import"./utils-BYqzY6_X-CjnuDVvs.js";import"./defaultCIMValues-gWpu7WSC-cjxb95kj.js";import"./enums-f9UUstHQ-hLTu4V1l.js";import"./heatmapUtils--OU2Fakh-BHsksCha.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./vec4f64-CjUMzAyX-DPYbdAom.js";import"./SimpleRenderer-ADQlYl8U-CgnfgtAT.js";import"./UniqueValueRenderer-BmoLL_Ee-BMOwdqHS.js";import"./diffUtils-BSe9IE26-BjWe09b5.js";import"./styleUtils-DxAOZq5S-B6IHJPdb.js";import"./Field-Cj6Pz3TI-7Kh5B7EF.js";import"./fieldType-VTpxE-EM-DfXCgZ6S.js";import"./mat3-DOnW3DjW-C3hbW9XY.js";import"./MapView-BcnxJC0k-XhKlBMoW.js";import"./globalCss-CFN4F315-CkOIrEan.js";import"./Queue-B8H6jIv7-CWN2Drql.js";import"./signal-DxzURL18-DU9shUFG.js";import"./CollectionFlattener-9hYRBLDX-BxhN1nWb.js";import"./workers-0oosFQiO-DL6WkP71.js";import"./intl-DLmy-Li5-DvNAY5zh.js";import"./TileInfo-owTCOSRx-BYSJCx_2.js";import"./TileKey-B_6qmYK--BtZdR-Xy.js";import"./jsxFactory-C5LxVioS-CmYczfeK.js";import"./uuid-Dj9mdEVg-BaKSCiyT.js";import"./UpdatingHandles-DBzjq66S-Csx99gqk.js";import"./Map-DbZVFU-I-oWvwAlTt.js";import"./Basemap-DxWxjcEH-1mU9LVsl.js";import"./loadAll-BIhJ1RSe-ClmT_CWO.js";import"./PortalItem-CJetnHeq-B5OCpHjs.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-BFStKTjU-BLcD6-H4.js";import"./Layer-B8q-l4yV-CQbjpD26.js";import"./TimeExtent-gZaEUVeW-Dcix5y2p.js";import"./HeightModelInfo-BkDck4B0-1Hw3gtfI.js";import"./ReactiveMap-BaMcQuG3-m5aPA47N.js";import"./Query-CxQYWcUQ-B3CaNqDP.js";import"./IViewEvents-BE10MM98-CvMfjolG.js";import"./HighlightDefaults-Cg50f_1y-BkWhG67y.js";import"./a11yUtils-C2ydunC--C67Vj0Ou.js";import"./heightModelInfoUtils-CI93rfC7-DZRKDXiA.js";import"./ViewingMode-CyR_b1T8-_s7_Gbsk.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./vec2f64-CEUyUoff-BBc0aQ6D.js";import"./mat2d-BQA-1WB--Pnyy0dhf.js";import"./normalizeUtils-b-vZURob-9NI1cyoE.js";import"./utils-Jw-4AGsF-Wbkmzvld.js";import"./mat2df32-BCnkwMW8-BLRY8i4P.js";import"./vec2f32-CVhmN3Me-DxoqVD7C.js";import"./Scheduler-Br-2v2ys-Da-cQ_A9.js";import"./vec32-BuqRmYBM-BygtSk7l.js";import"./unitBezier-DhyPAQO8-B9kUb8N6.js";import"./Tile-DvzRai0K-By6xxHsL.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./definitions-CBIQmVpq-o3EUznKY.js";import"./imageUtils-DEFspgr5-t3sFBkZb.js";import"./themeUtils-RB4IoNvm-uO-dsvgO.js";import"./ColorBackground-Dcc9SnXm-CeKolt5Z.js";import"./getDataTypeBytes-HSdrWtlL-ClHsCcSN.js";import"./Container-BdpN3llD-D_uMdgS7.js";import"./EffectView-Bw7SZPlx-DnOGFsd8.js";import"./parser-hXQyB-Qx-CYoJNA3B.js";import"./GraphShaderModule-C7Apfssb-KNEfGlqt.js";import"./ProgramTemplate-CBS0ERm4-DZY3RXud.js";import"./ShaderBuilder-BkQM64Qp-YZ8TA3uo.js";import"./BindType-CKbZk6AG-Bqvzo9NX.js";import"./TechniqueType-GommNIdJ-ByYTgVOB.js";import"./WGLContainer-CF3AeUnM-CsnzozHx.js";import"./dataViewUtils-xig9T3UA-NFB6ecDs.js";import"./VertexElementDescriptor-BAy1DPb3-BOhpDZGx.js";import"./BoundingBox-D9JxeQeA-SaxmeIkg.js";import"./VertexArrayObject-DTkLCIKs-CQufsYlK.js";import"./memoryEstimations-iHVpvWPf-Cx-GC3rz.js";import"./vec3f32-BS0cezmI-B_madU1n.js";import"./config-DB0LnTDt-CYa9nhWp.js";import"./earcut-XDcq3zAf-BcwyrT7l.js";import"./featureConversionUtils-DRaHTjrY-DznGJOdo.js";import"./OptimizedFeatureSet-D6mgsKNr-gDvHsWZJ.js";import"./OptimizedGeometry-1qDYm3YK-InGeJlwz.js";import"./utils-C0LvbFCo-RMQaTNpt.js";import"./layerViewUtils-Bk5QNiAa-jvrJ18ak.js";import"./AGraphicContainer-BSUvBxvy-CIrf3HpB.js";import"./TechniqueInstance-oJ4weLzg-Da47JwXp.js";import"./UpdateTracking2D-CaPtqow6-CBbuc_fH.js";import"./TileContainer-Dc8VVA_r-Cl-ffBNB.js";import"./FeatureCommandQueue-CqM9cs0l-CrMV6AWs.js";import"./CIMSymbolHelper-Bcp4nGf3-FH16quog.js";import"./BidiEngine-Bdqv5H5j-Dyqh9XG-.js";import"./fontUtils-Ce-zEYaT-BkZ_YVAb.js";import"./Rect-KI3be8Nv-CsoXZHcX.js";import"./rasterizingUtils-B8CPqgVl-BDtwU7C9.js";import"./floatRGBA-YJlz5IlR-BvjDe8Mc.js";import"./QueueProcessor-BtXHzeIT-CiJTJwNm.js";import"./OverrideHelper-GkMo7t6B-CjJcndbd.js";import"./colorUtils-DxUhbS7D-B5LMoaWP.js";import"./callExpressionWithFeature-uWLbeAgq-PoRJiP-9.js";import"./quantizationUtils-Cndke4AR-BMFQADGC.js";import"./FeatureMetadata-X_4q5T4e-B2-I03ak.js";import"./queryUtils-OXllLZed-CxdILFBz.js";import"./json-BI97KiBB-Ce5cWfI2.js";import"./timeSupport-_0FhDj9z-CFvWRgok.js";import"./TimeOnly-C3SOkmg2-0IQWrc5r.js";import"./labelUtils-Dd5sr1UJ-BszXRO5-.js";import"./mat3f64-Dh9_zhFu-BIT-k8Dm.js";import"./normalizeUtilsSync-C40q69cc-DdRc1LCh.js";import"./dehydratedFeatures-CekTKTy7-SuMrKJ9A.js";import"./utils-BddLNd1v-CNFuVXWo.js";import"./webglDeps-BKBjGpbm-gMsGrSEr.js";import"./NestedMap-Ddo7BfvO-BpVPk8mz.js";import"./renderState-DlSSrLcZ-Du_EmLq6.js";import"./glsl-o28TenZV-B0eZUNn3.js";import"./testSVGPremultipliedAlpha-CdWnvpEj-C-FVSRRp.js";import"./doublePrecisionUtils-BJbYwoii-kIP-tL_t.js";const Dt={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function kt(e){const t=e.folders||[],i=t.slice(),o=new Map,r=new Map,s=new Map,p=new Map,m=new Map,l={esriGeometryPoint:r,esriGeometryPolyline:s,esriGeometryPolygon:p};(e.featureCollection?.layers||[]).forEach(a=>{const c=D(a);c.featureSet.features=[];const h=a.featureSet.geometryType;o.set(h,c);const y=a.layerDefinition.objectIdField;h==="esriGeometryPoint"?L(r,y,a.featureSet.features):h==="esriGeometryPolyline"?L(s,y,a.featureSet.features):h==="esriGeometryPolygon"&&L(p,y,a.featureSet.features)}),e.groundOverlays&&e.groundOverlays.forEach(a=>{m.set(a.id,a)}),t.forEach(a=>{a.networkLinkIds.forEach(c=>{const h=Tt(c,a.id,e.networkLinks);h&&i.push(h)})}),i.forEach(a=>{if(a.featureInfos){a.points=D(o.get("esriGeometryPoint")),a.polylines=D(o.get("esriGeometryPolyline")),a.polygons=D(o.get("esriGeometryPolygon")),a.mapImages=[];for(const c of a.featureInfos)switch(c.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const h=l[c.type].get(c.id);h&&a[Dt[c.type]]?.featureSet.features.push(h);break}case"GroundOverlay":{const h=m.get(c.id);h&&a.mapImages.push(h);break}}a.fullExtent=H([a])}});const n=H(i);return{folders:t,sublayers:i,extent:n}}function Mt(e,t,i,o){const r=nt?.findCredential(e);e=it(e,{token:r?.token});const s=rt.kmlServiceUrl;return W(s,{query:{url:e,model:"simple",folders:"",refresh:i!==0||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:o})}function gr(e,t,i=null,o=[]){const r=[],s={},p=t.sublayers,m=new Set(t.folders.map(l=>l.id));return p.forEach(l=>{const n=new e;if(i?n.read(l,i):n.read(l),o.length&&m.has(n.id)&&(n.visible=o.includes(n.id)),s[l.id]=n,l.parentFolderId!=null&&l.parentFolderId!==-1){const a=s[l.parentFolderId];a.sublayers||(a.sublayers=[]),a.sublayers?.unshift(n)}else r.unshift(n)}),r}function L(e,t,i){i.forEach(o=>{e.set(o.attributes[t],o)})}function Rt(e,t){let i;return t.some(o=>o.id===e&&(i=o,!0)),i}function Tt(e,t,i){const o=Rt(e,i);return o&&(o.parentFolderId=t,o.networkLink=o),o}async function j(e){const t=mt.fromJSON(e.featureSet).features,i=e.layerDefinition,o=pt(i.drawingInfo.renderer),r=ot.fromJSON(e.popupInfo),s=[];for(const p of t){const m=await o.getSymbolAsync(p);p.symbol=m,p.popupTemplate=r,p.visible=!0,s.push(p)}return s}function H(e){const t=N(R),i=N(R);for(const o of e){if(o.polygons?.featureSet?.features)for(const r of o.polygons.featureSet.features)k(t,r.geometry),M(i,t);if(o.polylines?.featureSet?.features)for(const r of o.polylines.featureSet.features)k(t,r.geometry),M(i,t);if(o.points?.featureSet?.features)for(const r of o.points.featureSet.features)k(t,r.geometry),M(i,t);if(o.mapImages)for(const r of o.mapImages)k(t,r.extent),M(i,t)}return st(i,R)?void 0:{xmin:i[0],ymin:i[1],zmin:i[2],xmax:i[3],ymax:i[4],zmax:i[5],spatialReference:A.WGS84}}let w=class extends at{constructor(){super(...arguments),this.id=0,this.rotation=0,this.href="",this.extent=new U}};f([_({nonNullable:!0,json:{write:!0}})],w.prototype,"id",void 0),f([_({nonNullable:!0,json:{write:!0}})],w.prototype,"rotation",void 0),f([_({nonNullable:!0,json:{write:!0}})],w.prototype,"href",void 0),f([_({type:U,nonNullable:!0,json:{write:!0}})],w.prototype,"extent",void 0),w=f([J("esri.layers.support.KMLMapImage")],w);class u{constructor(t){if(this._ownsRctx=!1,t)this._ownsRctx=!1,this._rctx=t;else{if(u._instance)return u._instanceRefCount++,u._instance;u._instanceRefCount=1,u._instance=this,this._ownsRctx=!0;const r=document.createElement("canvas").getContext("webgl2");r.getExtension("OES_texture_float"),this._rctx=new bt(r,{})}const i={applyProjection:!0,bilinear:!1,bicubic:!1},o=vt("raster/reproject","raster/reproject",new Map([["a_position",0]]),i);this._program=this._rctx.programCache.acquire(o.shaders.vertexShader,o.shaders.fragmentShader,o.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new xt(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(t,i,o=!1){const r=O(t.extent,i),s=new F({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:p,y:m}=_t(s,i,t.extent);let l=(p+m)/2;const n=Math.round((r.xmax-r.xmin)/l),a=Math.round((r.ymax-r.ymin)/l);l=(r.width/n+r.height/a)/2;const c=new F({x:l,y:l,spatialReference:r.spatialReference}),h=wt({projectedExtent:r,srcBufferExtent:t.extent,pixelSize:c,hasWrapAround:!0,spacing:[16,16]}),y=Pt(this._rctx,h),v=new B(n,a);v.wrapMode=z.CLAMP_TO_EDGE;const d=new It(this._rctx,v);this._rctx.bindFramebuffer(d),this._rctx.setViewport(0,0,n,a),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(y,1),this._quad.bind();const{width:S=0,height:V=0}=t.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",S,V),this._program.setUniform2fv("u_transformSpacing",h.spacing),this._program.setUniform2fv("u_transformGridSize",h.size),this._program.setUniform2f("u_targetImageSize",n,a),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),y.dispose(),o){const{width:g,height:P}=d,b=new ImageData(g??0,P??0);d.readPixels(0,0,g??0,P??0,St.RGBA,Vt.UNSIGNED_BYTE,b.data);const Y=d.detachColorTexture($.COLOR_ATTACHMENT0);return d.dispose(),{texture:Y,extent:r,imageData:b}}const I=d.detachColorTexture($.COLOR_ATTACHMENT0);return d.dispose(),{texture:I,extent:r}}reprojectBitmapData(t,i){const o=ut(t.bitmapData)?dt(t.bitmapData):t.bitmapData,r=new B;r.wrapMode=z.CLAMP_TO_EDGE,r.width=t.bitmapData.width,r.height=t.bitmapData.height;const s=new Ct(this._rctx,r,o),p=this.reprojectTexture({texture:s,extent:t.extent},i,!0);p.texture.dispose();const m=document.createElement("canvas"),l=p.imageData;return m.width=l.width,m.height=l.height,m.getContext("2d").putImageData(l,0,0),{bitmapData:m,extent:p.extent}}async loadAndReprojectBitmapData(t,i,o){const r=(await W(t,{responseType:"image"})).data,s=document.createElement("canvas");s.width=r.width,s.height=r.height;const p=s.getContext("2d");p.drawImage(r,0,0);const m=p.getImageData(0,0,s.width,s.height);if(i.spatialReference.equals(o))return{bitmapData:m,extent:i};const l=this.reprojectBitmapData({bitmapData:m,extent:i},o);return{bitmapData:l.bitmapData,extent:l.extent}}destroy(){this._ownsRctx?(u._instanceRefCount--,u._instanceRefCount===0&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),u._instance=null)):(this._quad.dispose(),this._program.dispose())}}u._instanceRefCount=0;class K{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}}let x=class extends yt(gt){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new ft,this._kmlVisualData=new K,this._fetchController=null,this.allVisiblePoints=new T,this.allVisiblePolylines=new T,this.allVisiblePolygons=new T,this.allVisibleMapImages=new Q}async hitTest(e,t){const i=this.layer;return[this._pointsView?.hitTest(e),this._polylinesView?.hitTest(e),this._polygonsView?.hitTest(e)].flat().filter(Boolean).map(o=>(o.layer=i,o.sourceLayer=i,{type:"graphic",graphic:o,layer:i,mapPoint:e}))}update(e){this._polygonsView&&this._polygonsView.processUpdate(e),this._polylinesView&&this._polylinesView.processUpdate(e),this._pointsView&&this._pointsView.processUpdate(e)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new G({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new G({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new G({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on("change",e=>{e.added.forEach(t=>this._addMapImage(t)),e.removed.forEach(t=>this._removeMapImage(t))}),X(()=>this.layer.visibleSublayers,e=>{for(const t of this._kmlVisualData.allSublayers.values())t.visibility=0;for(const t of e){const i=this._kmlVisualData.allSublayers.get(t.id);i&&(i.visibility=1)}this._refreshCollections()})]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new u}detach(){this._fetchController=Z(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=C(this._polygonsView),this._polylinesView=C(this._polylinesView),this._pointsView=C(this._pointsView),this._imageReprojector=C(this._imageReprojector)}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(e){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(e.href,e.extent,this.view.spatialReference).then(t=>{const i=new ct(t.bitmapData);i.x=t.extent.xmin,i.y=t.extent.ymax,i.resolution=t.extent.width/t.bitmapData.width,i.rotation=e.rotation,this._mapImageContainer.addChild(i),this._bitmapIndex.set(e,i)})}async _getViewDependentUrl(e,t){const{viewFormat:i,viewBoundScale:o,httpQuery:r}=e;if(i!=null){if(t==null)throw new Error("Loading this network link requires a view state.");let s;if(await lt(),o!=null&&o!==1){const g=new U(t.extent);g.expand(o),s=g}else s=t.extent;s=O(s,A.WGS84);const p=O(s,A.WebMercator),m=s.xmin,l=s.xmax,n=s.ymin,a=s.ymax,c=t.size[0]*t.pixelRatio,h=t.size[1]*t.pixelRatio,y=Math.max(p.width,p.height),v={"[bboxWest]":m.toString(),"[bboxEast]":l.toString(),"[bboxSouth]":n.toString(),"[bboxNorth]":a.toString(),"[lookatLon]":s.center.x.toString(),"[lookatLat]":s.center.y.toString(),"[lookatRange]":y.toString(),"[lookatTilt]":"0","[lookatHeading]":t.rotation.toString(),"[lookatTerrainLon]":s.center.x.toString(),"[lookatTerrainLat]":s.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":s.center.x.toString(),"[cameraLat]":s.center.y.toString(),"[cameraAlt]":y.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":c.toString(),"[vertPixels]":h.toString(),"[terrainEnabled]":"0","[clientVersion]":tt,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"},d=g=>{for(const P in g){let b;for(b in v)g[P]=g[P].replace(b,v[b])}},S=q(i);d(S);let V={};r!=null&&(V=q(r),d(V));const I=ht(e.href);return I.query={...I.query,...S,...V},`${I.path}?${et(S)}`}return e.href}async _fetchService(e){const t=new K;await this._loadVisualData(this.layer.url,t,e),this._kmlVisualData=t,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e)),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e)),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e)),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e))}_isSublayerVisible(e){const t=this._kmlVisualData.allSublayers.get(e);return!!t?.visibility&&(t.parentFolderId===-1||this._isSublayerVisible(t.parentFolderId))}_loadVisualData(e,t,i){return this._fetchParsedKML(e,i).then(async o=>{for(const r of o.sublayers){t.allSublayers.set(r.id,r);const s=r.points?await j(r.points):[],p=r.polylines?await j(r.polylines):[],m=r.polygons?await j(r.polygons):[],l=r.mapImages?.map(n=>w.fromJSON(n))??[];if(t.allPoints.push(...s.map(n=>({item:n,sublayerId:r.id}))),t.allPolylines.push(...p.map(n=>({item:n,sublayerId:r.id}))),t.allPolygons.push(...m.map(n=>({item:n,sublayerId:r.id}))),t.allMapImages.push(...l.map(n=>({item:n,sublayerId:r.id}))),r.networkLink){const n=await this._getViewDependentUrl(r.networkLink,this.view.state);await this._loadVisualData(n,t,i)}}})}_fetchParsedKML(e,t){return Mt(e,this.layer.spatialReference,this.layer.refreshInterval,t).then(i=>kt(i.data))}_removeMapImage(e){const t=this._bitmapIndex.get(e);t&&(this._mapImageContainer.removeChild(t),this._bitmapIndex.delete(e))}};f([_()],x.prototype,"_pointsView",void 0),f([_()],x.prototype,"_polylinesView",void 0),f([_()],x.prototype,"_polygonsView",void 0),f([_()],x.prototype,"updating",void 0),x=f([J("esri.views.2d.layers.KMLLayerView2D")],x);const Et=x,_r=Object.freeze(Object.defineProperty({__proto__:null,default:Et},Symbol.toStringTag,{value:"Module"}));export{_r as K,gr as S,kt as d,Mt as g,H as j};
