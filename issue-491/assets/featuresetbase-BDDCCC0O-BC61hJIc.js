import{r as Fe}from"./TimeOnly-DSMefxKy-C40xLNTs.js";import{N as Z,t as De,D as Te,l as J}from"./arcadeUtils-DpP0k7IY-BfjOS2gM.js";import{w as x,h as $e,c as Y,r as N,T as c,n as m,y as C,M as E,P as xe,e as de,d as ue,D as ce,g as L,L as k,C as b,t as G,Z as M,U as Ee,f as O,ag as be,q,O as Ne}from"./languageUtils-BYxF9hRA-R8hCK3Ed.js";import{M as Ae,q as me,f as Le,c as _,e as Se,a as Ze,b as Ce,T as X,E as ve,N as Pe,O as Re,L as U,B as Ue,d as V,R as S,k as ee}from"./featureSetUtils-wd4FcF3A-CKRQ0h8a.js";import{n as Me}from"./ImmutableArray-CiJxhY8_-Kqx7aWRu.js";import{n as ke}from"./portalUtils-CKN9iXwH-QB-hRoZK.js";import{E as Oe,e as pe}from"./SpatialFilter-BlQBFhwz-DZ6OXK1v.js";import{I as ne}from"./shared-D1w-26bA-OK1RGup9.js";import{r as ye,t as ze}from"./main-B4qmu9Sm.js";import{Z as $}from"./WhereClause-DxwoyBMS-C7X6G4QK.js";import te from"./FeatureLayer-BrRKw5Si-Lb0mrh6Z.js";import{y as W}from"./Field-C6hA1tZj-pMTQ637d.js";import"./UnknownTimeZone-C--TOcPG-Bpt_3Rye.js";import"./featureConversionUtils-D6hFQ4Af-YKqF49d4.js";import"./OptimizedFeature-EIithYlr-Cq64mIT3.js";import"./OptimizedFeatureSet-DfZGBuxJ-C08BOAgi.js";import"./FieldsIndex-HmzMbJQG-BNuEHHiE.js";import"./number-eRKYXfX9-CtlI-tHH.js";import"./uuid-Dj9mdEVg-BaKSCiyT.js";import"./Query-BrwMGK8U-BcaaqPDu.js";import"./TimeExtent-Cn0Jofqr-j5c0CwgE.js";import"./fieldType-CD2CL2hr-CCMCn7k7.js";import"./MD5-CHHr-oed-SuyrCYQ0.js";import"./RelationshipQuery-DJsz3K0U-BbVi0xAt.js";import"./FeatureType-C9hJmS6_-DsrTQyPh.js";import"./FeatureTemplate-SPHPD45f-s1MR8YN_.js";import"./Layer-ChoECxvZ-CL8WOcRr.js";import"./PortalItem-CctGdnxF-Bh36VPYQ.js";import"./geometryEngineAsync-D7oEu5dd-RK82g5Ec.js";import"./workers-PiCjreoO-CO-vlPHx.js";import"./UniqueValueRenderer-fS5V0Ej1-Btug1NVb.js";import"./RendererLegendOptions-K3md58-X-B6boUMTz.js";import"./diffUtils-Cz3Fi8Xb-7a2MeS9v.js";import"./colorRamps-q0bZVhs2-C9moCcro.js";import"./sizeVariableUtils-t52KcLLi-D0hbQF8b.js";import"./visualVariableUtils-D3kZJRyn-DuWmoyIx.js";import"./compilerUtils-CV1QYWI8-B17Ns0r-.js";import"./lengthUtils-DKpMe5qR-DMg8L4A9.js";import"./styleUtils-BtpNqZyT-CcWQW415.js";import"./jsonUtils-C64Zfu7c-oOzc2JLf.js";import"./LRUCache-C3erQTWv-DsunpEpv.js";import"./Version-CoKzbupV-Di0p-MGl.js";import"./OverrideHelper-DWRbVlj1-BwTtk6Oj.js";import"./colorUtils-Cthpxcks-Ced_K3DL.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./vec4f64-hf2nxvhQ-CaAr8PTM.js";import"./utils-SPbpQbmm-AjfaCDY4.js";import"./enums-CpSG_SL3-BMD3Tb1v.js";import"./quantizationUtils-bJy1cRwp-Dl6BzCRx.js";import"./heatmapUtils-seiMkkkR-CpYIyyiF.js";import"./MultiOriginJSONSupport-DKRh9P6w-Dmxl9F3L.js";import"./commonProperties-BtIqvFU_-mXby8xMf.js";import"./ElevationInfo-yv2-9tj6-CGaxv8Fc.js";import"./FeatureLayerBase-vvYyZTfh-BQNrkNl_.js";import"./HeightModelInfo-C5vFqzyF-B6jKbv2_.js";import"./arcgisLayerUrl-HNYh8jvG-DX7-HV8u.js";import"./featureLayerUtils-DgfQQyK4-CuEdNZL_.js";import"./LayerFloorInfo-DRJ8wfwx-Ci3_sVaD.js";import"./Relationship-PyhUibYK-B4BZkv3A.js";import"./serviceCapabilitiesUtils-rPjN5QBe-B7lCFgv0.js";import"./editsZScale-BDsX6vv--DudE7s9N.js";import"./queryZScale-BiYV6Pr6-BSxQI788.js";import"./projection-BA9M1R7d-BBLUP_tV.js";import"./projectBuffer-CvCBvJ6W-DoZ2jUop.js";import"./FeatureSet-BkVNthuN-CgHqhDXc.js";import"./APIKeyMixin-BUMSx9ny-BjMC4cbi.js";import"./ArcGISService-BYA-y6X6-BCz6BkEb.js";import"./BlendLayer-D1WkSmwP-L_H9YCiJ.js";import"./jsonUtils-wIllKWI4-_PZ8Xdz_.js";import"./parser-DyDJ-rlI-DUbhyUv3.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-DX7gBViE-DzwQEsJx.js";import"./CustomParametersMixin-vdKsTHer-B5SXTUhx.js";import"./EditBusLayer-Df29OyJh-D8Wtp_lh.js";import"./FeatureEffectLayer-Cro89IEC-Cws9Uc-N.js";import"./FeatureEffect-CDEk9Es7-K3EOdkNO.js";import"./FeatureFilter-BCFHgLVU-DVYBhmw0.js";import"./FeatureReductionLayer-BTZjL0_Z-DaO7c80-.js";import"./FeatureReductionSelection-BjX3h7Sz-BBNzFP6C.js";import"./labelingInfo-DGVNul26-6bMPKmOm.js";import"./labelUtils-BW14kBqX-C2dGm9aA.js";import"./OperationalLayer-B5IXiMa2-fy6vxsco.js";import"./OrderedLayer-6Qsmrd_l-DxEca5ao.js";import"./OrderByInfo-GD2XnU8e-BdGyM4zG.js";import"./PortalLayer-CElnYuSQ-BeM6p1Hf.js";import"./portalItemUtils-B8bw6SAG-BgR8s2_7.js";import"./RefreshableLayer-a8BQ58Xh-iCySRAVC.js";import"./ScaleRangeLayer-Bz0DcnvM-BBUOFfQd.js";import"./TemporalLayer-CpOrN_w9-BvpMZY0l.js";import"./TimeInfo-w_HB2CsF-BV2hRgI0.js";import"./fieldProperties-Bq26w7gt-DzrdJTPf.js";import"./versionUtils-LZYZz-38-CWtdunYr.js";import"./styleUtils-ChrJTYIw-JB1OlUcs.js";import"./popupUtils-B0uZcXX0-Cpn_-elf.js";import"./AlphaCutoff-ZPx1GqOi-UcccL64p.js";import"./interfaces-Cwm0pihk-Ptzy6gTd.js";function He(r){if(r.length===1){if(b(r[0]))return J("distinct",r[0],-1);if(M(r[0]))return J("distinct",r[0].toArray(),-1)}return J("distinct",r,-1)}async function ie(r,n,i){const y=r.getVariables();if(y.length>0){const F=[];for(let t=0;t<y.length;t++){const o={name:y[t]};F.push(await n.evaluateIdentifier(i,o))}const e={};for(let t=0;t<y.length;t++)e[y[t]]=F[t];return r.parameters=e,r}return r}function u(r,n,i=null){for(const y in r)if(y.toLowerCase()===n.toLowerCase())return r[y];return i}function we(r){if(r===null)return null;const n={type:u(r,"type",""),name:u(r,"name","")};if(n.type==="range")n.range=u(r,"range",[]);else{n.codedValues=[];for(const i of u(r,"codedValues",[]))n.codedValues.push({name:u(i,"name",""),code:u(i,"code",null)})}return n}function ae(r){if(r===null)return null;const n={},i=u(r,"wkt");i!==null&&(n.wkt=i);const y=u(r,"wkid");return y!==null&&(n.wkid=y),n}function he(r){if(r===null)return null;const n={hasZ:u(r,"hasz",!1),hasM:u(r,"hasm",!1)},i=u(r,"spatialreference");i!=null&&(n.spatialReference=ae(i));const y=u(r,"x",null);if(y!==null)return n.x=y,n.y=u(r,"y",null),n.hasZ&&(n.z=u(r,"z",null)),n.hasM&&(n.m=u(r,"m",null)),n;const F=u(r,"rings",null);if(F!==null)return n.rings=F,n;const e=u(r,"paths",null);if(e!==null)return n.paths=e,n;const t=u(r,"points",null);if(t!==null)return n.points=t,n;for(const o of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=u(r,o,null);s!==null&&(n[o]=s)}return n}function je(r,n){for(const i of n)if(i===r)return!0;return!1}function We(r){return!!r.layerDefinition&&!!r.featureSet&&je(r.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&b(r.layerDefinition.fields)!==!1&&b(r.featureSet.features)!==!1}function z(r){return r?.toLowerCase()==="utc"?"UTC":r?.toLowerCase()==="unknown"?"Unknown":r}function Pt(r){r.mode==="async"&&(r.functions.timezone=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,1,2,n,i),$e(e[0])||Y(e[0]))return"Unknown";if(N(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?z("unknown"):z(e[0].dateFieldsTimeZone);if(!(e[1]instanceof Z)||e[1].hasField("type")===!1)throw new c(n,m.InvalidParameter,i);const s=e[1].field("type");if(C(s)===!1)throw new c(n,m.InvalidParameter,i);switch(E(s).toLowerCase()){case"preferredtimezone":return z(e[0].preferredTimeZone);case"editfieldsinfo":return z(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return z(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&C(e[1].field("fieldname")))return z(e[0].fieldTimeZone(E(e[1].field("fieldname"))))}throw new c(n,m.InvalidParameter,i)}const t=xe(e[0],de(n));if(t===null)return null;const o=t.timeZone;return o==="system"?Fe.systemTimeZoneCanonicalName:o.toLowerCase()==="utc"?"UTC":o.toLowerCase()==="unknown"?"Unknown":o})},r.functions.sqltimestamp=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{x(e,1,3,n,i);const t=e[0];if(ue(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new c(n,m.InvalidParameter,i)}if(Y(t))return t.toSQLWithKeyword();if(N(t)){if(e.length!==3)throw new c(n,m.InvalidParameter,i);await t.load();const o=E(e[1]);if(Y(e[2]))return e[2].toSQLWithKeyword();if(ue(e[2])===!1)throw new c(n,m.InvalidParameter,i);const s=t.fieldTimeZone(o);return s===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(s).toSQLWithKeyword()}throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"sqltimestamp",min:2,max:4}),r.functions.featuresetbyid=function(n,i){return r.standardFunctionAsync(n,i,(y,F,e)=>{if(x(e,2,4,n,i),ce(e[0])){const t=E(e[1]);let o=L(e[2],null);const s=k(L(e[3],!0));if(o===null&&(o=["*"]),b(o)===!1)throw new c(n,m.InvalidParameter,i);return e[0].featureSetById(t,s,o)}throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"featuresetbyid",min:2,max:4}),r.functions.getfeatureset=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,1,2,n,i),G(e[0])){let t=L(e[1],"datasource");return t===null&&(t="datasource"),t=E(t).toLowerCase(),Ae(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference??null)}throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"getfeatureset",min:1,max:2}),r.functions.featuresetbyportalitem=function(n,i){return r.standardFunctionAsync(n,i,(y,F,e)=>{if(x(e,2,5,n,i),e[0]===null)throw new c(n,m.PortalRequired,i);if(e[0]instanceof De){const f=E(e[1]),a=E(e[2]);let l=L(e[3],null);const d=k(L(e[4],!0));if(l===null&&(l=["*"]),b(l)===!1)throw new c(n,m.InvalidParameter,i);let w;return w=n.services?.portal?n.services.portal:ye.getDefault(),w=ke(e[0],w),me(f,a,n.spatialReference??null,l,d,w,n.lrucache,n.interceptor)}if(C(e[0])===!1)throw new c(n,m.PortalRequired,i);const t=E(e[0]),o=E(e[1]);let s=L(e[2],null);const p=k(L(e[3],!0));if(s===null&&(s=["*"]),b(s)===!1)throw new c(n,m.InvalidParameter,i);return me(t,o,n.spatialReference??null,s,p,n.services?.portal??ye.getDefault(),n.lrucache,n.interceptor)})},r.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),r.functions.featuresetbyname=function(n,i){return r.standardFunctionAsync(n,i,(y,F,e)=>{if(x(e,2,4,n,i),ce(e[0])){const t=E(e[1]);let o=L(e[2],null);const s=k(L(e[3],!0));if(o===null&&(o=["*"]),b(o)===!1)throw new c(n,m.InvalidParameter,i);return e[0].featureSetByName(t,s,o)}throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"featuresetbyname",min:2,max:4}),r.functions.featureset=function(n,i){return r.standardFunction(n,i,(y,F,e)=>{x(e,1,1,n,i);const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(C(e[0])){const o=JSON.parse(e[0]);o.layerDefinition!==void 0?(t.layerDefinition=o.layerDefinition,t.featureSet=o.featureSet,o.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=o.layerDefinition.spatialReference)):(t.featureSet.features=o.features,t.featureSet.geometryType=o.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=o.objectIdFieldName??"",t.layerDefinition.typeIdField=o.typeIdFieldName,t.layerDefinition.globalIdField=o.globalIdFieldName,t.layerDefinition.fields=o.fields,o.spatialReference&&(t.layerDefinition.spatialReference=o.spatialReference))}else{if(!(e[0]instanceof Z))throw new c(n,m.InvalidParameter,i);{const o=JSON.parse(e[0].castToText(!0)),s=u(o,"layerdefinition");if(s!==null){t.layerDefinition.geometryType=u(s,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=u(s,"globalidfield",""),t.layerDefinition.objectIdField=u(s,"objectidfield",""),t.layerDefinition.typeIdField=u(s,"typeidfield",""),t.layerDefinition.hasZ=u(s,"hasz",!1)===!0,t.layerDefinition.hasM=u(s,"hasm",!1)===!0;const p=u(s,"spatialreference");p&&(t.layerDefinition.spatialReference=ae(p));const f=[];for(const l of u(s,"fields",[])){const d={name:u(l,"name",""),alias:u(l,"alias",""),type:u(l,"type",""),nullable:u(l,"nullable",!0),editable:u(l,"editable",!0),length:u(l,"length",null),domain:we(u(l,"domain"))};f.push(d)}t.layerDefinition.fields=f;const a=u(o,"featureset");if(a){const l={};for(const d of f)l[d.name.toLowerCase()]=d.name;for(const d of u(a,"features",[])){const w={},D=u(d,"attributes",{});for(const g in D)w[l[g.toLowerCase()]]=D[g];t.featureSet.features.push({attributes:w,geometry:he(u(d,"geometry"))})}}}else{t.layerDefinition.hasZ=u(o,"hasz",!1)===!0,t.layerDefinition.hasM=u(o,"hasm",!1)===!0,t.layerDefinition.geometryType=u(o,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=u(o,"objectidfieldname",""),t.layerDefinition.typeIdField=u(o,"typeidfieldname","");const p=u(o,"spatialreference");p&&(t.layerDefinition.spatialReference=ae(p));const f=[],a=u(o,"fields",null);if(!b(a))throw new c(n,m.InvalidParameter,i);for(const w of a){const D={name:u(w,"name",""),alias:u(w,"alias",""),type:u(w,"type",""),nullable:u(w,"nullable",!0),editable:u(w,"editable",!0),length:u(w,"length",null),domain:we(u(w,"domain"))};f.push(D)}t.layerDefinition.fields=f;const l={};for(const w of f)l[w.name.toLowerCase()]=w.name;let d=u(o,"features",null);if(b(d))for(const w of d){const D={},g=u(w,"attributes",{});for(const T in g)D[l[T.toLowerCase()]]=g[T];t.featureSet.features.push({attributes:D,geometry:he(u(w,"geometry",null))})}else d=null,t.featureSet.features=d}}}if(We(t)===!1)throw new c(n,m.InvalidParameter,i);return t.layerDefinition.geometryType||(t.layerDefinition.geometryType="esriGeometryNull"),Le.create(t,n.spatialReference)})},r.signatures.push({name:"featureset",min:1,max:1}),r.functions.filter=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,2,2,n,i),b(e[0])||M(e[0])){const t=[];let o,s=e[0];if(s instanceof Me&&(s=s.toArray()),!Ee(e[1]))throw new c(n,m.InvalidParameter,i);o=e[1].createFunction(n);for(const p of s){const f=o(p);ze(f)?await f===!0&&t.push(p):f===!0&&t.push(p)}return t}if(N(e[0])){const t=await e[0].load(),o=$.create(e[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),s=o.getVariables();if(s.length>0){const p=[];for(let a=0;a<s.length;a++){const l={name:s[a]};p.push(await r.evaluateIdentifier(n,l))}const f={};for(let a=0;a<s.length;a++)f[s[a]]=p[a];return o.parameters=f,new _({parentfeatureset:e[0],whereclause:o})}return new _({parentfeatureset:e[0],whereclause:o})}throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"filter",min:2,max:2}),r.functions.orderby=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,2,2,n,i),N(e[0])){const t=new Se(e[1]);return new Ze({parentfeatureset:e[0],orderbyclause:t})}throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"orderby",min:2,max:2}),r.functions.top=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,2,2,n,i),N(e[0]))return new Ce({parentfeatureset:e[0],topnum:e[1]});if(b(e[0]))return O(e[1])>=e[0].length?e[0].slice():e[0].slice(0,O(e[1]));if(M(e[0]))return O(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,O(e[1]));throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"top",min:2,max:2}),r.functions.first=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,1,1,n,i),N(e[0])){const t=await e[0].first(y.abortSignal);if(t!==null){const o=Te.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeZone);return o._underlyingGraphic=t,o}return t}return b(e[0])?e[0].length===0?null:e[0][0]:M(e[0])?e[0].length()===0?null:e[0].get(0):null})},r.signatures.push({name:"first",min:1,max:1}),r.functions.attachments=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{x(e,1,2,n,i);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof Z){if(e[1].hasField("minsize")&&(t.minsize=O(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=k(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=O(e[1].field("maxsize"))),e[1].hasField("types")){const o=be(e[1].field("types"),!1);o.length>0&&(t.types=o)}}else if(e[1]!==null)throw new c(n,m.InvalidParameter,i)}if(G(e[0])){let o=e[0]._layer;return o instanceof te&&(o=X(o,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),o===null?[]:N(o)===!1?[]:(await o.load(),o.queryAttachments(e[0].field(o.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata))}if(e[0]===null)return[];throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"attachments",min:1,max:2}),r.functions.featuresetbyrelationshipname=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{x(e,2,4,n,i);const t=e[0],o=E(e[1]);let s=L(e[2],null);const p=k(L(e[3],!0));if(s===null&&(s=["*"]),b(s)===!1)throw new c(n,m.InvalidParameter,i);if(e[0]===null)return null;if(!G(e[0]))throw new c(n,m.InvalidParameter,i);let f=t._layer;if(f instanceof te&&(f=X(f,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),f===null||N(f)===!1)return null;f=await f.load();const a=f.relationshipMetaData().filter(g=>g.name===o);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return ve(f,a[0],t.field(f.objectIdField),f.spatialReference,s,p,n.lrucache,n.interceptor);let l=f.serviceUrl();if(!l)return null;l=l.charAt(l.length-1)==="/"?l+a[0].relatedTableId.toString():l+"/"+a[0].relatedTableId.toString();const d=await Pe(l,f.spatialReference,s,p,n.lrucache,n.interceptor);await d.load();let w=d.relationshipMetaData();if(w=w.filter(g=>g.id===a[0].id),t.hasField(a[0].keyField)===!1||t.field(a[0].keyField)===null){const g=await f.getFeatureByObjectId(t.field(f.objectIdField),[a[0].keyField]);if(g){const T=$.create(w[0].keyField+"= @id",{fieldsIndex:d.getFieldsIndex(),timeZone:d.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:g.attributes[a[0].keyField]},d.filter(T)}return new Oe({parentfeatureset:d})}const D=$.create(w[0].keyField+"= @id",{fieldsIndex:d.getFieldsIndex(),timeZone:d.dateFieldsTimeZoneDefaultUTC});return D.parameters={id:t.field(a[0].keyField)},d.filter(D)})},r.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),r.functions.featuresetbyassociation=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{x(e,2,3,n,i);const t=e[0],o=E(L(e[1],"")).toLowerCase(),s=C(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!G(e[0]))throw new c(n,m.InvalidParameter,i);let p=t._layer;if(p instanceof te&&(p=X(p,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),p===null||N(p)===!1)return null;await p.load();const f=p.serviceUrl(),a=await Re(f,n.spatialReference);let l=null,d=null,w=!1;if(s!==null&&s!==""&&s!==void 0){for(const I of a.terminals)I.terminalName===s&&(d=I.terminalId);d===null&&(w=!0)}const D=a.associations.getFieldsIndex(),g=D.get("TOGLOBALID").name,T=D.get("FROMGLOBALID").name,B=D.get("TOTERMINALID").name,K=D.get("FROMTERMINALID").name,H=D.get("FROMNETWORKSOURCEID").name,j=D.get("TONETWORKSOURCEID").name,R=D.get("ASSOCIATIONTYPE").name,ge=D.get("ISCONTENTVISIBLE").name,Ie=D.get("OBJECTID").name;for(const I of p.fields)if(I.type==="global-id"){l=t.field(I.name);break}let v=null,re=new U(new W({name:"percentalong",alias:"percentalong",type:"double"}),$.create("0",{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC})),oe=new U(new W({name:"side",alias:"side",type:"string"}),$.create("''",{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));const A="globalid",le="globalId",se={};for(const I in a.lkp)se[I]=a.lkp[I].sourceId;const P=new Ue(new W({name:"classname",alias:"classname",type:"string"}),null,se);let h="";switch(o){case"midspan":{h=`((${g}='${l}') OR ( ${T}='${l}')) AND (${R} IN (5))`,P.codefield=$.create(`CASE WHEN (${g}='${l}') THEN ${H} ELSE ${j} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC});const I=ne(S.findField(a.associations.fields,T));I.name=A,I.alias=A,v=new U(I,$.create(`CASE WHEN (${T}='${l}') THEN ${g} ELSE ${T} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC})),re=a.unVersion>=4?new ee(S.findField(a.associations.fields,D.get("PERCENTALONG").name)):new U(new W({name:"percentalong",alias:"percentalong",type:"double"}),$.create("0",{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{h=`((${g}='${l}') OR ( ${T}='${l}')) AND (${R} IN (4,6))`,P.codefield=$.create(`CASE WHEN (${g}='${l}') THEN ${H} ELSE ${j} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC});const I=ne(S.findField(a.associations.fields,T));I.name=A,I.alias=A,v=new U(I,$.create(`CASE WHEN (${T}='${l}') THEN ${g} ELSE ${T} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC})),oe=new U(new W({name:"side",alias:"side",type:"string"}),$.create(`CASE WHEN (${R}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let I=`${g}='@T'`,fe=`${T}='@T'`;d!==null&&(I+=` AND ${B}=@A`,fe+=` AND ${K}=@A`),h="(("+I+") OR ("+fe+"))",h=q(h,"@T",l??""),I=q(I,"@T",l??""),d!==null&&(I=q(I,"@A",d.toString()),h=q(h,"@A",d.toString())),P.codefield=$.create("CASE WHEN "+I+` THEN ${H} ELSE ${j} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC});const Q=ne(S.findField(a.associations.fields,T));Q.name=A,Q.alias=A,v=new U(Q,$.create("CASE WHEN "+I+` THEN ${T} ELSE ${g} END`,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}));break}case"container":h=`${g}='${l}' AND ${R} = 2`,d!==null&&(h+=` AND ${B} = `+d.toString()),P.codefield=H,h="( "+h+" )",v=new V(S.findField(a.associations.fields,T),A,A);break;case"content":h=`(${T}='${l}' AND ${R} = 2)`,d!==null&&(h+=` AND ${K} = `+d.toString()),P.codefield=j,h="( "+h+" )",v=new V(S.findField(a.associations.fields,g),A,A);break;case"structure":h=`(${g}='${l}' AND ${R} = 3)`,d!==null&&(h+=` AND ${B} = `+d.toString()),P.codefield=H,h="( "+h+" )",v=new V(S.findField(a.associations.fields,T),A,le);break;case"attached":h=`(${T}='${l}' AND ${R} = 3)`,d!==null&&(h+=` AND ${K} = `+d.toString()),P.codefield=j,h="( "+h+" )",v=new V(S.findField(a.associations.fields,g),A,le);break;default:throw new c(n,m.InvalidParameter,i)}return w&&(h="1 <> 1"),new S({parentfeatureset:a.associations,adaptedFields:[new ee(S.findField(a.associations.fields,Ie)),new ee(S.findField(a.associations.fields,ge)),v,oe,P,re],extraFilter:h?$.create(h,{fieldsIndex:a.associations.getFieldsIndex(),timeZone:a.associations.dateFieldsTimeZoneDefaultUTC}):null})})},r.signatures.push({name:"featuresetbyassociation",min:2,max:6}),r.functions.groupby=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,3,3,n,i),!N(e[0]))throw new c(n,m.InvalidParameter,i);const t=await e[0].load(),o=[],s=[];let p=!1,f=[];if(C(e[1]))f.push(e[1]);else if(e[1]instanceof Z)f.push(e[1]);else if(b(e[1]))f=e[1];else{if(!M(e[1]))throw new c(n,m.InvalidParameter,i);f=e[1].toArray()}for(const a of f)if(C(a)){const l=$.create(E(a),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),d=pe(l)===!0?E(a):"%%%%FIELDNAME";o.push({name:d,expression:l}),d==="%%%%FIELDNAME"&&(p=!0)}else{if(!(a instanceof Z))throw new c(n,m.InvalidParameter,i);{const l=a.hasField("name")?a.field("name"):"%%%%FIELDNAME",d=a.hasField("expression")?a.field("expression"):"";if(l==="%%%%FIELDNAME"&&(p=!0),!l)throw new c(n,m.InvalidParameter,i);o.push({name:l,expression:$.create(d||l,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(f=[],C(e[2]))f.push(e[2]);else if(b(e[2]))f=e[2];else if(M(e[2]))f=e[2].toArray();else{if(!(e[2]instanceof Z))throw new c(n,m.InvalidParameter,i);f.push(e[2])}for(const a of f){if(!(a instanceof Z))throw new c(n,m.InvalidParameter,i);{const l=a.hasField("name")?a.field("name"):"",d=a.hasField("statistic")?a.field("statistic"):"",w=a.hasField("expression")?a.field("expression"):"";if(!l||!d||!w)throw new c(n,m.InvalidParameter,i);s.push({name:l,statistic:d.toLowerCase(),expression:$.create(w,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(p){const a={};for(const d of t.fields)a[d.name.toLowerCase()]=1;for(const d of o)d.name!=="%%%%FIELDNAME"&&(a[d.name.toLowerCase()]=1);for(const d of s)d.name!=="%%%%FIELDNAME"&&(a[d.name.toLowerCase()]=1);let l=0;for(const d of o)if(d.name==="%%%%FIELDNAME"){for(;a["field_"+l.toString()]===1;)l++;a["field_"+l.toString()]=1,d.name="FIELD_"+l.toString()}}for(const a of o)await ie(a.expression,r,n);for(const a of s)await ie(a.expression,r,n);return e[0].groupby(o,s)})},r.signatures.push({name:"groupby",min:3,max:3}),r.functions.distinct=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(N(e[0])){x(e,2,2,n,i);const t=await e[0].load(),o=[];let s=[];if(C(e[1]))s.push(e[1]);else if(e[1]instanceof Z)s.push(e[1]);else if(b(e[1]))s=e[1];else{if(!M(e[1]))throw new c(n,m.InvalidParameter,i);s=e[1].toArray()}let p=!1;for(const f of s)if(C(f)){const a=$.create(E(f),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),l=pe(a)===!0?E(f):"%%%%FIELDNAME";o.push({name:l,expression:a}),l==="%%%%FIELDNAME"&&(p=!0)}else{if(!(f instanceof Z))throw new c(n,m.InvalidParameter,i);{const a=f.hasField("name")?f.field("name"):"%%%%FIELDNAME",l=f.hasField("expression")?f.field("expression"):"";if(a==="%%%%FIELDNAME"&&(p=!0),!a)throw new c(n,m.InvalidParameter,i);o.push({name:a,expression:$.create(l||a,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(p){const f={};for(const l of t.fields)f[l.name.toLowerCase()]=1;for(const l of o)l.name!=="%%%%FIELDNAME"&&(f[l.name.toLowerCase()]=1);let a=0;for(const l of o)if(l.name==="%%%%FIELDNAME"){for(;f["field_"+a.toString()]===1;)a++;f["field_"+a.toString()]=1,l.name="FIELD_"+a.toString()}}for(const f of o)await ie(f.expression,r,n);return e[0].groupby(o,[])}return He(e)})},r.functions.getfeaturesetinfo=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,1,1,n,i),!N(e[0]))return null;const t=await e[0].getFeatureSetInfo();return t?Z.convertObjectToArcadeDictionary({layerId:t.layerId,layerName:t.layerName,itemId:t.itemId,serviceLayerUrl:t.serviceLayerUrl,webMapLayerId:t.webMapLayerId??null,webMapLayerTitle:t.webMapLayerTitle??null,className:null,objectClassId:null},de(n),!1,!1):null})},r.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),r.functions.filterbysubtypecode=function(n,i){return r.standardFunctionAsync(n,i,async(y,F,e)=>{if(x(e,2,2,n,i),N(e[0])){const t=await e[0].load(),o=e[1];if(!Ne(o))throw new c(n,m.InvalidParameter,i);if(t.subtypeField){const p=$.create(`${t.subtypeField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new _({parentfeatureset:e[0],whereclause:p})}if(t.typeIdField===null||t.typeIdField==="")throw new c(n,m.FeatureSetDoesNotHaveSubtypes,i);const s=$.create(`${t.typeIdField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new _({parentfeatureset:e[0],whereclause:s})}throw new c(n,m.InvalidParameter,i)})},r.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{Pt as registerFunctions};
