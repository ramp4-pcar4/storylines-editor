import{dK as N,dL as P,dM as $,dN as h,dO as j,bA as b,cJ as A,dP as R,c_ as v,dQ as S,h as x,bL as O,dR as W,dS as _,dT as k}from"./main-166dfadA.js";import{k as F}from"./MD5-CXHDUqXT-CMrYdOi6.js";import{n as J}from"./multiOriginJSONSupportUtils-DGETddQl-BrWaY9_8.js";import{r as K}from"./uuid-Dj9mdEVg-BaKSCiyT.js";import{e as y}from"./resourceExtension-DCCj0Izs-BAZEp0O2.js";function Y(e){const t=e?.origins??[void 0];return(s,n)=>{const r=L(e,s,n);for(const c of t){const i=N(s,c,n);for(const o in r)i[o]=r[o]}}}function L(e,t,s){if(e?.type==="resource")return M(e,t,s);switch(e?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:n,write:r}=k;return{read:n,write:r}}}}function M(e,t,s){const n=P(t,s);return{type:String,read:(r,c,i)=>{const o=$(r,c,i);return n.type===String?o:typeof n.type=="function"?new n.type({url:o}):void 0},write:{isRequired:n.json?.write?.isRequired,writer(r,c,i,o){if(!o?.resources)return typeof r=="string"?void(c[i]=h(r,o)):void(c[i]=r.write({},o));const a=Z(r),p=h(a,{...o,verifyItemRelativeUrls:o?.verifyItemRelativeUrls?{writtenUrls:o.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},j.NO),d=n.type!==String&&(!J(this)||o?.origin&&this.originIdOf(s)>b(o.origin)),u={object:this,propertyName:s,value:r,targetUrl:p,dest:c,targetPropertyName:i,context:o,params:e};o?.portalItem&&p&&!A(p)?d&&e?.contentAddressed?g(u):d?q(u):C(u):o?.portalItem&&(p==null||R(p)!=null||v(p)||d)?g(u):c[i]=p}}}}function g(e){const{targetUrl:t,params:s,value:n,context:r,dest:c,targetPropertyName:i}=e;if(!r.portalItem)return;const o=S(t),a=U(n,t,r);if(s?.contentAddressed&&a.type!=="json")return void r.messages?.push(new x("persistable:contentAddressingUnsupported",`Property "${i}" is trying to serializing a resource with content of type ${a.type} with content addressing. Content addressing is only supported for json resources.`,{content:a}));const p=s?.contentAddressed&&a.type==="json"?F(a.jsonString):o?.filename??K(),d=O(s?.prefix??o?.prefix,p),u=`${d}.${y(a)}`;if(s?.contentAddressed&&r.resources&&a.type==="json"){const f=r.resources.toKeep.find(({resource:m})=>m.path===u)??r.resources.toAdd.find(({resource:m})=>m.path===u);if(f)return void(c[i]=f.resource.itemRelativeUrl)}const l=r.portalItem.resourceFromPath(u);v(t)&&r.resources&&r.resources.pendingOperations.push(W(t).then(f=>{l.path=`${d}.${y({type:"blob",blob:f})}`,c[i]=l.itemRelativeUrl}).catch(()=>{}));const I=s?.compress??!1;r.resources&&w({...e,resource:l,content:a,compress:I,updates:r.resources.toAdd}),c[i]=l.itemRelativeUrl}function q(e){const{context:t,targetUrl:s,params:n,value:r,dest:c,targetPropertyName:i}=e;if(!t.portalItem)return;const o=t.portalItem.resourceFromPath(s),a=U(r,s,t),p=y(a),d=_(o.path),u=n?.compress??!1;p===d?(t.resources&&w({...e,resource:o,content:a,compress:u,updates:t.resources.toUpdate}),c[i]=s):g(e)}function C({context:e,targetUrl:t,dest:s,targetPropertyName:n}){e.portalItem&&e.resources&&(e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(t),compress:!1}),s[n]=t)}function w({object:e,propertyName:t,updates:s,resource:n,content:r,compress:c}){const i=o=>{z(e,t,o)};s.push({resource:n,content:r,compress:c,finish:i})}function U(e,t,s){return typeof e=="string"?{type:"url",url:t}:{type:"json",jsonString:JSON.stringify(e.toJSON(s))}}function Z(e){return e==null?null:typeof e=="string"?e:e.url}function z(e,t,s){typeof e[t]=="string"?e[t]=s.url:e[t].url=s.url}export{Y as k};
