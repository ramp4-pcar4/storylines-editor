import{v as l,kJ as Ee,S as C,n as Fe,a1 as Ae,aM as ze,a6 as ke,ag as hs,a2 as ds,ac as ms,bv as gs,o as ys,b0 as fs,l as ws,an as bs,b9 as Rt,h as xs,ba as _s,ki as A}from"./main-BTSN56ll.js";import{C as wt,j as St,F as vs,y as Ce,r as Cs}from"./datasetUtils-DYlC2Qty-MsHFMS6J.js";import{g as Ts,o as Rs,n as Ss}from"./RasterVFDisplayObject-CjEe9AcH-fQniRNEK.js";import{G as Ps}from"./LayerView2D-BaefGYf9-DKBEBBo2.js";import{V as Is}from"./pixelRangeUtils-DcEknavd-DdeXXJfY.js";import{O as zs}from"./clipUtils-fw7VCGXU-4TGP2Vi7.js";import{y as Pt,m as ks,e as Me}from"./MapView-DVZSZHRJ-BKcJTAWs.js";import{Q as Ms,E as It,R as Fs,D as Qe,G as Vs,I as Bs}from"./mat3-DOnW3DjW-C3hbW9XY.js";import{r as De}from"./vec2f32-hTAvipMV-C0AQcwEv.js";import{u as Os}from"./Container-Dr2EdOEZ-Bs_3znaC.js";import{L as Ds,P as Xe,G as Ke,H as Gs,Y as As,U as Us,N as Ge}from"./enums-wEDHPbCF-Cf76M5_x.js";import{F as Ls,L as js,M as $s,G as et}from"./rasterUtils-CV4tTwvB-DDkFkrNh.js";import{q as zt}from"./WGLContainer-qQmF3DRB-BED0Hb5y.js";import{U as bt,k as qs,a as Es,j as tt}from"./enums-CQnCd4Rx-CHYIFQNv.js";import{h as kt}from"./TileContainer-CAC1uSjc--XASOAAc.js";import{K as m,F as Mt,V as _,B as pe,o as We,Z as Q,p,P as f,j as G,h as fe,ae,z as Ft,w as st,G as Ws,b as oe,af as Ns,f as Zs,a1 as Hs,ag as Qs,M as P,ah as Xs,N as Ys,ai as Js,aj as Ks,T as ei,ak as ti,al as si,am as ii,X as ri,an as ai,q as oi,ab as Ne,L as $,ao as ni,ap as li,aq as ui,ar as ci,as as pi,m as D,i as we,y as Vt,at as q,H as X,e as hi,W as Y,au as di,av as Ye,aw as mi,I as K,s as W,C as ht,ax as gi,O as I,Y as ie,U as b,J as Bt,g as _e,D as Ot,R as w,S as T,r as N,a as B,d as yi,ay as fi,u as E,t as it,n as wi,_ as bi,a5 as Dt,a0 as Gt,c as dt,az as ee,aA as te,$ as xt,l as mt}from"./GraphShaderModule-Baq-N_YO-C9LlFMpx.js";import{a as z}from"./TechniqueType-CMl1wqtX-7TDFwBxa.js";import{C as xi}from"./bitmapUtils-CAdCGIbP-NVq_npG1.js";import{A as _i,T as be}from"./utils-OrDMNKn4-DmEeVC39.js";import{t as ce}from"./definitions-MCCItX4r-o3EUznKY.js";import{d as vi}from"./FramebufferObject-D3QloItC-CvYpmj6z.js";import{Y as Ci,_ as Ti}from"./Texture-D5XWO2GQ-BW1yTigi.js";import{g as xe,V as Ri,U as Si}from"./dataUtils-CfR0oe2x-BYhS84Cs.js";import{i as Pi}from"./UpdatingHandles-Bd2FQ26N-fdvxC52e.js";import{a as _t}from"./TileInfo-U28GysF5-BqbA-B0e.js";import{t as vt,X as Ct,P as Ii,V as zi}from"./RawBlockCache-B-F6OWAv-CO4JHdLZ.js";import{E as ki,H as Mi,g as Fi,c as Tt,j as Vi}from"./rasterProjectionHelper-DGqzGF1m-ivSF2QpW.js";import"./TileKey-_zikB14n-B_YPRHpo.js";import{r as Bi}from"./Scheduler-BV4C4cVP-Dp9HvkB4.js";import{s as Oi}from"./capabilities-BaKzUyhi-y5w2NMiP.js";import{c as Di}from"./timeSupport-BlIpM2Fj-iNgnEkDM.js";import{i as Gi}from"./popupUtils-B9dNptlM-DrZ7JZPs.js";import{t as Ai}from"./LayerView-DdANuT-Y-CkOm9Qvo.js";import{o as Ui}from"./RefreshableLayerView-CqFW21Do-Bt8VXYQe.js";import"./Field-BIQ-quF4-BbpT1uvV.js";import"./fieldType-PhcL4ff8-2FwHs2Q-.js";import"./VertexArrayObject-CieliEx4-C1vhnmiU.js";import"./memoryEstimations-DeWfxwaV-C_MXa_yR.js";import"./VertexElementDescriptor-DLvjNrmQ-BHK9ksow.js";import"./Utils-Co3xiu1z-DRdUzBjJ.js";import"./BoundingBox-DlCd_wcU-DBB4UfPl.js";import"./getDataTypeBytes-DYbftOSj-BNZIboqJ.js";import"./utils-C0LvbFCo-RMQaTNpt.js";import"./ReactiveMap-iPeM8evD-CN1yLKEz.js";import"./layerViewUtils-DLIaYA64-Bsq38kLs.js";import"./Cyclical-DgD7_U1C-Vht-WHcK.js";import"./CollectionFlattener-DyEG1Q6J-BvSyZFgI.js";import"./workers-CeRXsnNJ-CuNDy0kC.js";import"./Queue-DV3gpSdl-DrFVJ5S7.js";import"./intl-BAA1onnp-B6SUCtGp.js";import"./projectionUtils-B-CplN3q-ikZX0f0r.js";import"./jsxFactory-Cua8zWVZ-B71T2Hwm.js";import"./uuid-Dj9mdEVg-BaKSCiyT.js";import"./sanitizerUtils-B1yRmbO2-B7KG_jBT.js";import"./asyncUtils-BPUlNCrX-nCXgmiAN.js";import"./utils-Dd8gTonD-I__WhOUn.js";import"./Version-CnwD6MZa-BOky48_S.js";import"./Map-7V1pm_Jo-CZetJqxN.js";import"./Basemap-C_NhFN5u-CegcWrt4.js";import"./loadAll-DQWsVoX1-CLJrFPIK.js";import"./PortalItem-BP-IQXnZ-OaDplu4L.js";import"./writeUtils-DAOvycBP-CBCBr7XL.js";import"./persistable-DgPk2hdg-BV4R3GmF.js";import"./MD5-CXHDUqXT-CMrYdOi6.js";import"./multiOriginJSONSupportUtils-DGETddQl-BrWaY9_8.js";import"./resourceExtension-DCCj0Izs-C07PdJmK.js";import"./PolygonCollection-Btw6sA7T-DpXnVm1H.js";import"./editableLayers-DFUBlMJy-D3scqz7b.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-OOmHNWi7-BzZ95Pzo.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./TablesMixin-BORwbVPt-DgkBli8R.js";import"./Layer-DvVVmz9x-DPlUpQTx.js";import"./TimeExtent-Cf2Pienb-DqqrEWFg.js";import"./GraphicsCollection-uWAVmks7-7OmK9l4y.js";import"./HeightModelInfo-C4voFc4k-HtHKRM55.js";import"./timeZoneUtils-d5p0Jda1-D0y-OBmm.js";import"./Query-n1aoaaFC-DtAFAKLZ.js";import"./IViewEvents-BE10MM98-CvMfjolG.js";import"./mat2df64-DDXwUeaJ-Tu7q-7Mk.js";import"./a11yUtils-CoCwThtH-CyxXc5qL.js";import"./projectionUtils-Dt6hj1Xh-DH_kUzRY.js";import"./ViewingMode-CdRKcXnc-Dab70bGf.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./vec2f64-CkowXrDb-3zFQ3LNH.js";import"./mat2d-BQA-1WB--Pnyy0dhf.js";import"./normalizeUtils-u00NGW3M-CqNqSQXu.js";import"./normalizeUtilsCommon-ClagynAA-CjzxcKnv.js";import"./utils-BO8hgPs3-DVCOsJGh.js";import"./utils-DpLVEUvg-Bxd2nj3H.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./vec32-Cj8pVsU0-CAadxa6x.js";import"./unitBezier-DhyPAQO8-B9kUb8N6.js";import"./imageUtils-D3tfFRL_-ReIuWbl9.js";import"./modeUtils-deizL-Tg-C4WiXKJs.js";import"./ILyr3DWasmPerSceneView-ChV4bxX0-B4BXvxji.js";import"./ColorBackground-C0D6MT0d-CzLQbL7l.js";import"./TileKey-B_6qmYK--BtZdR-Xy.js";import"./debugFlags-8tOwPnHK-iUEbNTwF.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./EffectView-Bpu5U548-Cf4tGL3_.js";import"./parser-CWccHtwJ-C7ev2h0Q.js";import"./ProgramTemplate-C4wmhGXE-C7IdNiH_.js";import"./vec3f32-GX_cKsFD-UJPpzdNc.js";import"./StyleDefinition-BOKVAZI1-BlGlrLNa.js";import"./enums-a_LDTPYU-CBIcy3mM.js";import"./config-CmYJx2vm-DFBdNYhW.js";import"./earcut-C6NeZYSh-Da0ULCQ5.js";import"./featureConversionUtils-Bjjlcfdo-jKUq9C94.js";import"./OptimizedFeature-mIz_HhJg-S7foeqDf.js";import"./OptimizedGeometry-pzfNw1AT-Df37wV8I.js";import"./OptimizedFeatureSet-Dz5hF8Qm-B1brSkRC.js";import"./ShaderBuilder-CU5v4tk1-BPHCM-0F.js";import"./BindType-CKbZk6AG-Bqvzo9NX.js";import"./constants-oLcGh8d3-CJuD0gcX.js";const Li={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let ji=class extends Os{constructor(t=null,e=null,s=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=t,this.transformGrid=e,this.interpolation=s}destroy(){this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(t){this._processedTexture!==t&&(this._disposeTextures(!0),this._processedTexture=t)}get rasterTexture(){return this._rasterTexture}set rasterTexture(t){this._rasterTexture!==t&&(this._rasterTexture?.dispose(),this._rasterTexture=t),t==null&&(this.projected=!1)}get processed(){return this._processed}set processed(t){this._processed=t,t||(this.processedTexture=A(this.processedTexture),this.invalidateTexture())}get symbolizerParameters(){return this._symbolizerParameters||Li}set symbolizerParameters(t){this._symbolizerParameters!==t&&(this._symbolizerParameters=t,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(t){this._source!==t&&(this._source=t,this._rasterTexture&&(this._rasterTexture=A(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this._maskTexture=A(this._maskTexture))}get suspended(){return this._suspended}set suspended(t){this._suspended&&!t&&this.stage&&(this.ready(),this.requestRender()),this._suspended=t}get bandIds(){return this._bandIds}set bandIds(t){this._bandIds=t,this._isBandIdsChanged(t)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(t||"nearest")==="bilinear"?Ke.LINEAR:Ke.NEAREST)}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid!==t&&(this._transformGrid=t,this._transformGridTexture=A(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(t=!1){const e=t||this.projected;return[e?this.width:this.source?.width||this.width,e?this.height:this.source?.height||this.height]}getRasterCellSize(){const t=this.rawPixelData?.srcPixelSize,{projected:e,resolution:s}=this;return t&&!e?[t.x,t.y]:[s,s]}_createTransforms(){return{displayViewScreenMat3:Me()}}setTransform(t){const e=Fs(this.transforms.displayViewScreenMat3),[s,i]=t.toScreenNoRotation([0,0],[this.x,this.y]),r=this.resolution/this.pixelRatio/t.resolution,a=r*this.width,o=r*this.height,n=Math.PI*this.rotation/180;Qe(e,e,De(s,i)),Qe(e,e,De(a/2,o/2)),Vs(e,e,-n),Qe(e,e,De(-a/2,-o/2)),Bs(e,e,De(a,o)),It(this.transforms.displayViewScreenMat3,t.displayViewMat3,e)}getTextures({forProcessing:t=!1,useProcessedTexture:e=!1}={}){const s=e?this._processedTexture??this._rasterTexture:this._rasterTexture,i=[],r=[];return s?(this._transformGridTexture&&!this.projected&&(r.push(this._transformGridTexture),i.push("u_transformGrid")),r.push(s),i.push("u_image"),!this._colormapTexture||!e&&t||(r.push(this._colormapTexture),i.push("u_colormap")),this._maskTexture&&(r.push(this._maskTexture),i.push("u_mask")),{names:i,textures:r}):{names:i,textures:r}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:t}){if(!this.stage)return void this._disposeTextures();const e=this._isValidSource(this.source);e&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(t)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(t),this._rasterTexture&&(e?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Ls(t,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=js(t,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(){const{functionTextures:t}=this;t.length!==0&&(this.processedTexture=t.shift(),t.forEach(e=>e?.dispose()),t.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(t){const e=this.source?.extractBands(this.bandIds);if(!this._isValidSource(e))return void(this._rasterTexture&&(this._rasterTexture=A(this._rasterTexture),this._rasterTextureBandIds=null));const s=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(s)return;this._rasterTexture=A(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!t.capabilities.textureFloatLinear;const i=this._getTextureSamplingMethod(this.interpolation),r=this.isRendereredSource;this._rasterTexture=$s(t,e,i,r),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(t){const e=this._rasterTextureBandIds;return!(e==null&&t==null||e&&t&&e.join("")===t.join(""))}_isValidSource(t){return t!=null&&t.pixels?.length>0}_getTextureSamplingMethod(t){const{type:e}=this.symbolizerParameters,s=e==="lut"&&!this.symbolizerParameters.isClassBreaks||e==="hillshade"||e==="stretch"&&this.symbolizerParameters.bandCount===1;return!this._supportsBilinearTexture||s||t!=="bilinear"&&t!=="cubic"?"nearest":"bilinear"}_updateColormapTexture(t){const e=this._colormap,s=this.symbolizerParameters.colormap;return s?e?s.length!==e.length||s.some((i,r)=>i!==e[r])?(this._colormapTexture&&(this._colormapTexture=A(this._colormapTexture)),this._colormapTexture=et(t,s),void(this._colormap=s)):void 0:(this._colormapTexture=et(t,s),void(this._colormap=s)):(this._colormapTexture&&(this._colormapTexture=A(this._colormapTexture)),void(this._colormap=null))}_disposeTextures(t=!1){t?this.projected&&(this._transformGridTexture=A(this._transformGridTexture)):(this._rasterTexture=A(this._rasterTexture),this._colormapTexture=A(this._colormapTexture),this._transformGridTexture=A(this._transformGridTexture),this._maskTexture=A(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=A(this._processedTexture)}},$i=class extends zt{constructor(t,e,s,i,r,a,o=null){super(t,e,s,i,r,a),this.bitmap=null,this.bitmap=new ji(o,null,null),this.bitmap.coordScale=[r,a],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}setTransform(t){super.setTransform(t),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:Me(),tileMat3:Me()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}};function qi(t,e,s,i){const r=X(e.multiply(s)),a=new ee(new P(r.x),new P(r.y)),o=new ee(a.x.add(1),a.y),n=new ee(a.x,a.y.add(1)),u=new ee(a.x.add(1),a.y.add(1)),c=te(t,a,new P(0)),h=te(t,o,new P(0)),d=te(t,n,new P(0)),y=te(t,u,new P(0)),g=dt(e.multiply(s)),x=W(c,h,g.x),v=W(d,y,g.x),S=W(x,v,g.y);if(!i)return S;const k=new f(c.a,h.a,d.a,y.a),R=k.xy.multiply(k.zw),j=X(R.x.multiply(R.y).add(.5)),J=S.multiply(j),He=be(j).multiply(T(t,e));return J.add(He)}class Te extends I{}function Ei(t,e){const s=T(e.transformTexture,t);return new b(s.r,s.g)}function Wi(t,e){const{transformTexture:s,targetImageSize:i,transformSpacing:r}=e,a=X(t.multiply(i)),o=new b(4,1),n=X(a.divide(r)).multiply(o),u=dt(a.add(new b(.5,.5)).divide(r)),c=new ee(xt(n.x),xt(n.y)),h=new w(u,1);return $(Ft(u.x,u.y),Ni(s,c,h),Zi(s,c,h))}function Ni(t,e,s){const i=te(t,e,new P(0)),r=new ee(e.x.add(1),e.y),a=te(t,r,new P(0));return new b(E(i.rgb,s),E(a.rgb,s))}function Zi(t,e,s){const i=new ee(e.x.add(2),e.y),r=te(t,i,new P(0)),a=new ee(e.x.add(3),e.y),o=te(t,a,new P(0));return new b(E(r.rgb,s),E(o.rgb,s))}function Hi(t){const e=B(new b(-1e-5,-1e-5),t).multiply(B(t,new b(1.00001,1.00001))),s=be(e.x.multiply(e.y));return new bi(s)}function At(t,e,s=!1){return e?s?Ei(t,e):Wi(t,e):t}function Ut(t,e,s){const{bicubic:i=!1,bilinear:r=!1,nearestOnEdge:a=!1}=s??{};return i||r?i?xi(e.texture,t,e.srcImageSize):qi(e.texture,t,e.srcImageSize,a):T(e.texture,t)}l([m(ie)],Te.prototype,"transformTexture",void 0),l([m(b)],Te.prototype,"targetImageSize",void 0),l([m(b)],Te.prototype,"transformSpacing",void 0),l([m(b)],Te.prototype,"transformGridSize",void 0);let Lt=class extends Bt{};l([Mt(0,b)],Lt.prototype,"position",void 0);let Qi=class extends Dt{},he=class extends I{};l([m(ie)],he.prototype,"texture",void 0),l([m(_e)],he.prototype,"dvsMat3",void 0),l([m(b)],he.prototype,"coordScale",void 0),l([m(b)],he.prototype,"srcImageSize",void 0),l([m(p)],he.prototype,"opacity",void 0);class jt extends I{}l([m(ie)],jt.prototype,"maskTexture",void 0);class U extends Ot{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1}vertex(e){const s=e.position,{dvsMat3:i,coordScale:r}=this.config,a=i.multiply(new w(s.multiply(r),1));return{uv:s,glPosition:new f(a,1)}}fragment(e){const s=new Gt,i=At(e.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection),r=$(Hi(i),new f(0,0,0,0),this._colorize(i));let a=r.a.multiply(this.config.opacity);if(this.applyPixelMask){const o=this._getPixelMask(e.uv);a=a.multiply(o)}return s.fragColor=new f(r.rgb,1).multiply(a),s}_getPixel(e){const{config:s,bicubic:i,bilinear:r,nearestOnEdge:a}=this;return Ut(e,s,{bicubic:i,bilinear:r,nearestOnEdge:a})}_getPixelMask(e){const{maskTexture:s}=this.pixelMaskConfig,i=T(s,e);return q(i.a)}}l([_],U.prototype,"applyProjection",void 0),l([_],U.prototype,"lookupProjection",void 0),l([_],U.prototype,"bilinear",void 0),l([_],U.prototype,"bicubic",void 0),l([_],U.prototype,"nearestOnEdge",void 0),l([_],U.prototype,"applyPixelMask",void 0),l([m(he)],U.prototype,"config",void 0),l([pe(Te)],U.prototype,"projectionConfig",void 0),l([pe(jt)],U.prototype,"pixelMaskConfig",void 0),l([Ee(0,We(Lt))],U.prototype,"vertex",null),l([Ee(0,We(Qi))],U.prototype,"fragment",null);let se=class extends I{};function Ve(t,e,s,i=!0){const{colormapTexture:r,colormapOffset:a,colormapMaxIndex:o}=s,n=t.r.multiply(e).subtract(a),u=N(n,new p(0),o),c=new b(u.add(.5).divide(o.add(1)),0),h=T(r,c),d=new f(h.rgb,h.a.multiply(t.a));if(i)return d;const y=B(new p(0),n).multiply(B(n,s.colormapMaxIndex));return d.multiply(y)}l([m(ie)],se.prototype,"colormapTexture",void 0),l([m(p)],se.prototype,"colormapOffset",void 0),l([m(p)],se.prototype,"colormapMaxIndex",void 0);let $t=class extends U{constructor(){super(...arguments),this.type="RasterColorizerLUTShader"}_colorize(t){const e=this._getPixel(t);return Ve(e,new p(1),this.colormapConfig,!1)}};l([m(se)],$t.prototype,"colormapConfig",void 0);function qt(t){const e=new f(0,-.3333333333333333,.6666666666666666,-1),s=$(st(t.y,t.z),new f(t.zy,e.wz),new f(t.yz,e.xy)),i=$(st(t.x,s.x),new f(s.xyw,t.x),new f(t.x,s.yzx)),r=i.x.subtract(it(i.w,i.y)),a=new p(1e-10),o=i.w.subtract(i.y),n=r.multiply(6).add(a),u=D(o.divide(n).add(i.z)),c=i.x.add(a),h=it(r.divide(c),new p(1));return new w(u,h,i.x)}function Et(t){const e=new f(1,.6666666666666666,.3333333333333333,3),s=D(dt(t.xxx.add(e.xyz)).multiply(6).subtract(e.www)),i=N(s.subtract(e.xxx),new w(0,0,0),new w(1));return t.z.multiply(W(e.xxx,i,t.y))}let Z=class extends I{};function L(t){const e=D(t),s=B(e,new b(1,1)).multiply(e),i=new p(2).subtract(e),r=B(new p(1),e).multiply(i);return s.add(r)}function Be(t,e,s){const i=new p(1).divide(s),r=T(t,L(i.multiply(new b(-1,-1)).add(e))),a=T(t,L(i.multiply(new b(0,-1)).add(e))),o=T(t,L(i.multiply(new b(1,-1)).add(e))),n=T(t,L(i.multiply(new b(-1,0)).add(e))),u=T(t,L(e)),c=T(t,L(i.multiply(new b(1,0)).add(e))),h=T(t,L(i.multiply(new b(-1,1)).add(e))),d=T(t,L(i.multiply(new b(0,1)).add(e))),y=T(t,L(i.multiply(new b(1,1)).add(e))),g=new f(r.a,a.a,o.a,n.a),x=new f(c.a,h.a,d.a,y.a),v=g.multiply(x),S=v.xy.multiply(v.zw),k=S.x.multiply(S.y).multiply(u.a),R=new Q(new p(0),10);return R[0]=r.r,R[1]=a.r,R[2]=o.r,R[3]=n.r,R[4]=u.r,R[5]=c.r,R[6]=h.r,R[7]=d.r,R[8]=y.r,R[9]=k,R}function gt(t,e){const s=new f(t[5],t[3],t[7],t[1]).multiply(2),i=new w(t[2],s[0],t[8]),r=new w(t[0],s[1],t[6]),a=E(i.subtract(r),new w(1)),o=new w(t[6],s[2],t[8]),n=new w(t[0],s[3],t[2]),u=E(o.subtract(n),new w(1));return new b(a,u).multiply(e)}function Wt(t,e,s){const{factor:i}=e,r=gt(t,i),a=K(E(r,r).add(1)),o=t[9],{sinZsinAs:n,sinZcosAs:u,cosZs:c,weights:h}=e;if(!s){const x=Je({sinZsinA:n[0],sinZcosA:u[0],cosZ:c[0],weights:new p(1),dzxy:r,dzd:a});return new f(x,x,x,o)}const d=Je({sinZsinA:new w(n[0],n[1],n[2]),sinZcosA:new w(u[0],u[1],u[2]),cosZ:new w(c[0],c[1],c[2]),weights:new w(h[0],h[1],h[2]),dzxy:r,dzd:a}),y=Je({sinZsinA:new w(n[3],n[4],n[5]),sinZcosA:new w(u[3],u[5],u[5]),cosZ:new w(c[3],c[4],c[5]),weights:new w(h[3],h[4],h[5]),dzxy:r,dzd:a}),g=E(d.add(y),new w(1));return new f(g,g,g,o)}function Je(t){const e=t.sinZsinA.multiply(t.dzxy.y),s=t.sinZcosA.multiply(t.dzxy.x),i=e.subtract(s),r=t.cosZ.add(i).divide(t.dzd);return r.multiply(B(new p(0),r)).multiply(t.weights)}function Nt(t,e){const{pixelSizeFactor:s}=t,i=[t.factor[0]/e[0],t.factor[1]/e[1]];if(s>0){const{zFactor:r,pixelSizePower:a,gcsFactor:o}=t,n=e[0]*o,u=e[1]*o;i[0]=(r+n**a*s)/(8*n),i[1]=(r+u**a*s)/(8*u)}return i}l([m(Q.ofType(p,6))],Z.prototype,"sinZcosAs",void 0),l([m(Q.ofType(p,6))],Z.prototype,"sinZsinAs",void 0),l([m(Q.ofType(p,6))],Z.prototype,"cosZs",void 0),l([m(Q.ofType(p,6))],Z.prototype,"weights",void 0),l([m(p)],Z.prototype,"minValue",void 0),l([m(p)],Z.prototype,"maxValue",void 0),l([m(b)],Z.prototype,"factor",void 0);let Re=class extends U{constructor(){super(...arguments),this.type="RasterColorizerShadedReliefShader",this.applyColormap=!1,this.isMultidirectional=!1}_colorize(t){const{texture:e}=this.config,s=Be(e,t,this.config.srcImageSize),i=Wt(s,this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new f(i.x,i.x,i.x,i.a);const{minValue:r,maxValue:a}=this.hillshadeConfig,o=this._getPixel(t),n=a.subtract(r),u=o.r.subtract(r),c=N(u.divide(n),new p(0),new p(1)),h=Ve(new f(c,c,c,1),new p(255),this.colormapConfig),d=qt(h.xyz),y=Et(new w(d.xy,i.x));return new f(y,h.a.multiply(i.a))}};l([_],Re.prototype,"applyColormap",void 0),l([_],Re.prototype,"isMultidirectional",void 0),l([m(Z)],Re.prototype,"hillshadeConfig",void 0),l([pe(se)],Re.prototype,"colormapConfig",void 0);let H=class extends I{};function Xi(t,e){const{minCutOff:s,maxCutOff:i,factor:r,minOutput:a}=e;return N(t,s,i).subtract(s).multiply(r).add(a)}function Yi(t,e){const{minCutOff:s,maxCutOff:i,minOutput:r,maxOutput:a,gamma:o,gammaCorrection:n}=e,u=N(t,s,i).subtract(s),c=i.subtract(s),h=u.divide(c),d=B(new p(1),o),y=q(o.subtract(1)),g=a.subtract(r),x=new w(1),v=Y(x.divide(g),h.multiply(n)),S=be(d.multiply(y).multiply(v)),k=Y(h,x.divide(o)),R=S.multiply(g).multiply(k).add(r);return N(R,r,a)}function Zt(t,e,s,i=255){const r=s?Yi(t.rgb,e).divide(i):Xi(t.rgb,e);return new f(r,t.a)}l([m(p)],H.prototype,"minOutput",void 0),l([m(p)],H.prototype,"maxOutput",void 0),l([m(w)],H.prototype,"minCutOff",void 0),l([m(w)],H.prototype,"maxCutOff",void 0),l([m(w)],H.prototype,"factor",void 0),l([m(w)],H.prototype,"gamma",void 0),l([m(w)],H.prototype,"gammaCorrection",void 0);let ne=class extends U{constructor(){super(...arguments),this.type="RasterColorizerStretchShader",this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1}_colorize(t){const e=this._getPixel(t);if(this.noOp)return e;let s=Zt(e,this.stretchConfig,this.useGamma);if(this.isMultiband)return s;if(s=new f(s.rrr,s.a),this.applyColormap){const i=this.useGamma?255:1;s=Ve(s,new p(i),this.colormapConfig)}return s}};l([_],ne.prototype,"isMultiband",void 0),l([_],ne.prototype,"applyColormap",void 0),l([_],ne.prototype,"useGamma",void 0),l([_],ne.prototype,"noOp",void 0),l([m(H)],ne.prototype,"stretchConfig",void 0),l([pe(se)],ne.prototype,"colormapConfig",void 0);let Ji=class extends mt{constructor(){super(...arguments),this.name="BrushRasterColorizer",this.type=z.RasterColorizer,this.shaders={lut:new $t,stretch:new ne,shadedRelief:new Re}}render(t,e){for(const s of e.bitmaps){if(!s.source||s.suspended)continue;t.timeline.begin(this.name);const{painter:i}=t;i.setPipelineState({depth:!1,stencil:{test:{mask:255,ref:s.stencilRef,compare:Ds.EQUAL,op:{fail:Xe.KEEP,zFail:Xe.KEEP,zPass:Xe.KEEP}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}}),s.updateTexture(t),s.processedTexture||s.updateProcessedTexture();const{type:r}=s.symbolizerParameters,a=r==="stretch"?this._getStretchOptions(s):r==="lut"?this._getLutOptions(s):this._getShadedReliefOptions(s);s.interpolation!=="bilinear"||t.context.capabilities.textureFloatLinear||(a.defines.bilinear=!0),i.submitDrawMesh(t.context,a,i.quadMesh),t.timeline.end(this.name)}}_getLutOptions(t){const{config:e,projectionConfig:s,colormapConfig:i,pixelMaskConfig:r,projectionDefines:a}=this._getCommonConfig(t),o=this._getInterpolationDefines("nearest",!1);return{shader:this.shaders.lut,uniforms:{projectionConfig:s,config:e,colormapConfig:i,pixelMaskConfig:r},defines:{...a,...o,applyPixelMask:!!r},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(t){const e=t.symbolizerParameters,{config:s,projectionConfig:i,colormapConfig:r,pixelMaskConfig:a,projectionDefines:o}=this._getCommonConfig(t),n=this._getInterpolationDefines(t.interpolation,e.bandCount===1);return{shader:this.shaders.stretch,uniforms:{projectionConfig:i,config:s,stretchConfig:e,colormapConfig:r,pixelMaskConfig:a},defines:{...o,...n,isMultiband:e.bandCount>1,applyColormap:!!r,useGamma:e.useGamma,noOp:t.isRendereredSource&&!t.processed,applyPixelMask:!!a},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(t){const e=t.symbolizerParameters,{config:s,projectionConfig:i,colormapConfig:r,pixelMaskConfig:a,projectionDefines:o}=this._getCommonConfig(t),n=this._getInterpolationDefines(t.interpolation,!0);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:i,config:s,hillshadeConfig:e,colormapConfig:r,pixelMaskConfig:a},defines:{...o,...n,isMultidirectional:e.hillshadeType>0,applyColormap:!!r,applyPixelMask:!!a},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(t){const{coordScale:e,computedOpacity:s,transforms:i}=t,{names:r,textures:a}=t.getTextures({useProcessedTexture:t.processed}),o=a[r.indexOf("u_image")],n=t.getRasterTextureSize(),u={texture:{texture:o,unit:0},dvsMat3:i.displayViewScreenMat3,coordScale:e,srcImageSize:n,opacity:s},c=a[r.indexOf("u_transformGrid")],{transformGrid:h}=t,d=!(!c||!h),y=d?{transformTexture:{texture:c,unit:2},targetImageSize:[t.width,t.height],transformSpacing:h.spacing,transformGridSize:h.size}:void 0,g=a[r.indexOf("u_colormap")],{colormap:x,colormapOffset:v}=t.symbolizerParameters,S=g&&x?{colormapTexture:{texture:g,unit:1},colormapOffset:v??0,colormapMaxIndex:x.length/4-1}:void 0,k=a[r.indexOf("u_mask")];return{config:u,projectionConfig:y,colormapConfig:S,pixelMaskConfig:k?{maskTexture:{texture:k,unit:3}}:void 0,projectionDefines:{applyProjection:d,lookupProjection:d&&h.spacing[0]===1}}}_getInterpolationDefines(t,e){const s=t==="bilinear"&&e;return{bilinear:s,bicubic:t==="cubic",nearestOnEdge:s}}};function Ht(t,e){const s=new Ci;return s.width=t,s.height=e,s.internalFormat=Gs.RGBA32F,s.samplingMode=Ke.NEAREST,s.dataType=As.FLOAT,s.isImmutable=!0,s.wrapMode=Us.CLAMP_TO_EDGE,s}function Ki(t,e,s){const i=Ht(e,s);return new Ti(t,i)}function Qt(t,e,s){const i=Ht(e,s);return new vi(t,i)}let V=class extends mt{shutdown(t){super.shutdown(t),this._fbo?.dispose(),this._fbo=void 0}render(t,e){const{rasterFunction:s}=t;if(!s)return;const{context:i}=t,r="indexedColormap"in s.parameters?et(i,s.parameters.indexedColormap):void 0,a=s.name==="Reproject",o=i.getBoundFramebufferObject(),n=i.getViewport();for(const u of e.bitmaps){const c=a?!(u.rasterTexture&&u.projected):!u.processed;if(!u.source||!c||u.suspended)continue;t.timeline.begin(this.name);const{painter:h}=t;h.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:Ge.ONE,dstRGB:Ge.ZERO,srcAlpha:Ge.ONE,dstAlpha:Ge.ZERO}}}),a||(u.processedTexture=A(u.processedTexture)),u.updateTexture(t);const[d,y]=u.getRasterTextureSize(a),g=d===ce&&y===ce,x=g?e.processorFbo:Qt(i,d,y);i.bindFramebuffer(x),i.setViewport(0,0,x.width,x.height),this._process(t,u,r);const v=Ki(t.context,d,y);if(x.copyToTexture(0,0,d,y,0,0,v),a)u.rasterTexture=v;else{const S=t.hasBranches?s.id:0;u.functionTextures[S]=v}g||x.dispose(),t.timeline.end(this.name)}r?.dispose(),i.bindFramebuffer(o),i.setViewport(n.x,n.y,n.width,n.height)}_getCommonConfig(t,e){const{rasterFunction:s,hasBranches:i}=t,{raster:r,rasters:a}=s.parameters,o=i?r?.id??a?.filter(c=>c.name!=="Constant")?.[0]?.id??-1:0,n=e.functionTextures[o]??e.rasterTexture,u=s.name==="Reproject";return{texture:{texture:n,unit:0},srcImageSize:e.getRasterTextureSize(u)}}_getMultipleInputConfig(t,e){return e?.length?e.length===2?{twoRasterConfig:this._getTwoInputConfig(e,t)}:e.length===3?{threeRasterConfig:this._getThreeInputConfig(e,t)}:{}:{}}_getConstantCount(t){return t?.filter(e=>e.name==="Constant").length??0}_getTextures(t,e){return t.filter(s=>s.name!=="Constant").map(s=>s.id!=null&&s.name!=="Identity"?e.functionTextures[s.id]:e.rasterTexture)}_getTwoInputConfig(t,e){const s=this._getTextures(t,e),i=s[1]?{texture:s[1],unit:1}:void 0,r=t.findIndex(o=>o.name==="Constant"),a=r===0?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:i,image1Const:r>-1?t[r].parameters.value:0,imageSwap:a}}_getThreeInputConfig(t,e){const s=this._getTextures(t,e);let i=0,r=0,a=new Float32Array([1,0,0,0,1,0,0,0,1]);const o=s[1]?{texture:s[1],unit:1}:void 0,n=s[2]?{texture:s[2],unit:2}:void 0,u=[];if(t.forEach((c,h)=>c.name==="Constant"&&u.push(h)),u.length===1)i=t[u[0]].parameters.value,a=u[0]===0?new Float32Array([0,1,0,0,0,1,1,0,0]):u[0]===1?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(u.length===2){i=t[u[0]].parameters.value,r=t[u[1]].parameters.value;const c=t.findIndex(h=>h.name!=="Constant");a=c===0?new Float32Array([1,0,0,0,1,0,0,0,1]):c===1?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:o,image2:n,image1Const:i,image2Const:r,imageSwap:a}}},Xt=class extends Bt{};l([Mt(0,b)],Xt.prototype,"position",void 0);let er=class extends Dt{},rt=class extends I{};l([m(ie)],rt.prototype,"texture",void 0),l([m(b)],rt.prototype,"srcImageSize",void 0);let M=class extends Ot{vertex(t){return{uv:t.position,glPosition:new f(_i(t.position),0,1)}}fragment(t){const e=new Gt,s=At(t.uv),i=this._process(s);return e.fragColor=new f(i.rgb,1).multiply(i.a),e}_getPixel(t){return Ut(t,this.config)}};l([m(rt)],M.prototype,"config",void 0),l([Ee(0,We(Xt))],M.prototype,"vertex",null),l([Ee(0,We(er))],M.prototype,"fragment",null);let Yt=class extends I{};l([m(b)],Yt.prototype,"cellSize",void 0);let Jt=class extends M{constructor(){super(...arguments),this.type="AspectShader"}_process(t){const{texture:e}=this.config,s=Be(e,t,this.config.srcImageSize),i=new b(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:r,y:a}=gt(s,i),o=we(a),n=s[9].multiply(q(D(r).add(D(o)))),u=D(q(r)),c=new p(3.14159265359),h=new p(0),d=B(h,o).multiply(.5).multiply(c).add(B(o,h).multiply(1.5).multiply(c)),y=Vt(new p(2.5).multiply(c).add(Ne(o,we(r))),new p(2).multiply(c)),g=W(d,y,u).multiply(180).divide(c);return new f(g,g,g,n)}};l([m(Yt)],Jt.prototype,"aspectConfig",void 0);let tr=class extends V{constructor(){super(...arguments),this.name="RasterAspectProcessor",this.type=z.Aspect,this.shaders={aspect:new Jt}}_process(t,e){const s={cellSize:e.getRasterCellSize()},i=this._getCommonConfig(t,e),r={shader:this.shaders.aspect,uniforms:{config:i,aspectConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=t;a.submitDrawMesh(o,r,a.quadMesh)}};function F(t){const e=q(t),s=t.add(D(e).subtract(1));return e.multiply(e).divide(s)}function ve(t){return new f(X(t.rgb.add(.5)),t.a)}function Kt(t,e){return B(e.x,t).multiply(B(t,e.y))}function sr(t,e,s){const i=new w(t);let r=new w(0,0,0),a=new p(0);for(let o=0;o<s/3;o++){const n=9*o,u=new w(e[n],e[n+3],e[n+6]),c=new w(e[n+1],e[n+4],e[n+7]),h=B(u,i).multiply(B(i,c)),d=new w(e[n+2],e[n+5],e[n+8]);a=W(a,d.x,h.x),a=W(a,d.y,h.y),a=W(a,d.z,h.z),r=r.add(h)}return{mapValue:a,includeMask:q(E(r,new w(1,1,1)))}}class es extends I{}l([m(_e)],es.prototype,"bandIndexMat3",void 0);let ts=class extends I{};l([m(w)],ts.prototype,"adjustments",void 0);let Se=class extends M{constructor(){super(...arguments),this.type="BandArithmeticShader",this.isOutputRounded=!1}_process(t){const e=this._getPixel(t),s=this.bandArithmeticConfig.bandIndexMat3.multiply(e.rgb),i=this._processIndex(s),r=new f(i,i,i,e.a);return this.isOutputRounded?ve(r):r}_processIndex(t){const{r:e,g:s}=t,i=this.adjustmentConfig?.adjustments;switch(this.indexType){case"ndxi":{const r=e.subtract(s),a=e.add(s);return r.multiply(F(a))}case"sr":return e.multiply(F(s));case"ci":return e.multiply(F(s)).subtract(1);case"savi":{const{x:r}=i,a=e.subtract(s),o=e.add(s).add(r);return a.multiply(F(o)).multiply(r.add(1))}case"tsavi":{const{x:r,y:a,z:o}=i,n=o.multiply(r.multiply(r).add(1)).subtract(a.multiply(r)),u=r.multiply(e.subtract(r.multiply(s)).subtract(a)),c=a.multiply(e).add(s).add(n);return u.multiply(F(c))}case"msavi":{const r=e.multiply(2).add(1),a=r.multiply(r).subtract(e.subtract(s).multiply(8));return r.subtract(K(a)).multiply(.5)}case"gemi":{const r=e.multiply(e).subtract(s.multiply(s)).multiply(2).add(e.multiply(1.5)).add(s.multiply(.5)),a=e.add(s).add(.5),o=r.multiply(F(a)),n=o.multiply(be(o.multiply(.25))),u=s.subtract(.125).multiply(F(be(s)));return n.subtract(u)}case"pvi":{const{x:r,y:a}=i,o=K(r.multiply(r).add(1));return e.subtract(s.multiply(r)).subtract(a).multiply(F(o))}case"vari":{const r=t.g.subtract(t.r),a=t.g.add(t.r).subtract(t.b);return r.multiply(F(a))}case"rtvicore":return e.subtract(s).multiply(100).subtract(e.subtract(t.b).multiply(10));case"bai":{const r=Y(new p(.1).subtract(s),new p(2)),a=Y(new p(.06).subtract(e),new p(2));return F(r.add(a))}case"evi":{const r=t.b,a=e.add(s.multiply(6)).subtract(r.multiply(7.5)).add(1);return e.subtract(s).multiply(2.5).multiply(F(a))}case"wndwi":{const{r,g:a,b:o}=t,n=i.x,u=n.multiply(a),c=n.multiply(o),h=r.add(u).add(o).subtract(c);return r.subtract(u).subtract(o).add(c).multiply(F(h))}case"mtvi":{const r=t.b,a=Y(e.multiply(2).add(1),new p(2)),o=e.multiply(6).subtract(K(s).multiply(5)),n=K(a.subtract(o).subtract(.5)),u=e.subtract(r).multiply(1.2),c=s.subtract(r).multiply(2.5);return u.subtract(c).multiply(1.5).multiply(F(n))}default:return e}}};l([_],Se.prototype,"indexType",void 0),l([_],Se.prototype,"isOutputRounded",void 0),l([m(es)],Se.prototype,"bandArithmeticConfig",void 0),l([pe(ts)],Se.prototype,"adjustmentConfig",void 0);let ir=class extends V{constructor(){super(...arguments),this.name="RasterBandArithmeticProcessor",this.type=z.BandArithmetic,this.shaders={bandArithmetic:new Se}}_process(t,e){const s=t.rasterFunction.parameters,i={indexType:s.indexType,isOutputRounded:s.isOutputRounded},r={bandIndexMat3:s.bandIndexMat3},a=s.adjustments?{adjustments:[...s.adjustments]}:void 0,o=this._getCommonConfig(t,e),n={shader:this.shaders.bandArithmetic,uniforms:{config:o,bandArithmeticConfig:r,adjustmentConfig:a},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:c}=t;u.submitDrawMesh(c,n,u.quadMesh)}},ss=class extends M{constructor(){super(...arguments),this.type="ColormapToRGBShader"}_process(t){const e=this._getPixel(t),s=Ve(e,new p(1),this.colormapConfig,!1);return new f(s.xyz.multiply(255),s.a)}};l([m(se)],ss.prototype,"colormapConfig",void 0);class rr extends V{constructor(){super(...arguments),this.name="RasterColormapToRGBProcessor",this.type=z.ColormapToRGB,this.shaders={colormapToRGB:new ss}}_process(e,s,i){const r=e.rasterFunction.parameters,a={colormapTexture:{texture:i,unit:1},colormapOffset:r.offset,colormapMaxIndex:r.indexedColormap.length/4-1},o=this._getCommonConfig(e,s),n={shader:this.shaders.colormapToRGB,uniforms:{config:o,colormapConfig:a},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:c}=e;u.submitDrawMesh(c,n,u.quadMesh)}}let Ue=class extends I{};l([m(ie)],Ue.prototype,"image1",void 0),l([m(p)],Ue.prototype,"image1Const",void 0),l([m(_e)],Ue.prototype,"imageSwap",void 0);let de=class extends I{};l([m(ie)],de.prototype,"image1",void 0),l([m(ie)],de.prototype,"image2",void 0),l([m(p)],de.prototype,"image1Const",void 0),l([m(p)],de.prototype,"image2Const",void 0),l([m(_e)],de.prototype,"imageSwap",void 0);const yt=t=>{class e extends t{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(i){const{imageCount:r}=this;if(r===1){const a=T(this.config.texture,i);return{a:a.r,b:a.g,c:a.b,alpha:a.a}}if(r===2){const a=this._getTwoValues(i);return{a:a.a,b:a.b,c:a.b,alpha:a.alpha}}return this._getThreeValues(i)}_getTwoValues(i){const r=T(this.config.texture,i);if(this.constantCount===1){const{imageSwap:n,image1Const:u}=this.twoRasterConfig,c=n.multiply(new w(r.r,u,0));return{a:c.x,b:c.y,alpha:r.a}}const{image1:a}=this.twoRasterConfig,o=T(a,i);return{a:r.r,b:o.r,alpha:r.a.multiply(o.a)}}_getThreeValues(i){const r=T(this.config.texture,i),{imageSwap:a,image1:o,image2:n,image1Const:u,image2Const:c}=this.threeRasterConfig;if(this.constantCount===2){const y=a.multiply(new w(r.r,u,c));return{a:y.x,b:y.y,c:y.z,alpha:r.a}}if(this.constantCount===1){const y=T(o,i),g=a.multiply(new w(r.r,y.r,u));return{a:g.x,b:g.y,c:g.z,alpha:r.a.multiply(y.a)}}const h=T(o,i),d=T(n,i);return{a:r.r,b:h.r,c:d.r,alpha:r.a.multiply(h.a).multiply(d.a)}}}return l([_],e.prototype,"constantCount",void 0),l([_],e.prototype,"imageCount",void 0),l([pe(Ue)],e.prototype,"twoRasterConfig",void 0),l([pe(de)],e.prototype,"threeRasterConfig",void 0),e};let ar=class extends yt(M){constructor(){super(...arguments),this.type="CompositeBandShader"}_process(t){const{a:e,b:s,c:i,alpha:r}=this._getRasterValues(t);return new f(e,s,i,r)}},or=class extends V{constructor(){super(...arguments),this.name="RasterCompositeBandProcessor",this.type=z.CompositeBand,this.shaders={compositeBand:new ar}}_process(t,e){const{rasters:s}=t.rasterFunction.parameters,i={constantCount:this._getConstantCount(s),imageCount:s?.length??1},r=this._getMultipleInputConfig(e,s),a=this._getCommonConfig(t,e),o={shader:this.shaders.compositeBand,uniforms:{config:a,...r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:u}=t;n.submitDrawMesh(u,o,n.quadMesh)}};class ft extends I{}l([m(b)],ft.prototype,"domainRange",void 0);class Le extends yt(M){constructor(){super(...arguments),this.type="LocalShader",this.isOutputRounded=!1}_process(e){if(this.operationName==="conditional")return this._conditional(e);const{a:s,b:i,alpha:r}=this._getRasterValues(e),{value:a,alpha:o}=this._compute(s,i,r);return this._processResult(a,o)}_processResult(e,s){const i=Kt(e,this.domainRangeConfig.domainRange),r=new f(e,e,e,s).multiply(i);return this.isOutputRounded?ve(r):r}_compute(e,s,i){const{operationName:r}=this;let a;switch(r){case"plus":a=e.add(s);break;case"minus":a=e.subtract(s);break;case"times":a=e.multiply(s);break;case"divide":case"floatdivide":a=e.multiply(F(s)),i=i.multiply(G(D(q(s))));break;case"floordivide":a=X(e.multiply(F(s))),i=i.multiply(G(D(q(s))));break;case"square":a=e.multiply(e);break;case"sqrt":a=K(e);break;case"power":a=Y(e,s);break;case"ln":a=$(oe(e,new p(0)),mi(e),new p(0)),i=i.multiply(this._isAboveZero(e));break;case"log10":a=$(oe(e,new p(0)),Ye(e).multiply(F(Ye(new p(10)))),new p(0)),i=i.multiply(this._isAboveZero(e));break;case"log2":a=$(oe(e,new p(0)),Ye(e),new p(0)),i=i.multiply(this._isAboveZero(e));break;case"exp":a=di(e);break;case"exp10":a=Y(new p(10),e);break;case"exp2":a=Y(new p(2),e);break;case"rounddown":a=X(e);break;case"roundup":a=hi(e);break;case"int":a=q(e).multiply(X(D(e)));break;case"mod":a=Vt(e,s);break;case"negate":a=we(e);break;case"abs":a=D(e);break;case"acos":{const o=this._isAbsBiggerThanOne(e);a=$(o,new p(0),pi(e)),i=$(o,new p(0),i);break}case"acosh":a=ci(e);break;case"asin":{const o=this._isAbsBiggerThanOne(e);a=$(o,new p(0),ui(e)),i=$(o,new p(0),i);break}case"asinh":a=li(e);break;case"atan":a=Ne(e);break;case"atanh":{const o=this._isAbsBiggerThanOne(e);a=$(o,new p(0),ni(e)),i=$(o,new p(0),i);break}case"atan2":a=Ne(e,s);break;case"cos":a=oi(e);break;case"cosh":a=ai(e);break;case"sin":a=ri(e);break;case"sinh":a=ii(e);break;case"tan":a=si(e);break;case"tanh":a=ti(e);break;case"bitwiseand":a=new p(ei(new P(e),new P(s)));break;case"bitwiseor":a=new p(Ks(new P(e),new P(s)));break;case"bitwiseleftshift":a=new p(Js(new P(e),new P(s)));break;case"bitwiserightshift":a=new p(Ys(new P(e),new P(s)));break;case"bitwisenot":a=new p(Xs(new P(e)));break;case"bitwisexor":a=new p(Qs(new P(e),new P(s)));break;case"booleanand":a=G(Hs(ae(e,new p(0)),ae(s,new p(0))));break;case"booleanor":a=G(Zs(ae(e,new p(0)),ae(s,new p(0))));break;case"booleannot":a=G(fe(e,new p(0)));break;case"booleanxor":a=G(Ns(ae(e,new p(0)),ae(s,new p(0))));break;case"greaterthan":a=G(oe(e,s));break;case"greaterthanequal":a=G(Ws(e,s));break;case"lessthan":a=G(st(e,s));break;case"lessthanequal":a=G(Ft(e,s));break;case"equalto":a=G(fe(e,s));break;case"notequal":a=G(ae(e,s));break;case"isnull":a=G(fe(i,new p(0))),i=new p(1);break;case"setnull":{const o=G(fe(e,new p(0)));a=o.multiply(s),i=i.multiply(o);break}default:a=e}return{value:a,alpha:i}}_conditional(e){const{a:s,b:i,c:r,alpha:a}=this._getRasterValues(e),o=new p(D(q(s))),n=W(r,i,o);return this._processResult(n,a)}_isAboveZero(e){return G(oe(e,new p(0)))}_isAbsBiggerThanOne(e){return oe(D(e),new p(1))}}l([_],Le.prototype,"operationName",void 0),l([_],Le.prototype,"isOutputRounded",void 0),l([m(ft)],Le.prototype,"domainRangeConfig",void 0);let je=class extends yt(M){constructor(){super(...arguments),this.type="ComputeChangeShader",this.isOutputRounded=!1}_process(t){const{a:e,b:s,alpha:i}=this._getRasterValues(t);let r=e.subtract(s);this.method==="relative-difference"&&(r=r.multiply(F(ht(D(e),D(s)))));const a=Kt(r,this.domainRangeConfig.domainRange),o=new f(r,r,r,i).multiply(a);return this.isOutputRounded?ve(o):o}};l([_],je.prototype,"method",void 0),l([_],je.prototype,"isOutputRounded",void 0),l([m(ft)],je.prototype,"domainRangeConfig",void 0);let nr=class extends V{constructor(){super(...arguments),this.name="RasterComputeChangeProcessor",this.type=z.ComputeChange,this.shaders={computeChange:new je}}_process(t,e){const s=t.rasterFunction.parameters,{rasters:i}=s,r={constantCount:this._getConstantCount(i),imageCount:i.length,method:s.method,isOutputRounded:s.isOutputRounded},a={domainRange:s.domainRange},{twoRasterConfig:o}=this._getMultipleInputConfig(e,i),n=this._getCommonConfig(t,e),u={shader:this.shaders.computeChange,uniforms:{config:n,domainRangeConfig:a,twoRasterConfig:o},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,u,c.quadMesh)}},at=class extends I{};l([m(p)],at.prototype,"contrastOffset",void 0),l([m(p)],at.prototype,"brightnessOffset",void 0);let is=class extends M{constructor(){super(...arguments),this.type="ContrastBrightnessShader"}_process(t){const{rgb:e,a:s}=this._getPixel(t),{contrastOffset:i,brightnessOffset:r}=this.contrastBrightnessConfig,a=new p(255),o=new p(128),n=e.multiply(200),u=a.multiply(100),c=a.multiply(2).multiply(r),h=n.subtract(u).add(c),d=yi([fe(i,new p(-100)),new w(o)],[fe(i,new p(100)),q(h).add(1).divide(2).multiply(a)],[oe(i,new p(0)),h.divide(new p(100).subtract(i).multiply(2)).add(o)],[!0,h.multiply(i.add(100)).divide(2e4).add(o)]);return ve(new f(d,s))}};l([m(at)],is.prototype,"contrastBrightnessConfig",void 0);class lr extends V{constructor(){super(...arguments),this.name="RasterContrastBrightnessProcessor",this.type=z.ContrastBrightness,this.shaders={contrastBrightness:new is}}_process(e,s){const i=this._getCommonConfig(e,s),r=e.rasterFunction.parameters,a={shader:this.shaders.contrastBrightness,uniforms:{config:i,contrastBrightnessConfig:r},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:n}=e;o.submitDrawMesh(n,a,o.quadMesh)}}let ot=class extends I{};l([m(gi.ofType(p,5,5,!0))],ot.prototype,"kernel",void 0),l([m(b)],ot.prototype,"clampRange",void 0);let $e=class extends M{constructor(){super(...arguments),this.type="ConvolutionShader",this.rows=3,this.cols=3}_process(t){const{rows:e,cols:s}=this,i=new b(Math.floor(e/2),Math.floor(s/2)),{texture:r,srcImageSize:a}=this.config,o=new p(1).divide(a),{kernel:n}=this.convolutionConfig,u=fi(n,{initialValue:new f(0,0,0,1),xRange:[0,e],yRange:[0,s],callback:(h,d,y,g)=>{const x=new b(new p(y),new p(g)).subtract(i).multiply(o),v=T(r,L(t.add(x))),S=v.rgb.multiply(d).add(h.rgb),k=v.a.multiply(h.a);return new f(S,k)}}),{clampRange:c}=this.convolutionConfig;return new f(N(u.rgb,c.x,c.y),1).multiply(u.a)}};l([_],$e.prototype,"rows",void 0),l([_],$e.prototype,"cols",void 0),l([m(ot)],$e.prototype,"convolutionConfig",void 0);let ur=class extends V{constructor(){super(...arguments),this.name="RasterConvolutionProcessor",this.type=z.Convolution,this.shaders={convolution:new $e}}_process(t,e){const s=t.rasterFunction.parameters,i={rows:s.kernelRows,cols:s.kernelCols},r={kernel:[...s.kernel],clampRange:s.clampRange},a=this._getCommonConfig(t,e),o={shader:this.shaders.convolution,uniforms:{config:a,convolutionConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:u}=t;n.submitDrawMesh(u,o,n.quadMesh)}},rs=class extends I{};l([m(p)],rs.prototype,"zlFactor",void 0);let nt=class extends M{constructor(){super(...arguments),this.type="CurvatureShader"}_process(t){const{texture:e}=this.config,s=Be(e,t,this.config.srcImageSize),i=s[3].add(s[5]).multiply(.5).subtract(s[4]),r=s[1].add(s[7]).multiply(.5).subtract(s[4]),{zlFactor:a}=this.curvatureConfig,{curvatureType:o}=this;let n;if(o==="standard")n=we(a).multiply(i.add(r));else{const u=s[2].subtract(s[0]).add(s[6]).subtract(s[8]).divide(4),c=s[5].subtract(s[3]).divide(2),h=s[1].subtract(s[7]).divide(2),d=c.multiply(c),y=h.multiply(h),g=c.multiply(h),x=a.divide(d.add(y));n=o==="profile"?E(new w(i,r,u),new w(d,y,g)).multiply(x):E(new w(i,r,we(u)),new w(y,d,g)).multiply(we(x))}return new f(n,n,n,s[9])}};l([_],nt.prototype,"curvatureType",void 0),l([m(rs)],nt.prototype,"curvatureConfig",void 0);let cr=class extends V{constructor(){super(...arguments),this.name="RasterCurvatureProcessor",this.type=z.Curvature,this.shaders={curvature:new nt}}_process(t,e){const s=t.rasterFunction.parameters,i={curvatureType:s.curvatureType},r=e.getRasterCellSize(),a={zlFactor:200*s.zFactor/r[0]/r[1]},o=this._getCommonConfig(t,e),n={shader:this.shaders.curvature,uniforms:{config:o,curvatureConfig:a},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:c}=t;u.submitDrawMesh(c,n,u.quadMesh)}},as=class extends I{};l([m(_e)],as.prototype,"bandIndexMat3",void 0);let os=class extends M{constructor(){super(...arguments),this.type="ExtractBandShader"}_process(t){const e=this._getPixel(t),s=this.extractBandConfig.bandIndexMat3.multiply(e.rgb);return new f(s,e.a)}};l([m(as)],os.prototype,"extractBandConfig",void 0);let pr=class extends V{constructor(){super(...arguments),this.name="RasterExtractBandProcessor",this.type=z.ExtractBand,this.shaders={extractBand:new os}}_process(t,e){const s={bandIndexMat3:t.rasterFunction.parameters.bandIndexMat3},i=this._getCommonConfig(t,e),r={shader:this.shaders.extractBand,uniforms:{config:i,extractBandConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=t;a.submitDrawMesh(o,r,a.quadMesh)}},ns=class extends I{};l([m(b)],ns.prototype,"clampRange",void 0);class me extends M{constructor(){super(...arguments),this.type="FocalStatisticsShader",this.rows=3,this.cols=3,this.fill=!1}_process(e){const s=this._process1(e),i=B(new p(1),s.a);if(!this.fill)return this._clamp(s.rgb,i);const r=this._getPixel(e),a=W(s.rgb,r.rgb,r.a);return this._clamp(a,i)}_clamp(e,s){const{clampRange:i}=this.focalStatisticsConfig;return new f(N(e,i.x,i.y),1).multiply(s)}_process1(e){const{texture:s,srcImageSize:i}=this.config,{rows:r,cols:a}=this,o=new b(Math.floor(r/2),Math.floor(a/2)),n=new p(1).divide(i),u=this._getPixel(e),{statisticsType:c}=this,h=c==="min"||c==="max"?new f(u.rgb,0):new f(0,0,0,0);switch(c){case"min":return this._stat(r,a,h,(d,y,g)=>{const x=new b(new p(y),new p(g)).subtract(o).multiply(n),v=T(s,L(e.add(x))),S=it(d.rgb,v.rgb);return new f(S,d.a.add(v.a))});case"max":return this._stat(r,a,h,(d,y,g)=>{const x=new b(new p(y),new p(g)).subtract(o).multiply(n),v=T(s,L(e.add(x))),S=ht(d.rgb,v.rgb);return new f(S,d.a.add(v.a))});case"mean":{const d=this._stat(r,a,h,(g,x,v)=>{const S=new b(new p(x),new p(v)).subtract(o).multiply(n),k=T(s,L(e.add(S))),R=g.rgb.add(k.rgb.multiply(k.a));return new f(R,g.a.add(k.a))}),y=d.rgb.multiply(F(d.a));return new f(y,d.a)}case"stddev":{const d=this._stat(r,a,h,(v,S,k)=>{const R=new b(new p(S),new p(k)).subtract(o).multiply(n),j=T(s,L(e.add(R))),J=v.rgb.add(j.rgb.multiply(j.a));return new f(J,v.a.add(j.a))}),y=this._stat(r,a,h,(v,S,k)=>{const R=new b(new p(S),new p(k)).subtract(o).multiply(n),j=T(s,L(e.add(R))),J=v.rgb.add(j.a.multiply(j.rgb).multiply(j.rgb));return new f(J,v.a.add(j.a))}),g=F(y.a),x=K(y.subtract(d.multiply(d).multiply(g)).multiply(g));return new f(x.rgb,d.a)}default:return u}}_stat(e=3,s=3,i,r){const a=new P(0).setMutable().setDebugName("StatColIterator"),o=new P(0).setMutable().setDebugName("StatRowIterator"),n=i.setMutable().setDebugName("StatAccumulator"),u=r(n,a,o).setDebugName("StatPredicate");return wi({iterX:a,iterY:o,accumulator:n},f,u,({out:c,iterX:h,iterY:d,accumulator:y,subgraph:g})=>`
  for (${d} = 0; ${d} < ${e}; ${d}++) {
    for (${h} = 0; ${h} < ${s}; ${h}++) {
  
    ${g.body}
  
    ${y} = ${g.varName};
    }
  }
  ${c} = ${y};
  `).setDebugName("statBody")}}l([_],me.prototype,"rows",void 0),l([_],me.prototype,"cols",void 0),l([_],me.prototype,"statisticsType",void 0),l([_],me.prototype,"fill",void 0),l([m(ns)],me.prototype,"focalStatisticsConfig",void 0);class hr extends V{constructor(){super(...arguments),this.name="RasterFocalStatisticsProcessor",this.type=z.Statistics,this.shaders={focalStatistics:new me}}_process(e,s){const i=e.rasterFunction.parameters,r={rows:i.kernelRows,cols:i.kernelCols,statisticsType:i.statisticsType,fill:i.fillNoDataOnly},a={clampRange:i.clampRange},o=this._getCommonConfig(e,s),n={shader:this.shaders.focalStatistics,uniforms:{config:o,focalStatisticsConfig:a},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:u,context:c}=e;u.submitDrawMesh(c,n,u.quadMesh)}}class ls extends I{}l([m(w)],ls.prototype,"weights",void 0);let us=class extends M{constructor(){super(...arguments),this.type="GrayscaleShader"}_process(t){const e=this._getPixel(t),{weights:s}=this.grayscaleConfig,i=E(s,e.rgb);return new f(i,i,i,e.a)}};l([m(ls)],us.prototype,"grayscaleConfig",void 0);let dr=class extends V{constructor(){super(...arguments),this.name="RasterGrayscaleProcessor",this.type=z.Grayscale,this.shaders={grayscale:new us}}_process(t,e){const s={weights:t.rasterFunction.parameters.weights},i=this._getCommonConfig(t,e),r={shader:this.shaders.grayscale,uniforms:{config:i,grayscaleConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=t;a.submitDrawMesh(o,r,a.quadMesh)}},Ze=class extends M{constructor(){super(...arguments),this.type="HillshadeShader",this.isMultidirectional=!1}_process(t){const{texture:e}=this.config,s=Be(e,t,this.config.srcImageSize),i=Wt(s,this.hillshadeConfig,this.isMultidirectional);return new f(i.rgb.multiply(255),i.a)}};l([_],Ze.prototype,"isMultidirectional",void 0),l([m(Z)],Ze.prototype,"hillshadeConfig",void 0);let mr=class extends V{constructor(){super(...arguments),this.name="RasterHillshadeProcessor",this.type=z.Hillshade,this.shaders={hillshade:new Ze}}_process(t,e){const s=t.rasterFunction.parameters,i={isMultidirectional:s.hillshadeType>0},r=e.getRasterCellSize(),a=Nt(s,r),o={...s,factor:a,minValue:0,maxValue:8e3},n=this._getCommonConfig(t,e),u={shader:this.shaders.hillshade,uniforms:{config:n,hillshadeConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,u,c.quadMesh)}},gr=class extends V{constructor(){super(...arguments),this.name="RasterLocalProcessor",this.type=z.Local,this.shaders={local:new Le}}_process(t,e){const s=t.rasterFunction.parameters,i={constantCount:this._getConstantCount(s.rasters),imageCount:s.imageCount,operationName:s.operationName,isOutputRounded:s.isOutputRounded},r={domainRange:s.domainRange},a=s.operationName==="conditional"?s.rasters:s.rasters?.slice(0,2),o=this._getMultipleInputConfig(e,a),n=this._getCommonConfig(t,e),u={shader:this.shaders.local,uniforms:{config:n,domainRangeConfig:r,...o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,u,c.quadMesh)}};class lt extends I{}l([m(Q.ofType(p,6))],lt.prototype,"includedRanges",void 0),l([m(Q.ofType(p,xe))],lt.prototype,"noDataValues",void 0);let ut=class extends M{constructor(){super(...arguments),this.type="MaskShader",this.isMultiband=!0}_process(t){const e=this._getPixel(t),s=this._computeNoDataFactor(e.r),i=this._computeRangeFactor(e.rgb);let r;if(this.isMultiband){const a=this._computeNoDataFactor(e.g),o=this._computeNoDataFactor(e.b),n=new w(s,a,o).multiply(i);r=n.x.multiply(n.y).multiply(n.z)}else r=s.multiply(i.x);return e.multiply(r)}_computeNoDataFactor(t){const{noDataValues:e}=this.maskConfig;let s=new w(1);for(let i=0;i<xe/3;i++){const r=3*i,a=new w(e[r+0],e[r+1],e[r+2]),o=D(q(a.subtract(t)));s=s.multiply(o)}return s.x.multiply(s.y).multiply(s.z)}_computeRangeFactor(t){const{includedRanges:e}=this.maskConfig,s=new w(e[0],e[2],e[4]),i=new w(e[1],e[3],e[5]);return B(s,t).multiply(B(t,i))}};l([_],ut.prototype,"isMultiband",void 0),l([m(lt)],ut.prototype,"maskConfig",void 0);let yr=class extends V{constructor(){super(...arguments),this.name="RasterMaskProcessor",this.type=z.Mask,this.shaders={mask:new ut}}_process(t,e){const s=t.rasterFunction.parameters,i={isMultiband:s.bandCount>1},r={includedRanges:[...s.includedRanges],noDataValues:[...s.noDataValues]},a=this._getCommonConfig(t,e),o={shader:this.shaders.mask,uniforms:{config:a,maskConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:u}=t;n.submitDrawMesh(u,o,n.quadMesh)}};class cs extends I{}l([m(_e)],cs.prototype,"bandIndexMat3",void 0);class ct extends M{constructor(){super(...arguments),this.type="NDVIShader",this.scaled=!0}_process(e){const s=this._getPixel(e),{r:i,g:r}=this.ndviConfig.bandIndexMat3.multiply(s.rgb),a=i.subtract(r),o=i.add(r),n=a.multiply(F(o));if(!this.scaled)return new f(n,n,n,s.a);const u=X(n.multiply(100).add(100.5));return new f(u,u,u,s.a)}}l([_],ct.prototype,"scaled",void 0),l([m(cs)],ct.prototype,"ndviConfig",void 0);let fr=class extends V{constructor(){super(...arguments),this.name="RasterNDVIProcessor",this.type=z.NDVI,this.shaders={ndvi:new ct}}_process(t,e){const s=t.rasterFunction.parameters,i={scaled:s.scaled},r={bandIndexMat3:s.bandIndexMat3},a=this._getCommonConfig(t,e),o={shader:this.shaders.ndvi,uniforms:{config:a,ndviConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:u}=t;n.submitDrawMesh(u,o,n.quadMesh)}},ge=class extends I{};l([m(Q.ofType(p,3*xe))],ge.prototype,"rangeMaps",void 0),l([m(Q.ofType(p,2*xe))],ge.prototype,"noDataRanges",void 0),l([m(p)],ge.prototype,"unmatchMask",void 0),l([m(p)],ge.prototype,"replacementValue",void 0),l([m(b)],ge.prototype,"clampRange",void 0);class pt extends M{constructor(){super(...arguments),this.type="RemapShader"}_process(e){const s=this._getPixel(e),{rangeMaps:i,unmatchMask:r,clampRange:a,replacementValue:o}=this.remapConfig,{mapValue:n,includeMask:u}=sr(s.r,i,xe),c=this.replaceUnmatched?o:r.multiply(s.r),h=W(c,n,u),d=N(h,a.x,a.y),y=this._computeNoDataFactor(s.rrr).multiply(ht(r,u));return new f(d,d,d,s.a).multiply(y)}_computeNoDataFactor(e){const{noDataRanges:s}=this.remapConfig;let i=new w(0,0,0);for(let r=0;r<xe/3;r++){const a=6*r,o=new w(s[a],s[a+2],s[a+4]),n=new w(s[a+1],s[a+3],s[a+5]);i=i.add(B(o,e).multiply(B(e,n)))}return be(q(E(i,new w(1,1,1))))}}l([m(ge)],pt.prototype,"remapConfig",void 0),l([_],pt.prototype,"replaceUnmatched",void 0);let wr=class extends V{constructor(){super(...arguments),this.name="RasterRemapProcessor",this.type=z.Remap,this.shaders={remap:new pt}}_process(t,e){const s=t.rasterFunction.parameters,i={replaceUnmatched:s.allowUnmatched&&s.replacementValue!=null},r={rangeMaps:[...s.rangeMaps],noDataRanges:[...s.noDataRanges],unmatchMask:s.allowUnmatched?1:0,replacementValue:s.replacementValue??0,clampRange:s.clampRange},a=this._getCommonConfig(t,e),o={shader:this.shaders.remap,uniforms:{config:a,remapConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:u}=t;n.submitDrawMesh(u,o,n.quadMesh)}},br=class extends U{constructor(){super(...arguments),this.type="ReprojectShader"}_colorize(t){return this._getPixel(t)}},xr=class extends V{constructor(){super(...arguments),this.name="RasterReprojectProcessor",this.type=z.Reproject,this.shaders={reproject:new br}}_process(t,e){const s=t.rasterFunction.parameters,i=this._getInterpolationDefines(e.interpolation,!!s.requireNNEdge),{config:r,projectionConfig:a,projectionDefines:o}=this._getReprojectConfig(e),n={shader:this.shaders.reproject,uniforms:{config:r,projectionConfig:a},defines:{...o,...i,applyPixelMask:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:u}=e;e.interpolation="nearest";const{painter:c,context:h}=t;c.submitDrawMesh(h,n,c.quadMesh),e.interpolation=u,e.projected=!0}_getReprojectConfig(t){const{source:e}=t,{names:s,textures:i}=t.getTextures({forProcessing:!0}),r={texture:{texture:i[s.indexOf("u_image")],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[e.width,e.height],opacity:1},a=i[s.indexOf("u_transformGrid")],{transformGrid:o}=t,n=!(!a||!o);return{config:r,projectionConfig:n?{transformTexture:{texture:a,unit:1},targetImageSize:[t.width,t.height],transformSpacing:o.spacing,transformGridSize:o.size}:void 0,projectionDefines:{applyProjection:n,lookupProjection:n&&o.spacing[0]===1}}}_getInterpolationDefines(t,e){const s=t==="bilinear"&&e;return{bilinear:s,bicubic:t==="cubic",nearestOnEdge:s}}};class ps extends Ze{constructor(){super(...arguments),this.type="ShadedReliefShader"}_process(e){const s=super._process(e),{minValue:i,maxValue:r}=this.hillshadeConfig,a=this._getPixel(e),o=r.subtract(i),n=a.r.subtract(i),u=N(n.divide(o),new p(0),new p(1)),c=Ve(new f(u,u,u,1),new p(255),this.colormapConfig),h=qt(c.xyz),d=Et(new w(h.xy,s.x.divide(255))).multiply(255);return new f(d,c.a.multiply(s.a))}}l([m(se)],ps.prototype,"colormapConfig",void 0);class _r extends V{constructor(){super(...arguments),this.name="RasterShadedReliefProcessor",this.type=z.ShadedRelief,this.shaders={shadedRelief:new ps}}_process(e,s,i){const r=e.rasterFunction.parameters,a={isMultidirectional:r.hillshadeType>0},o=s.getRasterCellSize(),n=Nt(r,o),u={...r,factor:n},c={colormapTexture:{texture:i,unit:1},colormapOffset:r.offset,colormapMaxIndex:r.indexedColormap.length/4-1},h=this._getCommonConfig(e,s),d={shader:this.shaders.shadedRelief,uniforms:{config:h,hillshadeConfig:u,colormapConfig:c},defines:a,optionalAttributes:null,useComputeBuffer:!1},{painter:y,context:g}=e;y.submitDrawMesh(g,d,y.quadMesh)}}let Pe=class extends I{};l([m(p)],Pe.prototype,"pixelSizePower",void 0),l([m(p)],Pe.prototype,"pixelSizeFactor",void 0),l([m(p)],Pe.prototype,"zFactor",void 0),l([m(b)],Pe.prototype,"cellSize",void 0);class qe extends M{constructor(){super(...arguments),this.type="SlopeShader",this.isOutputRounded=!1,this.percentRise=!1}_process(e){const{cellSize:s,pixelSizePower:i,pixelSizeFactor:r,zFactor:a}=this.slopeConfig,o=Y(s,new b(i)).multiply(r).add(a).divide(s.multiply(8)),{texture:n}=this.config,u=Be(n,e,this.config.srcImageSize),{x:c,y:h}=gt(u,o),d=K(c.multiply(c).add(h.multiply(h))),y=this.percentRise?d.multiply(100):Ne(d).multiply(57.2957795),g=new f(y,y,y,u[9]);return this.isOutputRounded?ve(g):g}}l([_],qe.prototype,"isOutputRounded",void 0),l([_],qe.prototype,"percentRise",void 0),l([m(Pe)],qe.prototype,"slopeConfig",void 0);let vr=class extends V{constructor(){super(...arguments),this.name="RasterSlopeProcessor",this.type=z.Slope,this.shaders={slope:new qe}}_process(t,e){const s=t.rasterFunction.parameters,i={isOutputRounded:s.isOutputRounded,percentRise:s.slopeType==="percent-rise"},r={cellSize:e.getRasterCellSize(),pixelSizePower:s.slopeType==="adjusted"?s.pixelSizePower:0,pixelSizeFactor:s.slopeType==="adjusted"?s.pixelSizeFactor:0,zFactor:s.zFactor},a=this._getCommonConfig(t,e),o={shader:this.shaders.slope,uniforms:{config:a,slopeConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:u}=t;n.submitDrawMesh(u,o,n.quadMesh)}};class Ie extends M{constructor(){super(...arguments),this.type="StretchShader",this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){const s=this._getPixel(e);let i=Zt(s,this.stretchConfig,this.useGamma,1);return this.isMultiband||(i=new f(i.rrr,i.a)),this.isOutputRounded?ve(i):i}}l([_],Ie.prototype,"isMultiband",void 0),l([_],Ie.prototype,"isOutputRounded",void 0),l([_],Ie.prototype,"useGamma",void 0),l([m(H)],Ie.prototype,"stretchConfig",void 0);let Cr=class extends V{constructor(){super(...arguments),this.name="RasterStretchProcessor",this.type=z.Stretch,this.shaders={stretch:new Ie}}_process(t,e){const s=t.rasterFunction.parameters,i={isMultiband:s.bandCount>1,isOutputRounded:s.isOutputRounded,useGamma:s.useGamma},r=this._getCommonConfig(t,e),a={shader:this.shaders.stretch,uniforms:{config:r,stretchConfig:s},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:n}=t;o.submitDrawMesh(n,a,o.quadMesh)}};const Tr=new Map([["Aspect",tr],["BandArithmetic",ir],["ColormapToRGB",rr],["CompositeBand",or],["ComputeChange",nr],["ContrastBrightness",lr],["Convolution",ur],["Curvature",cr],["ExtractBand",pr],["Grayscale",dr],["Hillshade",mr],["Local",gr],["Mask",yr],["NDVI",fr],["Remap",wr],["Reproject",xr],["ShadedRelief",_r],["Slope",vr],["Statistics",hr],["Stretch",Cr]]);class Rr extends mt{constructor(){super(...arguments),this.type=z.RasterProcessor,this.shaders={},this._techniques=new Map}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0;for(const s of this._techniques.values())s.shutdown();this._techniques.clear()}render(e,s){this._fbo??=Qt(e.context,ce,ce);let{name:i}=e.rasterFunction;if(i==="Arithmetic"&&(i="Local"),!this._techniques.has(i)){const r=Tr.get(i);if(!r)return;this._techniques.set(i,new r)}this._techniques.get(i).render(e,{...s,processorFbo:this._fbo})}}let Sr=class extends kt{constructor(){super(...arguments),this.isCustomTilingScheme=!1}createTile(t){const e=this._getTileBounds(t),[s,i]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(t.level);return new $i(t,r,e[0],e[3],s,i)}onAttach(){super.onAttach(),this._colorizerTechnique=new Ji,this._processorTechnique=new Rr}onDetach(){super.onDetach(),this._colorizerTechnique?.shutdown(),this._colorizerTechnique=void 0,this._processorTechnique?.shutdown(),this._processorTechnique=void 0}doRender(t){if(!this.visible||t.drawPhase!==tt.MAP||!this._colorizerTechnique)return;const{rasterFunctionChain:e}=this;if(e?.functions?.length){if(!this._processorTechnique)return;const{functions:i,hasBranches:r}=e;for(const a of i){if(a.name==="Constant"||a.name==="Identity")continue;t.rasterFunction=a,t.hasBranches=r,super.doRender(t);const o=this.children.map(n=>n.bitmap);this._processorTechnique.render(t,{bitmaps:o})}}t.rasterFunction=null,super.doRender(t);const s=this.children.map(i=>i.bitmap);this._colorizerTechnique.render(t,{bitmaps:s})}_getTileBounds(t){const e=this.tileInfoView.getTileBounds(Rt(),t);if(this.isCustomTilingScheme&&t.world){const{tileInfo:s}=this.tileInfoView,i=ks(s.spatialReference);if(i){const r=s.lodAt(t.level);if(!r)return e;const{resolution:a}=r,o=a*s.size[0];e[0]=i*t.world+s.origin.x+t.col*o,e[2]=e[0]+o}}return e}};const Pr=[0,0];let O=class extends ms{constructor(){super(...arguments),this._updatingHandles=new Pi,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=gs(async(t={})=>{const e=this._rasterFunctionState,s=t.reprocess||e==="gpu"&&!this.canUseWebGLForProcessing||e==="cpu"&&this.canUseWebGLForProcessing;if(s&&(await this._updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters()),!this.previousLOD||this.layerView.suspended)return;const i=this._rasterFunctionState,{type:r}=this;return t.refetch||r!=="raster"&&s||i==="cpu"||e==="cpu"?this._updatingHandles.addPromise(this.doRefresh()):this._updatingHandles.addPromise(this._redrawImage(t.signal))})}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||this.type==="rasterVF")&&!this.layerView.hasTilingEffects}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(t){this._set("useWebGLForProcessing",t)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(t){if(this._tileStrategy&&this.useProgressiveUpdate!==t){this._tileStrategy.destroy(),this.container.removeAllChildren();const e=this._getCacheSize(t);this._tileStrategy=new bt({cachePolicy:"purge",acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),cacheSize:e,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",t),this.layerView.requestUpdate()}}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume();const{extent:e,resolution:s,scale:i}=t.state,r=this._tileInfoView.getClosestInfoForScale(i);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const a=this._srcResolutions[r.level],o="toJSON"in e?e:ys.fromJSON(e);vt(this._blockCacheRegistryUrl,this._blockCacheRegistryId,o,s,a,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,this.previousLOD?.level!==r.level&&(this.previousLOD=r,this._symbolizerParams!=null&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.layerView.hasTilingEffects&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.layerView.requestUpdate()}get updating(){return this._globalUpdateRequested||this._updatingHandles?.updating}attach(){const t=Oi();this._maxIndexedColormapSize=4*(t.maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new qs(this.layerView.tileInfo,this.layerView.fullExtent);const e=this._computeFetchConcurrency();this._fetchQueue=new Es({tileInfoView:this._tileInfoView,concurrency:e,process:(i,r)=>this._fetchTile(i,r),priority:Bi.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});const s=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new bt({cachePolicy:"purge",acquireTile:i=>this.acquireTile(i),releaseTile:i=>this.releaseTile(i),cacheSize:s,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,Ct(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(t){const e=this.container.createTile(t);return this._updatingHandles.addPromise(this._enqueueTileFetch(e)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,e}releaseTile(t){this._fetchQueue.abort(t.key.id),this.container.removeChild(t),t.once("detach",()=>{t.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(t=null){const e=t==null||t.join(",")===this._tileInfoView.tileInfo.size.join(",");if(e&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;t=t||this._tileInfoView.tileInfo.size;const[s,i]=t,r=new Ri({width:s,height:i,pixels:[new Uint8Array(s*i)],mask:new Uint8Array(s*i),pixelType:"u8"});return e&&(this._emptyTilePixelBlock=r),r}_getBandIds(){if(!("rasterFunctionChain"in this.container)||!this.container.rasterFunctionChain)return this.layer.bandIds;const{bandIds:t,raster:e}=this.layer,s="rasterFunction"in e?e.rasterFunction.rawInputBandIds:null;return t?.length&&s?.length&&e.rasterInfo.bandCount!==1?t.map(i=>s[Math.min(i,s.length-1)]):"rasterFunction"in e?s:t}updateRasterFunctionParameters(){}_fetchTile(t,e){const s=this._getFetchOptions(t.level,e.signal);return this.fetchTile(t,s)}_getFetchOptions(t,e){const{canUseWebGLForProcessing:s}=this,{layerView:i}=this,{tileInfo:r}=i,a=!r.isWrappable&&ki(i.view.spatialReference)!=null,o=s&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:n}=this.layerView,u=n.serviceRasterInfo?.storageInfo.isBsqTile?n.bandIds:void 0;return{allowPartialFill:!0,datumTransformation:i.datumTransformation,interpolation:s?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:o,skipRasterFunction:this.type==="raster"&&this.container.rasterFunctionChain!=null,signal:e,srcResolution:this._srcResolutions[t],timeExtent:i.timeExtent,tileInfo:r,bandIds:u,disableWrapAround:a}}_getCacheSize(t){return t?40:0}_initializeTileInfo(){const{layerView:t}=this,e=t.view.spatialReference;if(this._canUseLayerLODs()){const{origin:c,lods:h}=this.layer.tileInfo,d=h.map(({scale:g})=>g),y=_t.create({spatialReference:e,size:ce,scales:d,origin:c});return t.set("tileInfo",y),void(this._srcResolutions=h.map(({resolution:g})=>({x:g,y:g})))}const{scales:s,srcResolutions:i,isCustomTilingScheme:r}=Mi(this.layer.serviceRasterInfo,e,{tileSize:ce,alignGlobalDatasetWithAGOL:!0}),a=_t.create({spatialReference:e,size:ce,scales:s}),o=a.origin.x===0;fs(t.fullExtent);const{xmin:n,ymax:u}=t.fullExtent;(o||r&&a.origin.x>n)&&(a.origin=new ws({x:n,y:u,spatialReference:e})),this._isCustomTilingScheme=r,t.set("tileInfo",a),this._srcResolutions=i??[]}_canUseLayerLODs(){const{layer:t,layerView:e}=this;if(t.raster.tileType!=="Map")return!1;const{lods:s}=t.tileInfo,i=e.view.constraints?.effectiveLODs;return i?.length===s.length&&i.every(({scale:r},a)=>Math.abs(r-s[a].scale)<.001)}_computeFetchConcurrency(){const{blockBoundary:t}=this.layer.serviceRasterInfo.storageInfo,e=t[t.length-1];return(e.maxCol-e.minCol+1)*(e.maxRow-e.minRow+1)>64?2:10}async _enqueueTileFetch(t,e){if(!this._fetchQueue.has(t.key.id)){try{const s=await this._fetchQueue.push(t.key),i=this._getBandIds();let r=!this.useProgressiveUpdate||this.layerView.hasTilingEffects&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){r=!1;try{await this._redrawImage(this._abortController?.signal)}catch(n){ze(n)&&ke.getLogger(this).error(n)}this._globalUpdateRequested=!1}this.canUseLocalSymbolizerParams&&this._symbolizerParams==null&&this._updateSymbolizerParams();const a=this._tileInfoView.getTileCoords(Pr,t.key),o=this._tileInfoView.getTileResolution(t.key);await this.updateTileSource(t,{source:s,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:r,bandIds:i,coords:a,resolution:o}),t.once("attach",()=>this.layerView.requestUpdate()),this.container.addChild(t)}catch(s){ze(s)||ke.getLogger(this).error(s)}this.layerView.requestUpdate()}}async _redrawImage(t){if(this.container.children.length===0)return;await this.layer.updateRenderer(),this.layerView.hasTilingEffects?await this._updateGlobalSymbolizerParams(t):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null);const e=this.container.children.map(async s=>this.updateTileSymbolizerParameters(s,{local:this._symbolizerParams,global:this._globalSymbolizerParams}));await Promise.allSettled(e),this.container.requestRender()}async _updateGlobalSymbolizerParams(t){const e=this._getFetchOptions(this.previousLOD.level,t),s=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...e,interpolation:"nearest",requestRawData:!1,skipRasterFunction:!1});if(!s?.pixelBlock)return;const{resolution:i}=this.previousLOD,r=this._getBandIds(),a=this.layer.symbolizer.generateWebGLParameters({pixelBlock:s.pixelBlock.extractBands(r),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:i,y:i},bandIds:r});!this.canUseWebGLForProcessing&&a&&a.type==="stretch"&&this.layer.renderer&&this.layer.renderer.type==="raster-stretch"&&(a.factor=a.factor.map(o=>255*o),a.minOutput=Math.round(255*a.minOutput),a.maxOutput=Math.round(255*a.maxOutput)),this._globalSymbolizerParams=a}_updateSymbolizerParams(){const{resolution:t}=this.previousLOD,e=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:e})}_updateBlockCacheRegistry(t=!1){const{layer:e,layerView:s}=this,{raster:i}=e,{multidimensionalDefinition:r}=e.normalizeRasterFetchOptions({multidimensionalDefinition:e.multidimensionalDefinition,timeExtent:s.timeExtent}),a=i.rasterInfo.multidimensionalInfo?i.getSliceIndex(r):null,o=i.rasterInfo.storageInfo.isBsqTile&&e.bandIds?.length?e.bandIds:null,n=Ii(i.rasterId,a,o);if(n!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&Ct(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=zi(n,i.rasterInfo),t){const{view:u}=s,c=this._tileInfoView.getClosestInfoForScale(u.scale),h=this._srcResolutions[c.level];vt(n,this._blockCacheRegistryId,u.extent,u.resolution,h,i.ioConfig.sampling)}this._blockCacheRegistryUrl=n}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const t=[];this._globalUpdateRequested=this.layerView.hasTilingEffects||!this.useProgressiveUpdate,this._tileStrategy.refresh(e=>t.push(this._enqueueTileFetch(e))),await this._updatingHandles.addPromise(Promise.allSettled(t))}};l([C()],O.prototype,"_globalUpdateRequested",void 0),l([C()],O.prototype,"attached",void 0),l([C()],O.prototype,"canUseWebGLForProcessing",null),l([C()],O.prototype,"canUseLocalSymbolizerParams",null),l([C()],O.prototype,"container",void 0),l([C()],O.prototype,"layer",void 0),l([C()],O.prototype,"layerView",void 0),l([C()],O.prototype,"scheduler",void 0),l([C()],O.prototype,"type",void 0),l([C()],O.prototype,"useWebGLForProcessing",null),l([C()],O.prototype,"useProgressiveUpdate",null),l([C()],O.prototype,"timeExtent",void 0),l([C()],O.prototype,"updating",null),O=l([Fe("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],O);let le=class extends O{constructor(){super(...arguments),this.type="raster"}get canUseWebGLForProcessing(){const{loaded:t,symbolizer:e}=this.layer;if(!t||!e)return!1;const s=e.lookup.colormapLut?.indexedColormap,i=s&&s.length>this._maxIndexedColormapSize,r=Is(this.layer.serviceRasterInfo);return!(bs("ios")&&r>4)&&this.useWebGLForProcessing&&e.canRenderInWebGL&&!i&&!(this.layer.interpolation==="majority"&&Pt(this.layer))}attach(){super.attach(),this.container=new Sr(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(t,e){return this.layer.fetchTile(t.level,t.row,t.col,e)}updateRasterFunctionParameters(){const{raster:t,type:e}=this.layer,{container:s}=this;if(t.datasetFormat!=="Function"||e==="wcs")return s.rasterFunctionChain=null,s.children.forEach(y=>{const{bitmap:g}=y;g&&(g.suspended=!0,g.processed=!1,g.projected&&(g.invalidateTexture(),g.rasterTexture=null))}),void(this._rasterFunctionState="na");const i=this._rasterFunctionState,{rasterFunction:r,primaryRasters:a}=t,o=r.supportsGPU&&(!a||a.rasters.length<=1),n=o?r.flatWebGLFunctionChain:null,{renderer:u}=this.layer,c=!o||!n?.functions.length||u?.type==="raster-stretch"&&u.dynamicRangeAdjustment||!this.canUseWebGLForProcessing;s.rasterFunctionChain=c?null:this._addProjection(n);const h=r==null?"na":s.rasterFunctionChain?"gpu":"cpu",d=i===h||i==="na"&&h==="cpu"&&n?.functions?.length===0;s.children.forEach(y=>{const{bitmap:g}=y;g&&(g.suspended=!d,g.processed=!1,g.processedTexture=null)}),this._rasterFunctionState=h}async updateTileSource(t,e){const s=this._getBandIds(),i=this._getLayerInterpolation(),{canUseWebGLForProcessing:r}=this,{source:a,globalSymbolizerParams:o,suspended:n,coords:u,resolution:c}=e,h=this.layerView.hasTilingEffects?o:e.symbolizerParams,{bitmap:d}=t;if([d.x,d.y]=u,d.resolution=c,a?.pixelBlock!=null){const g={extent:a.extent,pixelBlock:a.pixelBlock,srcPixelSize:a.srcTilePixelSize};if(d.rawPixelData=g,r)d.source=a.pixelBlock,d.isRendereredSource=!1;else{const x=await this.layer.applyRenderer(g,o?.type==="stretch"?o:void 0);d.source=x,d.isRendereredSource=!0}d.symbolizerParameters=r?h:null,d.transformGrid=r?a.transformGrid:null}else{const g=this.createEmptyTilePixelBlock();d.source=g,d.symbolizerParameters=r?h:null,d.transformGrid=null}d.bandIds=r?s:null,d.width=this._tileInfoView.tileInfo.size[0],d.height=this._tileInfoView.tileInfo.size[1],d.interpolation=i,d.suspended=n;const{raster:y}=this.layer;if(St(y)){const g=y.getClippingGeometry(this.layerView.view.spatialReference);if(g){const x=y.getTileExtentFromTileInfo(t.key.level,t.key.row,t.key.col,this._tileInfoView.tileInfo);d.mask=zs({srcExtent:x,geometry:g,size:[d.width,d.height]})}}d.invalidateTexture()}async updateTileSymbolizerParameters(t,e){const{local:s,global:i}=e,r=this._getBandIds(),a=this._getLayerInterpolation(),{canUseWebGLForProcessing:o}=this,{bitmap:n}=t,{rawPixelData:u}=n;o||u==null?(n.isRendereredSource&&u!=null&&(n.source=u.pixelBlock),n.isRendereredSource=!1):(n.source=await this.layer.applyRenderer(u,i?.type==="stretch"?i:void 0),n.isRendereredSource=!0),n.symbolizerParameters=o?this.layerView.hasTilingEffects?i:s:null,n.bandIds=o?r:null,n.interpolation=a,n.suspended=!1}_getLayerInterpolation(){const{interpolation:t,renderer:e}=this.layer;if(!e)return t;const s=e.type;return s==="raster-colormap"||s==="unique-value"?"nearest":e.type==="raster-stretch"&&e.colorRamp!=null?t==="bilinear"||t==="cubic"?"bilinear":"nearest":t}_addProjection(t){return t?.functions?.length&&!t.hasFocalFunction&&t.functions.unshift({name:"Reproject",parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:t.isSourceSingleBand},pixelType:"f32",id:0,isNoopProcess:!1}),t}};l([C()],le.prototype,"canUseWebGLForProcessing",null),l([C()],le.prototype,"container",void 0),l([C()],le.prototype,"layer",void 0),l([C()],le.prototype,"type",void 0),le=l([Fe("esri.views.2d.layers.imagery.ImageryTileView2D")],le);class Ir extends zt{constructor(e,s,i,r,a,o,n=null){super(e,s,i,r,a,o),this.tileData=new Ss(n),this.tileData.coordScale=[a,o],this.tileData.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:Me(),tileMat3:Me()}}setTransform(e){super.setTransform(e);const s=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[r,a]=this.tileData.offset,o=[this.x+r*this.resolution,this.y-a*this.resolution],[n,u]=e.toScreenNoRotation([0,0],o),{symbolTileSize:c}=this.tileData.symbolizerParameters,h=Math.round((this.width-this.tileData.offset[0])/c)*c,d=Math.round((this.height-this.tileData.offset[1])/c)*c,y=h/this.rangeX*s,g=d/this.rangeY*s;Ms(i,y,0,0,0,g,0,n,u,1),It(this.transforms.displayViewScreenMat3,e.displayViewMat3,i),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class zr extends kt{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(e){const s=this.tileInfoView.getTileBounds(Rt(),e),[i,r]=this.tileInfoView.tileInfo.size,a=this.tileInfoView.getTileResolution(e.level);return new Ir(e,a,s[0],s[3],i,r)}prepareRenderPasses(e){const s=e.registerRenderPass({name:"imagery (vf tile)",brushes:[Rs],target:()=>this.children.map(i=>i.tileData),drawPhase:tt.MAP});return[...super.prepareRenderPasses(e),s]}doRender(e){this.visible&&e.drawPhase===tt.MAP&&this.symbolTypes.forEach(s=>{e.renderPass=s,super.doRender(e)})}}let ye=class extends O{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}async fetchTile(t,e){e={...e,interpolation:"nearest",requestProjectedLocalDirections:!0};const s=await this.layer.fetchTile(t.level,t.row,t.col,e);return this.layer.serviceRasterInfo?.dataType==="vector-magdir"&&s?.pixelBlock&&(s.pixelBlock=await this.layer.convertVectorFieldData(s.pixelBlock,"vector-magdir",e)),s}updateTileSource(t,e){const s=e.symbolizerParams,{tileData:i}=t;i.key=t.key,i.width=this._tileInfoView.tileInfo.size[0],i.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:r}=s,{source:a}=e;if(i.offset=this._getTileSymbolOffset(i.key,r),a?.pixelBlock!=null){const o={extent:a.extent,pixelBlock:a.pixelBlock};i.rawPixelData=o,i.symbolizerParameters=s,i.source=this._sampleVectorFieldData(a.pixelBlock,s,i.offset)}else{const o=[Math.round((this._tileInfoView.tileInfo.size[0]-i.offset[0])/r),Math.round((this._tileInfoView.tileInfo.size[1]-i.offset[1])/r)],n=this.createEmptyTilePixelBlock(o);i.source=n,i.symbolizerParameters=s}return i.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(t,e){const s=e.local,{symbolTileSize:i}=s,{tileData:r}=t;r.offset=this._getTileSymbolOffset(r.key,i);const a=r.symbolizerParameters.symbolTileSize;r.symbolizerParameters=s;const o=r.rawPixelData?.pixelBlock;return o!=null&&a!==i&&(r.source=this._sampleVectorFieldData(o,r.symbolizerParameters,r.offset)),Promise.resolve()}attach(){super.attach(),this.container=new zr(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=Ae(()=>this.layer.renderer,t=>this._updateSymbolType(t))}detach(){super.detach(),this.container.removeAllChildren(),this._handle?.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(t,e){const s=t.col*this._tileInfoView.tileInfo.size[0]%e,i=t.row*this._tileInfoView.tileInfo.size[1]%e;return[s>e/2?e-s:-s,i>e/2?e-i:-i]}_sampleVectorFieldData(t,e,s){const{symbolTileSize:i}=e;return Si(t,"vector-uv",i,s)}_updateSymbolType(t){t?.type==="vector-field"&&(this.container.symbolTypes=t.style==="wind-barb"?["scalar","triangle"]:t.style==="simple-scalar"?["scalar"]:["triangle"])}};l([C()],ye.prototype,"container",void 0),l([C()],ye.prototype,"layer",void 0),l([C()],ye.prototype,"type",void 0),ye=l([Fe("esri.views.2d.layers.imagery.VectorFieldTileView2D")],ye);const kr=t=>{let e=class extends t{constructor(){super(...arguments),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return Di(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?Fi(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(s){try{return!this.layer.loaded||!!Tt(this.layer.serviceRasterInfo,s)}catch{return!1}}async fetchPopupFeaturesAtLocation(s,i){const{layer:r}=this;if(!s)throw new xs("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:a}=r,o=Gi(r,i);if(!a||o==null)return[];const n=[],{value:u,magdirValue:c,processedValue:h}=await r.identify(s,{timeExtent:this.timeExtent,signal:i?.signal});let d="";if(u?.length){d=r.type==="imagery-tile"&&r.hasStandardTime()&&u[0]!=null?u.map(R=>r.getStandardTimeValue(R)).join(", "):u.join(", ");const y={ObjectId:0};y[Ce.servicePixelValue]=r.type==="imagery-tile"&&St(r.raster)?h?.join(", "):d,y[Ce.rawServicePixelValue]=d;const g=r.raster?.rasterInfo??r.serviceRasterInfo,x=g?.attributeTable;if(x!=null){const{fields:R,features:j}=x,J=R.find(({name:re})=>re.toLowerCase()==="value"),He=y[Ce.servicePixelValue],Oe=J?j.find(re=>String(re.attributes[J.name])===He):null;if(Oe)for(const re in Oe.attributes)Oe.attributes.hasOwnProperty(re)&&(y[vs+re]=Oe.attributes[re])}const v=g?.dataType;v!=="vector-magdir"&&v!=="vector-uv"||(y[Ce.magnitude]=c?.[0],y[Ce.direction]=c?.[1]);const{multidimensionalDefinition:S}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});Cs(r.rasterFields,y,S);const k=new _s({geometry:this.fullExtent?.clone(),attributes:y,layer:r,sourceLayer:r});n.push(k)}return n}async getSourceScale(){return await this.layer.load(),Vi(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return Tt(this.layer.serviceRasterInfo,this.view.spatialReference)}};return l([C()],e.prototype,"fullExtent",null),l([C()],e.prototype,"layer",void 0),l([C({readOnly:!0})],e.prototype,"timeExtent",null),l([C()],e.prototype,"tileInfo",void 0),l([C({readOnly:!0})],e.prototype,"hasTilingEffects",null),l([C()],e.prototype,"datumTransformation",null),e=l([Fe("esri.views.layers.ImageryTileLayerView")],e),e};let ue=class extends kr(Ui(Ps(Ai))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(t){this._useWebGLForProcessing=t,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=t)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(t){this._useProgressiveUpdate=t,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=t)}get displayParameters(){const{layer:t}=this,e=this._get("displayParameters");return t.renderer&&t.visible?{bandIds:t.bandIds,renderer:t.renderer,interpolation:t.interpolation,multidimensionalDefinition:t.multidimensionalDefinition,rasterFunction:t.type==="imagery-tile"?t.rasterFunction:null}:e}update(t){this.subview?.update(t),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([Ae(()=>this.displayParameters,(t,e)=>{const s=t.interpolation!==e?.interpolation&&(t.interpolation==="majority"||e?.interpolation==="majority")&&Pt(this.layer),i=!!this.layer.serviceRasterInfo?.storageInfo?.isBsqTile&&t.bandIds?.join()!==e?.bandIds?.join(),r=t.renderer!==e?.renderer&&this._getSubviewType(e?.renderer)!==this._getSubviewType(t.renderer);r&&this._updateSubview();const a=t.multidimensionalDefinition!==e?.multidimensionalDefinition,o=t.rasterFunction!==e?.rasterFunction,n=o&&!this._useWebGLForProcessing,u=a||s||r||n||i;this.subview.redrawOrRefetch({refetch:u,reprocess:o}).catch(c=>{ze(c)||ke.getLogger(this).error(c)}),this.notifyChange("updating")}),Ae(()=>this.layer.multidimensionalSubset??null,(t,e)=>{const{multidimensionalDefinition:s}=this.layer;s!=null&&wt(s,t)!==wt(s,e)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(i=>{ze(i)||ke.getLogger(this).error(i)}),this.notifyChange("updating"))},hs),Ae(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(t=>{ze(t)||ke.getLogger(this).error(t)})},ds)])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){const{renderer:t}=this.layer;if(!t)return;const e=this._getSubviewType(t);if(this.subview){if(this.subview.type===e)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}const{layer:s}=this;let i;if(i=e==="rasterVF"?new ye({layer:s,layerView:this,scheduler:this.scheduler}):e==="flow"?new Ts({layer:s,layerView:this,scheduler:this.scheduler}):new le({layer:s,layerView:this,scheduler:this.scheduler}),"useWebGLForProcessing"in i&&(i.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in i&&(i.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in i){const{subview:r}=this;i.previousLOD=r&&"previousLOD"in r?r.previousLOD:null}this._attachSubview(i),this.subview=i,this.requestUpdate()}_attachSubview(t){t&&!t.attached&&(t.attach(),t.attached=!0,this.container.addChildAt(t.container,0))}_detachSubview(t){t?.attached&&(this.container.removeChild(t.container),t.detach(),t.attached=!1)}_getSubviewType(t){const e=t?.type;return e==="vector-field"?"rasterVF":e==="flow"?"flow":"raster"}};l([C()],ue.prototype,"subview",void 0),l([C()],ue.prototype,"useWebGLForProcessing",null),l([C()],ue.prototype,"useProgressiveUpdate",null),l([C({readOnly:!0})],ue.prototype,"displayParameters",null),ue=l([Fe("esri.views.2d.layers.ImageryTileLayerView2D")],ue);const Uo=ue;export{Uo as default};
