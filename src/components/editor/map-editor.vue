<template>
    <div class="flex flex-col">
        <label class="text-left">Map title:</label>
        <input type="text" v-model="panel.title" />

        <div v-if="status === 'editing'">
            <label class="mt-6">Enable Scrollguard:</label>
            <input type="checkbox" @change="saveScrollguard" v-model="panel.scrollguard" />
            <span class="ml-6"></span>
            <label class="mt-6">{{ $t('editor.map.timeslider.enable') }}</label>
            <input type="checkbox" @change="saveTimeSlider" v-model="usingTimeSlider" />
            <span class="mx-4"></span>
            <button
                v-if="usingTimeSlider"
                class="bg-black text-white hover:bg-gray-800 mt-3"
                @click="$modals.show('time-slider-edit-modal')"
            >
                {{ $t('editor.map.timeslider.edit') }}
            </button>
            <br />

            <div class="mb-4" v-if="usingTimeSlider"></div>

            <div class="flex justify-between mb-4">
                <label class="mt-2">Map Editor:</label>
                <button
                    class="border border-black hover:bg-gray-100"
                    @click="
                        () => {
                            status = 'default';
                        }
                    "
                >
                    Cancel Editing
                </button>
            </div>
            <iframe
                src="scripts/ramp-editor/samples/fgpv-author.html"
                style="width: 70vw; height: 100vh"
                id="RAMPeditorframe"
            ></iframe>
        </div>
        <div v-if="status === 'creating'">
            <label class="text-left mt-2">Map config name*:</label>
            <div class="flex flex-row items-center"><input type="text" v-model="newFileName" />.json</div>

            <ul class="flex flex-wrap list-none justify-center" v-if="newFileName != ''">
                <li class="map-item items-center my-8 mx-5 overflow-hidden" @click="createNewConfig">
                    <div class="add-map"></div>
                    {{ $t('editor.map.label.create') }}
                </li>
            </ul>
        </div>
        <div v-if="status === 'default'">
            <label class="text-left mt-2">Map Editor:</label>
            <ul class="flex flex-wrap list-none justify-center">
                <li class="map-item items-center my-8 mx-5 overflow-hidden" @click="openEditor">
                    <div class="edit-map"></div>
                    {{ $t('editor.map.label.edit') }}
                </li>
            </ul>
        </div>
        <vue-modal name="time-slider-edit-modal" :outer-close="false" :hide-close-btn="true" size="md">
            <h2 slot="header" class="text-lg font-bold">{{ $t('editor.map.timeslider.edit') }}</h2>
            <time-slider-editor
                :config="timeSliderConf"
                :error="timeSliderError"
                @time-slider-changed="onTimeSliderInput"
            ></time-slider-editor>
            <div class="w-full flex justify-end">
                <button
                    :class="timeSliderError ? '' : 'bg-black text-white hover:bg-gray-800'"
                    :disabled="timeSliderError"
                    @click="saveTimeSlider"
                >
                    Done
                </button>
            </div>
        </vue-modal>
    </div>
</template>

<script lang="ts">
import { Component, Prop, Vue } from 'vue-property-decorator';
import { ConfigFileStructure, MapPanel, SourceCounts, TimeSliderConfig } from '@/definitions';
import defaultConfigEn from '../../../public/scripts/ramp-editor/samples/map_en.json';
import defaultConfigFr from '../../../public/scripts/ramp-editor/samples/map_fr.json';
import TimeSliderEditorV from './helpers/time-slider-editor.vue';

@Component({
    components: {
        'time-slider-editor': TimeSliderEditorV
    }
})
export default class MapEditorV extends Vue {
    @Prop() panel!: MapPanel;
    @Prop() configFileStructure!: ConfigFileStructure;
    @Prop() lang!: string;
    @Prop() sourceCounts!: SourceCounts;

    // For creating new files.
    newFileName = '';

    // TimeSlider
    usingTimeSlider = !!this.panel.timeSlider;
    timeSliderError = false;
    timeSliderConf: TimeSliderConfig = { range: [], start: [], attribute: '' };
    status = this.panel.config !== '' ? 'default' : 'creating';
    strippedFileName = this.panel.config !== '' ? this.panel.config.split('/')[3].split('.')[0] : '';

    mounted(): void {
        // If a message is received, it means the map save button was pressed.
        window.addEventListener('message', this.saveEditor);
        this.timeSliderConf = JSON.parse(
            JSON.stringify({
                range: this.panel.timeSlider?.range ?? [1000, new Date().getFullYear()],
                start: this.panel.timeSlider?.start ?? [1000, new Date().getFullYear()],
                attribute: this.panel.timeSlider?.attribute ?? ''
            })
        );
        this.validateTimeSlider();
    }

    beforeDestroy(): void {
        window.removeEventListener('message', this.saveEditor);
    }

    createNewConfig(): void {
        // Update the path to the new file.
        // TODO: ensure that this is not a name already in use?
        this.panel.config = `${this.configFileStructure.uuid}/ramp-config/${this.lang}/${this.newFileName}.json`;
        this.strippedFileName = this.panel.config.split('/')[3].split('.')[0];

        if (this.sourceCounts[this.panel.config]) {
            this.sourceCounts[this.panel.config] += 1;
        } else {
            this.sourceCounts[this.panel.config] = 1;
        }

        // Create the new map configuration file in the ZIP folder. Copies the `config-default.json` file from the `ramp-editor` folder and renames it.
        this.configFileStructure.rampConfig[this.lang].file(
            `${this.strippedFileName}.json`,
            JSON.stringify(this.lang === 'en' ? defaultConfigEn : defaultConfigFr, null, 4)
        );

        // Display the normal edit page now.
        this.status = 'default';
    }

    openEditor(): void {
        if (this.panel.config === '') {
            return;
        }
        // Fetch the map configuration and load it into the editor.
        this.status = 'editing';

        if (this.panel.config) {
            // Check if the config file exists in the ZIP folder first.
            const assetSrc = `${this.panel.config.substring(this.panel.config.indexOf('/') + 1)}`;
            const configFile = this.configFileStructure.zip.file(assetSrc);

            if (configFile) {
                configFile.async('string').then((res: string) => {
                    window.config = res;
                    const iframe = document.getElementById('RAMPeditorframe') as HTMLIFrameElement;
                    if (iframe.contentWindow) {
                        iframe.contentWindow.config = res;
                        iframe.contentWindow.configname = this.strippedFileName;
                    }
                });
            } else {
                // If it does not exist in the ZIP folder, try and fetch from server.
                fetch(this.panel.config).then((data) => {
                    data.json().then((res) => {
                        let stringResponse = JSON.stringify(res);

                        window.config = stringResponse;
                        const iframe = document.getElementById('RAMPeditorframe') as HTMLIFrameElement;
                        if (iframe.contentWindow) {
                            iframe.contentWindow.config = stringResponse;
                            iframe.contentWindow.configname = this.strippedFileName;
                        }
                    });
                });
            }
        }
    }

    saveScrollguard($event: Event): void {
        this.panel.scrollguard = ($event.target as HTMLInputElement).checked;
    }

    saveTimeSlider(): void {
        if (!this.timeSliderError || !this.usingTimeSlider) {
            this.panel.timeSlider = this.usingTimeSlider ? this.timeSliderConf : undefined;
        }
        this.$parent.$emit('slide-edit');
        if (this.$modals.isActive('time-slider-edit-modal')) {
            this.$modals.hide('time-slider-edit-modal');
        }
    }

    saveEditor(e: MessageEvent): void {
        if (e.data === 'mapSaved') {
            this.status = 'default';

            // Add chart config to ZIP file.
            this.configFileStructure.rampConfig[this.lang].file(
                `${this.strippedFileName}.json`,
                JSON.stringify(JSON.parse(localStorage.RAMPconfig), null, 4)
            );

            this.$parent.$emit('slide-edit');
        }
    }

    onTimeSliderInput(property: 'range' | 'start' | 'attribute' | 'layers', index: number, value: string): void {
        if (property === 'layers') {
            if (!value || value === '') {
                delete this.timeSliderConf['layers'];
            } else {
                this.timeSliderConf['layers'] = value.split(',').map((layerId) => {
                    return layerId.trim();
                });
            }
        } else {
            property === 'attribute'
                ? (this.timeSliderConf[property] = value)
                : (this.timeSliderConf[property][index] = Number(value));
        }
        this.validateTimeSlider();
    }

    validateTimeSlider(): void {
        this.timeSliderError =
            this.timeSliderConf.range.some((val) => val < 0 || !Number.isInteger(val)) ||
            this.timeSliderConf.start.some((val) => val < 0 || !Number.isInteger(val)) ||
            this.timeSliderConf.range[1] < this.timeSliderConf.range[0] ||
            this.timeSliderConf.start[1] < this.timeSliderConf.start[0];
    }
}
</script>

<style lang="scss" scoped>
label {
    text-align: left !important;
    width: fit-content !important;
}

select {
    border: 1px black solid;
    background: white;
    padding: 0.25rem 0.5rem;
}
.map-item {
    width: 300px;
    background: #eee;

    text-align: center;
    padding: 25px;
    cursor: pointer;

    button {
        padding: 0 !important;
    }
}
.edit-map {
    content: url('../../assets/edit-icon.svg');
    margin: 0 auto;
    margin-bottom: 20px;
}
.add-map {
    content: url('../../assets/add.svg');
    margin: 0 auto;
    margin-bottom: 20px;
}

input[type='number'] {
    width: 76px;
}
</style>
